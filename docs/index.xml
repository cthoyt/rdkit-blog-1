<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>RDKit blog</title>
<link>https://greglandrum.github.io/rdkit-blog/index.html</link>
<atom:link href="https://greglandrum.github.io/rdkit-blog/index.xml" rel="self" type="application/rss+xml"/>
<description>RDKit experiments, tips, and tutorials</description>
<generator>quarto-1.2.269</generator>
<lastBuildDate>Sat, 24 Dec 2022 23:00:00 GMT</lastBuildDate>
<item>
  <title>Colliding bits II, revisited</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited.html</link>
  <description><![CDATA[ 



<section id="impact-of-bit-collisions-on-learning-performance" class="level1">
<h1>Impact of bit collisions on learning performance</h1>
<p><strong>Note</strong>: This is a significantly revised version of an <a href="https://rdkit.blogspot.com/2014/03/colliding-bits-ii.html">earlier post</a>.</p>
<p>In an <a href="http://rdkit.blogspot.ch/2014/02/colliding-bits.html">earlier post</a> I looked at the minimal impact bit collisions in the RDKit’s Morgan fingerprints has on calculated similarity between molecules. This time I’m going to look at the impact of fingerprint size (as a surrogate for number of collisions) on the performance of machine-learning algorithms.</p>
<p>I will use Datasets II from our <a href="https://pubs.acs.org/doi/abs/10.1021/ci400466r">model fusion</a> paper to do the analysis. I’ve covered these datasets, which are available as part of the <a href="https://github.com/rdkit/benchmarking_platform">benchmarkng platform</a>, in some detail in an <a href="https://rdkit.blogspot.ch/2014/02/more-on-datasets-ii.html">earlier post</a>.</p>
<p>While working on this post I updated the benchmarking platform to work with Python 3 (the paper was a long time ago!) and added a few additional learning methods and one additional evaluation metric. Those will be merged back to the github repo soon (probably by the time this blog post actually appears), in the meantime it’s <a href="https://github.com/greglandrum/benchmarking_platform/tree/update_to_modern_py">here</a> (if that branch is missing, it indicates that the code is already merged to the main repo).</p>
<p>The fingerprints examined here:</p>
<ol type="1">
<li>MFP2: Morgan fingerprint, radius = 2</li>
<li>MFP3: Morgan fingerprint, radius = 3</li>
<li>RDK5: RDKit fingerprint, max path length = 5</li>
<li>HashAP: atom pairs, using <a href="https://www.rdkit.org/docs/RDKit_Book.html#atom-pair-and-topological-torsion-fingerprints">count simulation</a></li>
<li>HashTT: topological torsions, <a href="https://www.rdkit.org/docs/RDKit_Book.html#atom-pair-and-topological-torsion-fingerprints">using count simulation</a></li>
</ol>
<p>The benchmarking platform is pre-configured to support a short (1K) and long (16K) form of the fingerprints, so that part was easy.</p>
<p>The learning algorithms:</p>
<ol type="1">
<li>LR: logistic regression, sklearn implementation</li>
<li>LMNB: Laplacian Naive Bayes, <a href="https://github.com/rdkit/lmnb">NIBR implementation</a></li>
<li>NB: Naive Bayes, sklearn implementation. Note that something went wrong with these calculations, so they won’t be included in any summaries.</li>
<li>RF: random forest, sklearn implementation</li>
<li>BRF: balanced random forest, <a href="https://imbalanced-learn.org/stable/references/generated/imblearn.ensemble.BalancedRandomForestClassifier.html">imbalanced-learn implementation</a></li>
<li>XGB: extreme gradient boosting, <a href="https://xgboost.readthedocs.io/en/stable/python/python_intro.html">XGBoost implementation</a></li>
</ol>
<p>Here’s a summary of the results using AUC as a metric (there’s a giant table at the bottom with the other metrics). The <code>result</code> column indicates whether the AUC value for the short fingerprint is usually less than (<code>lt</code>), the same as (<code>same</code>), or greater than (<code>gt</code>) the AUC value for the long fingerprint. The <code>P</code> column provides the P value for the difference (assessed using scipy’s <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.wilcoxon.html">Wilcoxon signed-rank test</a>). The <code>delt</code> column has the median difference between the short-fingerprint AUC and long-fingerprint AUC. The <code>pct_delt</code> column indicates the median percentage change in AUC relative to the short-fingerprint AUC.</p>
<table class="table">
<thead>
<tr class="header">
<th>alg</th>
<th>fp</th>
<th>metric</th>
<th>result</th>
<th>P</th>
<th>delt</th>
<th>pct_delt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lr</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>8.68e-51</td>
<td>-0.011</td>
<td>-0.0142</td>
</tr>
<tr class="even">
<td>lr</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>2.6e-64</td>
<td>-0.019</td>
<td>-0.0243</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>rdk5</td>
<td>AUC</td>
<td>lt</td>
<td>2.09e-24</td>
<td>-0.011</td>
<td>-0.0143</td>
</tr>
<tr class="even">
<td>lr</td>
<td>hashap</td>
<td>AUC</td>
<td>lt</td>
<td>8.77e-37</td>
<td>-0.026</td>
<td>-0.0325</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>8.02e-54</td>
<td>-0.022</td>
<td>-0.0294</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>3.2e-104</td>
<td>-0.042</td>
<td>-0.0573</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>6.05e-107</td>
<td>-0.077</td>
<td>-0.109</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>rdk5</td>
<td>AUC</td>
<td>lt</td>
<td>4.32e-60</td>
<td>-0.071</td>
<td>-0.193</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>1.67e-18</td>
<td>0.031</td>
<td>0.0494</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>7.52e-105</td>
<td>-0.051</td>
<td>-0.0767</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>1.45e-102</td>
<td>-0.087</td>
<td>-0.132</td>
</tr>
<tr class="even">
<td>rf</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>2.23e-92</td>
<td>-0.074</td>
<td>-0.115</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>4.27e-11</td>
<td>0.015</td>
<td>0.0212</td>
</tr>
<tr class="even">
<td>rf</td>
<td>hashap</td>
<td>AUC</td>
<td>same</td>
<td>0.00227</td>
<td>0.0036</td>
<td>0.00503</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>1.25e-63</td>
<td>-0.046</td>
<td>-0.0677</td>
</tr>
<tr class="even">
<td>brf</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>6.61e-37</td>
<td>-0.024</td>
<td>-0.0304</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>9.25e-40</td>
<td>-0.031</td>
<td>-0.04</td>
</tr>
<tr class="even">
<td>brf</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>2.77e-09</td>
<td>0.01</td>
<td>0.0131</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>5.32e-07</td>
<td>0.011</td>
<td>0.0152</td>
</tr>
<tr class="even">
<td>brf</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>8.45e-29</td>
<td>-0.027</td>
<td>-0.0362</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>mfp2</td>
<td>AUC</td>
<td>same</td>
<td>0.831</td>
<td>0.00097</td>
<td>0.00109</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>mfp3</td>
<td>AUC</td>
<td>same</td>
<td>0.00162</td>
<td>-0.0051</td>
<td>-0.00719</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>1.36e-07</td>
<td>0.012</td>
<td>0.0157</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>1.49e-20</td>
<td>0.027</td>
<td>0.0358</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>hashtt</td>
<td>AUC</td>
<td>same</td>
<td>0.0265</td>
<td>-0.0043</td>
<td>-0.00645</td>
</tr>
</tbody>
</table>
<p>The TL;DR from this: for most methods and fingerprints you can get a small, but real improvement in model performance (as measured by AUC) by using the longer fingerprints. There are a few cases, e.g.&nbsp;LMNB+rdk5 and RF+mfp2, where the model built with the longer fingerprint is &gt;10% better. Exceptions to the general rule, which it could be interesting to investigate more deeply, include: - The <code>rdk5</code> and <code>hashap</code> fingerprints: for this use case it looks like the additional information in the longer fingerprints tends to degrade performance. The “simpler” learning algorithms - <code>lr</code> and <code>lmnb</code> - either don’t show this effect or show it less… a strong suggestion that the problem is overfitting. - XGB doesn’t show improved performance for the longer fingerprint with any of the methods.</p>
<p>Note that we’ve only looked at one type of data set here - training on reasonably homogeneous active molecules and then testing with diverse actives - so the results could well be different for models built/tested on things like screening data (where both the training and test sets are chemically diverse).</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:07.046372Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:06.204264Z&quot;}" data-scrolled="true" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdFingerprintGenerator</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-6"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-8"><span class="bu" style="color: null;">print</span>(time.asctime())</span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;">%</span>pylab inline</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.09.1
Mon Dec 19 20:00:39 2022
%pylab is deprecated, use %matplotlib inline and import the required libraries.
Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
</div>
</section>
<section id="datasets-ii-results-from-the-benchmarking-platform" class="level1">
<h1>Datasets II results from the benchmarking platform</h1>
<p>Read in the results from running the benchmarking platform:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:17.460575Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:17.125083Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> defaultdict</span>
<span id="cb3-2"><span class="im" style="color: #00769E;">import</span> glob</span>
<span id="cb3-3"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb3-4"><span class="im" style="color: #00769E;">import</span> gzip</span>
<span id="cb3-5">alld <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb3-6"><span class="cf" style="color: #003B4F;">for</span> fn <span class="kw" style="color: #003B4F;">in</span> glob.glob(<span class="st" style="color: #20794D;">'../data/bp_results/dsII_validation/ChEMBL/*.pkl.gz'</span>):</span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(fn,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb3-8">        d <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb3-9">    fn <span class="op" style="color: #5E5E5E;">=</span> fn.split(<span class="st" style="color: #20794D;">'_'</span>)[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>].split(<span class="st" style="color: #20794D;">'.'</span>)[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb3-10">    alld[fn]<span class="op" style="color: #5E5E5E;">=</span>d</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:18.031428Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:18.016760Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">alld.keys()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>dict_keys(['100', '10188', '10193', '10260', '10280', '10434', '107', '108', '10980', '11140', '11365', '114', '11489', '11534', '11575', '11631', '121', '12209', '12252', '126', '12952', '130', '13001', '15', '165', '17045', '19905', '25', '259', '43', '51', '61', '65', '72', '87', '90', '93'])</code></pre>
</div>
</div>
<p>These are the evaluation metrics we’ll use: AUC, EF1, EF5, and AUPRC (area onder the precision-recall curve). Note that you have to be careful comparing EF1, EF5, and AUPRC across data sets with different active/inactive ratios, but that doesn’t affect us here since we only compare values within a given data set.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:19.903016Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:19.901303Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">metrics <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'AUC'</span>,<span class="st" style="color: #20794D;">'AUPRC'</span>,<span class="st" style="color: #20794D;">'EF1'</span>,<span class="st" style="color: #20794D;">'EF5'</span>,)</span></code></pre></div>
</div>
</section>
<section id="detailed-view-of-the-results-for-a-particular-method" class="level1">
<h1>Detailed view of the results for a particular method</h1>
<p>Start by reproducing some of the plots we used last time, though we’ll quickly switch to a view which is better suited to doing comparisons.</p>
<p>We’ll just show the plots for logistic regression:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:22.534613Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:22.489868Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">means<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">dict</span>)</span>
<span id="cb7-2">medians<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">dict</span>)</span>
<span id="cb7-3">delts<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">dict</span>)</span>
<span id="cb7-4">fdelts<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">dict</span>)</span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;">for</span> assay,d <span class="kw" style="color: #003B4F;">in</span> alld.items():</span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;">for</span> metric <span class="kw" style="color: #003B4F;">in</span> metrics:</span>
<span id="cb7-7">        v1 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][<span class="st" style="color: #20794D;">'lr_mfp2'</span>]])</span>
<span id="cb7-8">        v2 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][<span class="st" style="color: #20794D;">'lr_lmfp2'</span>]])</span>
<span id="cb7-9">        delt<span class="op" style="color: #5E5E5E;">=</span>v2<span class="op" style="color: #5E5E5E;">-</span>v1</span>
<span id="cb7-10">        means[assay][metric] <span class="op" style="color: #5E5E5E;">=</span> (np.mean(v1),np.mean(v2))</span>
<span id="cb7-11">        medians[assay][metric] <span class="op" style="color: #5E5E5E;">=</span> (np.median(v1),np.median(v2))</span>
<span id="cb7-12">        delts[assay][metric] <span class="op" style="color: #5E5E5E;">=</span> (np.mean(delt),np.<span class="bu" style="color: null;">min</span>(delt),np.<span class="bu" style="color: null;">max</span>(delt))</span>
<span id="cb7-13">        fdelts[assay][metric] <span class="op" style="color: #5E5E5E;">=</span> delt</span>
<span id="cb7-14">     </span>
<span id="cb7-15">                  </span></code></pre></div>
</div>
<p>Look at the mean values of the metrics across the different targets.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:27.416281Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:26.682234Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">figsize(<span class="dv" style="color: #AD0000;">16</span>,<span class="dv" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">*</span><span class="bu" style="color: null;">len</span>(metrics))</span>
<span id="cb8-2"><span class="cf" style="color: #003B4F;">for</span> i,metric <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(metrics):</span>
<span id="cb8-3">    subplot(<span class="bu" style="color: null;">len</span>(metrics),<span class="dv" style="color: #AD0000;">1</span>,i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb8-4">    plot([x[metric][<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> medians.values()],c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'b'</span>,label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'mfp2'</span>)</span>
<span id="cb8-5">    plot([x[metric][<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> medians.values()],c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'r'</span>,label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'lmfp2'</span>)</span>
<span id="cb8-6">    title(metric)</span>
<span id="cb8-7">    legend()</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>With LR, at least, the longer fingerprints (red lines) are, on average, slightly better with each metric.</p>
<p>Using the means here, which are calculated across multiple datasets (papers) per target isn’t the most accurate way to view the results, it’s more accurate to look at the deltas.</p>
<p>The same behavior is observed in the deltas, though the min delta curves do show that there are times that the longer fingerprints are sligthly worse:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:30.663800Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:29.658546Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">figsize(<span class="dv" style="color: #AD0000;">16</span>,<span class="dv" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">*</span><span class="bu" style="color: null;">len</span>(metrics))</span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;">for</span> i,metric <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(metrics):</span>
<span id="cb9-3">    subplot(<span class="bu" style="color: null;">len</span>(metrics),<span class="dv" style="color: #AD0000;">1</span>,i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb9-4">    plot([x[metric][<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> delts.values()],c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'b'</span>)</span>
<span id="cb9-5">    plot([x[metric][<span class="dv" style="color: #AD0000;">1</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> delts.values()],c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'r'</span>)</span>
<span id="cb9-6">    plot([x[metric][<span class="dv" style="color: #AD0000;">2</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> delts.values()],c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'r'</span>)</span>
<span id="cb9-7">    plot((<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">36</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">0</span>),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb9-8">    title(<span class="ss" style="color: #20794D;">f'$\Delta$ </span><span class="sc" style="color: #5E5E5E;">{</span>metric<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb9-9"></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>That’s a bit clearer in a box plot for the deltas:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-19T03:39:34.974533Z&quot;,&quot;start_time&quot;:&quot;2022-12-19T03:39:33.474584Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">figsize(<span class="dv" style="color: #AD0000;">16</span>,<span class="dv" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">*</span><span class="bu" style="color: null;">len</span>(metrics))</span>
<span id="cb10-2"><span class="cf" style="color: #003B4F;">for</span> i,metric <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(metrics):</span>
<span id="cb10-3">    subplot(<span class="bu" style="color: null;">len</span>(metrics),<span class="dv" style="color: #AD0000;">1</span>,i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-4">    _<span class="op" style="color: #5E5E5E;">=</span>boxplot([x[metric] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> fdelts.values()])</span>
<span id="cb10-5">    _<span class="op" style="color: #5E5E5E;">=</span>plot((<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">38</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">0</span>),c<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'k'</span>,linestyle<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'--'</span>)</span>
<span id="cb10-6">    title(<span class="ss" style="color: #20794D;">f'$\Delta$ </span><span class="sc" style="color: #5E5E5E;">{</span>metric<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="more-direct-comparisons" class="level1">
<h1>More direct comparisons</h1>
<p>Rather than doing a bunch more of the box and whisker plots showing the results broken down by dataset, let’s look at direct comparisions of the results for the various learning methods. We can do this because we know what all the method+fp combinations were trained/tested using the same data splits.</p>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;">def</span> do_scatter_plots(k1,k2,alld<span class="op" style="color: #5E5E5E;">=</span>alld,metrics<span class="op" style="color: #5E5E5E;">=</span>metrics):</span>
<span id="cb11-2">    delts <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb11-3">    v1s <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb11-4">    v2s <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb11-5"></span>
<span id="cb11-6">    <span class="cf" style="color: #003B4F;">for</span> assay,d <span class="kw" style="color: #003B4F;">in</span> alld.items():</span>
<span id="cb11-7">        <span class="cf" style="color: #003B4F;">for</span> metric <span class="kw" style="color: #003B4F;">in</span> metrics:</span>
<span id="cb11-8">            v1 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][k1]])</span>
<span id="cb11-9">            v2 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][k2]])</span>
<span id="cb11-10">            delt<span class="op" style="color: #5E5E5E;">=</span>v2<span class="op" style="color: #5E5E5E;">-</span>v1</span>
<span id="cb11-11">            delts[metric].extend(delt)</span>
<span id="cb11-12">            v1s[metric].extend(v1)</span>
<span id="cb11-13">            v2s[metric].extend(v2)</span>
<span id="cb11-14"></span>
<span id="cb11-15">    nmetrics <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(metrics)        </span>
<span id="cb11-16">    nrows <span class="op" style="color: #5E5E5E;">=</span> nmetrics<span class="op" style="color: #5E5E5E;">//</span><span class="dv" style="color: #AD0000;">2</span> <span class="op" style="color: #5E5E5E;">+</span> nmetrics<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb11-17">    ncols <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb11-18">    figsize(ncols<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">4</span>,nrows<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb11-19">    <span class="cf" style="color: #003B4F;">for</span> i,metric <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(metrics):</span>
<span id="cb11-20">        subplot(nrows,ncols,i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb11-21">        scatter(v1s[metric],v2s[metric],marker<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'.'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-22">        xmin,xmax <span class="op" style="color: #5E5E5E;">=</span> xlim()</span>
<span id="cb11-23">        ymin,ymax <span class="op" style="color: #5E5E5E;">=</span> ylim()</span>
<span id="cb11-24">        vmin <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(xmin,ymin)</span>
<span id="cb11-25">        vmax <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(xmax,ymax)</span>
<span id="cb11-26"></span>
<span id="cb11-27">        plot((vmin,vmax),(vmin,vmax),<span class="st" style="color: #20794D;">'k-'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-28">        xlabel(k1)</span>
<span id="cb11-29">        ylabel(k2)</span>
<span id="cb11-30">        tight_layout()</span>
<span id="cb11-31">        title(metric)<span class="op" style="color: #5E5E5E;">;</span>    </span></code></pre></div>
</div>
<section id="logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression">Logistic regression</h2>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lr_mfp2'</span>,<span class="st" style="color: #20794D;">'lr_lmfp2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="balanced-random-forests" class="level2">
<h2 class="anchored" data-anchor-id="balanced-random-forests">Balanced random forests</h2>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">do_scatter_plots(<span class="st" style="color: #20794D;">'brf_mfp2'</span>,<span class="st" style="color: #20794D;">'brf_lmfp2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="random-forests" class="level2">
<h2 class="anchored" data-anchor-id="random-forests">Random forests</h2>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">do_scatter_plots(<span class="st" style="color: #20794D;">'rf_mfp2'</span>,<span class="st" style="color: #20794D;">'rf_lmfp2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="xgboost" class="level2">
<h2 class="anchored" data-anchor-id="xgboost">XGBoost</h2>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">do_scatter_plots(<span class="st" style="color: #20794D;">'xgb_mfp2'</span>,<span class="st" style="color: #20794D;">'xgb_lmfp2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="laplacian-naive-bayes" class="level2">
<h2 class="anchored" data-anchor-id="laplacian-naive-bayes">Laplacian Naive Bayes</h2>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lmnb_mfp2_2'</span>,<span class="st" style="color: #20794D;">'lmnb_lmfp2_2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="naive-bayes" class="level2">
<h2 class="anchored" data-anchor-id="naive-bayes">Naive Bayes</h2>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">do_scatter_plots(<span class="st" style="color: #20794D;">'nb_mfp2'</span>,<span class="st" style="color: #20794D;">'nb_lmfp2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Something isn’t right with the NB results… I need to look into that</p>
</section>
</section>
<section id="look-at-morgan-3" class="level1">
<h1>Look at morgan 3</h1>
<p>This increases the number of set bits</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lr_mfp3'</span>,<span class="st" style="color: #20794D;">'lr_lmfp3'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">do_scatter_plots(<span class="st" style="color: #20794D;">'brf_mfp3'</span>,<span class="st" style="color: #20794D;">'brf_lmfp3'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">do_scatter_plots(<span class="st" style="color: #20794D;">'rf_mfp3'</span>,<span class="st" style="color: #20794D;">'rf_lmfp3'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">do_scatter_plots(<span class="st" style="color: #20794D;">'xgb_mfp3'</span>,<span class="st" style="color: #20794D;">'xgb_lmfp3'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lmnb_mfp3_2'</span>,<span class="st" style="color: #20794D;">'lmnb_lmfp3_2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="look-at-rdk5" class="level1">
<h1>Look at RDK5</h1>
<p>Now we really have a lot of set bits</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lr_rdk5'</span>,<span class="st" style="color: #20794D;">'lr_lrdk5'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">do_scatter_plots(<span class="st" style="color: #20794D;">'brf_rdk5'</span>,<span class="st" style="color: #20794D;">'brf_lrdk5'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">do_scatter_plots(<span class="st" style="color: #20794D;">'rf_rdk5'</span>,<span class="st" style="color: #20794D;">'rf_lrdk5'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">do_scatter_plots(<span class="st" style="color: #20794D;">'xgb_rdk5'</span>,<span class="st" style="color: #20794D;">'xgb_lrdk5'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">do_scatter_plots(<span class="st" style="color: #20794D;">'lmnb_rdk5_2'</span>,<span class="st" style="color: #20794D;">'lmnb_lrdk5_2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Again, some of those enrichment plots look suspicious and should be looked into</p>
</section>
<section id="are-there-statistically-significant-differences" class="level1">
<h1>Are there statistically significant differences?</h1>
<p>Use the Wilcoxon signed-rank test to detect whether or not the differences we saw in the plots are statistically significant. We’ll do this for every method and fingerprint and make a table.</p>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="im" style="color: #00769E;">from</span> scipy <span class="im" style="color: #00769E;">import</span> stats</span></code></pre></div>
</div>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="kw" style="color: #003B4F;">def</span> do_significance(alg,fp,tableOutput<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,showHeader<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,pthresh<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">0.001</span>,alld<span class="op" style="color: #5E5E5E;">=</span>alld,metrics<span class="op" style="color: #5E5E5E;">=</span>metrics):</span>
<span id="cb29-2">    k1 <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>alg<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_</span><span class="sc" style="color: #5E5E5E;">{</span>fp<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb29-3">    k2 <span class="op" style="color: #5E5E5E;">=</span> <span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>alg<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">_l</span><span class="sc" style="color: #5E5E5E;">{</span>fp<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span></span>
<span id="cb29-4">    <span class="cf" style="color: #003B4F;">if</span> alg <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'lmnb'</span>:</span>
<span id="cb29-5">        k1 <span class="op" style="color: #5E5E5E;">+=</span> <span class="st" style="color: #20794D;">'_2'</span></span>
<span id="cb29-6">        k2 <span class="op" style="color: #5E5E5E;">+=</span> <span class="st" style="color: #20794D;">'_2'</span></span>
<span id="cb29-7"></span>
<span id="cb29-8">    </span>
<span id="cb29-9">    v1s <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb29-10">    v2s <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb29-11">    delts <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb29-12">    pct_delts <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb29-13"></span>
<span id="cb29-14">    <span class="cf" style="color: #003B4F;">if</span> tableOutput <span class="kw" style="color: #003B4F;">and</span> showHeader:</span>
<span id="cb29-15">        row <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'alg'</span>,<span class="st" style="color: #20794D;">'fp'</span>,<span class="st" style="color: #20794D;">'metric'</span>,<span class="st" style="color: #20794D;">'result'</span>,<span class="st" style="color: #20794D;">'P'</span>,<span class="st" style="color: #20794D;">'delt'</span>,<span class="st" style="color: #20794D;">'pct_delt'</span>)</span>
<span id="cb29-16">        divider <span class="op" style="color: #5E5E5E;">=</span> [<span class="st" style="color: #20794D;">'-'</span><span class="op" style="color: #5E5E5E;">*</span><span class="bu" style="color: null;">len</span>(k) <span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> row]</span>
<span id="cb29-17">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'| '</span><span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' | '</span>.join(row)<span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' |'</span>)</span>
<span id="cb29-18">        <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'| '</span><span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' | '</span>.join(divider)<span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' |'</span>)</span>
<span id="cb29-19">        </span>
<span id="cb29-20">        </span>
<span id="cb29-21">    <span class="cf" style="color: #003B4F;">for</span> assay,d <span class="kw" style="color: #003B4F;">in</span> alld.items():</span>
<span id="cb29-22">        <span class="cf" style="color: #003B4F;">for</span> metric <span class="kw" style="color: #003B4F;">in</span> metrics:</span>
<span id="cb29-23">            v1 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][k1]])</span>
<span id="cb29-24">            v2 <span class="op" style="color: #5E5E5E;">=</span> np.array([x[<span class="dv" style="color: #AD0000;">0</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d[metric][k2]])</span>
<span id="cb29-25">            v1s[metric].extend(v1)</span>
<span id="cb29-26">            v2s[metric].extend(v2)</span>
<span id="cb29-27">            delt <span class="op" style="color: #5E5E5E;">=</span> v1<span class="op" style="color: #5E5E5E;">-</span>v2</span>
<span id="cb29-28">            delts[metric].extend(delt)</span>
<span id="cb29-29">            pct_delts[metric].extend(delt<span class="op" style="color: #5E5E5E;">/</span>v1)</span>
<span id="cb29-30">    <span class="cf" style="color: #003B4F;">for</span> metric <span class="kw" style="color: #003B4F;">in</span> metrics:</span>
<span id="cb29-31">        w2s <span class="op" style="color: #5E5E5E;">=</span> stats.wilcoxon(v1s[metric],v2s[metric],alternative<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'two-sided'</span>).pvalue</span>
<span id="cb29-32">        wlt <span class="op" style="color: #5E5E5E;">=</span> stats.wilcoxon(v1s[metric],v2s[metric],alternative<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'less'</span>).pvalue</span>
<span id="cb29-33">        wgt <span class="op" style="color: #5E5E5E;">=</span> stats.wilcoxon(v1s[metric],v2s[metric],alternative<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'greater'</span>).pvalue</span>
<span id="cb29-34">        result <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'same'</span></span>
<span id="cb29-35">        which <span class="op" style="color: #5E5E5E;">=</span> w2s</span>
<span id="cb29-36">        <span class="cf" style="color: #003B4F;">if</span> w2s <span class="op" style="color: #5E5E5E;">&lt;</span> pthresh:</span>
<span id="cb29-37">            <span class="cf" style="color: #003B4F;">if</span> wlt <span class="op" style="color: #5E5E5E;">&lt;</span> pthresh:</span>
<span id="cb29-38">                result <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'lt'</span></span>
<span id="cb29-39">                which <span class="op" style="color: #5E5E5E;">=</span> wlt</span>
<span id="cb29-40">            <span class="cf" style="color: #003B4F;">elif</span> wgt <span class="op" style="color: #5E5E5E;">&lt;</span> pthresh:</span>
<span id="cb29-41">                result <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'gt'</span></span>
<span id="cb29-42">                which <span class="op" style="color: #5E5E5E;">=</span> wgt</span>
<span id="cb29-43">        row <span class="op" style="color: #5E5E5E;">=</span> (alg,fp,metric,result,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>which<span class="sc" style="color: #5E5E5E;">:.3g}</span><span class="ss" style="color: #20794D;">'</span>,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>np<span class="sc" style="color: #5E5E5E;">.</span>median(delts[metric])<span class="sc" style="color: #5E5E5E;">:.2g}</span><span class="ss" style="color: #20794D;">'</span>,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>np<span class="sc" style="color: #5E5E5E;">.</span>median(pct_delts[metric])<span class="sc" style="color: #5E5E5E;">:.3g}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb29-44">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> tableOutput:</span>
<span id="cb29-45">            <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">' '</span>.join(row))</span>
<span id="cb29-46">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb29-47">            <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'| '</span><span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' | '</span>.join(row)<span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">' |'</span>)</span>
<span id="cb29-48"></span>
<span id="cb29-49"><span class="co" style="color: #5E5E5E;"># we skip 'nb' here since there's clearly something bogus with the results</span></span>
<span id="cb29-50"><span class="cf" style="color: #003B4F;">for</span> metric <span class="kw" style="color: #003B4F;">in</span> metrics:</span>
<span id="cb29-51">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'## </span><span class="sc" style="color: #5E5E5E;">{</span>metric<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb29-52">    <span class="cf" style="color: #003B4F;">for</span> i,alg <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>((<span class="st" style="color: #20794D;">'lr'</span>,<span class="st" style="color: #20794D;">'lmnb'</span>,<span class="st" style="color: #20794D;">'rf'</span>,<span class="st" style="color: #20794D;">'brf'</span>,<span class="st" style="color: #20794D;">'xgb'</span>)):</span>
<span id="cb29-53">        <span class="cf" style="color: #003B4F;">for</span> j,fp <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>((<span class="st" style="color: #20794D;">'mfp2'</span>,<span class="st" style="color: #20794D;">'mfp3'</span>,<span class="st" style="color: #20794D;">'rdk5'</span>,<span class="st" style="color: #20794D;">'hashap'</span>,<span class="st" style="color: #20794D;">'hashtt'</span>)):</span>
<span id="cb29-54">            do_significance(alg,fp,tableOutput<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,showHeader<span class="op" style="color: #5E5E5E;">=</span>(<span class="kw" style="color: #003B4F;">not</span> i <span class="op" style="color: #5E5E5E;">+</span> j),metrics<span class="op" style="color: #5E5E5E;">=</span>(metric,))</span>
<span id="cb29-55">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n\n</span><span class="st" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>## AUC
| alg | fp | metric | result | P | delt | pct_delt |
| --- | -- | ------ | ------ | - | ---- | -------- |
| lr | mfp2 | AUC | lt | 8.68e-51 | -0.011 | -0.0142 |
| lr | mfp3 | AUC | lt | 2.6e-64 | -0.019 | -0.0243 |
| lr | rdk5 | AUC | lt | 2.09e-24 | -0.011 | -0.0143 |
| lr | hashap | AUC | lt | 8.77e-37 | -0.026 | -0.0325 |
| lr | hashtt | AUC | lt | 8.02e-54 | -0.022 | -0.0294 |
| lmnb | mfp2 | AUC | lt | 3.2e-104 | -0.042 | -0.0573 |
| lmnb | mfp3 | AUC | lt | 6.05e-107 | -0.077 | -0.109 |
| lmnb | rdk5 | AUC | lt | 4.32e-60 | -0.071 | -0.193 |
| lmnb | hashap | AUC | gt | 1.67e-18 | 0.031 | 0.0494 |
| lmnb | hashtt | AUC | lt | 7.52e-105 | -0.051 | -0.0767 |
| rf | mfp2 | AUC | lt | 1.45e-102 | -0.087 | -0.132 |
| rf | mfp3 | AUC | lt | 2.23e-92 | -0.074 | -0.115 |
| rf | rdk5 | AUC | gt | 4.27e-11 | 0.015 | 0.0212 |
| rf | hashap | AUC | same | 0.00227 | 0.0036 | 0.00503 |
| rf | hashtt | AUC | lt | 1.25e-63 | -0.046 | -0.0677 |
| brf | mfp2 | AUC | lt | 6.61e-37 | -0.024 | -0.0304 |
| brf | mfp3 | AUC | lt | 9.25e-40 | -0.031 | -0.04 |
| brf | rdk5 | AUC | gt | 2.77e-09 | 0.01 | 0.0131 |
| brf | hashap | AUC | gt | 5.32e-07 | 0.011 | 0.0152 |
| brf | hashtt | AUC | lt | 8.45e-29 | -0.027 | -0.0362 |
| xgb | mfp2 | AUC | same | 0.831 | 0.00097 | 0.00109 |
| xgb | mfp3 | AUC | same | 0.00162 | -0.0051 | -0.00719 |
| xgb | rdk5 | AUC | gt | 1.36e-07 | 0.012 | 0.0157 |
| xgb | hashap | AUC | gt | 1.49e-20 | 0.027 | 0.0358 |
| xgb | hashtt | AUC | same | 0.0265 | -0.0043 | -0.00645 |



## AUPRC
| alg | fp | metric | result | P | delt | pct_delt |
| --- | -- | ------ | ------ | - | ---- | -------- |
| lr | mfp2 | AUPRC | lt | 9.58e-55 | -0.0079 | -0.0535 |
| lr | mfp3 | AUPRC | lt | 1.72e-71 | -0.011 | -0.0758 |
| lr | rdk5 | AUPRC | lt | 2.93e-38 | -0.0042 | -0.0508 |
| lr | hashap | AUPRC | lt | 1.11e-13 | -0.01 | -0.0857 |
| lr | hashtt | AUPRC | lt | 2.33e-60 | -0.0091 | -0.102 |
| lmnb | mfp2 | AUPRC | lt | 9.34e-31 | -0.009 | -0.101 |
| lmnb | mfp3 | AUPRC | lt | 5.43e-27 | -0.0099 | -0.135 |
| lmnb | rdk5 | AUPRC | gt | 0.000113 | 0.00025 | 0.00953 |
| lmnb | hashap | AUPRC | lt | 1.02e-18 | -0.0052 | -0.114 |
| lmnb | hashtt | AUPRC | lt | 2.39e-17 | -0.0039 | -0.0839 |
| rf | mfp2 | AUPRC | lt | 3.24e-46 | -0.017 | -0.174 |
| rf | mfp3 | AUPRC | lt | 3.09e-59 | -0.019 | -0.211 |
| rf | rdk5 | AUPRC | same | 0.41 | 1.1e-05 | 0.000428 |
| rf | hashap | AUPRC | gt | 2.54e-05 | 0.011 | 0.1 |
| rf | hashtt | AUPRC | lt | 8.39e-42 | -0.011 | -0.14 |
| brf | mfp2 | AUPRC | lt | 1.41e-22 | -0.0086 | -0.0915 |
| brf | mfp3 | AUPRC | lt | 4.72e-35 | -0.012 | -0.119 |
| brf | rdk5 | AUPRC | same | 0.455 | -0.00027 | -0.00484 |
| brf | hashap | AUPRC | gt | 0.00023 | 0.0058 | 0.0642 |
| brf | hashtt | AUPRC | lt | 3.38e-26 | -0.0075 | -0.121 |
| xgb | mfp2 | AUPRC | lt | 1.34e-12 | -0.0044 | -0.0558 |
| xgb | mfp3 | AUPRC | lt | 1.74e-25 | -0.0088 | -0.113 |
| xgb | rdk5 | AUPRC | lt | 1.32e-08 | -0.0034 | -0.0545 |
| xgb | hashap | AUPRC | same | 0.221 | 0.008 | 0.0872 |
| xgb | hashtt | AUPRC | lt | 1.07e-13 | -0.0044 | -0.0792 |



## EF1
| alg | fp | metric | result | P | delt | pct_delt |
| --- | -- | ------ | ------ | - | ---- | -------- |
| lr | mfp2 | EF1 | lt | 4.4e-23 | -1 | -0.0357 |
| lr | mfp3 | EF1 | lt | 1.24e-36 | -1 | -0.0625 |
| lr | rdk5 | EF1 | lt | 7.74e-16 | 0 | 0 |
| lr | hashap | EF1 | lt | 3.05e-06 | -1 | -0.0556 |
| lr | hashtt | EF1 | lt | 5.74e-36 | -1 | -0.0833 |
| lmnb | mfp2 | EF1 | lt | 2.32e-74 | -3 | -0.167 |
| lmnb | mfp3 | EF1 | lt | 9.4e-69 | -3 | -0.25 |
| lmnb | rdk5 | EF1 | gt | 1.97e-58 | 4 | nan |
| lmnb | hashap | EF1 | same | 0.147 | -1 | nan |
| lmnb | hashtt | EF1 | lt | 5.42e-48 | -2 | -0.2 |
| rf | mfp2 | EF1 | lt | 4.12e-11 | -1 | -0.0706 |
| rf | mfp3 | EF1 | lt | 1.94e-14 | -1 | -0.0833 |
| rf | rdk5 | EF1 | same | 0.0619 | 0 | 0 |
| rf | hashap | EF1 | gt | 3.15e-06 | 2 | 0.1 |
| rf | hashtt | EF1 | lt | 1.33e-09 | -1 | -0.0476 |
| brf | mfp2 | EF1 | lt | 2.84e-09 | -1 | -0.0421 |
| brf | mfp3 | EF1 | lt | 4.46e-13 | -1 | -0.0769 |
| brf | rdk5 | EF1 | same | 0.301 | 0 | nan |
| brf | hashap | EF1 | gt | 9.93e-09 | 1 | 0.0779 |
| brf | hashtt | EF1 | lt | 7.97e-14 | -1 | -0.0871 |
| xgb | mfp2 | EF1 | lt | 1.06e-14 | -1 | -0.075 |
| xgb | mfp3 | EF1 | lt | 2.22e-17 | -1 | -0.0625 |
| xgb | rdk5 | EF1 | lt | 4.54e-09 | -1 | nan |
| xgb | hashap | EF1 | same | 0.335 | 1 | 0.0769 |
| xgb | hashtt | EF1 | lt | 6.27e-09 | 0 | 0 |



## EF5
| alg | fp | metric | result | P | delt | pct_delt |
| --- | -- | ------ | ------ | - | ---- | -------- |
| lr | mfp2 | EF5 | lt | 4.32e-23 | -0.2 | -0.0357 |
| lr | mfp3 | EF5 | lt | 3.64e-38 | -0.4 | -0.0559 |
| lr | rdk5 | EF5 | lt | 8.96e-26 | -0.2 | -0.0469 |</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\glandrum\AppData\Local\Temp\ipykernel_9592\1757963699.py:29: RuntimeWarning: invalid value encountered in divide
  pct_delts[metric].extend(delt/v1)
C:\Users\glandrum\AppData\Local\Temp\ipykernel_9592\1757963699.py:29: RuntimeWarning: divide by zero encountered in divide
  pct_delts[metric].extend(delt/v1)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>| lr | hashap | EF5 | lt | 1.42e-08 | -0.2 | -0.0385 |
| lr | hashtt | EF5 | lt | 6.58e-38 | -0.4 | -0.0769 |
| lmnb | mfp2 | EF5 | lt | 1.44e-82 | -1 | -0.154 |
| lmnb | mfp3 | EF5 | lt | 2.57e-92 | -1.4 | -0.264 |
| lmnb | rdk5 | EF5 | same | 0.725 | -0.4 | nan |
| lmnb | hashap | EF5 | lt | 1.47e-64 | -1 | -0.217 |
| lmnb | hashtt | EF5 | lt | 6.85e-73 | -0.81 | -0.185 |
| rf | mfp2 | EF5 | lt | 3.72e-39 | -0.61 | -0.118 |
| rf | mfp3 | EF5 | lt | 3.14e-26 | -0.4 | -0.0948 |
| rf | rdk5 | EF5 | same | 0.988 | 0 | 0 |
| rf | hashap | EF5 | gt | 6.9e-14 | 0.61 | 0.0769 |
| rf | hashtt | EF5 | lt | 2.61e-19 | -0.4 | -0.0811 |
| brf | mfp2 | EF5 | lt | 4.02e-16 | -0.4 | -0.0476 |
| brf | mfp3 | EF5 | lt | 8.91e-25 | -0.6 | -0.0854 |
| brf | rdk5 | EF5 | same | 0.319 | 0 | 0 |
| brf | hashap | EF5 | gt | 9.01e-07 | 0.4 | 0.0674 |
| brf | hashtt | EF5 | lt | 1.18e-22 | -0.4 | -0.101 |
| xgb | mfp2 | EF5 | lt | 3.14e-05 | -0.2 | -0.0308 |
| xgb | mfp3 | EF5 | lt | 4.57e-13 | -0.4 | -0.0797 |
| xgb | rdk5 | EF5 | same | 0.00432 | -0.2 | -0.0354 |
| xgb | hashap | EF5 | gt | 1.24e-09 | 0.61 | 0.1 |
| xgb | hashtt | EF5 | lt | 0.000141 | -0.2 | -0.0199 |


</code></pre>
</div>
</div>
<p>And now display that:</p>
<section id="auc" class="level2">
<h2 class="anchored" data-anchor-id="auc">AUC</h2>
<table class="table">
<thead>
<tr class="header">
<th>alg</th>
<th>fp</th>
<th>metric</th>
<th>result</th>
<th>P</th>
<th>delt</th>
<th>pct_delt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lr</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>8.68e-51</td>
<td>-0.011</td>
<td>-0.0142</td>
</tr>
<tr class="even">
<td>lr</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>2.6e-64</td>
<td>-0.019</td>
<td>-0.0243</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>rdk5</td>
<td>AUC</td>
<td>lt</td>
<td>2.09e-24</td>
<td>-0.011</td>
<td>-0.0143</td>
</tr>
<tr class="even">
<td>lr</td>
<td>hashap</td>
<td>AUC</td>
<td>lt</td>
<td>8.77e-37</td>
<td>-0.026</td>
<td>-0.0325</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>8.02e-54</td>
<td>-0.022</td>
<td>-0.0294</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>3.2e-104</td>
<td>-0.042</td>
<td>-0.0573</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>6.05e-107</td>
<td>-0.077</td>
<td>-0.109</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>rdk5</td>
<td>AUC</td>
<td>lt</td>
<td>4.32e-60</td>
<td>-0.071</td>
<td>-0.193</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>1.67e-18</td>
<td>0.031</td>
<td>0.0494</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>7.52e-105</td>
<td>-0.051</td>
<td>-0.0767</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>1.45e-102</td>
<td>-0.087</td>
<td>-0.132</td>
</tr>
<tr class="even">
<td>rf</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>2.23e-92</td>
<td>-0.074</td>
<td>-0.115</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>4.27e-11</td>
<td>0.015</td>
<td>0.0212</td>
</tr>
<tr class="even">
<td>rf</td>
<td>hashap</td>
<td>AUC</td>
<td>same</td>
<td>0.00227</td>
<td>0.0036</td>
<td>0.00503</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>1.25e-63</td>
<td>-0.046</td>
<td>-0.0677</td>
</tr>
<tr class="even">
<td>brf</td>
<td>mfp2</td>
<td>AUC</td>
<td>lt</td>
<td>6.61e-37</td>
<td>-0.024</td>
<td>-0.0304</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>mfp3</td>
<td>AUC</td>
<td>lt</td>
<td>9.25e-40</td>
<td>-0.031</td>
<td>-0.04</td>
</tr>
<tr class="even">
<td>brf</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>2.77e-09</td>
<td>0.01</td>
<td>0.0131</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>5.32e-07</td>
<td>0.011</td>
<td>0.0152</td>
</tr>
<tr class="even">
<td>brf</td>
<td>hashtt</td>
<td>AUC</td>
<td>lt</td>
<td>8.45e-29</td>
<td>-0.027</td>
<td>-0.0362</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>mfp2</td>
<td>AUC</td>
<td>same</td>
<td>0.831</td>
<td>0.00097</td>
<td>0.00109</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>mfp3</td>
<td>AUC</td>
<td>same</td>
<td>0.00162</td>
<td>-0.0051</td>
<td>-0.00719</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>rdk5</td>
<td>AUC</td>
<td>gt</td>
<td>1.36e-07</td>
<td>0.012</td>
<td>0.0157</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>hashap</td>
<td>AUC</td>
<td>gt</td>
<td>1.49e-20</td>
<td>0.027</td>
<td>0.0358</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>hashtt</td>
<td>AUC</td>
<td>same</td>
<td>0.0265</td>
<td>-0.0043</td>
<td>-0.00645</td>
</tr>
</tbody>
</table>
</section>
<section id="auprc" class="level2">
<h2 class="anchored" data-anchor-id="auprc">AUPRC</h2>
<table class="table">
<thead>
<tr class="header">
<th>alg</th>
<th>fp</th>
<th>metric</th>
<th>result</th>
<th>P</th>
<th>delt</th>
<th>pct_delt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lr</td>
<td>mfp2</td>
<td>AUPRC</td>
<td>lt</td>
<td>9.58e-55</td>
<td>-0.0079</td>
<td>-0.0535</td>
</tr>
<tr class="even">
<td>lr</td>
<td>mfp3</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.72e-71</td>
<td>-0.011</td>
<td>-0.0758</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>rdk5</td>
<td>AUPRC</td>
<td>lt</td>
<td>2.93e-38</td>
<td>-0.0042</td>
<td>-0.0508</td>
</tr>
<tr class="even">
<td>lr</td>
<td>hashap</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.11e-13</td>
<td>-0.01</td>
<td>-0.0857</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>hashtt</td>
<td>AUPRC</td>
<td>lt</td>
<td>2.33e-60</td>
<td>-0.0091</td>
<td>-0.102</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>mfp2</td>
<td>AUPRC</td>
<td>lt</td>
<td>9.34e-31</td>
<td>-0.009</td>
<td>-0.101</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>mfp3</td>
<td>AUPRC</td>
<td>lt</td>
<td>5.43e-27</td>
<td>-0.0099</td>
<td>-0.135</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>rdk5</td>
<td>AUPRC</td>
<td>gt</td>
<td>0.000113</td>
<td>0.00025</td>
<td>0.00953</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>hashap</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.02e-18</td>
<td>-0.0052</td>
<td>-0.114</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>hashtt</td>
<td>AUPRC</td>
<td>lt</td>
<td>2.39e-17</td>
<td>-0.0039</td>
<td>-0.0839</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>mfp2</td>
<td>AUPRC</td>
<td>lt</td>
<td>3.24e-46</td>
<td>-0.017</td>
<td>-0.174</td>
</tr>
<tr class="even">
<td>rf</td>
<td>mfp3</td>
<td>AUPRC</td>
<td>lt</td>
<td>3.09e-59</td>
<td>-0.019</td>
<td>-0.211</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>rdk5</td>
<td>AUPRC</td>
<td>same</td>
<td>0.41</td>
<td>1.1e-05</td>
<td>0.000428</td>
</tr>
<tr class="even">
<td>rf</td>
<td>hashap</td>
<td>AUPRC</td>
<td>gt</td>
<td>2.54e-05</td>
<td>0.011</td>
<td>0.1</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>hashtt</td>
<td>AUPRC</td>
<td>lt</td>
<td>8.39e-42</td>
<td>-0.011</td>
<td>-0.14</td>
</tr>
<tr class="even">
<td>brf</td>
<td>mfp2</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.41e-22</td>
<td>-0.0086</td>
<td>-0.0915</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>mfp3</td>
<td>AUPRC</td>
<td>lt</td>
<td>4.72e-35</td>
<td>-0.012</td>
<td>-0.119</td>
</tr>
<tr class="even">
<td>brf</td>
<td>rdk5</td>
<td>AUPRC</td>
<td>same</td>
<td>0.455</td>
<td>-0.00027</td>
<td>-0.00484</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>hashap</td>
<td>AUPRC</td>
<td>gt</td>
<td>0.00023</td>
<td>0.0058</td>
<td>0.0642</td>
</tr>
<tr class="even">
<td>brf</td>
<td>hashtt</td>
<td>AUPRC</td>
<td>lt</td>
<td>3.38e-26</td>
<td>-0.0075</td>
<td>-0.121</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>mfp2</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.34e-12</td>
<td>-0.0044</td>
<td>-0.0558</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>mfp3</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.74e-25</td>
<td>-0.0088</td>
<td>-0.113</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>rdk5</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.32e-08</td>
<td>-0.0034</td>
<td>-0.0545</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>hashap</td>
<td>AUPRC</td>
<td>same</td>
<td>0.221</td>
<td>0.008</td>
<td>0.0872</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>hashtt</td>
<td>AUPRC</td>
<td>lt</td>
<td>1.07e-13</td>
<td>-0.0044</td>
<td>-0.0792</td>
</tr>
</tbody>
</table>
</section>
<section id="ef1" class="level2">
<h2 class="anchored" data-anchor-id="ef1">EF1</h2>
<table class="table">
<thead>
<tr class="header">
<th>alg</th>
<th>fp</th>
<th>metric</th>
<th>result</th>
<th>P</th>
<th>delt</th>
<th>pct_delt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lr</td>
<td>mfp2</td>
<td>EF1</td>
<td>lt</td>
<td>4.4e-23</td>
<td>-1</td>
<td>-0.0357</td>
</tr>
<tr class="even">
<td>lr</td>
<td>mfp3</td>
<td>EF1</td>
<td>lt</td>
<td>1.24e-36</td>
<td>-1</td>
<td>-0.0625</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>rdk5</td>
<td>EF1</td>
<td>lt</td>
<td>7.74e-16</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>lr</td>
<td>hashap</td>
<td>EF1</td>
<td>lt</td>
<td>3.05e-06</td>
<td>-1</td>
<td>-0.0556</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>hashtt</td>
<td>EF1</td>
<td>lt</td>
<td>5.74e-36</td>
<td>-1</td>
<td>-0.0833</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>mfp2</td>
<td>EF1</td>
<td>lt</td>
<td>2.32e-74</td>
<td>-3</td>
<td>-0.167</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>mfp3</td>
<td>EF1</td>
<td>lt</td>
<td>9.4e-69</td>
<td>-3</td>
<td>-0.25</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>rdk5</td>
<td>EF1</td>
<td>gt</td>
<td>1.97e-58</td>
<td>4</td>
<td>nan</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>hashap</td>
<td>EF1</td>
<td>same</td>
<td>0.147</td>
<td>-1</td>
<td>nan</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>hashtt</td>
<td>EF1</td>
<td>lt</td>
<td>5.42e-48</td>
<td>-2</td>
<td>-0.2</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>mfp2</td>
<td>EF1</td>
<td>lt</td>
<td>4.12e-11</td>
<td>-1</td>
<td>-0.0706</td>
</tr>
<tr class="even">
<td>rf</td>
<td>mfp3</td>
<td>EF1</td>
<td>lt</td>
<td>1.94e-14</td>
<td>-1</td>
<td>-0.0833</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>rdk5</td>
<td>EF1</td>
<td>same</td>
<td>0.0619</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>rf</td>
<td>hashap</td>
<td>EF1</td>
<td>gt</td>
<td>3.15e-06</td>
<td>2</td>
<td>0.1</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>hashtt</td>
<td>EF1</td>
<td>lt</td>
<td>1.33e-09</td>
<td>-1</td>
<td>-0.0476</td>
</tr>
<tr class="even">
<td>brf</td>
<td>mfp2</td>
<td>EF1</td>
<td>lt</td>
<td>2.84e-09</td>
<td>-1</td>
<td>-0.0421</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>mfp3</td>
<td>EF1</td>
<td>lt</td>
<td>4.46e-13</td>
<td>-1</td>
<td>-0.0769</td>
</tr>
<tr class="even">
<td>brf</td>
<td>rdk5</td>
<td>EF1</td>
<td>same</td>
<td>0.301</td>
<td>0</td>
<td>nan</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>hashap</td>
<td>EF1</td>
<td>gt</td>
<td>9.93e-09</td>
<td>1</td>
<td>0.0779</td>
</tr>
<tr class="even">
<td>brf</td>
<td>hashtt</td>
<td>EF1</td>
<td>lt</td>
<td>7.97e-14</td>
<td>-1</td>
<td>-0.0871</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>mfp2</td>
<td>EF1</td>
<td>lt</td>
<td>1.06e-14</td>
<td>-1</td>
<td>-0.075</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>mfp3</td>
<td>EF1</td>
<td>lt</td>
<td>2.22e-17</td>
<td>-1</td>
<td>-0.0625</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>rdk5</td>
<td>EF1</td>
<td>lt</td>
<td>4.54e-09</td>
<td>-1</td>
<td>nan</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>hashap</td>
<td>EF1</td>
<td>same</td>
<td>0.335</td>
<td>1</td>
<td>0.0769</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>hashtt</td>
<td>EF1</td>
<td>lt</td>
<td>6.27e-09</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</section>
<section id="ef5" class="level2">
<h2 class="anchored" data-anchor-id="ef5">EF5</h2>
<table class="table">
<thead>
<tr class="header">
<th>alg</th>
<th>fp</th>
<th>metric</th>
<th>result</th>
<th>P</th>
<th>delt</th>
<th>pct_delt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lr</td>
<td>mfp2</td>
<td>EF5</td>
<td>lt</td>
<td>4.32e-23</td>
<td>-0.2</td>
<td>-0.0357</td>
</tr>
<tr class="even">
<td>lr</td>
<td>mfp3</td>
<td>EF5</td>
<td>lt</td>
<td>3.64e-38</td>
<td>-0.4</td>
<td>-0.0559</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>rdk5</td>
<td>EF5</td>
<td>lt</td>
<td>8.96e-26</td>
<td>-0.2</td>
<td>-0.0469</td>
</tr>
<tr class="even">
<td>lr</td>
<td>hashap</td>
<td>EF5</td>
<td>lt</td>
<td>1.42e-08</td>
<td>-0.2</td>
<td>-0.0385</td>
</tr>
<tr class="odd">
<td>lr</td>
<td>hashtt</td>
<td>EF5</td>
<td>lt</td>
<td>6.58e-38</td>
<td>-0.4</td>
<td>-0.0769</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>mfp2</td>
<td>EF5</td>
<td>lt</td>
<td>1.44e-82</td>
<td>-1</td>
<td>-0.154</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>mfp3</td>
<td>EF5</td>
<td>lt</td>
<td>2.57e-92</td>
<td>-1.4</td>
<td>-0.264</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>rdk5</td>
<td>EF5</td>
<td>same</td>
<td>0.725</td>
<td>-0.4</td>
<td>nan</td>
</tr>
<tr class="odd">
<td>lmnb</td>
<td>hashap</td>
<td>EF5</td>
<td>lt</td>
<td>1.47e-64</td>
<td>-1</td>
<td>-0.217</td>
</tr>
<tr class="even">
<td>lmnb</td>
<td>hashtt</td>
<td>EF5</td>
<td>lt</td>
<td>6.85e-73</td>
<td>-0.81</td>
<td>-0.185</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>mfp2</td>
<td>EF5</td>
<td>lt</td>
<td>3.72e-39</td>
<td>-0.61</td>
<td>-0.118</td>
</tr>
<tr class="even">
<td>rf</td>
<td>mfp3</td>
<td>EF5</td>
<td>lt</td>
<td>3.14e-26</td>
<td>-0.4</td>
<td>-0.0948</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>rdk5</td>
<td>EF5</td>
<td>same</td>
<td>0.988</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>rf</td>
<td>hashap</td>
<td>EF5</td>
<td>gt</td>
<td>6.9e-14</td>
<td>0.61</td>
<td>0.0769</td>
</tr>
<tr class="odd">
<td>rf</td>
<td>hashtt</td>
<td>EF5</td>
<td>lt</td>
<td>2.61e-19</td>
<td>-0.4</td>
<td>-0.0811</td>
</tr>
<tr class="even">
<td>brf</td>
<td>mfp2</td>
<td>EF5</td>
<td>lt</td>
<td>4.02e-16</td>
<td>-0.4</td>
<td>-0.0476</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>mfp3</td>
<td>EF5</td>
<td>lt</td>
<td>8.91e-25</td>
<td>-0.6</td>
<td>-0.0854</td>
</tr>
<tr class="even">
<td>brf</td>
<td>rdk5</td>
<td>EF5</td>
<td>same</td>
<td>0.319</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>brf</td>
<td>hashap</td>
<td>EF5</td>
<td>gt</td>
<td>9.01e-07</td>
<td>0.4</td>
<td>0.0674</td>
</tr>
<tr class="even">
<td>brf</td>
<td>hashtt</td>
<td>EF5</td>
<td>lt</td>
<td>1.18e-22</td>
<td>-0.4</td>
<td>-0.101</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>mfp2</td>
<td>EF5</td>
<td>lt</td>
<td>3.14e-05</td>
<td>-0.2</td>
<td>-0.0308</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>mfp3</td>
<td>EF5</td>
<td>lt</td>
<td>4.57e-13</td>
<td>-0.4</td>
<td>-0.0797</td>
</tr>
<tr class="odd">
<td>xgb</td>
<td>rdk5</td>
<td>EF5</td>
<td>same</td>
<td>0.00432</td>
<td>-0.2</td>
<td>-0.0354</td>
</tr>
<tr class="even">
<td>xgb</td>
<td>hashap</td>
<td>EF5</td>
<td>gt</td>
<td>1.24e-09</td>
<td>0.61</td>
<td>0.1</td>
</tr>
</tbody>
</table>
<p>I am sorely tempted to compare the individual methods and fingerprints to each other as well, but that’s not the point of this post, so I’ll hold that for another time.</p>


</section>
</section>

 ]]></description>
  <category>reference</category>
  <category>fingerprints</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-12-25-colliding-bits-ii-revisited.html</guid>
  <pubDate>Sat, 24 Dec 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/colliding-bits-ii-revisited-1.png" medium="image" type="image/png" height="69" width="144"/>
</item>
<item>
  <title>Descriptor calculation tutorial</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-12-23-descriptor-tutorial.html</link>
  <description><![CDATA[ 



<p>A <a href="https://aus.social/@polymerreaction/109543412170217264">question asked on Mastodon</a> made me realize that we don’t have a tutorial anywhere on descriptor calculation. Here’s a first pass at doing that. This will eventually end up in the RDKit documentation</p>
<p>Start by doing the usual imports</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:18:53.601332Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:18:53.477333Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-3">rdkit.__version__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>'2022.09.1'</code></pre>
</div>
</div>
<p>A test molecule:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:18:54.571085Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:18:54.561585Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">doravirine <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'Cn1c(n[nH]c1=O)Cn2ccc(c(c2=O)Oc3cc(cc(c3)Cl)C#N)C(F)(F)F'</span>)</span>
<span id="cb3-2">doravirine</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-23-descriptor-tutorial_files/figure-html/cell-3-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The <code>Descriptors</code> module has a list of the available descriptors. The list is made of (name, function) 2-tuples:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:18:55.586164Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:18:55.574240Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Descriptors</span>
<span id="cb4-2"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(Descriptors._descList))</span>
<span id="cb4-3"><span class="bu" style="color: null;">print</span>(Descriptors._descList[:<span class="dv" style="color: #AD0000;">5</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>208
[('MaxEStateIndex', &lt;function MaxEStateIndex at 0x7fe4a4f2d1f0&gt;), ('MinEStateIndex', &lt;function MinEStateIndex at 0x7fe4a4f2d280&gt;), ('MaxAbsEStateIndex', &lt;function MaxAbsEStateIndex at 0x7fe4a4f2d310&gt;), ('MinAbsEStateIndex', &lt;function MinAbsEStateIndex at 0x7fe4a4f2d3a0&gt;), ('qed', &lt;function qed at 0x7fe4a4e2e3a0&gt;)]</code></pre>
</div>
</div>
<p>We can use those functions to directly calculate the corresponding descriptor. So, for example, the value of <code>MaxEStateIndex</code> for doravirine is:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:00.014047Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:00.001327Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">Descriptors._descList[<span class="dv" style="color: #AD0000;">0</span>][<span class="dv" style="color: #AD0000;">1</span>](doravirine)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>13.412553309006833</code></pre>
</div>
</div>
<p>As an aside, if we just want a few named descriptors, it’s a lot clearer (and easier to write the code!) if we call the individual descriptor functions directly:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:01.156995Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:01.145963Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">Descriptors.MaxEStateIndex(doravirine)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>13.412553309006833</code></pre>
</div>
</div>
<p>Often we want to calculate all the descriptors. As of the 2022.09 release of the rdkit there’s no real convenience function for descriptor calculation, so let’s create one:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:02.305280Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:02.302703Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;">def</span> getMolDescriptors(mol, missingVal<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>):</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;">''' calculate the full list of descriptors for a molecule</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;">    </span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;">        missingVal is used if the descriptor cannot be calculated</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;">    '''</span></span>
<span id="cb10-6">    res <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb10-7">    <span class="cf" style="color: #003B4F;">for</span> nm,fn <span class="kw" style="color: #003B4F;">in</span> Descriptors._descList:</span>
<span id="cb10-8">        <span class="co" style="color: #5E5E5E;"># some of the descriptor fucntions can throw errors if they fail, catch those here:</span></span>
<span id="cb10-9">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb10-10">            val <span class="op" style="color: #5E5E5E;">=</span> fn(mol)</span>
<span id="cb10-11">        <span class="cf" style="color: #003B4F;">except</span>:</span>
<span id="cb10-12">            <span class="co" style="color: #5E5E5E;"># print the error message:</span></span>
<span id="cb10-13">            <span class="im" style="color: #00769E;">import</span> traceback</span>
<span id="cb10-14">            traceback.print_exc()</span>
<span id="cb10-15">            <span class="co" style="color: #5E5E5E;"># and set the descriptor value to whatever missingVal is</span></span>
<span id="cb10-16">            val <span class="op" style="color: #5E5E5E;">=</span> missingVal</span>
<span id="cb10-17">        res[nm] <span class="op" style="color: #5E5E5E;">=</span> val</span>
<span id="cb10-18">    <span class="cf" style="color: #003B4F;">return</span> res</span>
<span id="cb10-19">        </span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:03.356076Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:03.319709Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">getMolDescriptors(doravirine)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'MaxEStateIndex': 13.412553309006833,
 'MinEStateIndex': -4.871620672188628,
 'MaxAbsEStateIndex': 13.412553309006833,
 'MinAbsEStateIndex': 0.045220418860841605,
 'qed': 0.6914051268589834,
 'MolWt': 425.754,
 'HeavyAtomMolWt': 414.66600000000005,
 'ExactMolWt': 425.050251552,
 'NumValenceElectrons': 150,
 'NumRadicalElectrons': 0,
 'MaxPartialCharge': 0.4197525104273902,
 'MinPartialCharge': -0.45079941098947357,
 'MaxAbsPartialCharge': 0.45079941098947357,
 'MinAbsPartialCharge': 0.4197525104273902,
 'FpDensityMorgan1': 1.3103448275862069,
 'FpDensityMorgan2': 2.0344827586206895,
 'FpDensityMorgan3': 2.6206896551724137,
 'BCUT2D_MWHI': 35.495691906445956,
 'BCUT2D_MWLOW': 10.182401353178228,
 'BCUT2D_CHGHI': 2.363442602497932,
 'BCUT2D_CHGLO': -2.1532454345808123,
 'BCUT2D_LOGPHI': 2.362094239067197,
 'BCUT2D_LOGPLOW': -2.2620565247489415,
 'BCUT2D_MRHI': 6.30376236817795,
 'BCUT2D_MRLOW': -0.13831572005086737,
 'BalabanJ': 2.1143058157682066,
 'BertzCT': 1236.821427505276,
 'Chi0': 21.344570503761737,
 'Chi0n': 14.619315272563007,
 'Chi0v': 15.375244218581463,
 'Chi1': 13.595574016164479,
 'Chi1n': 7.8933192308003095,
 'Chi1v': 8.271283703809537,
 'Chi2n': 5.882827756329733,
 'Chi2v': 6.319263536801718,
 'Chi3n': 3.9307609940961763,
 'Chi3v': 4.148978884332168,
 'Chi4n': 2.4772835642835087,
 'Chi4v': 2.7023697348309867,
 'HallKierAlpha': -3.519999999999999,
 'Ipc': 2291995.915536308,
 'Kappa1': 20.220355828454835,
 'Kappa2': 7.4789147435283585,
 'Kappa3': 4.168020338062062,
 'LabuteASA': 164.8909024413842,
 'PEOE_VSA1': 9.303962601591405,
 'PEOE_VSA10': 11.3129633249809,
 'PEOE_VSA11': 5.824404497999927,
 'PEOE_VSA12': 5.749511833283905,
 'PEOE_VSA13': 5.559266895052007,
 'PEOE_VSA14': 11.86604191564695,
 'PEOE_VSA2': 9.361636831863176,
 'PEOE_VSA3': 9.893218992372859,
 'PEOE_VSA4': 23.531818506063985,
 'PEOE_VSA5': 0.0,
 'PEOE_VSA6': 11.600939890232516,
 'PEOE_VSA7': 24.26546827384644,
 'PEOE_VSA8': 18.267148868031594,
 'PEOE_VSA9': 18.177429210401844,
 'SMR_VSA1': 17.908108096824506,
 'SMR_VSA10': 11.600939890232516,
 'SMR_VSA2': 5.261891554738487,
 'SMR_VSA3': 19.331562912184786,
 'SMR_VSA4': 7.04767198267719,
 'SMR_VSA5': 12.72105492335605,
 'SMR_VSA6': 0.0,
 'SMR_VSA7': 73.27433730199388,
 'SMR_VSA8': 0.0,
 'SMR_VSA9': 17.568244979360085,
 'SlogP_VSA1': 15.98587324705553,
 'SlogP_VSA10': 13.171245143024459,
 'SlogP_VSA11': 11.49902366656781,
 'SlogP_VSA12': 11.600939890232516,
 'SlogP_VSA2': 19.331562912184786,
 'SlogP_VSA3': 19.76872690603324,
 'SlogP_VSA4': 11.33111286753076,
 'SlogP_VSA5': 16.95130748139392,
 'SlogP_VSA6': 40.05138621360316,
 'SlogP_VSA7': 5.022633313741326,
 'SlogP_VSA8': 0.0,
 'SlogP_VSA9': 0.0,
 'TPSA': 105.70000000000002,
 'EState_VSA1': 28.738272135679853,
 'EState_VSA10': 22.760319511168106,
 'EState_VSA11': 0.0,
 'EState_VSA2': 28.704757542634727,
 'EState_VSA3': 6.06636706846161,
 'EState_VSA4': 21.397409935657397,
 'EState_VSA5': 19.18040611960041,
 'EState_VSA6': 6.069221312792274,
 'EState_VSA7': 0.0,
 'EState_VSA8': 10.197363616602075,
 'EState_VSA9': 21.599694398771053,
 'VSA_EState1': 47.48050639865553,
 'VSA_EState10': 5.842061004535676,
 'VSA_EState2': 24.16343117595945,
 'VSA_EState3': 14.921853617262808,
 'VSA_EState4': -2.8980189732872814,
 'VSA_EState5': -1.0781549918202147,
 'VSA_EState6': 6.092225491490601,
 'VSA_EState7': -3.945179835565914,
 'VSA_EState8': -0.2762282865821226,
 'VSA_EState9': 1.3919488437959202,
 'FractionCSP3': 0.17647058823529413,
 'HeavyAtomCount': 29,
 'NHOHCount': 1,
 'NOCount': 8,
 'NumAliphaticCarbocycles': 0,
 'NumAliphaticHeterocycles': 0,
 'NumAliphaticRings': 0,
 'NumAromaticCarbocycles': 1,
 'NumAromaticHeterocycles': 2,
 'NumAromaticRings': 3,
 'NumHAcceptors': 7,
 'NumHDonors': 1,
 'NumHeteroatoms': 12,
 'NumRotatableBonds': 4,
 'NumSaturatedCarbocycles': 0,
 'NumSaturatedHeterocycles': 0,
 'NumSaturatedRings': 0,
 'RingCount': 3,
 'MolLogP': 2.65458,
 'MolMR': 94.87570000000002,
 'fr_Al_COO': 0,
 'fr_Al_OH': 0,
 'fr_Al_OH_noTert': 0,
 'fr_ArN': 0,
 'fr_Ar_COO': 0,
 'fr_Ar_N': 4,
 'fr_Ar_NH': 1,
 'fr_Ar_OH': 0,
 'fr_COO': 0,
 'fr_COO2': 0,
 'fr_C_O': 0,
 'fr_C_O_noCOO': 0,
 'fr_C_S': 0,
 'fr_HOCCN': 0,
 'fr_Imine': 0,
 'fr_NH0': 4,
 'fr_NH1': 1,
 'fr_NH2': 0,
 'fr_N_O': 0,
 'fr_Ndealkylation1': 0,
 'fr_Ndealkylation2': 0,
 'fr_Nhpyrrole': 1,
 'fr_SH': 0,
 'fr_aldehyde': 0,
 'fr_alkyl_carbamate': 0,
 'fr_alkyl_halide': 3,
 'fr_allylic_oxid': 0,
 'fr_amide': 0,
 'fr_amidine': 0,
 'fr_aniline': 0,
 'fr_aryl_methyl': 0,
 'fr_azide': 0,
 'fr_azo': 0,
 'fr_barbitur': 0,
 'fr_benzene': 1,
 'fr_benzodiazepine': 0,
 'fr_bicyclic': 0,
 'fr_diazo': 0,
 'fr_dihydropyridine': 0,
 'fr_epoxide': 0,
 'fr_ester': 0,
 'fr_ether': 1,
 'fr_furan': 0,
 'fr_guanido': 0,
 'fr_halogen': 4,
 'fr_hdrzine': 0,
 'fr_hdrzone': 0,
 'fr_imidazole': 0,
 'fr_imide': 0,
 'fr_isocyan': 0,
 'fr_isothiocyan': 0,
 'fr_ketone': 0,
 'fr_ketone_Topliss': 0,
 'fr_lactam': 0,
 'fr_lactone': 0,
 'fr_methoxy': 0,
 'fr_morpholine': 0,
 'fr_nitrile': 1,
 'fr_nitro': 0,
 'fr_nitro_arom': 0,
 'fr_nitro_arom_nonortho': 0,
 'fr_nitroso': 0,
 'fr_oxazole': 0,
 'fr_oxime': 0,
 'fr_para_hydroxylation': 0,
 'fr_phenol': 0,
 'fr_phenol_noOrthoHbond': 0,
 'fr_phos_acid': 0,
 'fr_phos_ester': 0,
 'fr_piperdine': 0,
 'fr_piperzine': 0,
 'fr_priamide': 0,
 'fr_prisulfonamd': 0,
 'fr_pyridine': 1,
 'fr_quatN': 0,
 'fr_sulfide': 0,
 'fr_sulfonamd': 0,
 'fr_sulfone': 0,
 'fr_term_acetylene': 0,
 'fr_tetrazole': 0,
 'fr_thiazole': 0,
 'fr_thiocyan': 0,
 'fr_thiophene': 0,
 'fr_unbrch_alkane': 0,
 'fr_urea': 0}</code></pre>
</div>
</div>
<p>Suppose I want to generate the full set of descriptors for a bunch of molecules…</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:07.446239Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:07.335355Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="op" style="color: #5E5E5E;">!</span>head ..<span class="op" style="color: #5E5E5E;">/</span>data<span class="op" style="color: #5E5E5E;">/</span>herg_data.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>canonical_smiles molregno activity_id standard_value standard_units
N[C@@H]([C@@H]1CC[C@H](CC1)NS(=O)(=O)c2ccc(F)cc2F)C(=O)N3CC[C@H](F)C3 29272 671631 49000 nM
N[C@@H](C1CCCCC1)C(=O)N2CCSC2 29758 674222 28000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NC(=O)c2ccc(F)c(F)c2)C(=O)N3CCSC3 29449 675583 5900 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NS(=O)(=O)c2ccc(F)cc2F)C(=O)N3CCCC3 29244 675588 35000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NS(=O)(=O)c2ccc(OC(F)(F)F)cc2)C(=O)N3CC[C@@H](F)C3 29265 679299 6000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NS(=O)(=O)c2ccc(F)cc2F)C(=O)N3CC[C@@H](F)C3 29253 679302 52000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NC(=O)c2ccc(F)c(F)c2)C(=O)N3CCCC3 29482 683566 29000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NC(=O)c2ccccc2C(F)(F)F)C(=O)N3CCSC3 29340 685042 39000 nM
N[C@@H]([C@@H]1CC[C@H](CC1)NC(=O)OCc2ccccc2)C(=O)N3CC[C@@H](F)C3 29213 685047 43000 nM</code></pre>
</div>
</div>
<p>We can read in all the molecules using a “Supplier” object, there’s more about this <a href="https://www.rdkit.org/docs/GettingStartedInPython.html#reading-sets-of-molecules">in the documentation</a></p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:08.934866Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:08.767216Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">suppl <span class="op" style="color: #5E5E5E;">=</span> Chem.SmilesMolSupplier(<span class="st" style="color: #20794D;">'../data/herg_data.txt'</span>)</span>
<span id="cb15-2">mols <span class="op" style="color: #5E5E5E;">=</span> [m <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> suppl]</span>
<span id="cb15-3"><span class="bu" style="color: null;">len</span>(mols)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>1090</code></pre>
</div>
</div>
<p>Now calculate the descriptors. This takes a bit (10-20 seconds on my machine) for the ~1100 molecules I read in.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:18.220827Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:09.896088Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">allDescrs <span class="op" style="color: #5E5E5E;">=</span> [getMolDescriptors(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
</div>
<p>The problem here is that we have a list of dictionaries… that’s not useful for most things. Let’s convert it to a pandas dataframe:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-20T05:19:18.393439Z&quot;,&quot;start_time&quot;:&quot;2022-12-20T05:19:18.221859Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb18-2">df <span class="op" style="color: #5E5E5E;">=</span> pd.DataFrame(allDescrs)</span>
<span id="cb18-3">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>MaxEStateIndex</th>
      <th>MinEStateIndex</th>
      <th>MaxAbsEStateIndex</th>
      <th>MinAbsEStateIndex</th>
      <th>qed</th>
      <th>MolWt</th>
      <th>HeavyAtomMolWt</th>
      <th>ExactMolWt</th>
      <th>NumValenceElectrons</th>
      <th>NumRadicalElectrons</th>
      <th>...</th>
      <th>fr_sulfide</th>
      <th>fr_sulfonamd</th>
      <th>fr_sulfone</th>
      <th>fr_term_acetylene</th>
      <th>fr_tetrazole</th>
      <th>fr_thiazole</th>
      <th>fr_thiocyan</th>
      <th>fr_thiophene</th>
      <th>fr_unbrch_alkane</th>
      <th>fr_urea</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13.787943</td>
      <td>-4.120373</td>
      <td>13.787943</td>
      <td>0.074317</td>
      <td>0.759946</td>
      <td>419.469</td>
      <td>395.277</td>
      <td>419.149047</td>
      <td>156</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12.032152</td>
      <td>-0.232407</td>
      <td>12.032152</td>
      <td>0.186944</td>
      <td>0.777429</td>
      <td>228.361</td>
      <td>208.201</td>
      <td>228.129634</td>
      <td>86</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>13.255664</td>
      <td>-1.036185</td>
      <td>13.255664</td>
      <td>0.017845</td>
      <td>0.835147</td>
      <td>383.464</td>
      <td>360.280</td>
      <td>383.147904</td>
      <td>142</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13.787093</td>
      <td>-4.072560</td>
      <td>13.787093</td>
      <td>0.015196</td>
      <td>0.786287</td>
      <td>401.479</td>
      <td>376.279</td>
      <td>401.158469</td>
      <td>150</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13.326286</td>
      <td>-4.859254</td>
      <td>13.326286</td>
      <td>0.063966</td>
      <td>0.625645</td>
      <td>467.485</td>
      <td>442.285</td>
      <td>467.150190</td>
      <td>174</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 208 columns</p>
</div>
</div>
</div>
<p>And now we have something that we could use to build models, filter, etc.</p>



 ]]></description>
  <category>tutorial</category>
  <category>descriptors</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-12-23-descriptor-tutorial.html</guid>
  <pubDate>Thu, 22 Dec 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/descriptor-tutorial-1.png" medium="image" type="image/png" height="29" width="144"/>
</item>
<item>
  <title>Introducing rdDetermineBonds</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-12-18-introducing-rdDetermineBonds.html</link>
  <description><![CDATA[ 



<p>One of the problems with using the results from quantum chemical calculations with the RDKit is that typical QM output formats just include atoms and their positions: since the calculations don’t need bond orders, they don’t show up in the output. The problem of assigning correct bond orders to the atoms in a molecule based solely on atomic positions (and the overall charge on the molecule) is a non-trivial one, and we’ve never had a good answer in the RDKit.</p>
<p>A few years ago Jan Jensen and his group published <code>xyz2mol</code>, an open-source, RDKit-based solution to this problem written in Python: https://github.com/jensengroup/xyz2mol. During this year’s Google Summer of Code, Sreya Gogineni, did a C++ port of the Python code and integrated it into the RDKit core for the 2022.09 release. Here’s the <a href="https://summerofcode.withgoogle.com/programs/2022/projects/ugO4HoEX">project description</a> and here’s Sreya’s <a href="https://github.com/rdkit/rdkit/pull/5557">“final report”</a> which is also the PR where we merged her changes into the RDKit core.</p>
<p>This post was originally just going to be a quick introduction to how to use that code. However, since I was having fun with it, I went ahead and did some testing on a bunch of 3D structures from QM9.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.336147Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.250244Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-6">rdkit.__version__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>'2022.09.1'</code></pre>
</div>
</div>
<section id="using-rddeterminebonds" class="level1">
<h1>Using rdDetermineBonds</h1>
<p>To get some testing files, I downloaded some structures from the <a href="https://figshare.com/collections/Quantum_chemistry_structures_and_properties_of_134_kilo_molecules/978904">QM9 dataset</a>. Here’s what those look like:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.446374Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.337014Z&quot;}" data-scrolled="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;">!</span>cat ..<span class="op" style="color: #5E5E5E;">/</span>data<span class="op" style="color: #5E5E5E;">/</span>dsgdb9nsd_107313.xyz</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>19
gdb 107313  2.67642 1.59305 1.14971 3.3443  81.12   -0.2359 -0.0506 0.1853  1106.1507   0.159794    -385.918216 -385.909962 -385.909018 -385.950934 31.892  
C    0.0645055554    1.4843171326    0.3723315122   -0.379845
C   -0.001915467     0.0516984051   -0.1729357038   -0.277772
C   -1.4001624807   -0.5304376801   -0.1487075838    0.233551
C   -1.9909553844   -1.0379429662    1.1601625215   -0.307513
C   -1.7182271444   -1.9962888369    0.0152208454   -0.158294
C   -2.905416575    -2.2627721735   -0.8489696604   -0.065615
C   -3.3347497536   -1.1525477782   -1.4661914556   -0.191532
C   -2.4353480328   -0.0114763902   -1.1388331005    0.336742
O   -2.4853518918    1.1093228549   -1.595794586    -0.340877
H    1.0876615149    1.8699729825    0.3263064541    0.106173
H   -0.5836533924    2.142053447    -0.2101812431    0.152698
H   -0.2626541721    1.5210712578    1.4170099662    0.108877
H    0.3710335675    0.0343653078   -1.2041622283    0.107526
H    0.662791197    -0.6008609283    0.4071642198    0.091428
H   -1.3142481944   -1.0584396879    2.0096409673    0.122076
H   -3.0252533013   -0.8199288984    1.4038330438    0.125348
H   -0.9412329872   -2.7436632889    0.1278385726    0.101319
H   -3.37329736 -3.2394582332   -0.9072563749    0.118603
H   -4.2004762777   -1.0463782959   -2.1061677066    0.117109
88.1998 132.6788    204.3282    214.9254    283.2151    320.8425    354.2003    451.4683    471.7609    631.475 661.0085    735.6532    750.9738    778.4916    839.8756    849.5692    876.8931    897.9162    967.6602    980.1789    992.0568    1026.4327   1049.1839   1072.0692   1075.099    1111.0662   1128.3577   1138.5104   1233.4573   1265.5356   1338.63 1352.428    1365.7919   1389.2764   1408.176    1477.5353   1487.9659   1495.4859   1514.6888   1630.2685   1799.8365   3021.0204   3038.158    3057.8354   3101.9102   3122.4464   3138.2864   3177.3129   3193.7776   3214.9261   3232.806
CCC12CC1C=CC2=O CC[C@]12C[C@H]1C=CC2=O  
InChI=1S/C8H10O/c1-2-8-5-6(8)3-4-7(8)9/h3-4,6H,2,5H2,1H3    InChI=1S/C8H10O/c1-2-8-5-6(8)3-4-7(8)9/h3-4,6H,2,5H2,1H3/t6-,8+/m1/s1</code></pre>
</div>
</div>
<p>Sreya also added an XYZ file format parser to the RDKit, but these files include a bunch of additional information that we need to strip out. Here’s the code for that:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.465614Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.452498Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;"># the XYZ files from QM9 aren't really XYZ... clean them up:</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;">def</span> cleanup_qm9_xyz(fname):</span>
<span id="cb5-3">    ind <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">open</span>(fname).readlines()</span>
<span id="cb5-4">    nAts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">int</span>(ind[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb5-5">    <span class="co" style="color: #5E5E5E;"># There are two smiles in the data: the one from GDB and the one assigned from the</span></span>
<span id="cb5-6">    <span class="co" style="color: #5E5E5E;"># 3D coordinates in the QM9 paper using OpenBabel (I think).</span></span>
<span id="cb5-7">    gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> ind[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>].split()[:<span class="dv" style="color: #AD0000;">2</span>]</span>
<span id="cb5-8">    ind[<span class="dv" style="color: #AD0000;">1</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span></span>
<span id="cb5-9">    ind <span class="op" style="color: #5E5E5E;">=</span> ind[:nAts<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">2</span>]</span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">2</span>,nAts<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">2</span>):</span>
<span id="cb5-11">        l <span class="op" style="color: #5E5E5E;">=</span> ind[i]</span>
<span id="cb5-12">        l <span class="op" style="color: #5E5E5E;">=</span> l.split(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\t</span><span class="st" style="color: #20794D;">'</span>)</span>
<span id="cb5-13">        l.pop(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb5-14">        ind[i] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\t</span><span class="st" style="color: #20794D;">'</span>.join(l)<span class="op" style="color: #5E5E5E;">+</span><span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\n</span><span class="st" style="color: #20794D;">'</span></span>
<span id="cb5-15">    ind <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span>.join(ind)</span>
<span id="cb5-16">    <span class="cf" style="color: #003B4F;">return</span> ind,gdb_smi,relax_smi</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.547937Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.470993Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">ind,gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> cleanup_qm9_xyz(<span class="st" style="color: #20794D;">'../data/dsgdb9nsd_107313.xyz'</span>)</span>
<span id="cb6-2"><span class="bu" style="color: null;">print</span>(ind)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>19

C    0.0645055554    1.4843171326    0.3723315122
C   -0.001915467     0.0516984051   -0.1729357038
C   -1.4001624807   -0.5304376801   -0.1487075838
C   -1.9909553844   -1.0379429662    1.1601625215
C   -1.7182271444   -1.9962888369    0.0152208454
C   -2.905416575    -2.2627721735   -0.8489696604
C   -3.3347497536   -1.1525477782   -1.4661914556
C   -2.4353480328   -0.0114763902   -1.1388331005
O   -2.4853518918    1.1093228549   -1.595794586
H    1.0876615149    1.8699729825    0.3263064541
H   -0.5836533924    2.142053447    -0.2101812431
H   -0.2626541721    1.5210712578    1.4170099662
H    0.3710335675    0.0343653078   -1.2041622283
H    0.662791197    -0.6008609283    0.4071642198
H   -1.3142481944   -1.0584396879    2.0096409673
H   -3.0252533013   -0.8199288984    1.4038330438
H   -0.9412329872   -2.7436632889    0.1278385726
H   -3.37329736 -3.2394582332   -0.9072563749
H   -4.2004762777   -1.0463782959   -2.1061677066
</code></pre>
</div>
</div>
<p>And now we can construct a molecule:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.622861Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.552852Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">raw_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb8-2"><span class="bu" style="color: null;">print</span>(raw_mol.GetNumAtoms(),raw_mol.GetNumBonds())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>19 0</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.692056Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.625322Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;">import</span> py3Dmol</span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;">def</span> draw_with_spheres(mol):</span>
<span id="cb10-3">    v <span class="op" style="color: #5E5E5E;">=</span> py3Dmol.view(width<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">300</span>,height<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">300</span>)</span>
<span id="cb10-4">    IPythonConsole.addMolToView(mol,v)</span>
<span id="cb10-5">    v.zoomTo()</span>
<span id="cb10-6">    v.setStyle({<span class="st" style="color: #20794D;">'sphere'</span>:{<span class="st" style="color: #20794D;">'radius'</span>:<span class="fl" style="color: #AD0000;">0.3</span>},<span class="st" style="color: #20794D;">'stick'</span>:{<span class="st" style="color: #20794D;">'radius'</span>:<span class="fl" style="color: #AD0000;">0.2</span>}})<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-7">    v.show()</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.774814Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.693887Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">draw_with_spheres(raw_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16713456397690604" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_16713456397690604" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16713456397690604 = null;
var warn = document.getElementById("3dmolwarning_16713456397690604");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16713456397690604 = $3Dmol.createViewer($("#3dmolviewer_16713456397690604"),{backgroundColor:"white"});
viewer_16713456397690604.zoomTo();
    viewer_16713456397690604.addModel("\n     RDKit          3D\n\n 19  0  0  0  0  0  0  0  0  0999 V2000\n    0.0645    1.4843    0.3723 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0019    0.0517   -0.1729 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.4002   -0.5304   -0.1487 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.9910   -1.0379    1.1602 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.7182   -1.9963    0.0152 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.9054   -2.2628   -0.8490 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3347   -1.1525   -1.4662 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4353   -0.0115   -1.1388 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4854    1.1093   -1.5958 O   0  0  0  0  0  0  0  0  0  0  0  0\n    1.0877    1.8700    0.3263 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5837    2.1421   -0.2102 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2627    1.5211    1.4170 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3710    0.0344   -1.2042 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6628   -0.6009    0.4072 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3142   -1.0584    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0253   -0.8199    1.4038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9412   -2.7437    0.1278 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3733   -3.2395   -0.9073 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2005   -1.0464   -2.1062 H   0  0  0  0  0  0  0  0  0  0  0  0\nM  END\n","sdf");
    viewer_16713456397690604.setStyle({"stick": {}});
    viewer_16713456397690604.zoomTo();
    viewer_16713456397690604.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_16713456397690604.render();
});
</script>
</div>
</div>
<p>Of course that doesn’t yet have bonds. Let’s fix that.</p>
<p>Start with <code>rdDetermineBonds.DetermineConnectivity()</code>, this uses distances between atoms to determine where there should be bonds, but does not attempt to figure out bond orders.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.851095Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.783941Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDetermineBonds</span>
<span id="cb12-2">conn_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(raw_mol)</span>
<span id="cb12-3">rdDetermineBonds.DetermineConnectivity(conn_mol)</span>
<span id="cb12-4"></span>
<span id="cb12-5">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16713456398471613" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_16713456398471613" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16713456398471613 = null;
var warn = document.getElementById("3dmolwarning_16713456398471613");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16713456398471613 = $3Dmol.createViewer($("#3dmolviewer_16713456398471613"),{backgroundColor:"white"});
viewer_16713456398471613.zoomTo();
    viewer_16713456398471613.addModel("\n     RDKit          3D\n\n 19 20  0  0  0  0  0  0  0  0999 V2000\n    0.0645    1.4843    0.3723 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0019    0.0517   -0.1729 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.4002   -0.5304   -0.1487 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.9910   -1.0379    1.1602 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.7182   -1.9963    0.0152 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.9054   -2.2628   -0.8490 C   0  0  0  0  0  3  0  0  0  0  0  0\n   -3.3347   -1.1525   -1.4662 C   0  0  0  0  0  3  0  0  0  0  0  0\n   -2.4353   -0.0115   -1.1388 C   0  0  0  0  0  3  0  0  0  0  0  0\n   -2.4854    1.1093   -1.5958 O   0  0  0  0  0  1  0  0  0  0  0  0\n    1.0877    1.8700    0.3263 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5837    2.1421   -0.2102 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2627    1.5211    1.4170 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3710    0.0344   -1.2042 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6628   -0.6009    0.4072 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3142   -1.0584    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0253   -0.8199    1.4038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9412   -2.7437    0.1278 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3733   -3.2395   -0.9073 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2005   -1.0464   -2.1062 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0\n  1 10  1  0\n  1 11  1  0\n  1 12  1  0\n  2  3  1  0\n  2 13  1  0\n  2 14  1  0\n  3  4  1  0\n  3  5  1  0\n  3  8  1  0\n  4  5  1  0\n  4 15  1  0\n  4 16  1  0\n  5  6  1  0\n  5 17  1  0\n  6  7  1  0\n  6 18  1  0\n  7  8  1  0\n  7 19  1  0\n  8  9  1  0\nM  END\n","sdf");
    viewer_16713456398471613.setStyle({"stick": {}});
    viewer_16713456398471613.zoomTo();
    viewer_16713456398471613.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_16713456398471613.render();
});
</script>
</div>
</div>
<p>Now we can use <code>rdDetermineBonds.DetermineBondOrders()</code> to figure out what the bond orders should be.</p>
<p>This requires the overall charge on the molecule (the default value of the charge is zero, so it’s not technically necessary to provide it here, but we do so to be clear):</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:39.957369Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.853149Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">rdDetermineBonds.DetermineBondOrders(conn_mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb13-2">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16713456399519362" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_16713456399519362" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16713456399519362 = null;
var warn = document.getElementById("3dmolwarning_16713456399519362");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16713456399519362 = $3Dmol.createViewer($("#3dmolviewer_16713456399519362"),{backgroundColor:"white"});
viewer_16713456399519362.zoomTo();
    viewer_16713456399519362.addModel("\n     RDKit          3D\n\n 19 20  0  0  0  0  0  0  0  0999 V2000\n    0.0645    1.4843    0.3723 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -0.0019    0.0517   -0.1729 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -1.4002   -0.5304   -0.1487 C   0  0  2  0  0  0  0  0  0  0  0  0\n   -1.9910   -1.0379    1.1602 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -1.7182   -1.9963    0.0152 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -2.9054   -2.2628   -0.8490 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3347   -1.1525   -1.4662 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4353   -0.0115   -1.1388 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4854    1.1093   -1.5958 O   0  0  0  0  0  0  0  0  0  0  0  0\n    1.0877    1.8700    0.3263 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5837    2.1421   -0.2102 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2627    1.5211    1.4170 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3710    0.0344   -1.2042 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6628   -0.6009    0.4072 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3142   -1.0584    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0253   -0.8199    1.4038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9412   -2.7437    0.1278 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3733   -3.2395   -0.9073 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2005   -1.0464   -2.1062 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0\n  1 10  1  1\n  1 11  1  0\n  1 12  1  0\n  2  3  1  0\n  2 13  1  6\n  2 14  1  0\n  3  4  1  0\n  3  5  1  0\n  3  8  1  6\n  4  5  1  0\n  4 15  1  1\n  4 16  1  0\n  5  6  1  0\n  5 17  1  1\n  6  7  2  0\n  6 18  1  0\n  7  8  1  0\n  7 19  1  0\n  8  9  2  0\nM  END\n","sdf");
    viewer_16713456399519362.setStyle({"stick": {}});
    viewer_16713456399519362.zoomTo();
    viewer_16713456399519362.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_16713456399519362.render();
});
</script>
</div>
</div>
<p>We can do both steps in a single call. This is the easiest way to use the code if you just want to look at the final bond orders:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.049649Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:39.962007Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">conn_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(raw_mol)</span>
<span id="cb14-2">rdDetermineBonds.DetermineBonds(conn_mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb14-3">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_1671345640045727" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_1671345640045727" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_1671345640045727 = null;
var warn = document.getElementById("3dmolwarning_1671345640045727");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_1671345640045727 = $3Dmol.createViewer($("#3dmolviewer_1671345640045727"),{backgroundColor:"white"});
viewer_1671345640045727.zoomTo();
    viewer_1671345640045727.addModel("\n     RDKit          3D\n\n 19 20  0  0  0  0  0  0  0  0999 V2000\n    0.0645    1.4843    0.3723 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -0.0019    0.0517   -0.1729 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -1.4002   -0.5304   -0.1487 C   0  0  2  0  0  0  0  0  0  0  0  0\n   -1.9910   -1.0379    1.1602 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -1.7182   -1.9963    0.0152 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -2.9054   -2.2628   -0.8490 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3347   -1.1525   -1.4662 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4353   -0.0115   -1.1388 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4854    1.1093   -1.5958 O   0  0  0  0  0  0  0  0  0  0  0  0\n    1.0877    1.8700    0.3263 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5837    2.1421   -0.2102 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2627    1.5211    1.4170 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3710    0.0344   -1.2042 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6628   -0.6009    0.4072 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3142   -1.0584    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0253   -0.8199    1.4038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9412   -2.7437    0.1278 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3733   -3.2395   -0.9073 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2005   -1.0464   -2.1062 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0\n  1 10  1  1\n  1 11  1  0\n  1 12  1  0\n  2  3  1  0\n  2 13  1  6\n  2 14  1  0\n  3  4  1  0\n  3  5  1  0\n  3  8  1  6\n  4  5  1  0\n  4 15  1  1\n  4 16  1  0\n  5  6  1  0\n  5 17  1  1\n  6  7  2  0\n  6 18  1  0\n  7  8  1  0\n  7 19  1  0\n  8  9  2  0\nM  END\n","sdf");
    viewer_1671345640045727.setStyle({"stick": {}});
    viewer_1671345640045727.zoomTo();
    viewer_1671345640045727.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_1671345640045727.render();
});
</script>
</div>
</div>
<p>See if the SMILES we got agrees with the what QM9 says it should be:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.123401Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.051965Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">cm <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(conn_mol)</span>
<span id="cb15-2">osmi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(cm)</span>
<span id="cb15-3">smi <span class="op" style="color: #5E5E5E;">=</span> Chem.CanonSmiles(relax_smi)</span>
<span id="cb15-4"><span class="bu" style="color: null;">print</span>(osmi,smi)</span>
<span id="cb15-5">osmi<span class="op" style="color: #5E5E5E;">==</span>smi</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CC[C@]12C[C@H]1C=CC2=O CC[C@]12C[C@H]1C=CC2=O</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>True</code></pre>
</div>
</div>
<p>Yep… that’s all good.</p>
<p>Let’s do another example:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.193888Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.124116Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">ind,gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> cleanup_qm9_xyz(<span class="st" style="color: #20794D;">'../data/dsgdb9nsd_127185.xyz'</span>)</span>
<span id="cb18-2">raw_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb18-3">conn_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(raw_mol)</span>
<span id="cb18-4">rdDetermineBonds.DetermineBonds(conn_mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb18-5">conn_mol</span>
<span id="cb18-6">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16713456401917276" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_16713456401917276" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16713456401917276 = null;
var warn = document.getElementById("3dmolwarning_16713456401917276");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16713456401917276 = $3Dmol.createViewer($("#3dmolviewer_16713456401917276"),{backgroundColor:"white"});
viewer_16713456401917276.zoomTo();
    viewer_16713456401917276.addModel("\n     RDKit          3D\n\n 15 15  0  0  0  0  0  0  0  0999 V2000\n    0.0344    1.4639   -0.0145 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -0.0019    0.0063   -0.0044 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0458   -0.6642    1.2086 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0565   -0.1090    2.2824 O   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0084   -0.6842   -1.2118 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0233   -2.0014   -1.2649 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0002   -2.3144   -2.6220 O   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0441   -1.1838   -3.3314 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0526   -0.1011   -2.5153 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9467    1.8282   -0.4975 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.8359    1.8722   -0.5382 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0187    1.7900    1.0244 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0699   -1.7554    1.0775 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0656   -1.2996   -4.4040 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0848    0.9382   -2.7902 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0\n  1 10  1  6\n  1 11  1  0\n  1 12  1  0\n  2  3  1  0\n  2  5  1  0\n  3  4  2  0\n  3 13  1  0\n  5  6  2  0\n  5  9  1  0\n  6  7  1  0\n  7  8  1  0\n  8  9  2  0\n  8 14  1  0\n  9 15  1  0\nM  END\n","sdf");
    viewer_16713456401917276.setStyle({"stick": {}});
    viewer_16713456401917276.zoomTo();
    viewer_16713456401917276.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_16713456401917276.render();
});
</script>
</div>
</div>
<p>Again, make sure we got it right:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.272552Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.195534Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">cm <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(conn_mol)</span>
<span id="cb19-2">osmi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(cm)</span>
<span id="cb19-3">smi <span class="op" style="color: #5E5E5E;">=</span> Chem.CanonSmiles(relax_smi)</span>
<span id="cb19-4"><span class="bu" style="color: null;">print</span>(osmi,smi)</span>
<span id="cb19-5">osmi<span class="op" style="color: #5E5E5E;">==</span>smi</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CN(C=O)c1ccon1 CN(C=O)c1ccon1</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>True</code></pre>
</div>
</div>
<p>Since this method needs the Hs to be there, it unfortunately won’t be useful in assigning bond orders to the ligands from PDB structures… ah well.</p>
</section>
<section id="testing-the-functionality-on-a-bunch-of-molecules" class="level1">
<h1>Testing the functionality on a bunch of molecules</h1>
<p>Here’s a little test to see how well the new functionality does on a randomly selected subset of <a href="https://figshare.com/collections/Quantum_chemistry_structures_and_properties_of_134_kilo_molecules/978904">QM9</a>.</p>
<p>Start by getting 10K random files from my local copy of QM9 (these, for obvious reasons, aren’t in the gitub repo for this notebook) and preprocessing them:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.575532Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.274106Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;">import</span> glob</span>
<span id="cb22-2"><span class="im" style="color: #00769E;">import</span> random</span>
<span id="cb22-3">random.seed(<span class="bn" style="color: #AD0000;">0xf00d</span>)</span>
<span id="cb22-4"></span>
<span id="cb22-5">fns <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(glob.glob(<span class="st" style="color: #20794D;">'/local/QM9/*.xyz'</span>))</span>
<span id="cb22-6">random.shuffle(fns)</span>
<span id="cb22-7">fns <span class="op" style="color: #5E5E5E;">=</span> fns[:<span class="dv" style="color: #AD0000;">10000</span>]</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.828592Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.578524Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">qm9_data <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-2"><span class="cf" style="color: #003B4F;">for</span> fn <span class="kw" style="color: #003B4F;">in</span> fns:</span>
<span id="cb23-3">    d,gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> cleanup_qm9_xyz(fn)</span>
<span id="cb23-4">    qm9_data.append((fn,d,gdb_smi,relax_smi))</span></code></pre></div>
</div>
<p>I believe that QM9 doesn’t have double bond stereo indicated in the SMILES, verify that:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:40.834201Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.829559Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">has_dbl_bond_stereo<span class="op" style="color: #5E5E5E;">=</span>[]</span>
<span id="cb24-2"><span class="cf" style="color: #003B4F;">for</span> tpl <span class="kw" style="color: #003B4F;">in</span> qm9_data:</span>
<span id="cb24-3">    smi <span class="op" style="color: #5E5E5E;">=</span> tpl[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb24-4">    <span class="cf" style="color: #003B4F;">if</span> smi.find(<span class="st" style="color: #20794D;">'/'</span>) <span class="op" style="color: #5E5E5E;">!=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span> <span class="kw" style="color: #003B4F;">or</span> smi.find(<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\\</span><span class="st" style="color: #20794D;">'</span>) <span class="op" style="color: #5E5E5E;">!=</span> <span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb24-5">        <span class="bu" style="color: null;">print</span>(tpl)</span></code></pre></div>
</div>
<p>Here’s the testing code.</p>
<p>For each molecule we have two SMILES to compare to: 1. <code>gdb_smi</code>: the SMILES from GDB that the QM9 authors used as input 2. <code>relax_smi</code>: the SMILES generated by OpenBabel(?) from the optimized structure.</p>
<p>We’ll start by seeing if we match <code>relax_smi</code> and, if that fails, compare to <code>gdb_smi</code>.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:44.477276Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:40.835150Z&quot;}" data-scrolled="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> RDLogger</span>
<span id="cb25-2">RDLogger.DisableLog(<span class="st" style="color: #20794D;">'rdApp.*'</span>)</span>
<span id="cb25-3">relax_fails <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb25-4">gdb_fails <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb25-5"><span class="cf" style="color: #003B4F;">for</span> fn,ind,gdb_smi,relax_smi <span class="kw" style="color: #003B4F;">in</span> qm9_data:</span>
<span id="cb25-6">    <span class="co" style="color: #5E5E5E;"># the RDKit can't parse some of the SMILES from QM9... skip those mols</span></span>
<span id="cb25-7">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb25-8">        smi <span class="op" style="color: #5E5E5E;">=</span> Chem.CanonSmiles(relax_smi)</span>
<span id="cb25-9">    <span class="cf" style="color: #003B4F;">except</span>:</span>
<span id="cb25-10">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb25-11">    mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb25-12">    <span class="cf" style="color: #003B4F;">if</span> mol <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb25-13">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'Could not parse </span><span class="sc" style="color: #5E5E5E;">{</span>fn<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb25-14">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb25-15">    rdDetermineBonds.DetermineBonds(mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb25-16">    <span class="co" style="color: #5E5E5E;"># remove double bond stereo:</span></span>
<span id="cb25-17">    <span class="cf" style="color: #003B4F;">for</span> bond <span class="kw" style="color: #003B4F;">in</span> mol.GetBonds():</span>
<span id="cb25-18">        <span class="cf" style="color: #003B4F;">if</span> bond.GetBondType() <span class="op" style="color: #5E5E5E;">==</span> Chem.BondType.DOUBLE:</span>
<span id="cb25-19">            bond.SetStereo(Chem.BondStereo.STEREONONE)</span>
<span id="cb25-20">        <span class="cf" style="color: #003B4F;">elif</span> bond.GetBondType() <span class="op" style="color: #5E5E5E;">==</span> Chem.BondType.SINGLE:</span>
<span id="cb25-21">            bond.SetBondDir(Chem.BondDir.NONE)</span>
<span id="cb25-22">    osmi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(Chem.RemoveAllHs(mol))</span>
<span id="cb25-23">    <span class="co" style="color: #5E5E5E;"># compare to relax_smi:</span></span>
<span id="cb25-24">    <span class="cf" style="color: #003B4F;">if</span> smi<span class="op" style="color: #5E5E5E;">!=</span>osmi:</span>
<span id="cb25-25">        relax_fails.append((fn,smi,osmi))</span>
<span id="cb25-26">        <span class="co" style="color: #5E5E5E;"># that failed, so next we are going to compare to gdb_smi;</span></span>
<span id="cb25-27">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb25-28">            smi <span class="op" style="color: #5E5E5E;">=</span> Chem.CanonSmiles(gdb_smi)</span>
<span id="cb25-29">        <span class="cf" style="color: #003B4F;">except</span>:</span>
<span id="cb25-30">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb25-31">        <span class="co" style="color: #5E5E5E;"># the GDB smiles don't have any stereo at all, so get rid of atomic stereo</span></span>
<span id="cb25-32">        <span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> mol.GetAtoms():</span>
<span id="cb25-33">            atom.SetChiralTag(Chem.ChiralType.CHI_UNSPECIFIED)</span>
<span id="cb25-34">        osmi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(Chem.RemoveAllHs(mol))</span>
<span id="cb25-35">        <span class="cf" style="color: #003B4F;">if</span> smi <span class="op" style="color: #5E5E5E;">!=</span> osmi:</span>
<span id="cb25-36">            gdb_fails.append((fn,smi,osmi))</span>
<span id="cb25-37">RDLogger.EnableLog(<span class="st" style="color: #20794D;">'rdApp.*'</span>)</span>
<span id="cb25-38"></span>
<span id="cb25-39"><span class="bu" style="color: null;">len</span>(relax_fails),<span class="bu" style="color: null;">len</span>(gdb_fails)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Could not parse /local/QM9/dsgdb9nsd_112773.xyz
Could not parse /local/QM9/dsgdb9nsd_071817.xyz
Could not parse /local/QM9/dsgdb9nsd_024513.xyz
Could not parse /local/QM9/dsgdb9nsd_057755.xyz
Could not parse /local/QM9/dsgdb9nsd_005005.xyz
Could not parse /local/QM9/dsgdb9nsd_132540.xyz
Could not parse /local/QM9/dsgdb9nsd_002091.xyz
Could not parse /local/QM9/dsgdb9nsd_025366.xyz
Could not parse /local/QM9/dsgdb9nsd_104557.xyz</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(909, 27)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:44.480944Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:44.478243Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">relax_fails[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>('/local/QM9/dsgdb9nsd_130414.xyz', '[NH][C]1C=NOC(CN)=N1', 'N=c1cnoc(CN)n1')</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:44.678134Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:44.482006Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">gdb_fails[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>('/local/QM9/dsgdb9nsd_130861.xyz', 'O=Cc1cc(=O)nno1', 'N#N.O=C=CC(=O)C=O')</code></pre>
</div>
</div>
<p>Let’s start by looking at some of the failures based on <code>relax_smi</code>.</p>
<p>In the output we have pairs of molecules where the first is constructed from <code>relax_smi</code> and the second is what we perceived</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:44.913265Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:44.681548Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb32-2">failmols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb32-3">nms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb32-4"><span class="cf" style="color: #003B4F;">for</span> fn,ismi,osmi <span class="kw" style="color: #003B4F;">in</span> relax_fails:</span>
<span id="cb32-5">    im <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(ismi)</span>
<span id="cb32-6">    om <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(osmi)</span>
<span id="cb32-7">    failmols.append(im)</span>
<span id="cb32-8">    failmols.append(om)</span>
<span id="cb32-9">    nms.append(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>os<span class="sc" style="color: #5E5E5E;">.</span>path<span class="sc" style="color: #5E5E5E;">.</span>basename(fn)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> relax_smi'</span>)</span>
<span id="cb32-10">    nms.append(<span class="st" style="color: #20794D;">'rdkit_smi'</span>)</span>
<span id="cb32-11">Draw.MolsToGridImage(failmols[:<span class="dv" style="color: #AD0000;">20</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>,legends<span class="op" style="color: #5E5E5E;">=</span>nms)        </span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-18-introducing-rdDetermineBonds_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Those seem to be cases where we’ve assigned a multiple bond while the SMILES in the publication has a single bond with radicals on either side.</p>
<p>What about some of the 27 cases where we haven’t reproduced the input GDB SMILES?</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:44.974390Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:44.914068Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="im" style="color: #00769E;">import</span> os</span>
<span id="cb33-2">failmols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb33-3">nms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb33-4"><span class="cf" style="color: #003B4F;">for</span> fn,ismi,osmi <span class="kw" style="color: #003B4F;">in</span> gdb_fails:</span>
<span id="cb33-5">    im <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(ismi)</span>
<span id="cb33-6">    om <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(osmi)</span>
<span id="cb33-7">    failmols.append(im)</span>
<span id="cb33-8">    failmols.append(om)</span>
<span id="cb33-9">    nms.append(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>os<span class="sc" style="color: #5E5E5E;">.</span>path<span class="sc" style="color: #5E5E5E;">.</span>basename(fn)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> relax_smi'</span>)</span>
<span id="cb33-10">    nms.append(<span class="st" style="color: #20794D;">'rdkit_smi'</span>)</span>
<span id="cb33-11">Draw.MolsToGridImage(failmols[:<span class="dv" style="color: #AD0000;">20</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>,legends<span class="op" style="color: #5E5E5E;">=</span>nms)        </span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-12-18-introducing-rdDetermineBonds_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s look at a couple of those:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:45.092015Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:44.975201Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">ind,gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> cleanup_qm9_xyz(<span class="st" style="color: #20794D;">'/local/QM9/dsgdb9nsd_129106.xyz'</span>)</span>
<span id="cb34-2">raw_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb34-3">conn_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(raw_mol)</span>
<span id="cb34-4">rdDetermineBonds.DetermineBonds(conn_mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb34-5">conn_mol</span>
<span id="cb34-6">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_1671345645087176" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_1671345645087176" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_1671345645087176 = null;
var warn = document.getElementById("3dmolwarning_1671345645087176");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_1671345645087176 = $3Dmol.createViewer($("#3dmolviewer_1671345645087176"),{backgroundColor:"white"});
viewer_1671345645087176.zoomTo();
    viewer_1671345645087176.addModel("\n     RDKit          3D\n\n 13 13  0  0  0  0  0  0  0  0999 V2000\n   -0.2255    1.2316    0.0079 N   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0078   -0.0141    0.0005 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.1022   -1.0658    0.0002 C   0  0  1  0  0  0  0  0  0  0  0  0\n   -0.3126   -2.3488   -0.0099 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1315   -2.0942   -0.0152 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2211   -0.6943   -0.0085 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0653   -2.8598   -0.0233 O   0  0  0  0  0  1  0  0  0  0  0  0\n   -1.2073   -4.6066   -0.0174 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7951   -3.5497   -0.0138 N   0  0  0  0  0  4  0  0  0  0  0  0\n    0.6338    1.7832    0.0068 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.7315   -0.9387    0.8869 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.7394   -0.9298   -0.8796 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1220   -0.2408   -0.0104 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  1 10  1  0\n  2  3  1  0\n  2  6  1  0\n  3  4  1  0\n  3 11  1  1\n  3 12  1  0\n  4  5  2  0\n  4  9  1  0\n  5  6  1  0\n  5  7  1  0\n  6 13  1  0\n  8  9  3  0\nM  CHG  2   7  -1   9   1\nM  END\n","sdf");
    viewer_1671345645087176.setStyle({"stick": {}});
    viewer_1671345645087176.zoomTo();
    viewer_1671345645087176.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_1671345645087176.render();
});
</script>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:45.177975Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:45.099458Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">ind,gdb_smi,relax_smi <span class="op" style="color: #5E5E5E;">=</span> cleanup_qm9_xyz(<span class="st" style="color: #20794D;">'/local/QM9/dsgdb9nsd_133855.xyz'</span>)</span>
<span id="cb35-2">raw_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb35-3">conn_mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(raw_mol)</span>
<span id="cb35-4">rdDetermineBonds.DetermineBonds(conn_mol,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb35-5">conn_mol</span>
<span id="cb35-6">draw_with_spheres(conn_mol)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16713456451761575" style="position: relative; width: 300px; height: 300px">
        <p id="3dmolwarning_16713456451761575" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16713456451761575 = null;
var warn = document.getElementById("3dmolwarning_16713456451761575");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16713456451761575 = $3Dmol.createViewer($("#3dmolviewer_16713456451761575"),{backgroundColor:"white"});
viewer_16713456451761575.zoomTo();
    viewer_16713456451761575.addModel("\n     RDKit          3D\n\n 17 18  0  0  0  0  0  0  0  0999 V2000\n    1.0375   -0.1058   -1.0380 C   0  0  2  0  0  0  0  0  0  0  0  0\n    2.4805    0.2357   -0.9937 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.8209   -2.0692    1.2656 O   0  0  0  0  0  0  0  0  0  0  0  0\n    4.3213   -1.2872    0.5052 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.7490   -0.6642    0.6310 C   0  0  2  0  0  0  0  0  0  0  0  0\n    5.5766    0.7022   -0.0251 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.4627    0.6912   -0.7624 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.2147    1.3641   -1.1603 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7348   -0.6357   -0.7551 C   0  0  2  0  0  0  0  0  0  0  0  0\n    0.4240    0.7686   -1.2722 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.7061   -0.5180   -0.0773 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8418   -0.8788   -1.7919 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.4957   -1.3176    0.1566 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.0221   -0.5977    1.6894 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.1728    1.5644    0.2492 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.9555    2.3914   -1.3836 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.9589   -1.2883   -1.6104 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0\n  1 10  1  6\n  1 11  1  0\n  1 12  1  0\n  2  8  2  0\n  2  9  1  0\n  3  4  2  0\n  4  5  1  0\n  4  9  1  0\n  5  6  1  0\n  5 13  1  6\n  5 14  1  0\n  6  7  2  0\n  6 15  1  0\n  7  8  1  0\n  7  9  1  0\n  8 16  1  0\n  9 17  1  6\nM  END\n","sdf");
    viewer_16713456451761575.setStyle({"stick": {}});
    viewer_16713456451761575.zoomTo();
    viewer_16713456451761575.setStyle({"sphere": {"radius": 0.3}, "stick": {"radius": 0.2}});
viewer_16713456451761575.render();
});
</script>
</div>
</div>
<p>Those are clearly cases where the QM optimization has yielded a completely different structure from what they started with.</p>
<p>I’m sure we’ll end up finding (and fixing) issues once more people start using the code, but I think these results show that the new functionality in <code>rdDetermineBonds</code> works quite well!</p>
</section>
<section id="benchmarking-the-code" class="level1">
<h1>Benchmarking the code</h1>
<p>The last question I had, and I will definitely stop after this, is how long it takes to run the code. Let’s check that.</p>
<p>I just want to time <code>DetermineBonds()</code> part, so let’s construct the molecules in advance:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:45.446017Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:45.179115Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> rdBase</span>
<span id="cb36-2"><span class="cf" style="color: #003B4F;">with</span> rdBase.BlockLogs():</span>
<span id="cb36-3">    tmols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb36-4">    <span class="cf" style="color: #003B4F;">for</span> fn,ind,gdb_smi,relax_smi <span class="kw" style="color: #003B4F;">in</span> qm9_data:</span>
<span id="cb36-5">        <span class="co" style="color: #5E5E5E;"># the RDKit can't parse some of the SMILES from QM9... skip those</span></span>
<span id="cb36-6">        mol <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromXYZBlock(ind)</span>
<span id="cb36-7">        <span class="cf" style="color: #003B4F;">if</span> mol <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb36-8">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb36-9">        tmols.append(mol)</span>
<span id="cb36-10"><span class="bu" style="color: null;">len</span>(tmols)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>9991</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-18T06:40:50.623429Z&quot;,&quot;start_time&quot;:&quot;2022-12-18T06:40:45.446902Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="op" style="color: #5E5E5E;">%</span>timeit [rdDetermineBonds.DetermineBonds(m,charge<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> tmols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>646 ms ± 2.95 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>We can do almost 10K molecules in 646 ms, that’s about 65 μs per molecule. So running <code>DetermineBonds()</code> shouldn’t be a bottleneck in any workflows. :-)</p>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>3d</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-12-18-introducing-rdDetermineBonds.html</guid>
  <pubDate>Sat, 17 Dec 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/introducing-rdDetermineBonds-img1.png" medium="image" type="image/png" height="57" width="144"/>
</item>
<item>
  <title>Timing methods for serializing molecules</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-12-09-timing-text-methods-for-serializing-mols.html</link>
  <description><![CDATA[ 



<p>This is just a short one, mainly to have the information online to use as a reference.</p>
<p>The RDKit has a number of different ways of serializing and deserializing molecules (converting them to and from strings). This post looks at how long it takes to do that with the three serialization approaches I normally recommend: 1. CXSMILES 2. The RDKit’s internal binary format 3. the RDKit’s variant of <a href="https://github.com/CommonChem/CommonChem">commonchem</a> JSON.</p>
<p>I looked at just serializing the molecular structure, including atomic coordinates, and serializing a few propertis together with the molecule.</p>
<p>Note that this isn’t exactly comparing apples to apples: the binary and JSON formats both capture more or less the full perceived state of the molecule (aromaticity, ring systems, etc), while the CXSMILES variant doesn’t include the ring information.</p>
<p>Here are the timing results for 50K molecules from ChEMBL. I ran this on my normal desktop machine, a 3-year old Dell desktop with a 3.1GHz Intel Core9 CPU. I’m running the conda-forge RDKit build.</p>
<p>Times are in seconds</p>
<p><strong>Writing</strong></p>
<table class="table">
<thead>
<tr class="header">
<th>Method</th>
<th>Mol</th>
<th>Mol + coordinates</th>
<th>Mol + properties</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CXSMILES</td>
<td>3.9</td>
<td>6.4</td>
<td>N/A</td>
</tr>
<tr class="even">
<td>Pickle</td>
<td>1.31</td>
<td>1.48</td>
<td>1.44</td>
</tr>
<tr class="odd">
<td>JSON</td>
<td>2.4</td>
<td>3.1</td>
<td>4.1</td>
</tr>
</tbody>
</table>
<p><strong>Reading</strong></p>
<table class="table">
<thead>
<tr class="header">
<th>Method</th>
<th>Mol</th>
<th>Mol + coordinates</th>
<th>Mol + properties</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CXSMILES</td>
<td>1.56</td>
<td>3.78</td>
<td>N/A</td>
</tr>
<tr class="even">
<td>Pickle</td>
<td>0.9</td>
<td>1.14</td>
<td>1.16</td>
</tr>
<tr class="odd">
<td>JSON</td>
<td>1.66</td>
<td>2.08</td>
<td>2.14</td>
</tr>
</tbody>
</table>
<p>The binary format is, of course, the fastest. The JSON format is slower than that, but it’s still faster than using CXSMILES when serializing coordinates and roughly equivalent to CXSMILES when just storing the molecule (but, as noted above, the JSON contains more info than the CXSMILES does).</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:57:52.647808Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:57:52.542335Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">import</span> gzip</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-5"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.09.1</code></pre>
</div>
</div>
<p>Read in a set of 50K ChEMBL molecules that we’ll use for the testing.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:57:59.891842Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:57:52.649355Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">mols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb3-2">suppl <span class="op" style="color: #5E5E5E;">=</span> Chem.SmilesMolSupplier(<span class="st" style="color: #20794D;">'../data/new_chembl_document_activity_set.smi'</span>)</span>
<span id="cb3-3"><span class="cf" style="color: #003B4F;">while</span> <span class="bu" style="color: null;">len</span>(mols)<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">50000</span>:</span>
<span id="cb3-4">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb3-5">        m <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">next</span>(suppl)</span>
<span id="cb3-6">    <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">StopIteration</span>:</span>
<span id="cb3-7">        <span class="cf" style="color: #003B4F;">break</span><span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb3-8">    mols.append(m)</span>
<span id="cb3-9">    </span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:57:59.900161Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:57:59.893106Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="bu" style="color: null;">len</span>(mols)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>50000</code></pre>
</div>
</div>
<p>This class makes timing our runs easier:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:00.082129Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:57:59.901949Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;">class</span> timer(<span class="bu" style="color: null;">object</span>):</span>
<span id="cb6-2">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__init__</span>(<span class="va" style="color: #111111;">self</span>, <span class="op" style="color: #5E5E5E;">*</span>args, <span class="op" style="color: #5E5E5E;">**</span>kwargs):</span>
<span id="cb6-3">        <span class="cf" style="color: #003B4F;">pass</span></span>
<span id="cb6-4">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__enter__</span>(<span class="va" style="color: #111111;">self</span>):</span>
<span id="cb6-5">        <span class="va" style="color: #111111;">self</span>.t1<span class="op" style="color: #5E5E5E;">=</span>time.time()</span>
<span id="cb6-6">    <span class="kw" style="color: #003B4F;">def</span> <span class="fu" style="color: #4758AB;">__exit__</span>(<span class="va" style="color: #111111;">self</span>, <span class="bu" style="color: null;">type</span>, value, traceback):</span>
<span id="cb6-7">        delta <span class="op" style="color: #5E5E5E;">=</span> time.time()<span class="op" style="color: #5E5E5E;">-</span><span class="va" style="color: #111111;">self</span>.t1</span>
<span id="cb6-8">        <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'That took </span><span class="sc" style="color: #5E5E5E;">{</span>delta<span class="sc" style="color: #5E5E5E;">:.2f}</span><span class="ss" style="color: #20794D;"> seconds'</span>)</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T05:52:42.589997Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T05:52:42.586522Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">jsons[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>'{"commonchem":{"version":10},"defaults":{"atom":{"z":6,"impHs":0,"chg":0,"nRad":0,"isotope":0,"stereo":"unspecified"},"bond":{"bo":1,"stereo":"unspecified"}},"molecules":[{"name":"436078","atoms":[{"z":8,"chg":-1},{"z":7,"chg":1},{"z":8},{},{"impHs":1},{"impHs":1},{},{"z":7},{},{"z":8},{"impHs":1,"stereo":"ccw"},{"impHs":1},{"impHs":2},{"impHs":2},{"impHs":1},{"z":8},{"impHs":1,"stereo":"ccw"},{},{"z":8},{},{"impHs":1},{"impHs":1},{"impHs":1},{"impHs":1},{}],"bonds":[{"atoms":[0,1]},{"bo":2,"atoms":[1,2]},{"atoms":[1,3]},{"bo":2,"atoms":[3,4]},{"atoms":[4,5]},{"bo":2,"atoms":[5,6]},{"atoms":[6,7]},{"atoms":[7,8]},{"bo":2,"atoms":[8,9]},{"atoms":[8,10]},{"atoms":[10,11]},{"atoms":[11,12]},{"atoms":[12,13]},{"atoms":[13,14]},{"atoms":[14,15]},{"atoms":[14,16]},{"atoms":[16,17]},{"bo":2,"atoms":[17,18]},{"atoms":[6,19]},{"bo":2,"atoms":[19,20]},{"atoms":[20,21]},{"bo":2,"atoms":[21,22]},{"atoms":[22,23]},{"bo":2,"atoms":[23,24]},{"atoms":[24,3]},{"atoms":[17,7]},{"atoms":[16,10]},{"atoms":[15,11]},{"atoms":[24,19]}],"properties":{"numAtoms":25,"numBonds":29,"numRings":5,"smiles":"O=C1[C@@H]2C3CCC(O3)[C@@H]2C(=O)N1c1ccc([N+](=O)[O-])c2ccccc12"},"extensions":[{"name":"rdkitRepresentation","formatVersion":2,"toolkitVersion":"2022.09.1","aromaticAtoms":[3,4,5,6,19,20,21,22,23,24],"aromaticBonds":[3,4,5,18,19,20,21,22,23,24,28],"cipRanks":[23,19,24,13,7,6,12,18,16,21,8,14,0,1,15,20,9,17,22,10,4,2,3,5,11],"cipCodes":[[10,"S"],[16,"R"]],"atomRings":[[3,24,19,6,5,4],[8,7,17,16,10],[12,11,15,14,13],[15,14,16,10,11],[20,21,22,23,24,19]]}]}]}'</code></pre>
</div>
</div>
<section id="molecules-without-conformers" class="level1">
<h1>Molecules without conformers</h1>
<p>Generating CXSMILES:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:04.103873Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:00.086671Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb9-2">    smis <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolToCXSmiles(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 3.88 seconds</code></pre>
</div>
</div>
<p>Generating the RDKit’s binary format:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:05.419327Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:04.105062Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb11-2">    pkls <span class="op" style="color: #5E5E5E;">=</span> [m.ToBinary() <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.31 seconds</code></pre>
</div>
</div>
<p>Generating the RDKit’s variant of <a href="https://github.com/CommonChem/CommonChem">commonchem</a> JSON:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:07.825913Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:05.420333Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb13-2">    jsons <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolToJSON(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 2.40 seconds</code></pre>
</div>
</div>
<p>Generating JSON for all of the molecules at once:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:10.657864Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:07.826983Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb15-2">    allJson <span class="op" style="color: #5E5E5E;">=</span> Chem.MolsToJSON(mols)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 2.83 seconds</code></pre>
</div>
</div>
<p>Now look at reading the molecules.</p>
<p>Start from SMILES, but skip full sanitization since we know that the chemistry and aromaticity are correct:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:13.120885Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:10.658914Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb17-2">    <span class="cf" style="color: #003B4F;">for</span> smi <span class="kw" style="color: #003B4F;">in</span> smis:</span>
<span id="cb17-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(smi,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb17-4">        m.UpdatePropertyCache()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.56 seconds</code></pre>
</div>
</div>
<p>From the binary format:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:14.048187Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:13.122950Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb19-2">    <span class="cf" style="color: #003B4F;">for</span> pkl <span class="kw" style="color: #003B4F;">in</span> pkls:</span>
<span id="cb19-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(pkl)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 0.92 seconds</code></pre>
</div>
</div>
<p>And the two variants for parsing JSON:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:15.712186Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:14.049254Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb21-2">    <span class="cf" style="color: #003B4F;">for</span> js <span class="kw" style="color: #003B4F;">in</span> jsons:</span>
<span id="cb21-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.JSONToMols(js)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.66 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:17.206460Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:15.713387Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb23-2">    _ <span class="op" style="color: #5E5E5E;">=</span> Chem.JSONToMols(allJson)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.49 seconds</code></pre>
</div>
</div>
</section>
<section id="molecules-with-a-conformer" class="level1">
<h1>Molecules with a conformer</h1>
<p>Add a conformer to each molecule (which will be written to the output) and re-do the timing runs:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:28.728407Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:17.207590Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb25-2"><span class="cf" style="color: #003B4F;">for</span> mol <span class="kw" style="color: #003B4F;">in</span> mols:</span>
<span id="cb25-3">    rdDepictor.Compute2DCoords(mol)</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:35.160370Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:28.729540Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb26-2">    smis <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolToCXSmiles(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 6.43 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:35.164280Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:35.161396Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">smis[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>'O=C1[C@@H]2C3CCC(O3)[C@@H]2C(=O)N1c1ccc([N+](=O)[O-])c2ccccc12 |(-1.03854,-2.25072,;-1.65866,-0.884909,;-3.12813,-0.583792,;-4.49394,-1.20391,;-5.96341,-0.902797,;-6.13112,0.587798,;-4.7653,1.20792,;-3.75347,0.100581,;-3.29584,0.906803,;-1.93002,1.52692,;-1.62891,2.99639,;-0.918193,0.419586,;0.572402,0.587296,;1.17246,1.96204,;2.66305,2.12976,;3.55359,0.922718,;5.04419,1.09043,;5.93473,-0.116609,;5.64424,2.46518,;2.95354,-0.452031,;3.84407,-1.65907,;3.24402,-3.03382,;1.75342,-3.20153,;0.862885,-1.99449,;1.46294,-0.619741,)|'</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:36.769456Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:35.165809Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb30-2">    pkls <span class="op" style="color: #5E5E5E;">=</span> [m.ToBinary() <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.48 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:39.847219Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:36.770859Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb32-2">    jsons <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolToJSON(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 3.07 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:43.635706Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:39.848792Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb34-2">    <span class="cf" style="color: #003B4F;">for</span> smi <span class="kw" style="color: #003B4F;">in</span> smis:</span>
<span id="cb34-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(smi,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb34-4">        m.UpdatePropertyCache()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 3.78 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:44.776245Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:43.636980Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb36-2">    <span class="cf" style="color: #003B4F;">for</span> pkl <span class="kw" style="color: #003B4F;">in</span> pkls:</span>
<span id="cb36-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(pkl)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.14 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:46.859527Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:44.777172Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb38-2">    <span class="cf" style="color: #003B4F;">for</span> js <span class="kw" style="color: #003B4F;">in</span> jsons:</span>
<span id="cb38-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.JSONToMols(js)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 2.08 seconds</code></pre>
</div>
</div>
</section>
<section id="molecules-with-properties" class="level1">
<h1>Molecules with properties</h1>
<p>Since all three formats can also save properties, see how those impact writing and parsing times:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:51.694045Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:46.860730Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="cf" style="color: #003B4F;">for</span> mol <span class="kw" style="color: #003B4F;">in</span> mols:</span>
<span id="cb40-2">    mol.RemoveAllConformers()</span>
<span id="cb40-3">    mol.SetIntProp(<span class="st" style="color: #20794D;">'numAtoms'</span>,mol.GetNumAtoms())</span>
<span id="cb40-4">    mol.SetIntProp(<span class="st" style="color: #20794D;">'numBonds'</span>,mol.GetNumBonds())</span>
<span id="cb40-5">    mol.SetIntProp(<span class="st" style="color: #20794D;">'numRings'</span>,mol.GetRingInfo().NumRings())</span>
<span id="cb40-6">    mol.SetProp(<span class="st" style="color: #20794D;">'smiles'</span>,Chem.MolToSmiles(mol))</span>
<span id="cb40-7">    </span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:53.139144Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:51.695108Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb41-2">    pkls <span class="op" style="color: #5E5E5E;">=</span> [m.ToBinary(Chem.PropertyPickleOptions.MolProps) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.44 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:57.228644Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:53.140068Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb43-2">    jsons <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolToJSON(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mols]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 4.09 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:58:58.387478Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:57.229722Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb45-2">    <span class="cf" style="color: #003B4F;">for</span> pkl <span class="kw" style="color: #003B4F;">in</span> pkls:</span>
<span id="cb45-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(pkl)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 1.16 seconds</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-12-09T04:59:00.526830Z&quot;,&quot;start_time&quot;:&quot;2022-12-09T04:58:58.388913Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="cf" style="color: #003B4F;">with</span> timer() <span class="im" style="color: #00769E;">as</span> cm:</span>
<span id="cb47-2">    <span class="cf" style="color: #003B4F;">for</span> js <span class="kw" style="color: #003B4F;">in</span> jsons:</span>
<span id="cb47-3">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.JSONToMols(js)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>That took 2.14 seconds</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>reference</category>
  <category>optimization</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-12-09-timing-text-methods-for-serializing-mols.html</guid>
  <pubDate>Thu, 08 Dec 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/timing-text-methods1-1.png" medium="image" type="image/png" height="91" width="144"/>
</item>
<item>
  <title>Dealing with multiconformer SD files</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-10-28-dealing-with-multiconformer-sd-files.html</link>
  <description><![CDATA[ 



<p>A recurring question is how to save and share multi-conformer molecules. The easiest (and fastest) way to do this in the RDKit is to just pickle the molecules. It’s not significantly more difficult to use <code>rdMolInterchange.MolToJSON()</code> to serialize the molecules as JSON. Neither of these methods work if you want to work with other tools, so we’re frequently stuck with using something like SD files.</p>
<p>The topic came up in the lab today, so I figured I’d do a blog post looking at how to create and work with multi-conformer SD files as well as multi-molecule, multi-conformer SD files with the RDKit. Memo to myself: some of this should probably also end up in the Cookbook.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:38:29.761990Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:38:29.429806Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-4">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-7"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.5</code></pre>
</div>
</div>
<p>Start by generating conformers for doravirine, lenalidomide, and mutanobactin:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:38:30.519620Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:38:30.446746Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">dorav <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'Cn1c(n[nH]c1=O)Cn2ccc(c(c2=O)Oc3cc(cc(c3)Cl)C#N)C(F)(F)F'</span>)</span>
<span id="cb3-2">lenal <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'O=C1NC(=O)CCC1N3C(=O)c2cccc(c2C3)N'</span>)</span>
<span id="cb3-3">mutanob <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'CCCCCCCCCC(=O)[C@@H]1[C@@H]2CNC(=O)[C@H](CS2)NC(=O)[C@@H](NC(=O)[C@@H]3CCCN3C(=O)[C@H](NC(=O)[C@@H](NC1=O)CC(C)C)C)C(C)C'</span>)</span>
<span id="cb3-4"></span>
<span id="cb3-5">Draw.MolsToGridImage([dorav,lenal,mutanob],subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">300</span>,<span class="dv" style="color: #AD0000;">250</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-10-28-dealing-with-multiconformer-SD-files_files/figure-html/cell-3-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:38:53.373678Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:38:34.149600Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDistGeom</span>
<span id="cb4-2"></span>
<span id="cb4-3">ps <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.ETKDGv3()</span>
<span id="cb4-4">ps.randomSeed <span class="op" style="color: #5E5E5E;">=</span> <span class="bn" style="color: #AD0000;">0xf00d</span></span>
<span id="cb4-5">ps.numThreads <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb4-6">ps.pruneRmsThresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb4-7"></span>
<span id="cb4-8"></span>
<span id="cb4-9">dorav <span class="op" style="color: #5E5E5E;">=</span> Chem.AddHs(dorav)</span>
<span id="cb4-10">lenal <span class="op" style="color: #5E5E5E;">=</span> Chem.AddHs(lenal)</span>
<span id="cb4-11">mutanob <span class="op" style="color: #5E5E5E;">=</span> Chem.AddHs(mutanob)</span>
<span id="cb4-12"></span>
<span id="cb4-13">d_cids <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.EmbedMultipleConfs(dorav,<span class="dv" style="color: #AD0000;">200</span>,ps)</span>
<span id="cb4-14">l_cids <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.EmbedMultipleConfs(lenal,<span class="dv" style="color: #AD0000;">200</span>,ps)</span>
<span id="cb4-15">m_cids <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.EmbedMultipleConfs(mutanob,<span class="dv" style="color: #AD0000;">200</span>,ps)</span>
<span id="cb4-16"></span>
<span id="cb4-17"></span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="bu" style="color: null;">print</span>(dorav.GetNumConformers(),lenal.GetNumConformers(),mutanob.GetNumConformers())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>58 7 200</code></pre>
</div>
</div>
<p>Now let’s start with a digression and quickly demo the two easy ways of storing and retrieving this multi-conformer molecule: pickling and using JSON:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:04.508476Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:04.502653Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb6-2"></span>
<span id="cb6-3">pkl <span class="op" style="color: #5E5E5E;">=</span> pickle.dumps(dorav)</span>
<span id="cb6-4">nmol <span class="op" style="color: #5E5E5E;">=</span> pickle.loads(pkl)</span>
<span id="cb6-5">nmol.GetNumConformers()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>58</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:04.983577Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:04.965939Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolInterchange</span>
<span id="cb8-2">mjs <span class="op" style="color: #5E5E5E;">=</span> rdMolInterchange.MolToJSON(dorav)</span>
<span id="cb8-3">nmol <span class="op" style="color: #5E5E5E;">=</span> rdMolInterchange.JSONToMols(mjs)[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb8-4">nmol.GetNumConformers()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>58</code></pre>
</div>
</div>
<p>Just out of curiosity let’s see how long those take:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:19.232948Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:06.070747Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="op" style="color: #5E5E5E;">%</span>timeit pickle.dumps(dorav)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>162 µs ± 1.33 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:33.430174Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:19.233999Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="op" style="color: #5E5E5E;">%</span>timeit pickle.loads(pkl)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>175 µs ± 1.44 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:38.689461Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:33.431762Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="op" style="color: #5E5E5E;">%</span>timeit rdMolInterchange.MolToJSON(dorav)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>646 µs ± 12.7 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:40.753562Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:38.690593Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="op" style="color: #5E5E5E;">%</span>timeit rdMolInterchange.JSONToMols(mjs)[<span class="dv" style="color: #AD0000;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>252 µs ± 3.5 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</code></pre>
</div>
</div>
<p>Write those to an SDF “file”</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:40.771197Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:40.755020Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> StringIO</span>
<span id="cb18-2">sio <span class="op" style="color: #5E5E5E;">=</span> StringIO()</span>
<span id="cb18-3">w <span class="op" style="color: #5E5E5E;">=</span> Chem.SDWriter(sio)</span>
<span id="cb18-4"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> d_cids:</span>
<span id="cb18-5">    w.write(dorav,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb18-6">w.flush()</span>
<span id="cb18-7">sdf <span class="op" style="color: #5E5E5E;">=</span> sio.getvalue()</span></code></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:40.994494Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:40.772671Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">sdf[:<span class="dv" style="color: #AD0000;">100</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>'\n     RDKit          3D\n\n 40 42  0  0  0  0  0  0  0  0999 V2000\n   -3.5730   -0.0689    0.9965 C   '</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:41.123106Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:40.999926Z&quot;}" data-scrolled="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> BytesIO</span>
<span id="cb21-2"></span>
<span id="cb21-3">bio <span class="op" style="color: #5E5E5E;">=</span> BytesIO(sdf.encode())</span>
<span id="cb21-4">suppl <span class="op" style="color: #5E5E5E;">=</span> Chem.ForwardSDMolSupplier(bio)</span>
<span id="cb21-5"></span>
<span id="cb21-6">ref <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">next</span>(suppl)</span>
<span id="cb21-7"><span class="cf" style="color: #003B4F;">for</span> mol <span class="kw" style="color: #003B4F;">in</span> suppl:</span>
<span id="cb21-8">    ref.AddConformer(mol.GetConformer(),assignId<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb21-9"></span>
<span id="cb21-10"><span class="bu" style="color: null;">print</span>(ref.GetNumConformers())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>58</code></pre>
</div>
</div>
<p>Again: how long does this take?</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:49.212238Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:41.124801Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="op" style="color: #5E5E5E;">%</span>timeit sio<span class="op" style="color: #5E5E5E;">=</span>StringIO()<span class="op" style="color: #5E5E5E;">;</span>w<span class="op" style="color: #5E5E5E;">=</span>Chem.SDWriter(sio)<span class="op" style="color: #5E5E5E;">;</span>[w.write(dorav,confId<span class="op" style="color: #5E5E5E;">=</span>cid) <span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> d_cids]<span class="op" style="color: #5E5E5E;">;</span>w.flush()<span class="op" style="color: #5E5E5E;">;</span>sdf<span class="op" style="color: #5E5E5E;">=</span>sio.getvalue()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9.85 ms ± 213 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:39:59.848187Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:39:49.213366Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="op" style="color: #5E5E5E;">%</span>timeit bio<span class="op" style="color: #5E5E5E;">=</span>BytesIO(sdf.encode())<span class="op" style="color: #5E5E5E;">;</span>suppl<span class="op" style="color: #5E5E5E;">=</span>Chem.ForwardSDMolSupplier(bio)<span class="op" style="color: #5E5E5E;">;</span>ref<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">next</span>(suppl)<span class="op" style="color: #5E5E5E;">;</span>[ref.AddConformer(m.GetConformer(),assignId<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> suppl]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>13.1 ms ± 250 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
</div>
<p>Ok, that was pretty easy. What about handling SDFs which contain multiple conformers of more than one molecule?</p>
<p>Start by creating an SDF with all conformers of all three molecules:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:40:14.467601Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:40:14.318834Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> StringIO</span>
<span id="cb27-2">sio <span class="op" style="color: #5E5E5E;">=</span> StringIO()</span>
<span id="cb27-3">w <span class="op" style="color: #5E5E5E;">=</span> Chem.SDWriter(sio)</span>
<span id="cb27-4"></span>
<span id="cb27-5">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(dorav)</span>
<span id="cb27-6">mol.SetProp(<span class="st" style="color: #20794D;">'_Name'</span>,<span class="st" style="color: #20794D;">'doravirine'</span>)</span>
<span id="cb27-7"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> d_cids:</span>
<span id="cb27-8">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb27-9">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(lenal)</span>
<span id="cb27-10">mol.SetProp(<span class="st" style="color: #20794D;">'_Name'</span>,<span class="st" style="color: #20794D;">'lenalidomide'</span>)</span>
<span id="cb27-11"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> l_cids:</span>
<span id="cb27-12">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb27-13">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(mutanob)</span>
<span id="cb27-14">mol.SetProp(<span class="st" style="color: #20794D;">'_Name'</span>,<span class="st" style="color: #20794D;">'mutanobactin'</span>)</span>
<span id="cb27-15"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> m_cids:</span>
<span id="cb27-16">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb27-17"></span>
<span id="cb27-18">    </span>
<span id="cb27-19">w.flush()</span>
<span id="cb27-20">multimol_sdf <span class="op" style="color: #5E5E5E;">=</span> sio.getvalue()</span></code></pre></div>
</div>
<p>And here’s a function to return the molecules from a multi-molecule, multi-conformer supplier:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:40:18.070499Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:40:18.067797Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="kw" style="color: #003B4F;">def</span> mols_from_multimol_multiconf_supplier(supplier,propertyName<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'_Name'</span>):</span>
<span id="cb28-2">    mol <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb28-3">    <span class="cf" style="color: #003B4F;">for</span> itm <span class="kw" style="color: #003B4F;">in</span> supplier:</span>
<span id="cb28-4">        <span class="cf" style="color: #003B4F;">if</span> itm <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb28-5">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb28-6">        <span class="cf" style="color: #003B4F;">if</span> mol <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb28-7">            mol <span class="op" style="color: #5E5E5E;">=</span> itm</span>
<span id="cb28-8">            refVal <span class="op" style="color: #5E5E5E;">=</span> mol.GetProp(propertyName)</span>
<span id="cb28-9">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb28-10">        pVal <span class="op" style="color: #5E5E5E;">=</span> itm.GetProp(propertyName)</span>
<span id="cb28-11">        <span class="cf" style="color: #003B4F;">if</span> pVal <span class="op" style="color: #5E5E5E;">==</span> refVal:</span>
<span id="cb28-12">            mol.AddConformer(itm.GetConformer(),assignId<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb28-13">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb28-14">            <span class="co" style="color: #5E5E5E;"># we're done with the last molecule, so let's restart the next one</span></span>
<span id="cb28-15">            res <span class="op" style="color: #5E5E5E;">=</span> mol</span>
<span id="cb28-16">            mol <span class="op" style="color: #5E5E5E;">=</span> itm</span>
<span id="cb28-17">            refVal <span class="op" style="color: #5E5E5E;">=</span> pVal</span>
<span id="cb28-18">            <span class="cf" style="color: #003B4F;">yield</span> res</span>
<span id="cb28-19">    </span>
<span id="cb28-20">    <span class="cf" style="color: #003B4F;">yield</span> mol</span></code></pre></div>
</div>
<p>Now try that out:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:40:18.824996Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:40:18.684942Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> BytesIO</span>
<span id="cb29-2"></span>
<span id="cb29-3">bio <span class="op" style="color: #5E5E5E;">=</span> BytesIO(multimol_sdf.encode())</span>
<span id="cb29-4">suppl <span class="op" style="color: #5E5E5E;">=</span> Chem.ForwardSDMolSupplier(bio)</span>
<span id="cb29-5"></span>
<span id="cb29-6">ms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mols_from_multimol_multiconf_supplier(suppl)]</span>
<span id="cb29-7"><span class="bu" style="color: null;">print</span>([m.GetNumConformers() <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[58, 7, 200]</code></pre>
</div>
</div>
<p>By default the function uses the molecule names, but we can use other property names if we want:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2022-10-28T14:45:28.870663Z&quot;,&quot;start_time&quot;:&quot;2022-10-28T14:45:28.598013Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> StringIO</span>
<span id="cb31-2">sio <span class="op" style="color: #5E5E5E;">=</span> StringIO()</span>
<span id="cb31-3">w <span class="op" style="color: #5E5E5E;">=</span> Chem.SDWriter(sio)</span>
<span id="cb31-4"></span>
<span id="cb31-5">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(dorav)</span>
<span id="cb31-6">mol.SetProp(<span class="st" style="color: #20794D;">'molecule_id'</span>,<span class="st" style="color: #20794D;">'doravirine'</span>)</span>
<span id="cb31-7"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> d_cids:</span>
<span id="cb31-8">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb31-9">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(lenal)</span>
<span id="cb31-10">mol.SetProp(<span class="st" style="color: #20794D;">'molecule_id'</span>,<span class="st" style="color: #20794D;">'lenalidomide'</span>)</span>
<span id="cb31-11"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> l_cids:</span>
<span id="cb31-12">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb31-13">mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(mutanob)</span>
<span id="cb31-14">mol.SetProp(<span class="st" style="color: #20794D;">'molecule_id'</span>,<span class="st" style="color: #20794D;">'mutanobactin'</span>)</span>
<span id="cb31-15"><span class="cf" style="color: #003B4F;">for</span> cid <span class="kw" style="color: #003B4F;">in</span> m_cids:</span>
<span id="cb31-16">    w.write(mol,confId<span class="op" style="color: #5E5E5E;">=</span>cid)</span>
<span id="cb31-17"></span>
<span id="cb31-18">    </span>
<span id="cb31-19">w.flush()</span>
<span id="cb31-20">multimol_sdf <span class="op" style="color: #5E5E5E;">=</span> sio.getvalue()</span>
<span id="cb31-21"></span>
<span id="cb31-22">bio <span class="op" style="color: #5E5E5E;">=</span> BytesIO(multimol_sdf.encode())</span>
<span id="cb31-23">suppl <span class="op" style="color: #5E5E5E;">=</span> Chem.ForwardSDMolSupplier(bio)</span>
<span id="cb31-24"></span>
<span id="cb31-25">ms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mols_from_multimol_multiconf_supplier(suppl,propertyName<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'molecule_id'</span>)]</span>
<span id="cb31-26"><span class="bu" style="color: null;">print</span>([m.GetNumConformers() <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[58, 7, 200]</code></pre>
</div>
</div>



 ]]></description>
  <category>3d</category>
  <category>conformers</category>
  <category>tutorial</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-10-28-dealing-with-multiconformer-sd-files.html</guid>
  <pubDate>Thu, 27 Oct 2022 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/multiconformer-sdf-1.png" medium="image" type="image/png" height="168" width="144"/>
</item>
<item>
  <title>Optimizing conformer generation parameters</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters.html</link>
  <description><![CDATA[ 



<p>Whether it’s making it go faster or producing better results, we’re always on the lookout for ways to improve the RDKit’s conformer generator. Earlier this year I spent some time using a profiler to look in detail at where the code spends its time and saw that a lot of time is spent in optimizing structures using the so-called “distance geometry forcefield” (see the <a href="https://rdkit.org/docs/RDKit_Book.html#conformer-generation">documentation</a> for more details about conformer generation). Directly changing the optimization code is one of those daunting tasks which is only to be undertaken when one has a lot of time available, so I wasn’t particularly enthusiastic about that. However, while looking at the code I realized that the behavior of the optimizer is controlled by a number of parameters which have rather arbitrary values. Given that I know we never really tried to systematically find the best values for these parameters and that they definitely can have an impact on how quickly the optimizations converge (as well as how well converged they are), it seemed like adjusting these would be a logical place to try and improve things.</p>
<p>Fortunately, we had a student, Thibault Kläy, starting a semester project in the group who was willing to take on this project. This post has a brief description of what Thibault did and an exploration of the key results from his project.</p>
<p><strong>TL;DR</strong> Thibault found that increasing one of the force field convergence parameters (<code>optimizerForceTol</code>) from its default value of 0.001 to 0.0135 reduced the average run time of conformer generation by around 20% for the &gt;4000 molecules in the <a href="https://pubs.acs.org/doi/full/10.1021/acs.jcim.6b00613">Platinum set</a>. This improvement in run time came without a significant decrease in the quality of the conformers, as measured by how close we get to the crystal conformer. This will be the default value for <code>optimizerForceTol</code> starting in the 2022.09 release, but you can already change the value yourself, see below.</p>
<section id="finding-the-best-parameters" class="level2">
<h2 class="anchored" data-anchor-id="finding-the-best-parameters">Finding the best parameters</h2>
<p>At first I hoped that we’d be able to adjust the parameters while only making small changes to the conformers generated… this turned out to be competely unrealistic, so we decided to evaluate the quality of the results the same way we validated the results in the <a href="https://doi.org/10.1021/acs.jcim.5b00654">ETKDG paper</a>: by looking at how well we reproduce crystal conformers. Since using the CSD compounds we used in the original paper was complicated (from a licensing perspective), we just used the PDB structures from the <a href="https://pubs.acs.org/doi/full/10.1021/acs.jcim.6b00613">Platinum set</a>. We filtered this down to only include molecules with less than 50 heavy atoms.</p>
<p>Thibault explored changing the following parameters: - <code>optimizerForceTol</code> - <code>basinThresh</code> - <code>ERROR_TOL</code> - <code>MOVETOL</code> - <code>FORCETOL</code> - <code>TOLX</code></p>
<p>The first two of those can be modified by the user; the last four require recompiling the RDKit.</p>
<p>After running <em>a lot</em> of calculations Thibault found that the only parameters which really yielded a significant improvement in runtime performance were <code>optimizerForceTol</code> and <code>basinThresh</code>, that <code>optimizerForceTol</code> gave larger improvements, and that the results were not cumulative (so once <code>optimizerForceTol</code> was set to an optimal value changing <code>basinThresh</code> no longer really improved things).</p>
<p>The rest of this post repeats some of Thibault’s analysis to show the impact of setting <code>optimizerForceTol</code> to the new recommended value.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-3">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDistGeom</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> TorsionFingerprints</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> AllChem</span>
<span id="cb1-7"><span class="op" style="color: #5E5E5E;">%</span>matplotlib inline</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">import</span> pylab <span class="im" style="color: #00769E;">as</span> plt</span>
<span id="cb1-9">plt.style.use(<span class="st" style="color: #20794D;">'tableau-colorblind10'</span>)</span>
<span id="cb1-10">plt.rcParams[<span class="st" style="color: #20794D;">'font.size'</span>] <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'16'</span></span>
<span id="cb1-11"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-14"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.5</code></pre>
</div>
</div>
<p>Start by generating conformers using the original and updated values of <code>optimizerForceTol</code>. This takes quite a while to run:</p>
<pre><code>import gzip
import time
import pickle

etkdg = rdDistGeom.ETKDGv3()
etkdg.randomSeed = 0xa700f
etkdg.verbose = False
etkdg.numThreads = 8
conformer_num=100

# 0.001 was the default value of optimizerForceTol up to and including v2022.03
timings = []
for forceTol in ('0.001', '0.0135'):
    print(
f'''---------------------------
    forceTol: {forceTol}
---------------------------''')
    inf = gzip.open('../data/platinum_dataset_2017_01.sdf.gz')
    outf = gzip.open(f'./results/platinum_forcetol_{forceTol}.100confs.pkl.gz','wb+')
    etkdg.optimizerForceTol = float(forceTol)
    lts = []
    for i,m in enumerate(Chem.ForwardSDMolSupplier(inf,removeHs=False)):
        if not m:
            continue
        if m.GetNumHeavyAtoms()&gt;50:
            continue
        Chem.AssignStereochemistryFrom3D(m)
        start = time.time()
        conformation_ids = rdDistGeom.EmbedMultipleConfs(m, numConfs=conformer_num, params=etkdg)
        lts.append(time.time()-start)
        if not (i+1)%1000:
            print(f"***** done {i+1}")
        pickle.dump(m,outf)
    timings.append(lts)
with open('./results/optmizer_force_tol_timings.pkl','wb+') as outf:
    pickle.dump(timings,outf)
</code></pre>
<p>Repeat that exercise for random coordinate embedding, this one takes even longer.</p>
<pre><code>import gzip
import time
import pickle

etkdg = rdDistGeom.ETKDGv3()
etkdg.randomSeed = 0xa700f
etkdg.verbose = False
etkdg.numThreads = 8
etkdg.useRandomCoords = True
conformer_num=100

# 0.001 was the default value of optimizerForceTol up to and including v2022.03
timings = []
for forceTol in ('0.001', '0.0135'):
    print(
f'''---------------------------
    forceTol: {forceTol}
---------------------------''')
    inf = gzip.open('../data/platinum_dataset_2017_01.sdf.gz')
    outf = gzip.open(f'./results/platinum_forcetol_{forceTol}.random_coords.100confs.pkl.gz','wb+')
    etkdg.optimizerForceTol = float(forceTol)
    lts = []
    for i,m in enumerate(Chem.ForwardSDMolSupplier(inf,removeHs=False)):
        if not m:
            continue
        if m.GetNumHeavyAtoms()&gt;50:
            continue
        Chem.AssignStereochemistryFrom3D(m)
        start = time.time()
        conformation_ids = rdDistGeom.EmbedMultipleConfs(m, numConfs=conformer_num, params=etkdg)
        lts.append(time.time()-start)
        if not (i+1)%1000:
            print(f"***** done {i+1}")
        pickle.dump(m,outf)
    timings.append(lts)
with open('./results/optmizer_force_tol_timings.random_coords.pkl','wb+') as outf:
    pickle.dump(timings,outf)</code></pre>
</section>
<section id="standard-embedding" class="level1">
<h1>Standard embedding</h1>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/optmizer_force_tol_timings.pkl'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb5-2">   timings <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb5-3">base_runtimes,mod_runtimes <span class="op" style="color: #5E5E5E;">=</span> timings</span>
<span id="cb5-4">base_runtimes <span class="op" style="color: #5E5E5E;">=</span> np.array(base_runtimes)</span>
<span id="cb5-5">mod_runtimes <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_runtimes)</span></code></pre></div>
</div>
<p>Look at the impact on run time:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>] <span class="op" style="color: #5E5E5E;">=</span> (<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb6-2"></span>
<span id="cb6-3">plt.scatter(base_runtimes,mod_runtimes)</span>
<span id="cb6-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_runtimes<span class="op" style="color: #5E5E5E;">+</span>mod_runtimes)</span>
<span id="cb6-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb6-6">plt.xscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb6-7">plt.yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb6-8"></span>
<span id="cb6-9">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)</span>
<span id="cb6-10">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)</span>
<span id="cb6-11">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It’s clear that most of those points are below the diagonal, indicating that using the new value of <code>optimizerForceTol</code> results in shorter run times.</p>
<p>Do a histogram of the differences in run time:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">pcts <span class="op" style="color: #5E5E5E;">=</span> (base_runtimes <span class="op" style="color: #5E5E5E;">-</span> mod_runtimes) <span class="op" style="color: #5E5E5E;">/</span> base_runtimes</span>
<span id="cb7-2">plt.hist(pcts,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">40</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb7-3">plt.xlabel(<span class="st" style="color: #20794D;">'fractional runtime decrease'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb7-4">plt.title(<span class="st" style="color: #20794D;">'optimizerForceTol 0.001 vs 0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There’s an extreme outlier there, remove it so that we can actually see something:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> pcts <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">&gt;-</span><span class="fl" style="color: #AD0000;">0.5</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">40</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb8-2">plt.xlabel(<span class="st" style="color: #20794D;">'fractional runtime decrease'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb8-3">plt.title(<span class="st" style="color: #20794D;">'optimizerForceTol 0.001 vs 0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The fact that the histogram is clearly shifted to the right indicates that using <code>optimizerForceTol=0.0135</code> speeds things up for most of the molecules.</p>
<p>Now lets look at the fraction of the compounds appearing in various <img src="https://latex.codecogs.com/png.latex?%5CDelta"> time bins:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">bins <span class="op" style="color: #5E5E5E;">=</span> [<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">10</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">.1</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.05</span>,<span class="dv" style="color: #AD0000;">0</span>,<span class="fl" style="color: #AD0000;">0.05</span>,<span class="fl" style="color: #AD0000;">0.1</span>,<span class="fl" style="color: #AD0000;">0.15</span>,<span class="fl" style="color: #AD0000;">0.2</span>,<span class="fl" style="color: #AD0000;">0.25</span>,<span class="fl" style="color: #AD0000;">0.3</span>,<span class="dv" style="color: #AD0000;">10</span>]</span>
<span id="cb9-2">nPts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(pcts)</span>
<span id="cb9-3"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(bins)<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb9-4">    frac <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> pcts <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">&gt;</span>bins[i] <span class="kw" style="color: #003B4F;">and</span> x<span class="op" style="color: #5E5E5E;">&lt;=</span>bins[i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>]])<span class="op" style="color: #5E5E5E;">/</span>nPts</span>
<span id="cb9-5">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>bins[i]<span class="sc" style="color: #5E5E5E;">: .2f}</span><span class="ss" style="color: #20794D;"> - </span><span class="sc" style="color: #5E5E5E;">{</span>bins[i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>]<span class="sc" style="color: #5E5E5E;">: .2f}</span><span class="ss" style="color: #20794D;">: </span><span class="sc" style="color: #5E5E5E;">{</span>frac<span class="sc" style="color: #5E5E5E;">: .3f}</span><span class="ss" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-10.00 - -0.10:  0.017
-0.10 - -0.05:  0.009
-0.05 -  0.00:  0.014
 0.00 -  0.05:  0.036
 0.05 -  0.10:  0.095
 0.10 -  0.15:  0.194
 0.15 -  0.20:  0.263
 0.20 -  0.25:  0.206
 0.25 -  0.30:  0.112
 0.30 -  10.00:  0.054</code></pre>
</div>
</div>
<p>And a set of quantiles for the <img src="https://latex.codecogs.com/png.latex?%5CDelta"> time values:</p>
<div class="cell" data-scrolled="true" data-execution_count="29">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> [<span class="fl" style="color: #AD0000;">0.2</span>,<span class="fl" style="color: #AD0000;">0.4</span>,<span class="fl" style="color: #AD0000;">0.5</span>,<span class="fl" style="color: #AD0000;">0.6</span>,<span class="fl" style="color: #AD0000;">0.7</span>,<span class="fl" style="color: #AD0000;">0.8</span>,<span class="fl" style="color: #AD0000;">0.9</span>]:</span>
<span id="cb11-2">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>q<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> </span><span class="sc" style="color: #5E5E5E;">{</span>np<span class="sc" style="color: #5E5E5E;">.</span>quantile(pcts,q)<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.2 0.109
0.4 0.157
0.5 0.175
0.6 0.195
0.7 0.215
0.8 0.241
0.9 0.274</code></pre>
</div>
</div>
<p>Ok, so we see an overall improvement of about 20%.</p>
<p>The outliers - compounds where things got slower with the change - are also interesting to look at, but that’s a topic for a possible future post.</p>
<p>Next question: how much do the conformers change?</p>
<p>We start by doing a direct comparison of the conformers to each other.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;">import</span> gzip</span>
<span id="cb13-2"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb13-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> AllChem</span>
<span id="cb13-4"></span>
<span id="cb13-5">rms_by_mol <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb13-6"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.001.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> basef,<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb13-7">     gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.0135.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> modf:</span>
<span id="cb13-8">    <span class="cf" style="color: #003B4F;">while</span> <span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb13-9">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb13-10">            m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(basef))</span>
<span id="cb13-11">            m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(modf))</span>
<span id="cb13-12">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb13-13">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb13-14">        m_res <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb13-15">        <span class="cf" style="color: #003B4F;">for</span> conf1,conf2 <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(m1.GetConformers(),m2.GetConformers()):</span>
<span id="cb13-16">            rms <span class="op" style="color: #5E5E5E;">=</span> AllChem.GetBestRMS(m1,m2,conf1.GetId(),conf2.GetId())</span>
<span id="cb13-17">            m_res.append(rms)</span>
<span id="cb13-18">        rms_by_mol.append(m_res)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">all_rms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-2"><span class="cf" style="color: #003B4F;">for</span> t <span class="kw" style="color: #003B4F;">in</span> rms_by_mol:</span>
<span id="cb14-3">    all_rms.extend(t)</span>
<span id="cb14-4"></span>
<span id="cb14-5">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>] <span class="op" style="color: #5E5E5E;">=</span> (<span class="dv" style="color: #AD0000;">8</span>,<span class="dv" style="color: #AD0000;">6</span>)    </span>
<span id="cb14-6">plt.hist(all_rms,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">50</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-7">plt.xlabel(<span class="st" style="color: #20794D;">'RMSD'</span>)</span>
<span id="cb14-8">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, optimizerForceTol 0.001 vs 0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>So there are clear differences between the conformers generated using the two different force tolerances.</p>
<p>Do they matter? Let’s look at our ability to reproduce crystal conformers to see.</p>
<section id="comparison-to-crystal-conformers" class="level2">
<h2 class="anchored" data-anchor-id="comparison-to-crystal-conformers">Comparison to crystal conformers</h2>
<p>Is there an impact on our ability to find the crystal conformer?</p>
<section id="rmsd" class="level3">
<h3 class="anchored" data-anchor-id="rmsd">RMSD</h3>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">inf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/platinum_dataset_2017_01.sdf.gz'</span>)</span>
<span id="cb15-2"></span>
<span id="cb15-3">base_xtal_rms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb15-4">mod_xtal_rms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb15-5"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.001.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> basef,<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb15-6">     gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.0135.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> modf:</span>
<span id="cb15-7">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(Chem.ForwardSDMolSupplier(inf,removeHs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)):</span>
<span id="cb15-8">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb15-9">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb15-10">        <span class="cf" style="color: #003B4F;">if</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>:</span>
<span id="cb15-11">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb15-12">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(m)</span>
<span id="cb15-13">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb15-14">            m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(basef))</span>
<span id="cb15-15">            m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(modf))</span>
<span id="cb15-16">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb15-17">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb15-18">        base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb15-19">        mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb15-20">        <span class="cf" style="color: #003B4F;">for</span> conf1,conf2 <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(m1.GetConformers(),m2.GetConformers()):</span>
<span id="cb15-21">            rms <span class="op" style="color: #5E5E5E;">=</span> AllChem.GetBestRMS(m1,m,conf1.GetId())</span>
<span id="cb15-22">            base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(base_best,rms)</span>
<span id="cb15-23">            rms <span class="op" style="color: #5E5E5E;">=</span> AllChem.GetBestRMS(m2,m,conf2.GetId())</span>
<span id="cb15-24">            mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(mod_best,rms)</span>
<span id="cb15-25">        <span class="cf" style="color: #003B4F;">if</span> base_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span> <span class="kw" style="color: #003B4F;">and</span> mod_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span>:</span>
<span id="cb15-26">            base_xtal_rms.append(base_best)</span>
<span id="cb15-27">            mod_xtal_rms.append(mod_best)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb16-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb16-3">plt.scatter(base_xtal_rms,mod_xtal_rms)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_rms<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_rms)</span>
<span id="cb16-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb16-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb16-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, RMSD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb17-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb17-3">plt.hexbin(base_xtal_rms,mod_xtal_rms,cmap<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Blues'</span>,bins<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'log'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb17-4">outside <span class="op" style="color: #5E5E5E;">=</span> [(x,y) <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(base_xtal_rms,mod_xtal_rms) <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x<span class="op" style="color: #5E5E5E;">-</span>y)<span class="op" style="color: #5E5E5E;">&gt;</span>thresh]</span>
<span id="cb17-5">plt.scatter([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> outside],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> outside],marker<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'.'</span>)</span>
<span id="cb17-6">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_rms<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_rms)</span>
<span id="cb17-7">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb17-8">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb17-9">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb17-10">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb17-11">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb17-12">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, RMSD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Based on these plots it looks like we haven’t negatively impacted our ability to reproduce crystal conformers.</p>
<p>Let’s look at the <img src="https://latex.codecogs.com/png.latex?%5CDelta"> RMSD differences directly:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_rms)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_rms)</span>
<span id="cb18-2">plt.hist(d,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-3">plt.xlabel(<span class="st" style="color: #20794D;">'RMSD(forceTol=0.0135)-RMSD(forceTol=0.001)'</span>)</span>
<span id="cb18-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Zoom in:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_rms)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_rms)</span>
<span id="cb19-2">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x)<span class="op" style="color: #5E5E5E;">&lt;=</span><span class="fl" style="color: #AD0000;">0.75</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-3">plt.xlabel(<span class="st" style="color: #20794D;">'RMSD(forceTol=0.0135)-RMSD(forceTol=0.001)'</span>)</span>
<span id="cb19-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There really aren’t significant changes here.</p>
</section>
<section id="tfd" class="level3">
<h3 class="anchored" data-anchor-id="tfd">TFD</h3>
<p>RMSD, though familiar and intuitive, has some well-documented shortcomings. <a href="https://doi.org/10.1021/ci2002318">Torsion Fingerprint Differences (TFDs)</a> were developed as an alternative metric for comparing structures which is less susceptible to some of these problems.</p>
<p>We used TFDs in the original ETKDG paper, so let’s try them here too</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;"># The RDKit's TFD implementation doesn't currently (v2022.03) have a fast implementation of</span></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;"># the method we need, so do it directly here:</span></span>
<span id="cb20-3"><span class="kw" style="color: #003B4F;">def</span> GetBestTFDBetweenMolecules(mol1, mol2, confId1<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">1</span>, useWeights<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>, maxDev<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'equal'</span>,</span>
<span id="cb20-4">                           symmRadius<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>, ignoreColinearBonds<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>):</span>
<span id="cb20-5">  <span class="co" style="color: #5E5E5E;">""" Wrapper to calculate the TFD between two molecules.</span></span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;">      All conformers of mol2 will be compared against a single conformer of mol1</span></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;">      and the lowest TFD returned</span></span>
<span id="cb20-8"><span class="co" style="color: #5E5E5E;">      </span></span>
<span id="cb20-9"><span class="co" style="color: #5E5E5E;">      Important: The two molecules must be instances of the same molecule</span></span>
<span id="cb20-10"></span>
<span id="cb20-11"><span class="co" style="color: #5E5E5E;">      Arguments:</span></span>
<span id="cb20-12"><span class="co" style="color: #5E5E5E;">      - mol1:     first instance of the molecule of interest</span></span>
<span id="cb20-13"><span class="co" style="color: #5E5E5E;">      - mol2:     second instance the molecule of interest</span></span>
<span id="cb20-14"><span class="co" style="color: #5E5E5E;">      - confId1:  conformer index for mol1 (default: first conformer)</span></span>
<span id="cb20-15"><span class="co" style="color: #5E5E5E;">      - useWeights: flag for using torsion weights in the TFD calculation</span></span>
<span id="cb20-16"><span class="co" style="color: #5E5E5E;">      - maxDev:   maximal deviation used for normalization</span></span>
<span id="cb20-17"><span class="co" style="color: #5E5E5E;">                  'equal': all torsions are normalized using 180.0 (default)</span></span>
<span id="cb20-18"><span class="co" style="color: #5E5E5E;">                  'spec':  each torsion is normalized using its specific</span></span>
<span id="cb20-19"><span class="co" style="color: #5E5E5E;">                           maximal deviation as given in the paper</span></span>
<span id="cb20-20"><span class="co" style="color: #5E5E5E;">      - symmRadius: radius used for calculating the atom invariants</span></span>
<span id="cb20-21"><span class="co" style="color: #5E5E5E;">                    (default: 2)</span></span>
<span id="cb20-22"><span class="co" style="color: #5E5E5E;">      - ignoreColinearBonds: if True (default), single bonds adjacent to</span></span>
<span id="cb20-23"><span class="co" style="color: #5E5E5E;">                             triple bonds are ignored</span></span>
<span id="cb20-24"><span class="co" style="color: #5E5E5E;">                             if False, alternative not-covalently bound</span></span>
<span id="cb20-25"><span class="co" style="color: #5E5E5E;">                             atoms are used to define the torsion</span></span>
<span id="cb20-26"></span>
<span id="cb20-27"><span class="co" style="color: #5E5E5E;">      Return: TFD value</span></span>
<span id="cb20-28"><span class="co" style="color: #5E5E5E;">  """</span></span>
<span id="cb20-29">  <span class="cf" style="color: #003B4F;">if</span> (Chem.MolToSmiles(mol1) <span class="op" style="color: #5E5E5E;">!=</span> Chem.MolToSmiles(mol2)):</span>
<span id="cb20-30">    <span class="cf" style="color: #003B4F;">raise</span> <span class="pp" style="color: #AD0000;">ValueError</span>(<span class="st" style="color: #20794D;">"The two molecules must be instances of the same molecule!"</span>)</span>
<span id="cb20-31">  mol2 <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints._getSameAtomOrder(mol1, mol2)</span>
<span id="cb20-32">  tl, tlr <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTorsionLists(mol1, maxDev<span class="op" style="color: #5E5E5E;">=</span>maxDev, symmRadius<span class="op" style="color: #5E5E5E;">=</span>symmRadius,</span>
<span id="cb20-33">                                  ignoreColinearBonds<span class="op" style="color: #5E5E5E;">=</span>ignoreColinearBonds)</span>
<span id="cb20-34">  <span class="co" style="color: #5E5E5E;"># first molecule</span></span>
<span id="cb20-35">  torsion1 <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTorsionAngles(mol1, tl, tlr, confId<span class="op" style="color: #5E5E5E;">=</span>confId1)</span>
<span id="cb20-36">  <span class="cf" style="color: #003B4F;">if</span> useWeights:</span>
<span id="cb20-37">    weights <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTorsionWeights(mol1, ignoreColinearBonds<span class="op" style="color: #5E5E5E;">=</span>ignoreColinearBonds)</span>
<span id="cb20-38">  best <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1e8</span></span>
<span id="cb20-39">  <span class="cf" style="color: #003B4F;">for</span> conf <span class="kw" style="color: #003B4F;">in</span> mol2.GetConformers():</span>
<span id="cb20-40">    <span class="co" style="color: #5E5E5E;"># second molecule</span></span>
<span id="cb20-41">    torsion2 <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTorsionAngles(mol2, tl, tlr, confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId())</span>
<span id="cb20-42">    <span class="cf" style="color: #003B4F;">if</span> useWeights:</span>
<span id="cb20-43">      tfd <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTFD(torsion1, torsion2, weights<span class="op" style="color: #5E5E5E;">=</span>weights)</span>
<span id="cb20-44">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb20-45">      tfd <span class="op" style="color: #5E5E5E;">=</span> TorsionFingerprints.CalculateTFD(torsion1, torsion2)</span>
<span id="cb20-46">    best <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(best,tfd)</span>
<span id="cb20-47">  <span class="cf" style="color: #003B4F;">return</span> best</span></code></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">inf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/platinum_dataset_2017_01.sdf.gz'</span>)</span>
<span id="cb21-2">base_xtal_tfd <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb21-3">mod_xtal_tfd <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb21-4"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.001.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> basef,<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb21-5">     gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.0135.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> modf:</span>
<span id="cb21-6">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(Chem.ForwardSDMolSupplier(inf,removeHs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)):</span>
<span id="cb21-7">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb21-8">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb21-9">        <span class="cf" style="color: #003B4F;">if</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>:</span>
<span id="cb21-10">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb21-11">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(m)</span>
<span id="cb21-12">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb21-13">            m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(basef))</span>
<span id="cb21-14">            m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(modf))</span>
<span id="cb21-15">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb21-16">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb21-17">        base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb21-18">        mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb21-19">        base_best <span class="op" style="color: #5E5E5E;">=</span> GetBestTFDBetweenMolecules(m,m1)</span>
<span id="cb21-20">        mod_best <span class="op" style="color: #5E5E5E;">=</span> GetBestTFDBetweenMolecules(m,m2)</span>
<span id="cb21-21">        <span class="cf" style="color: #003B4F;">if</span> base_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span> <span class="kw" style="color: #003B4F;">and</span> mod_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span>:</span>
<span id="cb21-22">            base_xtal_tfd.append(base_best)</span>
<span id="cb21-23">            mod_xtal_tfd.append(mod_best)</span>
<span id="cb21-24">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> (i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">500</span>:</span>
<span id="cb21-25">            <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Done </span><span class="sc" style="color: #5E5E5E;">{</span>i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done 500
Done 1000
Done 1500
Done 2000
Done 2500
Done 3000
Done 3500
Done 4000
Done 4500</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span></span>
<span id="cb23-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb23-3">plt.scatter(base_xtal_tfd,mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb23-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_tfd<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_tfd)</span>
<span id="cb23-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb23-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb23-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb23-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb23-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb23-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, TFD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span></span>
<span id="cb24-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb24-3">plt.hexbin(base_xtal_tfd,mod_xtal_tfd,cmap<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Blues'</span>,bins<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'log'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb24-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_tfd<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_tfd)</span>
<span id="cb24-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb24-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb24-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb24-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb24-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb24-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, TFD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Look at the histogram of the changes in TFD between the two methods</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_tfd)</span>
<span id="cb25-2">plt.hist(d,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-3">plt.xlabel(<span class="st" style="color: #20794D;">'TFD(forceTol=0.0135)-TFD(forceTol=0.001)'</span>)</span>
<span id="cb25-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Zoom in:</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_tfd)</span>
<span id="cb26-2">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x)<span class="op" style="color: #5E5E5E;">&lt;</span><span class="fl" style="color: #AD0000;">0.1</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-3">plt.xlabel(<span class="st" style="color: #20794D;">'TFD(forceTol=0.0135)-TFD(forceTol=0.001)'</span>)</span>
<span id="cb26-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Conclusion: the updated force field parameters don’t have a much of an impact at all on our ability to reproduce crystal conformers as measured by TFD.</p>
</section>
</section>
</section>
<section id="repeat-the-analysis-for-random-coordinate-embedding" class="level1">
<h1>Repeat the analysis for random-coordinate embedding</h1>
<p>The <a href="https://www.sciencedirect.com/science/article/abs/pii/S1093326397000144">random-coordinate embedding scheme</a> is more robust than standard embedding, but it is (as implemented in the RDKit) also slower. Let’s see how much it is affected by the modified <code>optimizerForceTol</code></p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb27-2"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/optmizer_force_tol_timings.random_coords.pkl'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb27-3">   timings <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb27-4">base_runtimes,mod_runtimes <span class="op" style="color: #5E5E5E;">=</span> timings</span>
<span id="cb27-5">base_runtimes <span class="op" style="color: #5E5E5E;">=</span> np.array(base_runtimes)</span>
<span id="cb27-6">mod_runtimes <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_runtimes)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>] <span class="op" style="color: #5E5E5E;">=</span> (<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb28-2"></span>
<span id="cb28-3">plt.scatter(base_runtimes,mod_runtimes)</span>
<span id="cb28-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_runtimes<span class="op" style="color: #5E5E5E;">+</span>mod_runtimes)</span>
<span id="cb28-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb28-6">plt.xscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb28-7">plt.yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb28-8"></span>
<span id="cb28-9">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)</span>
<span id="cb28-10">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)</span>
<span id="cb28-11">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">pcts <span class="op" style="color: #5E5E5E;">=</span> (base_runtimes <span class="op" style="color: #5E5E5E;">-</span> mod_runtimes) <span class="op" style="color: #5E5E5E;">/</span> base_runtimes</span>
<span id="cb29-2">plt.hist(pcts,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">40</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb29-3">plt.xlabel(<span class="st" style="color: #20794D;">'fractional runtime decrease'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb29-4">plt.title(<span class="st" style="color: #20794D;">'optimizerForceTol 0.001 vs 0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> pcts <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">&gt;-</span><span class="fl" style="color: #AD0000;">0.5</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">40</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb30-2">plt.xlabel(<span class="st" style="color: #20794D;">'fractional runtime decrease'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb30-3">plt.title(<span class="st" style="color: #20794D;">'optimizerForceTol 0.001 vs 0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There are a small number of compounds here where things get worse, but it looks like there is an overall improvement similar to what we saw before.</p>
<p>Look at the bins and quantiles to quantify that:</p>
<div class="cell" data-scrolled="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">bins <span class="op" style="color: #5E5E5E;">=</span> [<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">10</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">.1</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.05</span>,<span class="dv" style="color: #AD0000;">0</span>,<span class="fl" style="color: #AD0000;">0.05</span>,<span class="fl" style="color: #AD0000;">0.1</span>,<span class="fl" style="color: #AD0000;">0.15</span>,<span class="fl" style="color: #AD0000;">0.2</span>,<span class="fl" style="color: #AD0000;">0.25</span>,<span class="fl" style="color: #AD0000;">0.3</span>,<span class="dv" style="color: #AD0000;">10</span>]</span>
<span id="cb31-2">nPts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(pcts)</span>
<span id="cb31-3"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(bins)<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb31-4">    frac <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> pcts <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">&gt;</span>bins[i] <span class="kw" style="color: #003B4F;">and</span> x<span class="op" style="color: #5E5E5E;">&lt;=</span>bins[i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>]])<span class="op" style="color: #5E5E5E;">/</span>nPts</span>
<span id="cb31-5">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>bins[i]<span class="sc" style="color: #5E5E5E;">: .2f}</span><span class="ss" style="color: #20794D;"> - </span><span class="sc" style="color: #5E5E5E;">{</span>bins[i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>]<span class="sc" style="color: #5E5E5E;">: .2f}</span><span class="ss" style="color: #20794D;">: </span><span class="sc" style="color: #5E5E5E;">{</span>frac<span class="sc" style="color: #5E5E5E;">: .3f}</span><span class="ss" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-10.00 - -0.10:  0.040
-0.10 - -0.05:  0.010
-0.05 -  0.00:  0.019
 0.00 -  0.05:  0.034
 0.05 -  0.10:  0.057
 0.10 -  0.15:  0.115
 0.15 -  0.20:  0.210
 0.20 -  0.25:  0.261
 0.25 -  0.30:  0.185
 0.30 -  10.00:  0.069</code></pre>
</div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> [<span class="fl" style="color: #AD0000;">0.2</span>,<span class="fl" style="color: #AD0000;">0.4</span>,<span class="fl" style="color: #AD0000;">0.5</span>,<span class="fl" style="color: #AD0000;">0.6</span>,<span class="fl" style="color: #AD0000;">0.7</span>,<span class="fl" style="color: #AD0000;">0.8</span>,<span class="fl" style="color: #AD0000;">0.9</span>]:</span>
<span id="cb33-2">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>q<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> </span><span class="sc" style="color: #5E5E5E;">{</span>np<span class="sc" style="color: #5E5E5E;">.</span>quantile(pcts,q)<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.2 0.121
0.4 0.183
0.5 0.204
0.6 0.223
0.7 0.241
0.8 0.261
0.9 0.288</code></pre>
</div>
</div>
<p>So the impact here is actually a bit larger than for standard embedding.</p>
<section id="comparing-to-crystal-structures" class="level2">
<h2 class="anchored" data-anchor-id="comparing-to-crystal-structures">Comparing to crystal structures</h2>
<section id="rmsd-1" class="level3">
<h3 class="anchored" data-anchor-id="rmsd-1">RMSD</h3>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="im" style="color: #00769E;">import</span> gzip</span>
<span id="cb35-2">inf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/platinum_dataset_2017_01.sdf.gz'</span>)</span>
<span id="cb35-3"></span>
<span id="cb35-4">base_xtal_rms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb35-5">mod_xtal_rms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb35-6"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.001.random_coords.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> basef,<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb35-7">     gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.0135.random_coords.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> modf:</span>
<span id="cb35-8">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(Chem.ForwardSDMolSupplier(inf,removeHs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)):</span>
<span id="cb35-9">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb35-10">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb35-11">        <span class="cf" style="color: #003B4F;">if</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>:</span>
<span id="cb35-12">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb35-13">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(m)</span>
<span id="cb35-14">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb35-15">            m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(basef))</span>
<span id="cb35-16">            m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(modf))</span>
<span id="cb35-17">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb35-18">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb35-19">        base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb35-20">        mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb35-21">        <span class="cf" style="color: #003B4F;">for</span> conf1,conf2 <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(m1.GetConformers(),m2.GetConformers()):</span>
<span id="cb35-22">            rms <span class="op" style="color: #5E5E5E;">=</span> AllChem.GetBestRMS(m1,m,conf1.GetId())</span>
<span id="cb35-23">            base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(base_best,rms)</span>
<span id="cb35-24">            rms <span class="op" style="color: #5E5E5E;">=</span> AllChem.GetBestRMS(m2,m,conf2.GetId())</span>
<span id="cb35-25">            mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">min</span>(mod_best,rms)</span>
<span id="cb35-26">        <span class="cf" style="color: #003B4F;">if</span> base_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span> <span class="kw" style="color: #003B4F;">and</span> mod_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span>:</span>
<span id="cb35-27">            base_xtal_rms.append(base_best)</span>
<span id="cb35-28">            mod_xtal_rms.append(mod_best)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb36-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb36-3">plt.scatter(base_xtal_rms,mod_xtal_rms)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb36-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_rms<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_rms)</span>
<span id="cb36-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb36-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb36-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb36-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb36-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb36-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, RMSD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb37-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb37-3">plt.hexbin(base_xtal_rms,mod_xtal_rms,cmap<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Blues'</span>,bins<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'log'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb37-4">outside <span class="op" style="color: #5E5E5E;">=</span> [(x,y) <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(base_xtal_rms,mod_xtal_rms) <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x<span class="op" style="color: #5E5E5E;">-</span>y)<span class="op" style="color: #5E5E5E;">&gt;</span>thresh]</span>
<span id="cb37-5">plt.scatter([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> outside],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> outside],marker<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'.'</span>)</span>
<span id="cb37-6">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_rms<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_rms)</span>
<span id="cb37-7">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb37-8">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb37-9">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb37-10">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb37-11">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb37-12">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, RMSD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Once again, it looks like we haven’t negatively impacted our ability to reproduce crystal conformers in any serious way.</p>
<p>Let’s look at the <img src="https://latex.codecogs.com/png.latex?%5CDelta"> RMSD differences directly:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_rms)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_rms)</span>
<span id="cb38-2">plt.hist(d,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb38-3">plt.xlabel(<span class="st" style="color: #20794D;">'RMSD(forceTol=0.0135)-RMSD(forceTol=0.001)'</span>)</span>
<span id="cb38-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Zoom in:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_rms)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_rms)</span>
<span id="cb39-2">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x)<span class="op" style="color: #5E5E5E;">&lt;=</span><span class="fl" style="color: #AD0000;">0.5</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb39-3">plt.xlabel(<span class="st" style="color: #20794D;">'RMSD(forceTol=0.0135)-RMSD(forceTol=0.001)'</span>)</span>
<span id="cb39-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="tfds" class="level3">
<h3 class="anchored" data-anchor-id="tfds">TFDs</h3>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">inf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/platinum_dataset_2017_01.sdf.gz'</span>)</span>
<span id="cb40-2">base_xtal_tfd <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb40-3">mod_xtal_tfd <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb40-4"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.001.random_coords.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> basef,<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb40-5">     gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/platinum_forcetol_0.0135.random_coords.100confs.pkl.gz'</span>) <span class="im" style="color: #00769E;">as</span> modf:</span>
<span id="cb40-6">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(Chem.ForwardSDMolSupplier(inf,removeHs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)):</span>
<span id="cb40-7">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb40-8">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb40-9">        <span class="cf" style="color: #003B4F;">if</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>:</span>
<span id="cb40-10">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb40-11">        m <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(m)</span>
<span id="cb40-12">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb40-13">            m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(basef))</span>
<span id="cb40-14">            m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(pickle.load(modf))</span>
<span id="cb40-15">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb40-16">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb40-17">        base_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb40-18">        mod_best <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb40-19">        base_best <span class="op" style="color: #5E5E5E;">=</span> GetBestTFDBetweenMolecules(m,m1)</span>
<span id="cb40-20">        mod_best <span class="op" style="color: #5E5E5E;">=</span> GetBestTFDBetweenMolecules(m,m2)</span>
<span id="cb40-21">        <span class="cf" style="color: #003B4F;">if</span> base_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span> <span class="kw" style="color: #003B4F;">and</span> mod_best<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1000</span>:</span>
<span id="cb40-22">            base_xtal_tfd.append(base_best)</span>
<span id="cb40-23">            mod_xtal_tfd.append(mod_best)</span>
<span id="cb40-24">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> (i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">500</span>:</span>
<span id="cb40-25">            <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f"Done </span><span class="sc" style="color: #5E5E5E;">{</span>i<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done 500
Done 1000
Done 1500
Done 2000
Done 2500
Done 3000
Done 3500
Done 4000
Done 4500</code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span></span>
<span id="cb42-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb42-3">plt.scatter(base_xtal_tfd,mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb42-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_tfd<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_tfd)</span>
<span id="cb42-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb42-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb42-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb42-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb42-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb42-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, TFD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-34-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">thresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span></span>
<span id="cb43-2">plt.rcParams[<span class="st" style="color: #20794D;">'figure.figsize'</span>]<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb43-3">plt.hexbin(base_xtal_tfd,mod_xtal_tfd,cmap<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'Blues'</span>,bins<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'log'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb43-4">lim <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(base_xtal_tfd<span class="op" style="color: #5E5E5E;">+</span>mod_xtal_tfd)</span>
<span id="cb43-5">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim),<span class="st" style="color: #20794D;">'k'</span>)</span>
<span id="cb43-6">plt.plot((<span class="dv" style="color: #AD0000;">0</span>,lim),(thresh,lim<span class="op" style="color: #5E5E5E;">+</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)</span>
<span id="cb43-7">plt.plot((thresh,lim),(<span class="dv" style="color: #AD0000;">0</span>,lim<span class="op" style="color: #5E5E5E;">-</span>thresh),ls<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'dashed'</span>,color<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'grey'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb43-8">plt.xlabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.001'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb43-9">plt.ylabel(<span class="st" style="color: #20794D;">'optimizerForceTol=0.0135'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb43-10">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol, TFD to xtal conf'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Look at the histogram of the changes in TFD between the two methods</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_tfd)</span>
<span id="cb44-2">plt.hist(d,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb44-3">plt.xlabel(<span class="st" style="color: #20794D;">'TFD(forceTol=0.0135)-TFD(forceTol=0.001)'</span>)</span>
<span id="cb44-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Zoom in:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">d <span class="op" style="color: #5E5E5E;">=</span> np.array(mod_xtal_tfd)<span class="op" style="color: #5E5E5E;">-</span>np.array(base_xtal_tfd)</span>
<span id="cb45-2">plt.hist([x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> d <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">abs</span>(x)<span class="op" style="color: #5E5E5E;">&lt;</span><span class="fl" style="color: #AD0000;">0.1</span>],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb45-3">plt.xlabel(<span class="st" style="color: #20794D;">'TFD(forceTol=0.0135)-TFD(forceTol=0.001)'</span>)</span>
<span id="cb45-4">plt.title(<span class="st" style="color: #20794D;">'platinum 100 confs/mol'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters_files/figure-html/cell-37-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Again, there are no major changes seen here.</p>


</section>
</section>
</section>

 ]]></description>
  <category>3d</category>
  <category>conformers</category>
  <category>optimization</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-09-29-optimizing-conformer-generation-parameters.html</guid>
  <pubDate>Wed, 28 Sep 2022 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/confgen-optimization-1.png" medium="image" type="image/png" height="149" width="144"/>
</item>
<item>
  <title>3D maximum common substructure</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs.html</link>
  <description><![CDATA[ 



<p>One of the “underdocumented”, and perhaps lesser known, features of the RDKit MCS code is the ability to take atomic coordinates into account when generating the MCS. The idea here is to find the MCS between a set of 3D molecules where the distance between potential matching atoms is taken into account.</p>
<p>This blog post shows how to do it.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDistGeom</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdFMCS</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-7">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-8">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-10"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.3</code></pre>
</div>
</div>
<p>Let’s start with an artifical example as a demo:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'c1ccccc1-c1c(C(F)(F)F)cc(-c2c(C(F)(F)F)cccn2)cc1'</span>)</span>
<span id="cb3-2">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb3-3">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-3-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Generate a conformer:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.AddHs(m1)</span>
<span id="cb4-2">rdDistGeom.EmbedMolecule(m1,randomSeed<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span>)</span>
<span id="cb4-3">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(m1)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">m1</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16560005135946162" style="position: relative; width: 400px; height: 400px">
        <p id="3dmolwarning_16560005135946162" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.csb.pitt.edu/build/3Dmol.js');
}

var viewer_16560005135946162 = null;
var warn = document.getElementById("3dmolwarning_16560005135946162");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16560005135946162 = $3Dmol.createViewer($("#3dmolviewer_16560005135946162"),{backgroundColor:"white"});
    viewer_16560005135946162.removeAllModels();
    viewer_16560005135946162.addModel("\n     RDKit          3D\n\n 26 28  0  0  0  0  0  0  0  0999 V2000\n    3.4900   -1.0985   -0.1990 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.8509   -1.1927   -0.3013 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.6168   -0.0656   -0.0925 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.0627    1.1549    0.2166 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.6696    1.2361    0.3184 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8869    0.1297    0.1141 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.4251    0.1252    0.1670 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6762    0.7411   -0.8008 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2714    1.3928   -1.9779 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2132    1.8815   -2.7702 F   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0566    2.4816   -1.7036 F   0  0  0  0  0  0  0  0  0  0  0  0\n    1.9797    0.5193   -2.7700 F   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7188    0.7065   -0.6441 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3362    0.0923    0.4161 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.7876    0.1835    0.4750 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.6154   -0.9146    0.4120 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.1255   -2.3115    0.3388 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2558   -3.1370    0.1763 F   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.5946   -2.7353    1.5596 F   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.2774   -2.5022   -0.7132 F   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9923   -0.6615    0.4017 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.4876    0.6096    0.4509 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.6265    1.6694    0.5120 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.3266    1.4299    0.5221 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5665   -0.5015    1.3466 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.7964   -0.4963    1.2405 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  2  3  1  0\n  3  4  2  0\n  4  5  1  0\n  5  6  2  0\n  6  7  1  0\n  7  8  2  0\n  8  9  1  0\n  9 10  1  0\n  9 11  1  0\n  9 12  1  0\n  8 13  1  0\n 13 14  2  0\n 14 15  1  0\n 15 16  2  0\n 16 17  1  0\n 17 18  1  0\n 17 19  1  0\n 17 20  1  0\n 16 21  1  0\n 21 22  2  0\n 22 23  1  0\n 23 24  2  0\n 14 25  1  0\n 25 26  2  0\n  6  1  1  0\n 26  7  1  0\n 24 15  1  0\nM  END\n","sdf");
    viewer_16560005135946162.setStyle({"stick": {}});
    viewer_16560005135946162.setBackgroundColor("0xeeeeee");
    viewer_16560005135946162.zoomTo();
viewer_16560005135946162.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">

</div>
</div>
<p>Clip out the central ring and change one of the atoms to an N</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">m2 <span class="op" style="color: #5E5E5E;">=</span> Chem.RWMol(m1)</span>
<span id="cb6-2">keep <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">7</span>,<span class="dv" style="color: #AD0000;">12</span>,<span class="dv" style="color: #AD0000;">13</span>,<span class="dv" style="color: #AD0000;">24</span>,<span class="dv" style="color: #AD0000;">25</span>]</span>
<span id="cb6-3">remove <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(<span class="bu" style="color: null;">range</span>(m2.GetNumAtoms())).difference(keep)</span>
<span id="cb6-4">m2.BeginBatchEdit()</span>
<span id="cb6-5"><span class="cf" style="color: #003B4F;">for</span> aidx <span class="kw" style="color: #003B4F;">in</span> remove:</span>
<span id="cb6-6">    m2.RemoveAtom(aidx)</span>
<span id="cb6-7">m2.CommitBatchEdit()</span>
<span id="cb6-8">m2.GetAtomWithIdx(<span class="dv" style="color: #AD0000;">0</span>).SetAtomicNum(<span class="dv" style="color: #AD0000;">7</span>)</span>
<span id="cb6-9">m2</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16560005139011226" style="position: relative; width: 400px; height: 400px">
        <p id="3dmolwarning_16560005139011226" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.csb.pitt.edu/build/3Dmol.js');
}

var viewer_16560005139011226 = null;
var warn = document.getElementById("3dmolwarning_16560005139011226");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16560005139011226 = $3Dmol.createViewer($("#3dmolviewer_16560005139011226"),{backgroundColor:"white"});
    viewer_16560005139011226.removeAllModels();
    viewer_16560005139011226.addModel("\n     RDKit          3D\n\n  6  6  0  0  0  0  0  0  0  0999 V2000\n    1.4251    0.1252    0.1670 N   0  0  0  0  0  4  0  0  0  0  0  0\n    0.6762    0.7411   -0.8008 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7188    0.7065   -0.6441 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.3362    0.0923    0.4161 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5665   -0.5015    1.3466 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.7964   -0.4963    1.2405 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  2  3  1  0\n  3  4  2  0\n  4  5  1  0\n  5  6  2  0\n  6  1  1  0\nM  END\n","sdf");
    viewer_16560005139011226.setStyle({"stick": {}});
    viewer_16560005139011226.setBackgroundColor("0xeeeeee");
    viewer_16560005139011226.zoomTo();
viewer_16560005139011226.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">

</div>
</div>
<p>A normal MCS will, of course, match this to the N-containing ring:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb7-2">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS([m1,m2],ps)</span>
<span id="cb7-3"><span class="bu" style="color: null;">print</span>(res.smartsString)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[#7]1:[#6]:[#6]:[#6]:[#6]:[#6]:1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb9-2">ps.AtomCompareParameters.MaxDistance <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb9-3">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS([m1,m2],ps)</span>
<span id="cb9-4"><span class="bu" style="color: null;">print</span>(res.smartsString)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[#6]:[#6]:[#6]:[#6]:[#6]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb11-2">ps.AtomCompareParameters.MaxDistance <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb11-3">ps.AtomTyper <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.AtomCompare.CompareAny</span>
<span id="cb11-4">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS([m1,m2],ps)</span>
<span id="cb11-5"><span class="bu" style="color: null;">print</span>(res.smartsString)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[#7,#6]1:[#6]:[#6]:[#6]:[#6]:[#6]:1</code></pre>
</div>
</div>
<section id="a-real-example" class="level1">
<h1>A real example</h1>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;"># exported from the binding db and converted to SDF in pymol</span></span>
<span id="cb13-2">ms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> Chem.ForwardSDMolSupplier(<span class="st" style="color: #20794D;">'../data/1TDU-results.sdf'</span>)]</span>
<span id="cb13-3">ms2d <span class="op" style="color: #5E5E5E;">=</span> [Chem.Mol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms]</span>
<span id="cb13-4"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms2d:</span>
<span id="cb13-5">    rdDepictor.Compute2DCoords(m)</span>
<span id="cb13-6">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb13-7">Draw.MolsToGridImage(ms2d)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;">import</span> py3Dmol</span>
<span id="cb14-2">viewer <span class="op" style="color: #5E5E5E;">=</span> py3Dmol.view(width<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">350</span>, height<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">350</span>)</span>
<span id="cb14-3">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">0</span>],viewer)</span>
<span id="cb14-4">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">1</span>],viewer)</span>
<span id="cb14-5">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">2</span>],viewer)</span>
<span id="cb14-6">viewer.zoomTo()</span>
<span id="cb14-7">viewer.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16560005145966377" style="position: relative; width: 350px; height: 350px">
        <p id="3dmolwarning_16560005145966377" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.csb.pitt.edu/build/3Dmol.js');
}

var viewer_16560005145966377 = null;
var warn = document.getElementById("3dmolwarning_16560005145966377");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16560005145966377 = $3Dmol.createViewer($("#3dmolviewer_16560005145966377"),{backgroundColor:"white"});
    viewer_16560005145966377.addModel("BindingDB_18050\n     RDKit          3D\n\n 33 35  0  0  0  0  0  0  0  0999 V2000\n   14.0825   17.4134   33.7894 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2616   18.4748   34.0351 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.6516   18.6164   31.7628 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5622   19.0757   33.0348 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7548   16.8376   34.8004 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.7402   20.1071   33.3039 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4386   17.5548   31.4573 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1922   16.9246   32.4699 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.2713   15.9899   29.8698 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.0278   15.3430   30.8715 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9579   15.8547   32.1367 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5103   17.0662   30.1949 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.8163   14.1133   30.5962 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.4721   13.5689   31.7866 N   0  0  0  0  0  0  0  0  0  0  0  0\n   17.9207   13.5301   31.7882 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.7459   13.1625   32.9058 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5873   12.7615   34.0599 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3245   13.0786   32.9031 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.3722   12.8426   34.1380 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.6374   12.5640   35.3014 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.2202   12.5439   35.3057 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4819   12.3139   36.4782 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.2891   12.0275   36.4008 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.0468   12.3720   37.6815 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4607   12.1636   38.9753 C   0  0  1  0  0  0  0  0  0  0  0  0\n   12.5547   13.3581   39.3962 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1056   13.3184   40.8874 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4658   14.5747   41.3134 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1412   14.7677   41.1209 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1727   15.5211   41.9760 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.8339   10.8243   39.0884 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6158   10.6358   39.6539 O   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4697    9.7379   38.5772 O   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  1  5  1  0\n  1  8  1  0\n  2  4  1  0\n  3  4  2  0\n  3  7  1  0\n  4  6  1  0\n  7  8  2  0\n  7 12  1  0\n  8 11  1  0\n  9 10  1  0\n  9 12  2  0\n 10 11  2  0\n 10 13  1  0\n 13 14  1  0\n 14 15  1  0\n 14 16  1  0\n 16 18  1  0\n 16 19  2  0\n 17 18  2  0\n 17 21  1  0\n 19 20  1  0\n 20 21  2  0\n 21 22  1  0\n 22 23  2  0\n 22 24  1  0\n 24 25  1  0\n 25 26  1  6\n 25 31  1  0\n 26 27  1  0\n 27 28  1  0\n 28 29  2  0\n 28 30  1  0\n 31 32  2  0\n 31 33  1  0\nM  CHG  2  30  -1  33  -1\nM  END\n","sdf");
    viewer_16560005145966377.setStyle({"stick": {}});
    viewer_16560005145966377.addModel("BindingDB_20676\n     RDKit          3D\n\n 31 33  0  0  0  0  0  0  0  0999 V2000\n   18.1936   16.0518   32.9100 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.4323   18.3879   32.6772 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.5420   18.4144   31.6502 N   0  0  0  0  0  0  0  0  0  0  0  0\n   18.7390   17.2078   33.2855 N   0  0  0  0  0  0  0  0  0  0  0  0\n   18.5327   15.0421   33.5058 O   0  0  0  0  0  0  0  0  0  0  0  0\n   19.0289   19.5181   33.0846 N   0  0  0  0  0  0  0  0  0  0  0  0\n   17.2774   16.0208   31.8533 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.9794   17.2423   31.2482 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.0779   16.9970   30.2357 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.8386   15.6227   30.2255 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.8876   15.0377   29.2554 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.5749   15.0398   31.2217 N   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6189   13.6372   31.5703 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.9095   13.3242   32.8454 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8179   13.1073   34.1133 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4994   13.4048   32.9106 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6013   12.9311   34.0049 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.9185   12.6188   35.1971 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.5069   12.6902   35.2817 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8212   12.3939   36.4694 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.7060   12.8686   36.6695 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3411   11.5847   37.3863 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8369   11.2544   38.7036 C   0  0  1  0  0  0  0  0  0  0  0  0\n   13.9405   12.4718   39.6748 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8543   12.1565   41.1937 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9882   11.3735   41.7219 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2648   11.7769   41.5288 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7730   10.2677   42.4666 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4950   10.6314   38.6064 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4911   10.8988   39.4711 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.2197    9.8166   37.5567 O   0  0  0  0  0  0  0  0  0  0  0  0\n  1  4  1  0\n  1  5  2  0\n  1  7  1  0\n  2  3  2  0\n  2  4  1  0\n  2  6  1  0\n  3  8  1  0\n  7  8  2  0\n  7 12  1  0\n  8  9  1  0\n  9 10  2  0\n 10 11  1  0\n 10 12  1  0\n 12 13  1  0\n 13 14  1  0\n 14 16  1  0\n 14 17  2  0\n 15 16  2  0\n 15 19  1  0\n 17 18  1  0\n 18 19  2  0\n 19 20  1  0\n 20 21  2  0\n 20 22  1  0\n 22 23  1  0\n 23 24  1  1\n 23 29  1  0\n 24 25  1  0\n 25 26  1  0\n 26 27  2  0\n 26 28  1  0\n 29 30  2  0\n 29 31  1  0\nM  CHG  2  28  -1  31  -1\nM  END\n","sdf");
    viewer_16560005145966377.setStyle({"stick": {}});
    viewer_16560005145966377.addModel("BindingDB_50008294\n     RDKit          3D\n\n 35 37  0  0  0  0  0  0  0  0999 V2000\n   12.8065   19.3059   32.2234 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5341   19.8046   30.9926 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.8643   19.0872   29.8886 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4039   18.1358   32.4019 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.7823   17.3649   31.2972 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4841   17.8733   30.0043 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8285   17.1233   28.8634 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4627   15.8748   29.0012 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7708   15.3485   30.2804 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4359   16.1185   31.4190 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5876   17.7715   33.5545 O   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9559   21.0095   30.8839 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.3549   13.9791   30.4145 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2223   13.7804   31.5768 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.7357   13.3016   32.7953 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.6292   14.1290   31.3776 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.1352   14.9477   32.3475 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3484   13.1465   33.0780 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8632   12.7744   34.3544 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7565   12.5005   35.4094 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.1375   12.5561   35.1284 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6065   12.9521   33.8636 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3054   12.1312   36.6760 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5555   12.9599   37.4000 N   0  0  0  0  0  0  0  0  0  0  0  0\n   14.6867   11.0634   37.1407 O   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0402   12.7813   38.7403 C   0  0  1  0  0  0  0  0  0  0  0  0\n   12.1453   11.5970   38.8098 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1724   12.7687   39.8304 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.7994   12.1854   41.2374 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0925   11.5928   39.6612 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4772   10.4329   38.1997 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9196   11.4155   41.8332 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2055   11.7795   41.6207 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.6864   10.2029   42.3892 O   0  0  0  0  0  0  0  0  0  0  0  0\n   18.5903   15.6475   33.2179 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  1  4  1  0\n  2  3  1  0\n  2 12  1  0\n  3  6  1  0\n  4  5  1  0\n  4 11  2  0\n  5  6  2  0\n  5 10  1  0\n  6  7  1  0\n  7  8  2  0\n  8  9  1  0\n  9 10  2  0\n  9 13  1  0\n 13 14  1  0\n 14 15  1  0\n 14 16  1  0\n 15 18  2  0\n 15 22  1  0\n 16 17  1  0\n 17 35  3  0\n 18 19  1  0\n 19 20  2  0\n 20 21  1  0\n 20 23  1  0\n 21 22  2  0\n 23 24  1  0\n 23 25  2  0\n 24 26  1  0\n 26 27  1  0\n 26 28  1  1\n 27 30  2  0\n 27 31  1  0\n 28 29  1  0\n 29 32  1  0\n 32 33  1  0\n 32 34  2  0\nM  CHG  2  31  -1  33  -1\nM  END\n","sdf");
    viewer_16560005145966377.setStyle({"stick": {}});
    viewer_16560005145966377.zoomTo();
viewer_16560005145966377.render();
});
</script>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb15-2">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS(ms,ps)</span>
<span id="cb15-3">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(res.smartsString)</span>
<span id="cb15-4">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">matches <span class="op" style="color: #5E5E5E;">=</span> [x.GetSubstructMatch(qry) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms2d]</span>
<span id="cb16-2"></span>
<span id="cb16-3">conf <span class="op" style="color: #5E5E5E;">=</span> Chem.Conformer(qry.GetNumAtoms())</span>
<span id="cb16-4"><span class="cf" style="color: #003B4F;">for</span> i,mi <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(matches[<span class="dv" style="color: #AD0000;">0</span>]):</span>
<span id="cb16-5">    conf.SetAtomPosition(i,ms2d[<span class="dv" style="color: #AD0000;">0</span>].GetConformer().GetAtomPosition(mi))</span>
<span id="cb16-6">qry.AddConformer(conf)</span>
<span id="cb16-7"></span>
<span id="cb16-8">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">False</span>) <span class="co" style="color: #5E5E5E;"># coordgen doesn't always obey the scaffold, so switch to the RDKit coordinates</span></span>
<span id="cb16-9"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms2d:</span>
<span id="cb16-10">    rdDepictor.GenerateDepictionMatching2DStructure(m,qry)</span>
<span id="cb16-11">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb16-12">Draw.MolsToGridImage(ms2d,highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matches)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb17-2">ps.AtomTyper <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.AtomCompare.CompareAny</span>
<span id="cb17-3">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS(ms,ps)</span>
<span id="cb17-4">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(res.smartsString)</span>
<span id="cb17-5">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">matches <span class="op" style="color: #5E5E5E;">=</span> [x.GetSubstructMatch(qry) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms2d]</span>
<span id="cb18-2"></span>
<span id="cb18-3">conf <span class="op" style="color: #5E5E5E;">=</span> Chem.Conformer(qry.GetNumAtoms())</span>
<span id="cb18-4"><span class="cf" style="color: #003B4F;">for</span> i,mi <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(matches[<span class="dv" style="color: #AD0000;">0</span>]):</span>
<span id="cb18-5">    conf.SetAtomPosition(i,ms2d[<span class="dv" style="color: #AD0000;">0</span>].GetConformer().GetAtomPosition(mi))</span>
<span id="cb18-6">qry.AddConformer(conf)</span>
<span id="cb18-7">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">False</span>) <span class="co" style="color: #5E5E5E;"># coordgen doesn't always obey the scaffold, so switch to the RDKit coordinates</span></span>
<span id="cb18-8"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms2d:</span>
<span id="cb18-9">    rdDepictor.GenerateDepictionMatching2DStructure(m,qry)</span>
<span id="cb18-10">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb18-11"></span>
<span id="cb18-12">Draw.MolsToGridImage(ms2d,highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matches)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>This is an example where the constrained coordinates, which only match part of a ring system, cause problems.</p>
<p>Both of those MCS results are matching significant parts of the molecules, but we saw that the molecules didn’t actually align quite that well.</p>
<p>What about if we take atom coordinates into account?</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.MCSParameters()</span>
<span id="cb19-2">ps.AtomCompareParameters.MaxDistance <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">1.0</span></span>
<span id="cb19-3">ps.AtomTyper <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.AtomCompare.CompareAny</span>
<span id="cb19-4">res <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS(ms,ps)</span>
<span id="cb19-5">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(res.smartsString)</span>
<span id="cb19-6">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">matches <span class="op" style="color: #5E5E5E;">=</span> [x.GetSubstructMatch(qry) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms2d]</span>
<span id="cb20-2"></span>
<span id="cb20-3">conf <span class="op" style="color: #5E5E5E;">=</span> Chem.Conformer(qry.GetNumAtoms())</span>
<span id="cb20-4"><span class="cf" style="color: #003B4F;">for</span> i,mi <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(matches[<span class="dv" style="color: #AD0000;">0</span>]):</span>
<span id="cb20-5">    conf.SetAtomPosition(i,ms2d[<span class="dv" style="color: #AD0000;">0</span>].GetConformer().GetAtomPosition(mi))</span>
<span id="cb20-6">qry.AddConformer(conf)</span>
<span id="cb20-7"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms2d:</span>
<span id="cb20-8">    rdDepictor.GenerateDepictionMatching2DStructure(m,qry)</span>
<span id="cb20-9">Draw.MolsToGridImage(ms2d,highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matches)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The MCS gave us a SMARTS which matches, but unfortunately it does not provide the matching atoms. Finding those via substructure search would be easy if we could assume that the MCS only matches each molecule once, but that’s not always going to be the case.</p>
<p>This is actually one of those examples.</p>
<p>Let’s look at how many times the core can match each of the molecules:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">allMatches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb21-2"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb21-3">    allMatches.append(m.GetSubstructMatches(qry,uniquify<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>))</span>
<span id="cb21-4">allMatches</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>[((13, 15, 17, 16, 20, 19, 18, 21), (13, 15, 18, 19, 20, 16, 17, 21)),
 ((12, 13, 15, 14, 18, 17, 16, 19),
  (12, 13, 16, 17, 18, 14, 15, 19),
  (19, 18, 14, 15, 13, 16, 17, 12),
  (19, 18, 17, 16, 13, 15, 14, 12)),
 ((13, 14, 17, 18, 19, 20, 21, 22), (13, 14, 21, 20, 19, 18, 17, 22))]</code></pre>
</div>
</div>
<p>Now define a function which goes through all the possible substructure matches and finds the one which satisfies the 3D distance constraints on the core:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;">def</span> getAlignedSubstructMatch(ms,qry,distTol<span class="op" style="color: #5E5E5E;">=</span><span class="fl" style="color: #AD0000;">1.0</span>):</span>
<span id="cb23-2">    allMatches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-3">    <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb23-4">        allMatches.append(m.GetSubstructMatches(qry,uniquify<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>))</span>
<span id="cb23-5"></span>
<span id="cb23-6">    keepMatches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-7">    <span class="cf" style="color: #003B4F;">for</span> match0 <span class="kw" style="color: #003B4F;">in</span> allMatches[<span class="dv" style="color: #AD0000;">0</span>]:</span>
<span id="cb23-8">        allMatched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb23-9">        <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="bu" style="color: null;">len</span>(ms)):</span>
<span id="cb23-10">            imatched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb23-11">            <span class="cf" style="color: #003B4F;">for</span> matchi <span class="kw" style="color: #003B4F;">in</span> allMatches[i]:</span>
<span id="cb23-12">                matched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb23-13">                <span class="cf" style="color: #003B4F;">for</span> i0,ii <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>(match0,matchi):</span>
<span id="cb23-14">                    dist <span class="op" style="color: #5E5E5E;">=</span> (ms[<span class="dv" style="color: #AD0000;">0</span>].GetConformer().GetAtomPosition(i0) <span class="op" style="color: #5E5E5E;">-</span> ms[i].GetConformer().GetAtomPosition(ii)).Length()</span>
<span id="cb23-15">                    <span class="cf" style="color: #003B4F;">if</span> dist <span class="op" style="color: #5E5E5E;">&gt;</span> distTol:</span>
<span id="cb23-16">                        matched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb23-17">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb23-18">                <span class="cf" style="color: #003B4F;">if</span> matched:</span>
<span id="cb23-19">                    keepMatches.append(matchi)</span>
<span id="cb23-20">                    imatched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb23-21">                    <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb23-22">            <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> imatched:</span>
<span id="cb23-23">                allMatched <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb23-24">                keepMatches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-25">                <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb23-26">        <span class="cf" style="color: #003B4F;">if</span> allMatched:</span>
<span id="cb23-27">            keepMatches <span class="op" style="color: #5E5E5E;">=</span> [match0] <span class="op" style="color: #5E5E5E;">+</span> keepMatches</span>
<span id="cb23-28">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb23-29">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb23-30">            keepMatches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-31">    <span class="cf" style="color: #003B4F;">return</span> keepMatches</span>
<span id="cb23-32">    </span></code></pre></div>
</div>
<p>The results for our molecules and the 3D MCS core:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">keepMatches <span class="op" style="color: #5E5E5E;">=</span> getAlignedSubstructMatch(ms,qry)</span>
<span id="cb24-2">keepMatches</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>[(13, 15, 17, 16, 20, 19, 18, 21),
 (12, 13, 15, 14, 18, 17, 16, 19),
 (13, 14, 17, 18, 19, 20, 21, 22)]</code></pre>
</div>
</div>
<p>And highlight the substructures:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">Draw.MolsToGridImage(ms2d,highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>keepMatches)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s redraw the molecules in 3D and highlight the atoms involved in the MCS. It’s nice to see, plus I learned some stuff about how to use py3Dmol while doing it… so that’s a bonus. :-)</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;">import</span> py3Dmol</span>
<span id="cb27-2">viewer <span class="op" style="color: #5E5E5E;">=</span> py3Dmol.view(width<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">450</span>, height<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">450</span>)</span>
<span id="cb27-3">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">0</span>],viewer)</span>
<span id="cb27-4">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">1</span>],viewer)</span>
<span id="cb27-5">IPythonConsole.addMolToView(ms[<span class="dv" style="color: #AD0000;">2</span>],viewer)</span>
<span id="cb27-6"><span class="cf" style="color: #003B4F;">for</span> idx,clr <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">zip</span>((<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">3</span>),(<span class="st" style="color: #20794D;">'redCarbon'</span>,<span class="st" style="color: #20794D;">'cyanCarbon'</span>,<span class="st" style="color: #20794D;">'blueCarbon'</span>)):</span>
<span id="cb27-7">    viewer.setStyle({<span class="st" style="color: #20794D;">'model'</span>:idx,},</span>
<span id="cb27-8">                    {<span class="st" style="color: #20794D;">'stick'</span>:{<span class="st" style="color: #20794D;">'colorscheme'</span>:clr,<span class="st" style="color: #20794D;">'radius'</span>:<span class="fl" style="color: #AD0000;">.15</span>}})</span>
<span id="cb27-9">    viewer.setStyle({<span class="st" style="color: #20794D;">'model'</span>:idx,<span class="st" style="color: #20794D;">'serial'</span>:keepMatches[idx]},</span>
<span id="cb27-10">                    {<span class="st" style="color: #20794D;">'stick'</span>:{<span class="st" style="color: #20794D;">'colorscheme'</span>:clr},<span class="st" style="color: #20794D;">'sphere'</span>:{<span class="st" style="color: #20794D;">'colorscheme'</span>:clr,<span class="st" style="color: #20794D;">'radius'</span>:<span class="fl" style="color: #AD0000;">.5</span>}})</span>
<span id="cb27-11"></span>
<span id="cb27-12">viewer.zoomTo()</span>
<span id="cb27-13">viewer.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16560005160727732" style="position: relative; width: 450px; height: 450px">
        <p id="3dmolwarning_16560005160727732" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.csb.pitt.edu/build/3Dmol.js');
}

var viewer_16560005160727732 = null;
var warn = document.getElementById("3dmolwarning_16560005160727732");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16560005160727732 = $3Dmol.createViewer($("#3dmolviewer_16560005160727732"),{backgroundColor:"white"});
    viewer_16560005160727732.addModel("BindingDB_18050\n     RDKit          3D\n\n 33 35  0  0  0  0  0  0  0  0999 V2000\n   14.0825   17.4134   33.7894 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2616   18.4748   34.0351 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.6516   18.6164   31.7628 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5622   19.0757   33.0348 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7548   16.8376   34.8004 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.7402   20.1071   33.3039 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4386   17.5548   31.4573 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1922   16.9246   32.4699 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.2713   15.9899   29.8698 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.0278   15.3430   30.8715 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9579   15.8547   32.1367 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5103   17.0662   30.1949 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.8163   14.1133   30.5962 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.4721   13.5689   31.7866 N   0  0  0  0  0  0  0  0  0  0  0  0\n   17.9207   13.5301   31.7882 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.7459   13.1625   32.9058 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5873   12.7615   34.0599 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3245   13.0786   32.9031 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.3722   12.8426   34.1380 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.6374   12.5640   35.3014 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.2202   12.5439   35.3057 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4819   12.3139   36.4782 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.2891   12.0275   36.4008 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.0468   12.3720   37.6815 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4607   12.1636   38.9753 C   0  0  1  0  0  0  0  0  0  0  0  0\n   12.5547   13.3581   39.3962 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1056   13.3184   40.8874 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4658   14.5747   41.3134 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1412   14.7677   41.1209 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1727   15.5211   41.9760 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.8339   10.8243   39.0884 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6158   10.6358   39.6539 O   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4697    9.7379   38.5772 O   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  1  5  1  0\n  1  8  1  0\n  2  4  1  0\n  3  4  2  0\n  3  7  1  0\n  4  6  1  0\n  7  8  2  0\n  7 12  1  0\n  8 11  1  0\n  9 10  1  0\n  9 12  2  0\n 10 11  2  0\n 10 13  1  0\n 13 14  1  0\n 14 15  1  0\n 14 16  1  0\n 16 18  1  0\n 16 19  2  0\n 17 18  2  0\n 17 21  1  0\n 19 20  1  0\n 20 21  2  0\n 21 22  1  0\n 22 23  2  0\n 22 24  1  0\n 24 25  1  0\n 25 26  1  6\n 25 31  1  0\n 26 27  1  0\n 27 28  1  0\n 28 29  2  0\n 28 30  1  0\n 31 32  2  0\n 31 33  1  0\nM  CHG  2  30  -1  33  -1\nM  END\n","sdf");
    viewer_16560005160727732.setStyle({"stick": {}});
    viewer_16560005160727732.addModel("BindingDB_20676\n     RDKit          3D\n\n 31 33  0  0  0  0  0  0  0  0999 V2000\n   18.1936   16.0518   32.9100 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.4323   18.3879   32.6772 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.5420   18.4144   31.6502 N   0  0  0  0  0  0  0  0  0  0  0  0\n   18.7390   17.2078   33.2855 N   0  0  0  0  0  0  0  0  0  0  0  0\n   18.5327   15.0421   33.5058 O   0  0  0  0  0  0  0  0  0  0  0  0\n   19.0289   19.5181   33.0846 N   0  0  0  0  0  0  0  0  0  0  0  0\n   17.2774   16.0208   31.8533 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.9794   17.2423   31.2482 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.0779   16.9970   30.2357 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.8386   15.6227   30.2255 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.8876   15.0377   29.2554 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.5749   15.0398   31.2217 N   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6189   13.6372   31.5703 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.9095   13.3242   32.8454 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8179   13.1073   34.1133 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4994   13.4048   32.9106 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6013   12.9311   34.0049 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.9185   12.6188   35.1971 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.5069   12.6902   35.2817 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8212   12.3939   36.4694 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.7060   12.8686   36.6695 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3411   11.5847   37.3863 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8369   11.2544   38.7036 C   0  0  1  0  0  0  0  0  0  0  0  0\n   13.9405   12.4718   39.6748 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8543   12.1565   41.1937 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9882   11.3735   41.7219 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2648   11.7769   41.5288 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7730   10.2677   42.4666 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4950   10.6314   38.6064 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4911   10.8988   39.4711 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.2197    9.8166   37.5567 O   0  0  0  0  0  0  0  0  0  0  0  0\n  1  4  1  0\n  1  5  2  0\n  1  7  1  0\n  2  3  2  0\n  2  4  1  0\n  2  6  1  0\n  3  8  1  0\n  7  8  2  0\n  7 12  1  0\n  8  9  1  0\n  9 10  2  0\n 10 11  1  0\n 10 12  1  0\n 12 13  1  0\n 13 14  1  0\n 14 16  1  0\n 14 17  2  0\n 15 16  2  0\n 15 19  1  0\n 17 18  1  0\n 18 19  2  0\n 19 20  1  0\n 20 21  2  0\n 20 22  1  0\n 22 23  1  0\n 23 24  1  1\n 23 29  1  0\n 24 25  1  0\n 25 26  1  0\n 26 27  2  0\n 26 28  1  0\n 29 30  2  0\n 29 31  1  0\nM  CHG  2  28  -1  31  -1\nM  END\n","sdf");
    viewer_16560005160727732.setStyle({"stick": {}});
    viewer_16560005160727732.addModel("BindingDB_50008294\n     RDKit          3D\n\n 35 37  0  0  0  0  0  0  0  0999 V2000\n   12.8065   19.3059   32.2234 N   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5341   19.8046   30.9926 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.8643   19.0872   29.8886 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4039   18.1358   32.4019 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.7823   17.3649   31.2972 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4841   17.8733   30.0043 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8285   17.1233   28.8634 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4627   15.8748   29.0012 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7708   15.3485   30.2804 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.4359   16.1185   31.4190 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5876   17.7715   33.5545 O   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9559   21.0095   30.8839 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.3549   13.9791   30.4145 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2223   13.7804   31.5768 N   0  0  0  0  0  0  0  0  0  0  0  0\n   15.7357   13.3016   32.7953 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.6292   14.1290   31.3776 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.1352   14.9477   32.3475 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3484   13.1465   33.0780 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.8632   12.7744   34.3544 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.7565   12.5005   35.4094 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.1375   12.5561   35.1284 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.6065   12.9521   33.8636 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3054   12.1312   36.6760 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5555   12.9599   37.4000 N   0  0  0  0  0  0  0  0  0  0  0  0\n   14.6867   11.0634   37.1407 O   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0402   12.7813   38.7403 C   0  0  1  0  0  0  0  0  0  0  0  0\n   12.1453   11.5970   38.8098 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1724   12.7687   39.8304 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.7994   12.1854   41.2374 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0925   11.5928   39.6612 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4772   10.4329   38.1997 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.9196   11.4155   41.8332 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2055   11.7795   41.6207 O   0  0  0  0  0  0  0  0  0  0  0  0\n   14.6864   10.2029   42.3892 O   0  0  0  0  0  0  0  0  0  0  0  0\n   18.5903   15.6475   33.2179 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0\n  1  4  1  0\n  2  3  1  0\n  2 12  1  0\n  3  6  1  0\n  4  5  1  0\n  4 11  2  0\n  5  6  2  0\n  5 10  1  0\n  6  7  1  0\n  7  8  2  0\n  8  9  1  0\n  9 10  2  0\n  9 13  1  0\n 13 14  1  0\n 14 15  1  0\n 14 16  1  0\n 15 18  2  0\n 15 22  1  0\n 16 17  1  0\n 17 35  3  0\n 18 19  1  0\n 19 20  2  0\n 20 21  1  0\n 20 23  1  0\n 21 22  2  0\n 23 24  1  0\n 23 25  2  0\n 24 26  1  0\n 26 27  1  0\n 26 28  1  1\n 27 30  2  0\n 27 31  1  0\n 28 29  1  0\n 29 32  1  0\n 32 33  1  0\n 32 34  2  0\nM  CHG  2  31  -1  33  -1\nM  END\n","sdf");
    viewer_16560005160727732.setStyle({"stick": {}});
    viewer_16560005160727732.setStyle({"model": -1},{"stick": {"colorscheme": "redCarbon", "radius": 0.15}});
    viewer_16560005160727732.setStyle({"model": -1, "serial": [13, 14, 17, 18, 19, 20, 21, 22]},{"stick": {"colorscheme": "redCarbon"}, "sphere": {"colorscheme": "redCarbon", "radius": 0.5}});
    viewer_16560005160727732.setStyle({"model": -2},{"stick": {"colorscheme": "cyanCarbon", "radius": 0.15}});
    viewer_16560005160727732.setStyle({"model": -2, "serial": [12, 13, 15, 14, 18, 17, 16, 19]},{"stick": {"colorscheme": "cyanCarbon"}, "sphere": {"colorscheme": "cyanCarbon", "radius": 0.5}});
    viewer_16560005160727732.setStyle({"model": -3},{"stick": {"colorscheme": "blueCarbon", "radius": 0.15}});
    viewer_16560005160727732.setStyle({"model": -3, "serial": [13, 15, 17, 16, 20, 19, 18, 21]},{"stick": {"colorscheme": "blueCarbon"}, "sphere": {"colorscheme": "blueCarbon", "radius": 0.5}});
    viewer_16560005160727732.zoomTo();
viewer_16560005160727732.render();
});
</script>
</div>
</div>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>3d</category>
  <category>mcs</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-06-23-3d-mcs.html</guid>
  <pubDate>Wed, 22 Jun 2022 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/3d-mcs-1.png" medium="image" type="image/png" height="145" width="144"/>
</item>
<item>
  <title>Variability of PMI descriptors</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors.html</link>
  <description><![CDATA[ 



<p>Earlier this year <a href="https://github.com/rdkit/rdkit/discussions/5102">Axel asked</a> about the differences in PMI (princile moments of inertia) values between different stereoisomers of the same molecule. I guessed, but wasn’t sure, that the differences arising from different stereoisomers would be small relative to those arising from inter-conformer variability in the structure.</p>
<p>This post looks into that question.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDistGeom</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolDescriptors</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Descriptors</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-6">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-11"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;">%</span>pylab inline</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.2
%pylab is deprecated, use %matplotlib inline and import the required libraries.
Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
</div>
<p>Start by reading in 50 molecules from the <a href="https://doi.org/10.1021/acs.jcim.6b00613">platinum dataset</a> which have at least one chiral center.</p>
<p>Note that as of the 2022.03.3 release of the RDKit the explicit call to <code>AssignStereochemistryFrom3D()</code> is no longer necessary for molecules which have 3D conformers. We changed the default behavior so that this function is called whenever a molecule has a 3D conformer.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;">with</span> Chem.SDMolSupplier(<span class="st" style="color: #20794D;">'../data/platinum_dataset_2017_01.sdf'</span>,removeHs<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>) <span class="im" style="color: #00769E;">as</span> suppl:</span>
<span id="cb3-2">    ms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;">while</span> <span class="bu" style="color: null;">len</span>(ms)<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">50</span>:</span>
<span id="cb3-4">        m <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">next</span>(suppl)</span>
<span id="cb3-5">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb3-6">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb3-7">        Chem.AssignStereochemistryFrom3D(m)</span>
<span id="cb3-8">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(Chem.FindMolChiralCenters(m))<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb3-9">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb3-10">        ms.append(m)</span></code></pre></div>
</div>
<p>Look at the number of chiral centers present in each molecule</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">figsize(<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb4-2">hist([<span class="bu" style="color: null;">len</span>(Chem.FindPotentialStereo(m)) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms],bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb4-3">xlabel(<span class="st" style="color: #20794D;">'num chiral centers'</span>)</span>
<span id="cb4-4">ylabel(<span class="st" style="color: #20794D;">'count'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="inter-conformer-variability-for-a-single-stereoisomer" class="level1">
<h1>inter-conformer variability for a single stereoisomer</h1>
<p>Start by generating 100 conformers for each of our molecules.</p>
<p>We will only generate conformers which match the stereochemistry of the input structure (this is the default RDKit behavior).</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.srETKDGv3()</span>
<span id="cb5-2">ps.numThreads <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">6</span></span>
<span id="cb5-3">ps.randomSeed <span class="op" style="color: #5E5E5E;">=</span> <span class="bn" style="color: #AD0000;">0xf00d</span></span>
<span id="cb5-4">ps.pruneRmsThresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb5-7">    rdDistGeom.EmbedMultipleConfs(m,<span class="dv" style="color: #AD0000;">100</span>,ps)</span></code></pre></div>
</div>
<p>Generate the three PMI descriptors for each conformer of each molecule (note that PMI1 is the <em>smallest</em> principle moment).</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">accum <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-2"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb6-3">    confs <span class="op" style="color: #5E5E5E;">=</span> m.GetConformers()</span>
<span id="cb6-4">    d <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;">for</span> conf <span class="kw" style="color: #003B4F;">in</span> confs:</span>
<span id="cb6-6">        d.append((rdMolDescriptors.CalcPMI1(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId()),</span>
<span id="cb6-7">        rdMolDescriptors.CalcPMI2(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId()),</span>
<span id="cb6-8">        rdMolDescriptors.CalcPMI3(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId())))</span>
<span id="cb6-9">    accum.append(np.array(d))</span></code></pre></div>
</div>
<p>Look at the inter-conformer variability, as measured by the relative standard deviation, of the three descriptors</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb7-2">means <span class="op" style="color: #5E5E5E;">=</span> np.array([np.average(mat,axis<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>) <span class="cf" style="color: #003B4F;">for</span> mat <span class="kw" style="color: #003B4F;">in</span> accum])</span>
<span id="cb7-3">stds <span class="op" style="color: #5E5E5E;">=</span> np.array([np.std(mat,axis<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>) <span class="cf" style="color: #003B4F;">for</span> mat <span class="kw" style="color: #003B4F;">in</span> accum])</span>
<span id="cb7-4">rel_stds <span class="op" style="color: #5E5E5E;">=</span> stds<span class="op" style="color: #5E5E5E;">/</span>means</span>
<span id="cb7-5">hist(rel_stds,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>,label<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'PMI1'</span>,<span class="st" style="color: #20794D;">'PMI2'</span>,<span class="st" style="color: #20794D;">'PMI3'</span>))<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb7-6">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb7-7">title(<span class="st" style="color: #20794D;">'inter-conformer variation, single stereoisomer'</span>)</span>
<span id="cb7-8">xlabel(<span class="st" style="color: #20794D;">'relative std dev'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>And let’s look at the standard deviations themselves:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb8-2">hist(stds,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>,label<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'PMI1'</span>,<span class="st" style="color: #20794D;">'PMI2'</span>,<span class="st" style="color: #20794D;">'PMI3'</span>))<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb8-3">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb8-4">title(<span class="st" style="color: #20794D;">'inter-conformer variation, single stereoisomer'</span>)</span>
<span id="cb8-5">xlabel(<span class="st" style="color: #20794D;">'std dev'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="variability-across-conformers-and-stereoisomers" class="level1">
<h1>Variability across conformers and stereoisomers</h1>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">m2s <span class="op" style="color: #5E5E5E;">=</span> [Chem.Mol(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms]</span></code></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">ps <span class="op" style="color: #5E5E5E;">=</span> rdDistGeom.srETKDGv3()</span>
<span id="cb10-2">ps.numThreads <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">6</span></span>
<span id="cb10-3">ps.randomSeed <span class="op" style="color: #5E5E5E;">=</span> <span class="bn" style="color: #AD0000;">0xf00d</span></span>
<span id="cb10-4">ps.pruneRmsThresh <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb10-5">ps.enforceChirality <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> m2s:</span>
<span id="cb10-8">    rdDistGeom.EmbedMultipleConfs(m,<span class="dv" style="color: #AD0000;">100</span>,ps)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">accum2 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> m2s:</span>
<span id="cb11-3">    confs <span class="op" style="color: #5E5E5E;">=</span> m.GetConformers()</span>
<span id="cb11-4">    d <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-5">    <span class="cf" style="color: #003B4F;">for</span> conf <span class="kw" style="color: #003B4F;">in</span> confs:</span>
<span id="cb11-6">        d.append((rdMolDescriptors.CalcPMI1(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId()),</span>
<span id="cb11-7">        rdMolDescriptors.CalcPMI2(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId()),</span>
<span id="cb11-8">        rdMolDescriptors.CalcPMI3(m,confId<span class="op" style="color: #5E5E5E;">=</span>conf.GetId())))</span>
<span id="cb11-9">    accum2.append(np.array(d))</span></code></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb12-2">means2 <span class="op" style="color: #5E5E5E;">=</span> np.array([np.average(mat,axis<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>) <span class="cf" style="color: #003B4F;">for</span> mat <span class="kw" style="color: #003B4F;">in</span> accum2])</span>
<span id="cb12-3">stds2 <span class="op" style="color: #5E5E5E;">=</span> np.array([np.std(mat,axis<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>) <span class="cf" style="color: #003B4F;">for</span> mat <span class="kw" style="color: #003B4F;">in</span> accum2])</span>
<span id="cb12-4">rel_stds2 <span class="op" style="color: #5E5E5E;">=</span> stds2<span class="op" style="color: #5E5E5E;">/</span>means2</span>
<span id="cb12-5">hist(rel_stds2,bins<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>,label<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'PMI1'</span>,<span class="st" style="color: #20794D;">'PMI2'</span>,<span class="st" style="color: #20794D;">'PMI3'</span>))<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-6">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-7">title(<span class="st" style="color: #20794D;">'inter-conformer variation, multiple stereoisomers'</span>)</span>
<span id="cb12-8">xlabel(<span class="st" style="color: #20794D;">'relative std dev'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="compare-the-single-stereisomer-variability-to-the-multiple-stereoisomer-variability" class="level1">
<h1>Compare the single stereisomer variability to the multiple stereoisomer variability</h1>
<p>First make sure that the means don’t actually change</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">figsize(<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb13-2">scatter((means)[:,<span class="dv" style="color: #AD0000;">0</span>],(means2)[:,<span class="dv" style="color: #AD0000;">0</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI1'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb13-3">scatter((means)[:,<span class="dv" style="color: #AD0000;">1</span>],(means2)[:,<span class="dv" style="color: #AD0000;">1</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI2'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb13-4">scatter((means)[:,<span class="dv" style="color: #AD0000;">2</span>],(means2)[:,<span class="dv" style="color: #AD0000;">2</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI3'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb13-5"></span>
<span id="cb13-6">ylabel(<span class="st" style="color: #20794D;">'multiple stereoisomers'</span>)</span>
<span id="cb13-7">xlabel(<span class="st" style="color: #20794D;">'single stereoisomer'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb13-8">title(<span class="st" style="color: #20794D;">'mean'</span>)</span>
<span id="cb13-9">legend()</span>
<span id="cb13-10">plot((<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">25000</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">25000</span>),<span class="st" style="color: #20794D;">'k'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>That looks good</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">figsize(<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb14-2"></span>
<span id="cb14-3">scatter((stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">0</span>],(stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">0</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI1'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-4">scatter((stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">1</span>],(stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">1</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI2'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-5">scatter((stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">2</span>],(stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">2</span>],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PMI3'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-6"></span>
<span id="cb14-7">ylabel(<span class="st" style="color: #20794D;">'multiple stereoisomers'</span>)</span>
<span id="cb14-8">xlabel(<span class="st" style="color: #20794D;">'single stereoisomer'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-9">title(<span class="st" style="color: #20794D;">'relative std dev'</span>)</span>
<span id="cb14-10">legend()</span>
<span id="cb14-11">plot((<span class="dv" style="color: #AD0000;">0</span>,<span class="fl" style="color: #AD0000;">0.35</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="fl" style="color: #AD0000;">0.35</span>),<span class="st" style="color: #20794D;">'k'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>So, at least for this set of 50 molecules, it looks like the answer to Axel’s question is that the differences in PMI which arise from differing stereoisomers are small relative to the differences between conformers.</p>
<p>Let’s still dig into the results a little bit. Which molecule(s) have the highest deviation for each of the moments?</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">indices <span class="op" style="color: #5E5E5E;">=</span> (argmax((stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">-</span>(stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">0</span>]),<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb15-2">argmax((stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">1</span>]<span class="op" style="color: #5E5E5E;">-</span>(stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">1</span>]),<span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb15-3">argmax((stds2<span class="op" style="color: #5E5E5E;">/</span>means2)[:,<span class="dv" style="color: #AD0000;">2</span>]<span class="op" style="color: #5E5E5E;">-</span>(stds<span class="op" style="color: #5E5E5E;">/</span>means)[:,<span class="dv" style="color: #AD0000;">2</span>]))</span>
<span id="cb15-4">indices</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(13, 13, 37)</code></pre>
</div>
</div>
<p>Let’s look at those two molecules</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">350</span>,<span class="dv" style="color: #AD0000;">350</span></span>
<span id="cb17-2">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb17-3"></span>
<span id="cb17-4">maxdevs <span class="op" style="color: #5E5E5E;">=</span> [Chem.RemoveHs(Chem.Mol(ms[x])) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> (<span class="dv" style="color: #AD0000;">13</span>,<span class="dv" style="color: #AD0000;">37</span>)]</span>
<span id="cb17-5"><span class="cf" style="color: #003B4F;">for</span> md <span class="kw" style="color: #003B4F;">in</span> maxdevs:</span>
<span id="cb17-6">           rdDepictor.Compute2DCoords(md)</span>
<span id="cb17-7">Draw.MolsToGridImage(maxdevs,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">350</span>,<span class="dv" style="color: #AD0000;">350</span>),molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Just to be sure, check which atoms can be stereo:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">Chem.AssignStereochemistry(maxdevs[<span class="dv" style="color: #AD0000;">0</span>],force<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,flagPossibleStereoCenters<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb18-2"><span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> maxdevs[<span class="dv" style="color: #AD0000;">0</span>].GetAtoms():</span>
<span id="cb18-3">    <span class="cf" style="color: #003B4F;">if</span> atom.HasProp(<span class="st" style="color: #20794D;">'_ChiralityPossible'</span>):</span>
<span id="cb18-4">        <span class="bu" style="color: null;">print</span>(atom.GetIdx())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>11
16</code></pre>
</div>
</div>
<p>Look at one of the conformers:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb20-2">ms[<span class="dv" style="color: #AD0000;">13</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_16551054842074397" style="position: relative; width: 400px; height: 400px">
        <p id="3dmolwarning_16551054842074397" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_16551054842074397 = null;
var warn = document.getElementById("3dmolwarning_16551054842074397");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_16551054842074397 = $3Dmol.createViewer($("#3dmolviewer_16551054842074397"),{backgroundColor:"white"});
viewer_16551054842074397.zoomTo();
    viewer_16551054842074397.removeAllModels();
    viewer_16551054842074397.addModel("07N_3TTZ_A\n     RDKit          3D\n\n 40 42  0  0  0  0  0  0  0  0999 V2000\n   -7.4715    0.1655   -0.4576 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0437    2.2227    1.6642 Cl  0  0  0  0  0  0  0  0  0  0  0  0\n   -6.0200    0.3800   -0.1174 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.4395    2.5858    1.5366 Cl  0  0  0  0  0  0  0  0  0  0  0  0\n   -5.5156    1.3617    0.7018 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.1294    1.2048    0.7472 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.8030    0.1385   -0.0375 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9794   -0.3349   -0.5447 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.5047   -0.4476   -0.3343 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.4574   -1.4555   -1.1073 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.2641    0.0015    0.1618 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0121   -0.6473   -0.1890 C   0  0  2  0  0  0  0  0  0  0  0  0\n    0.7519   -1.1170    1.0228 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0421   -1.7658    0.6195 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8108   -0.7767   -0.1221 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1724   -0.2706   -1.3347 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8652    0.3711   -0.9040 C   0  0  2  0  0  0  0  0  0  0  0  0\n    1.0617    1.4428   -0.0781 F   0  0  0  0  0  0  0  0  0  0  0  0\n    4.0649   -0.3389    0.2875 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.7867   -0.6905    1.3545 N   0  0  0  0  0  0  0  0  0  0  0  0\n    5.9396   -0.1692    1.5674 C   0  0  0  0  0  0  0  0  0  0  0  0\n    6.4070    0.7583    0.6675 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.1279    0.8222   -0.4534 S   0  0  0  0  0  0  0  0  0  0  0  0\n    7.6880    1.4802    0.7075 C   0  0  0  0  0  0  0  0  0  0  0  0\n    8.4853    1.2684    1.6431 O   0  0  0  0  0  0  0  0  0  0  0  0\n    7.9588    2.3706   -0.3002 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.6565    0.7998   -1.3629 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.5623   -0.9010   -0.7784 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -8.1248    0.4229    0.3793 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0790   -1.1642   -1.1975 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.2439    0.8192    0.7960 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.1411   -1.5072   -0.8689 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.1332   -1.7834    1.6697 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.0347   -0.1886    1.5828 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5798   -2.0969    1.5296 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8058   -2.6092   -0.0596 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7977    0.4975   -1.7922 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0317   -1.1053   -2.0196 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3371    0.7002   -1.8087 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.5662   -0.4438    2.4517 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  3  1  0\n  2  6  1  0\n  3  5  2  0\n  3  8  1  0\n  4  5  1  0\n  5  6  1  0\n  6  7  2  0\n  7  8  1  0\n  7  9  1  0\n  9 10  2  0\n  9 11  1  0\n 11 12  1  0\n 12 13  1  0\n 12 17  1  0\n 13 14  1  0\n 14 15  1  0\n 15 16  1  0\n 15 19  1  0\n 16 17  1  0\n 17 18  1  0\n 19 20  2  0\n 19 23  1  0\n 20 21  1  0\n 21 22  2  0\n 22 23  1  0\n 22 24  1  0\n 24 25  2  0\n 24 26  1  0\n  1 27  1  0\n  1 28  1  0\n  1 29  1  0\n  8 30  1  0\n 11 31  1  0\n 12 32  1  6\n 13 33  1  0\n 13 34  1  0\n 14 35  1  0\n 14 36  1  0\n 16 37  1  0\n 16 38  1  0\n 17 39  1  6\n 21 40  1  0\nM  CHG  1  26  -1\nM  END\n","sdf");
    viewer_16551054842074397.setStyle({"stick": {}});
    viewer_16551054842074397.setBackgroundColor("0xeeeeee");
    viewer_16551054842074397.zoomTo();
viewer_16551054842074397.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">

</div>
</div>


</section>

 ]]></description>
  <category>3d</category>
  <category>questions</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-06-22-variability-of-pmi-descriptors.html</guid>
  <pubDate>Tue, 21 Jun 2022 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/pmi-variability-1.png" medium="image" type="image/png" height="102" width="144"/>
</item>
<item>
  <title>Searching with generic groups</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups.html</link>
  <description><![CDATA[ 



<p>One of the features added for the v2022.03 RDKit release is support for “Reaxys/Beilstein” generic groups - atoms with labels like “ARY” or “ACY” which can be used to make substructure searches more specific.</p>
<p>This post provides a quick overview of that functionality.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolEnumerator</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdTautomerQuery</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-6">IPythonConsole.drawOptions.minFontSize <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb1-7">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">350</span>,<span class="dv" style="color: #AD0000;">300</span></span>
<span id="cb1-8"></span>
<span id="cb1-9">Draw.SetComicMode(IPythonConsole.drawOptions)</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-11">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-12"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-13"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span>
<span id="cb1-14"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-15"><span class="bu" style="color: null;">print</span>(time.asctime())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.1
Tue Apr  5 06:10:45 2022</code></pre>
</div>
</div>
<p>Load a <code>SubstructLibrary</code> created using ChEMBL_30. The code used to construct this is below. Note that I’ve configured the <code>SubstructLibrary</code> to return search results sorted by the number of heavy atoms so that I get smaller, more specific results first.</p>
<pre><code>from rdkit import RDLogger
from rdkit import Chem
from rdkit.Chem import rdSubstructLibrary
import pickle, time
import gzip
import numpy as np

gz = gzip.GzipFile('/home/glandrum/Downloads/chembl_30.sdf.gz')
suppl = Chem.ForwardSDMolSupplier(gz)
RDLogger.DisableLog("rdApp.warning")
t1=time.time()
data = []
for i,mol in enumerate(suppl):
    if not ((i+1)%50000):
        print(f"Processed {i+1} molecules in {(time.time()-t1):.1f} seconds")
    if mol is None or mol.GetNumHeavyAtoms()&gt;50:
        continue
    fp = Chem.PatternFingerprint(mol,fpSize=1024,tautomerFingerprints=True)
    smi = Chem.MolToSmiles(mol)
    data.append((smi,fp,mol.GetNumHeavyAtoms()))
t2=time.time()
pickle.dump(data,open('./results/chembl30_sssdata.pkl','wb+'))
t1=time.time()
mols = rdSubstructLibrary.CachedTrustedSmilesMolHolder()
fps = rdSubstructLibrary.TautomerPatternHolder(1024)
natoms = []
for smi,fp,nats in data:
    mols.AddSmiles(smi)
    fps.AddFingerprint(fp)
    natoms.append(nats)
library = rdSubstructLibrary.SubstructLibrary(mols,fps)
library.SetSearchOrder([int(x) for x in np.argsort(natoms)])

t2=time.time()
print(f"That took {t2-t1:.2f} seconds. The library has {len(library)} molecules.")
pickle.dump(library,open('./results/chembl30_ssslib.pkl','wb+'))</code></pre>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb4-2"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/chembl30_ssslib.pkl'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb4-3">    sslib <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb4-4"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'SubstructLibrary loaded with </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(sslib)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> molecules'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SubstructLibrary loaded with 2035013 molecules</code></pre>
</div>
</div>
<section id="beilstein-generic-queries" class="level1">
<h1>Beilstein generic queries</h1>
<p>Start with a simple query molecule which includes a generic atom in an SGroup:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">mb <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'''</span></span>
<span id="cb6-2"><span class="st" style="color: #20794D;">  Mrv2108 04052206092D          </span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb6-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb6-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 10 11 1 0 0</span></span>
<span id="cb6-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb6-8"><span class="st" style="color: #20794D;">M  V30 1 C -11.4118 0.5479 0 0</span></span>
<span id="cb6-9"><span class="st" style="color: #20794D;">M  V30 2 C -11.3849 -0.9919 0 0</span></span>
<span id="cb6-10"><span class="st" style="color: #20794D;">M  V30 3 C -10.0379 -1.7385 0 0</span></span>
<span id="cb6-11"><span class="st" style="color: #20794D;">M  V30 4 C -8.7179 -0.9454 0 0</span></span>
<span id="cb6-12"><span class="st" style="color: #20794D;">M  V30 5 C -8.7448 0.5943 0 0</span></span>
<span id="cb6-13"><span class="st" style="color: #20794D;">M  V30 6 C -10.0918 1.341 0 0</span></span>
<span id="cb6-14"><span class="st" style="color: #20794D;">M  V30 7 N -7.2453 -1.3956 0 0</span></span>
<span id="cb6-15"><span class="st" style="color: #20794D;">M  V30 8 C -6.362 -0.1342 0 0</span></span>
<span id="cb6-16"><span class="st" style="color: #20794D;">M  V30 9 N -7.2888 1.0958 0 0</span></span>
<span id="cb6-17"><span class="st" style="color: #20794D;">M  V30 10 C -4.8222 -0.161 0 0</span></span>
<span id="cb6-18"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb6-19"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb6-20"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb6-21"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb6-22"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb6-23"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb6-24"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb6-25"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb6-26"><span class="st" style="color: #20794D;">M  V30 7 1 7 8</span></span>
<span id="cb6-27"><span class="st" style="color: #20794D;">M  V30 8 1 5 9</span></span>
<span id="cb6-28"><span class="st" style="color: #20794D;">M  V30 9 1 4 7</span></span>
<span id="cb6-29"><span class="st" style="color: #20794D;">M  V30 10 2 8 9</span></span>
<span id="cb6-30"><span class="st" style="color: #20794D;">M  V30 11 1 8 10</span></span>
<span id="cb6-31"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb6-32"><span class="st" style="color: #20794D;">M  V30 BEGIN SGROUP</span></span>
<span id="cb6-33"><span class="st" style="color: #20794D;">M  V30 1 SUP 0 -</span></span>
<span id="cb6-34"><span class="st" style="color: #20794D;">M  V30 ATOMS=(1 10) -</span></span>
<span id="cb6-35"><span class="st" style="color: #20794D;">M  V30 LABEL="ARY"</span></span>
<span id="cb6-36"><span class="st" style="color: #20794D;">M  V30 END SGROUP</span></span>
<span id="cb6-37"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb6-38"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb6-39"><span class="st" style="color: #20794D;">'''</span></span>
<span id="cb6-40">bqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb6-41"></span>
<span id="cb6-42"><span class="co" style="color: #5E5E5E;"># show labels for the Sgroups:</span></span>
<span id="cb6-43"><span class="cf" style="color: #003B4F;">for</span> sgs <span class="kw" style="color: #003B4F;">in</span> Chem.GetMolSubstanceGroups(bqry):</span>
<span id="cb6-44">    <span class="cf" style="color: #003B4F;">if</span> sgs.GetProp(<span class="st" style="color: #20794D;">'TYPE'</span>) <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'SUP'</span>:</span>
<span id="cb6-45">        bqry.GetAtomWithIdx(sgs.GetAtoms()[<span class="dv" style="color: #AD0000;">0</span>]).SetProp(<span class="st" style="color: #20794D;">"atomLabel"</span>,sgs.GetProp(<span class="st" style="color: #20794D;">"LABEL"</span>))</span>
<span id="cb6-46">bqry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Initially the generic <code>ARY</code> query is not used in the substructure search:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(bqry)</span>
<span id="cb7-2">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb7-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb7-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1000 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>But we can limit the results to aryl substituents by expanding the generic query and telling the SubstructLib to use it:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">ary_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(bqry)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;"># expand the query:</span></span>
<span id="cb9-4">Chem.SetGenericQueriesFromProperties(ary_qry)</span>
<span id="cb9-5"></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;"># do the search using generic query matchers:</span></span>
<span id="cb9-7">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb9-8">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb9-9">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ary_qry,params)</span>
<span id="cb9-10"></span>
<span id="cb9-11">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb9-12"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb9-13">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1000 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-6-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The full list of recognized generic atoms is here: https://github.com/rdkit/rdkit/blob/master/Code/GraphMol/GenericGroups/GenericGroups.h#L245 (And, yes, that should be in the documentation… hopefully we can get that in for the next release).</p>
<p>Here are a couple of more examples</p>
<p><code>AHC</code>: heteroacyclic groups</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">mb <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'''</span></span>
<span id="cb11-2"><span class="st" style="color: #20794D;">  Mrv2108 03242208122D          </span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb11-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb11-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 10 11 1 0 0</span></span>
<span id="cb11-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb11-8"><span class="st" style="color: #20794D;">M  V30 1 C -11.4118 0.5479 0 0</span></span>
<span id="cb11-9"><span class="st" style="color: #20794D;">M  V30 2 C -11.3849 -0.9919 0 0</span></span>
<span id="cb11-10"><span class="st" style="color: #20794D;">M  V30 3 C -10.0379 -1.7385 0 0</span></span>
<span id="cb11-11"><span class="st" style="color: #20794D;">M  V30 4 C -8.7179 -0.9454 0 0</span></span>
<span id="cb11-12"><span class="st" style="color: #20794D;">M  V30 5 C -8.7448 0.5943 0 0</span></span>
<span id="cb11-13"><span class="st" style="color: #20794D;">M  V30 6 C -10.0918 1.341 0 0</span></span>
<span id="cb11-14"><span class="st" style="color: #20794D;">M  V30 7 N -7.2453 -1.3956 0 0</span></span>
<span id="cb11-15"><span class="st" style="color: #20794D;">M  V30 8 C -6.362 -0.1342 0 0</span></span>
<span id="cb11-16"><span class="st" style="color: #20794D;">M  V30 9 N -7.2888 1.0958 0 0</span></span>
<span id="cb11-17"><span class="st" style="color: #20794D;">M  V30 10 C -4.8222 -0.161 0 0</span></span>
<span id="cb11-18"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb11-19"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb11-20"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb11-21"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb11-22"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb11-23"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb11-24"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb11-25"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb11-26"><span class="st" style="color: #20794D;">M  V30 7 1 7 8</span></span>
<span id="cb11-27"><span class="st" style="color: #20794D;">M  V30 8 1 5 9</span></span>
<span id="cb11-28"><span class="st" style="color: #20794D;">M  V30 9 1 4 7</span></span>
<span id="cb11-29"><span class="st" style="color: #20794D;">M  V30 10 2 8 9</span></span>
<span id="cb11-30"><span class="st" style="color: #20794D;">M  V30 11 1 8 10</span></span>
<span id="cb11-31"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb11-32"><span class="st" style="color: #20794D;">M  V30 BEGIN SGROUP</span></span>
<span id="cb11-33"><span class="st" style="color: #20794D;">M  V30 1 SUP 0 ATOMS=(1 10) SAP=(3 10 8 1) XBONDS=(1 11) LABEL=AHC</span></span>
<span id="cb11-34"><span class="st" style="color: #20794D;">M  V30 END SGROUP</span></span>
<span id="cb11-35"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb11-36"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb11-37"><span class="st" style="color: #20794D;">'''</span></span>
<span id="cb11-38">bqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb11-39"></span>
<span id="cb11-40"><span class="co" style="color: #5E5E5E;"># show labels for the Sgroups:</span></span>
<span id="cb11-41"><span class="cf" style="color: #003B4F;">for</span> sgs <span class="kw" style="color: #003B4F;">in</span> Chem.GetMolSubstanceGroups(bqry):</span>
<span id="cb11-42">    <span class="cf" style="color: #003B4F;">if</span> sgs.GetProp(<span class="st" style="color: #20794D;">'TYPE'</span>) <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'SUP'</span>:</span>
<span id="cb11-43">        bqry.GetAtomWithIdx(sgs.GetAtoms()[<span class="dv" style="color: #AD0000;">0</span>]).SetProp(<span class="st" style="color: #20794D;">"atomLabel"</span>,sgs.GetProp(<span class="st" style="color: #20794D;">"LABEL"</span>))</span>
<span id="cb11-44">ahc_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(bqry)</span>
<span id="cb11-45"></span>
<span id="cb11-46"><span class="co" style="color: #5E5E5E;"># expand the query:</span></span>
<span id="cb11-47">Chem.SetGenericQueriesFromProperties(ahc_qry)</span>
<span id="cb11-48"></span>
<span id="cb11-49"><span class="co" style="color: #5E5E5E;"># do the search using generic query matchers:</span></span>
<span id="cb11-50">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb11-51">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb11-52">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ahc_qry,params)</span>
<span id="cb11-53"></span>
<span id="cb11-54">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb11-55"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb11-56">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1000 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><code>CAL</code>: carbocyclic alkyl</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">mb <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'''</span></span>
<span id="cb13-2"><span class="st" style="color: #20794D;">  Mrv2108 03242208122D          </span></span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb13-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb13-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 10 11 1 0 0</span></span>
<span id="cb13-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb13-8"><span class="st" style="color: #20794D;">M  V30 1 C -11.4118 0.5479 0 0</span></span>
<span id="cb13-9"><span class="st" style="color: #20794D;">M  V30 2 C -11.3849 -0.9919 0 0</span></span>
<span id="cb13-10"><span class="st" style="color: #20794D;">M  V30 3 C -10.0379 -1.7385 0 0</span></span>
<span id="cb13-11"><span class="st" style="color: #20794D;">M  V30 4 C -8.7179 -0.9454 0 0</span></span>
<span id="cb13-12"><span class="st" style="color: #20794D;">M  V30 5 C -8.7448 0.5943 0 0</span></span>
<span id="cb13-13"><span class="st" style="color: #20794D;">M  V30 6 C -10.0918 1.341 0 0</span></span>
<span id="cb13-14"><span class="st" style="color: #20794D;">M  V30 7 N -7.2453 -1.3956 0 0</span></span>
<span id="cb13-15"><span class="st" style="color: #20794D;">M  V30 8 C -6.362 -0.1342 0 0</span></span>
<span id="cb13-16"><span class="st" style="color: #20794D;">M  V30 9 N -7.2888 1.0958 0 0</span></span>
<span id="cb13-17"><span class="st" style="color: #20794D;">M  V30 10 C -4.8222 -0.161 0 0</span></span>
<span id="cb13-18"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb13-19"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb13-20"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb13-21"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb13-22"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb13-23"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb13-24"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb13-25"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb13-26"><span class="st" style="color: #20794D;">M  V30 7 1 7 8</span></span>
<span id="cb13-27"><span class="st" style="color: #20794D;">M  V30 8 1 5 9</span></span>
<span id="cb13-28"><span class="st" style="color: #20794D;">M  V30 9 1 4 7</span></span>
<span id="cb13-29"><span class="st" style="color: #20794D;">M  V30 10 2 8 9</span></span>
<span id="cb13-30"><span class="st" style="color: #20794D;">M  V30 11 1 8 10</span></span>
<span id="cb13-31"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb13-32"><span class="st" style="color: #20794D;">M  V30 BEGIN SGROUP</span></span>
<span id="cb13-33"><span class="st" style="color: #20794D;">M  V30 1 SUP 0 ATOMS=(1 10) SAP=(3 10 8 1) XBONDS=(1 11) LABEL=CAL</span></span>
<span id="cb13-34"><span class="st" style="color: #20794D;">M  V30 END SGROUP</span></span>
<span id="cb13-35"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb13-36"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb13-37"><span class="st" style="color: #20794D;">'''</span></span>
<span id="cb13-38">bqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb13-39"></span>
<span id="cb13-40">cal_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(bqry)</span>
<span id="cb13-41"></span>
<span id="cb13-42"><span class="co" style="color: #5E5E5E;"># expand the query:</span></span>
<span id="cb13-43">Chem.SetGenericQueriesFromProperties(cal_qry)</span>
<span id="cb13-44"></span>
<span id="cb13-45"><span class="co" style="color: #5E5E5E;"># do the search using generic query matchers:</span></span>
<span id="cb13-46">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb13-47">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb13-48">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(cal_qry,params)</span>
<span id="cb13-49"></span>
<span id="cb13-50">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb13-51"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb13-52">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 784 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="providing-the-queries-in-cxsmiles" class="level1">
<h1>Providing the queries in CXSMILES</h1>
<p>You can also use CXSMILES/CXSMARTS to provide these queries:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;"># AHC: heteroacyclic</span></span>
<span id="cb15-2">sqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;">'*-c1nc2c(n1)cccc2 |$AHC;;;;;;;;;$|'</span>)</span>
<span id="cb15-3">sqry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">ahc_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(sqry)</span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;"># expand the query:</span></span>
<span id="cb16-3">Chem.SetGenericQueriesFromProperties(ahc_qry)</span>
<span id="cb16-4"></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;"># do the search using generic query matchers:</span></span>
<span id="cb16-6">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb16-7">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb16-8">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ahc_qry,params)</span>
<span id="cb16-9"></span>
<span id="cb16-10">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb16-11"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb16-12">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1000 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Though note that if you use CXSMILES it’s important to make sure the dummy atom is replaced with a query before doing the search. If you don’t do so, you’ll get no results since the dummy atom only matches other dummy atoms:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">sqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'*C1=NC2=C(N1)C=CC=C2 |$AHC;;;;;;;;;$|'</span>)</span>
<span id="cb18-2">ahc_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(sqry)</span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;"># expand the query:</span></span>
<span id="cb18-4">Chem.SetGenericQueriesFromProperties(ahc_qry)</span>
<span id="cb18-5"></span>
<span id="cb18-6">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb18-7">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb18-8">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ahc_qry,params)</span>
<span id="cb18-9"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 0 matches</code></pre>
</div>
</div>
<p>Here’s the fix:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">qps <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryParameters.NoAdjustments()</span>
<span id="cb20-2">qps.makeDummiesQueries <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb20-3">sqry <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(sqry)</span>
<span id="cb20-4"></span>
<span id="cb20-5">ahc_qry <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(sqry)</span>
<span id="cb20-6">Chem.SetGenericQueriesFromProperties(ahc_qry)</span>
<span id="cb20-7">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb20-8">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb20-9">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ahc_qry,params)</span>
<span id="cb20-10"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 186 matches</code></pre>
</div>
</div>
</section>
<section id="search-performance" class="level1">
<h1>Search performance</h1>
<p>Get a baseline for how long a search takes by ignoring the generic matchers:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb22-2">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb22-3"><span class="op" style="color: #5E5E5E;">%</span>timeit matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(cal_qry,params,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>329 ms ± 6.11 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>We’d expect the searches using generic groups to take at least a bit longer since they will results in more molecules being scanned until we find our 5000 results. The big question is whether or not merely including the generic queries results in a significant slow down.</p>
<p>Let’s test how much longer it takes using two of the different generic groups:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;"># Start with "CAL"</span></span>
<span id="cb24-2">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb24-3">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb24-4"><span class="op" style="color: #5E5E5E;">%</span>timeit matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(cal_qry,params,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>415 ms ± 18.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>That really doesn’t make much of a difference at all.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;"># "ARY"</span></span>
<span id="cb26-2">params <span class="op" style="color: #5E5E5E;">=</span> Chem.SubstructMatchParameters()</span>
<span id="cb26-3">params.useGenericMatchers <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb26-4"><span class="op" style="color: #5E5E5E;">%</span>timeit matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ary_qry,params,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.24 s ± 139 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>So there is definitely some impact, and it depends on which generic query is being used.</p>
<section id="aside" class="level2">
<h2 class="anchored" data-anchor-id="aside">Aside</h2>
<p>Since the ARY query mainly returns molecules which have a phenyl group attached at the ARY position, let’s compare search performance with a query where we explicitly include the phenyl. Here the extra atoms/bonds will slow the substructure search down but they will also make the fingerprint screenout more effective. The question is which effect is dominant.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">fullqry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'c1ccccc1-c1nc2ccccc2[nH]1'</span>)</span>
<span id="cb28-2">fullqry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="op" style="color: #5E5E5E;">%</span>timeit matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(fullqry,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">5000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.05 s ± 54.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<p>In this case the larger query is a bit faster.</p>
<p>It’s worth mentioning that the query with the phenyl group returns different search results than the version with the ARY:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">full_matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(fullqry,params,maxResults<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb31-2">ary_matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(ary_qry,params,maxResults<span class="op" style="color: #5E5E5E;">=-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb31-3"><span class="bu" style="color: null;">len</span>(full_matches),<span class="bu" style="color: null;">len</span>(ary_matches)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(6866, 6488)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">full_not_ary <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(full_matches).difference(ary_matches)</span>
<span id="cb33-2">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> full_not_ary]</span>
<span id="cb33-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb33-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 379 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-19-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>As you’d expect, there are a bunch of molecules with heterocyclic aromatic systems here. The ARY query only matches carboaryl systems.</p>
<p>There is only one molecule returned by the ARY query but not the full query; this one has an unusual aromatic ring system:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">ary_not_full <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(ary_matches).difference(full_matches)</span>
<span id="cb35-2">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ary_not_full]</span>
<span id="cb35-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb35-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 1 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>That’s a good one to ignite a round of “but that’s not aromatic!” arguments, but before you start down that road, please read this section of the RDKit docs: https://www.rdkit.org/docs/RDKit_Book.html#aromaticity and possibly the section on aromaticity in the <a href="https://www.daylight.com/dayhtml/doc/theory/theory.smiles.html">Daylight Theory manual</a>.</p>
<p>This seems like a great place to close this post. :-)</p>


</section>
</section>

 ]]></description>
  <category>tutorial</category>
  <category>substructure</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-04-05-searching-with-generic-groups.html</guid>
  <pubDate>Mon, 04 Apr 2022 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/searching-with-generic-groups-img1.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>Some thoughts on refactoring the MolDraw2D code</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-03-18-refactoring-moldraw2d.html</link>
  <description><![CDATA[ 



<p><em>The functionality described here is available in the 2022.03.1 and later releases of the RDKit</em></p>
<section id="intro" class="level1">
<h1>Intro</h1>
<p>I recently merged a pull request (https://github.com/rdkit/rdkit/pull/4948) from Dave Cosgrove with some pretty significant changes (58 modified files and &gt;8000 modified lines of code according to Github) to the backend MolDraw2D code. Dave and I have been working on this (well, ok, Dave has been working, I’ve been commenting on his work ;-) ) for a couple of months.</p>
<p>Given the amount of effort that went into this PR, and how happy I am about it, it may be somewhat surprising to hear that I hope that most of these changes will remain more or less invisible to most of the RDKit community. All existing code and scripts should continue to work without modification, though there may be some small changes (I hope they are improvements) to the way molecules are actually drawn; see below for more information on this.</p>
</section>
<section id="why-do-something-like-this" class="level1">
<h1>Why do something like this?</h1>
<p>The MolDraw2D code is heavily used and, in my opinion, pretty important. Over the last few years it had also gotten pretty complex and difficult to maintain. Some of that complexity is inevitable, the rendering code is quite flexible and is solving a non-trivial problem, but a lot of it was also due to the incremental addition of features over time. This “accidental” complexity made both extending and fixing the code more difficult. So at the end of 2021 when Dave had time to do a chunk of work on the RDKit and T5 Informatics had some funds available, we took what we’ve learned over the past years and Dave rewrote the backend. The goal was to clean things up and make the code more extensible and maintainable without breaking existing code.</p>
</section>
<section id="end-user-visible-changes" class="level1">
<h1>End-user visible changes</h1>
<section id="molecule-rendering" class="level2">
<h2 class="anchored" data-anchor-id="molecule-rendering">Molecule rendering</h2>
<p>There are some small differences in the way molecules are rendered; these will most likely only be visible if you are really paying attention.</p>
</section>
<section id="reaction-rendering" class="level2">
<h2 class="anchored" data-anchor-id="reaction-rendering">Reaction rendering</h2>
<p>Here the changes are a bit larger: the reaction rendering code now makes better use of the available space.</p>
<p>Here’s a rendering of one of the sample reactions we use in the testing code using the 2021.09.4 release of the RDKit:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-0.png" class="img-fluid"></p>
<p>Here’s the new version:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-1.png" class="img-fluid"></p>
</section>
</section>
<section id="new-features" class="level1">
<h1>New features</h1>
<section id="drawing-molecules-in-grids-using-different-scales" class="level2">
<h2 class="anchored" data-anchor-id="drawing-molecules-in-grids-using-different-scales">Drawing molecules in grids using different scales</h2>
<p>When drawing molecules in a grid the default behavior is to draw them all at the same scale. Here’s an example of that:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-2.png" class="img-fluid"></p>
<p>Since the last molecule is big, the other two molecules end up being drawn really small. We can change that by setting the new drawing option <code>drawMolsSameScale</code> to False:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-3.png" class="img-fluid"></p>
<p>As an aside: if you’re bothered by how big small molecules like ethanol end up being, you can use the <code>fixedBondLength</code> drawing option (units are, roughly, pixels per angstrom) to set the maximum bond length. Combining this with <code>drawMolsSameScale=False</code> for the three molecules above results in:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-4.png" class="img-fluid"></p>
</section>
<section id="the-flexicanvas-fitting-the-canvas-size-to-the-molecule" class="level2">
<h2 class="anchored" data-anchor-id="the-flexicanvas-fitting-the-canvas-size-to-the-molecule">The “flexicanvas”: fitting the canvas size to the molecule</h2>
<p>Aside: I added the initial version of this before Dave did the refactoring, but the new backend simplifies the implementation.</p>
<p>Normally the drawing code scales the molecule and font size to fit the canvas provided for it. With the SVG and Cairo renderers it’s now possible to set the font size and scale and let the drawer figure out how large the canvas needs to be. If I use this feature I get a larger canvas for oxytocin:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-5.png" class="img-fluid"></p>
<p>than I do for ezetimibe:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-6.png" class="img-fluid"></p>
<p>but the bond lengths and font sizes are the same in each image.</p>
<p>You can use this functionality by creating a MolDraw2D object with width and height set to -1. Here’s the code used to produce the image of ezetimibe above:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">ezetimibe <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'O=C1[C@H](CC[C@H](O)c2ccc(F)cc2)[C@@H](c2ccc(O)cc2)N1c1ccc(F)cc1'</span>)</span>
<span id="cb1-2">d2d <span class="op" style="color: #5E5E5E;">=</span> Draw.MolDraw2DCairo(<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb1-3">d2d.drawOptions().scalingFactor <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">20</span>  <span class="co" style="color: #5E5E5E;"># units are roughly pixels/angstrom</span></span>
<span id="cb1-4">d2d.drawOptions().fixedFontSize <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">14</span></span>
<span id="cb1-5">d2d.DrawMolecule(ezetimibe)</span>
<span id="cb1-6">d2d.FinishDrawing()</span>
<span id="cb1-7">Image(d2d.GetDrawingText())</span></code></pre></div>
</section>
</section>
<section id="control-over-font-size" class="level1">
<h1>Control over font size</h1>
<p>This is a particularly difficult one because there are just too many odd and conflicting situations which need to be handled. Here are some of the outliers:</p>
<ul>
<li>small molecules in large canvases</li>
<li>large molecules in small canvases where you expect to be able to read the fonts</li>
<li>very large molecules in small canvases there’s no practical way to be able to read the fonts</li>
</ul>
<p>You have a number of ways to control the font size used when drawing molecules. Let’s start with a small drawing of oxytocin and the default font parameters:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-7.png" class="img-fluid"></p>
<p>The relative size of the font and the bond lengths is controlled by the <code>baseFontSize</code> option, which defaults to 0.6. Increasing it to, for example, 0.8 increases the relative font size, this affects every drawing:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-8.png" class="img-fluid"></p>
<p>You can also set a minimum font size in points with the <code>minFontSize</code> option (not shown here).</p>
<p>Finally, it’s possible to set an exact font size to use with the <code>fixedFontSize</code> option. Here, again, is oxytocin but with <code>fixedFontSize=13</code>(obviously this is too large for this canvas size):</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-9.png" class="img-fluid"></p>
</section>
<section id="giving-the-legend-a-bit-more-space" class="level1">
<h1>Giving the legend a bit more space</h1>
<p>When you draw a molecule with a legend 10% of the vertical space is set aside for the canvas. This seems to work well for single-line legends:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-10.png" class="img-fluid"></p>
<p>But results in a pretty small font if the legend has multiple lines:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-11.png" class="img-fluid"></p>
<p>In cases like this we can set <code>legendFraction</code> to something like 0.15 to give the legend a bit more room:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-12.png" class="img-fluid"></p>
</section>
<section id="legends-and-flexicanvas-mode" class="level1">
<h1>Legends and flexicanvas mode</h1>
<p>When you don’t specify the size of the canvas in advance, the <code>legendFontSize</code> parameter is directly used to control the size of the legend. For example, here’s a 24 point legend:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-13.png" class="img-fluid"></p>
<p>or the same legend but with <code>legendFontSize=12</code>:</p>
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-14.png" class="img-fluid"></p>


</section>

 ]]></description>
  <category>technical</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-03-18-refactoring-moldraw2d.html</guid>
  <pubDate>Thu, 17 Mar 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/refactoring-moldraw2d-0.png" medium="image" type="image/png" height="29" width="144"/>
</item>
<item>
  <title>R-group decomposition and molzip</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip.html</link>
  <description><![CDATA[ 



<p>Recently a couple of customers have asked questions along the lines of: “How do I do an R-group decomposition and then recombine the cores and R groups to create new molecules?” That’s an interesting and useful task which the RDKit has some built-in tools to help with, so I figured I’d do a blog post.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdqueries</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdRGroupDecomposition</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Geometry</span>
<span id="cb1-8">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> itertools</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-11"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.03.1pre</code></pre>
</div>
</div>
<p>Note: Though I’m doing this blog post using a local build from RDKit master all of the functionality which I demonstrate here is already available in the 2021.09 release series.</p>
<section id="read-in-the-dataset" class="level1">
<h1>Read in the dataset</h1>
<p>Read in a bunch of molecules from a J Med Chem paper (https://doi.org/10.1021/acs.jmedchem.7b00306 the paper is open access). Here I downloaded the SMILES in the supporting information, sketched the scaffold manually, and then saved the scaffold + molecules to an SD file. The scaffold is the first molecule in the SDF.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">ms <span class="op" style="color: #5E5E5E;">=</span> [mol <span class="cf" style="color: #003B4F;">for</span> mol <span class="kw" style="color: #003B4F;">in</span> Chem.SDMolSupplier(<span class="st" style="color: #20794D;">'../data/jm7b00306.sdf'</span>)]</span>
<span id="cb3-2">core <span class="op" style="color: #5E5E5E;">=</span> ms[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb3-3">ms.pop(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb3-4"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(ms)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> molecules'</span>)</span>
<span id="cb3-5">core</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 31 molecules</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">

<table><tbody><tr><td colspan="2" style="text-align:center"><img src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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"></td></tr>
<tr><th style="text-align:right">scaffold</th><td style="text-align:left">1</td></tr></tbody></table>
</div>
</div>
<p>Now let’s look at some of the other molecules</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">Draw.MolsToGridImage(ms[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="doing-the-r-group-decomposition" class="level1">
<h1>Doing the R-group decomposition</h1>
<p>The RGD code takes a list of cores to be used along with a list of molecules. It returns a 2-tuple with: 1. a dictionary with the results 2. a list with the indices of the molecules which failed; these are molecules which did not match any of the cores</p>
<p>I’ve blogged about the RGD code before <a href="http://rdkit.blogspot.com/2019/12/using-r-group-decomposition-code.html">here</a> and <a href="https://greglandrum.github.io/rdkit-blog/tutorial/prototypes/drawing/2021/08/07/rgd-and-highlighting.html">here</a> if you want to read more about it. It’s probably time for another post with an update, but those are hopefully already useful.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">rgd,failed <span class="op" style="color: #5E5E5E;">=</span> rdRGroupDecomposition.RGroupDecompose([core],ms,asRows<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb6-2"><span class="bu" style="color: null;">len</span>(failed)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>6</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">failed</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[0, 1, 2, 3, 29, 30]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">rgd.keys()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>dict_keys(['Core', 'R1', 'R2', 'R3'])</code></pre>
</div>
</div>
<p>Let’s look at the results</p>
<div class="cell" data-scrolled="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'There are </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(rgd[<span class="st" style="color: #20794D;">"R1"</span>])<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> R1s'</span>)</span>
<span id="cb12-2">Draw.MolsToGridImage(rgd[<span class="st" style="color: #20794D;">'R1'</span>][:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 25 R1s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Remove any R groups which have more than one dummy atom. This happens if an R group is attached to the core at multiple points and it may mess up the rest of the analysis.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">qa <span class="op" style="color: #5E5E5E;">=</span> rdqueries.AtomNumEqualsQueryAtom(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb14-2">r1 <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> rgd[<span class="st" style="color: #20794D;">'R1'</span>] <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(x.GetAtomsMatchingQuery(qa))<span class="op" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb14-3">r2 <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> rgd[<span class="st" style="color: #20794D;">'R2'</span>] <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(x.GetAtomsMatchingQuery(qa))<span class="op" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb14-4">r3 <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> rgd[<span class="st" style="color: #20794D;">'R3'</span>] <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(x.GetAtomsMatchingQuery(qa))<span class="op" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>]</span></code></pre></div>
</div>
<p>Now find the unique members in each set of R groups:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;">def</span> uniquify(rgs):</span>
<span id="cb15-2">    seen <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>()</span>
<span id="cb15-3">    keep <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb15-4">    <span class="cf" style="color: #003B4F;">for</span> rg <span class="kw" style="color: #003B4F;">in</span> rgs:</span>
<span id="cb15-5">        smi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(rg)</span>
<span id="cb15-6">        <span class="cf" style="color: #003B4F;">if</span> smi <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> seen:</span>
<span id="cb15-7">            keep.append(rg)</span>
<span id="cb15-8">            seen.add(smi)</span>
<span id="cb15-9">    <span class="cf" style="color: #003B4F;">return</span> keep</span></code></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">r1s <span class="op" style="color: #5E5E5E;">=</span> uniquify(r1)</span>
<span id="cb16-2">r2s <span class="op" style="color: #5E5E5E;">=</span> uniquify(r2)</span>
<span id="cb16-3">r3s<span class="op" style="color: #5E5E5E;">=</span> uniquify(r3)</span>
<span id="cb16-4"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(r1s),<span class="bu" style="color: null;">len</span>(r2s),<span class="bu" style="color: null;">len</span>(r3s))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15 6 6</code></pre>
</div>
</div>
<p>Look at the unique R1s:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">Draw.MolsToGridImage(r1s[:<span class="dv" style="color: #AD0000;">12</span>],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="enumerating-all-possible-molecules-from-the-r-groups" class="level1">
<h1>Enumerating all possible molecules from the R groups</h1>
<section id="quick-intro-to-molzip" class="level2">
<h2 class="anchored" data-anchor-id="quick-intro-to-molzip">Quick intro to molzip</h2>
<p>We’ll use the RDKit’s <code>molzip()</code> function to recombine the cores with the side chains.</p>
<p><code>molzip</code> lets you take a molecule containing multiple fragments and “zip” them together. The atoms which should be bonded in the final molecule are labelled by connecting them to dummy atoms. The code identifies matching dummy atoms (by default this means dummies with the same isotopic label) in the fragments, adds bonds between the atoms connected to the dummies, and then removes the dummies.</p>
<p>Here’s a simple example using a molecule with three fragments:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">sample <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'[*:1]c1nc([*:2])ncc1.CO[*:1].[*:2]N(C)C'</span>)</span>
<span id="cb19-2">sample</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>And this is what happens when we zip those together:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">Chem.molzip(sample)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="using-molzip-with-rgd-output" class="level2">
<h2 class="anchored" data-anchor-id="using-molzip-with-rgd-output">Using molzip with RGD output</h2>
<p>The molzip function is perfect for working with the output from an R-group decomposition.</p>
<p>Here I’ll define the function we’re going to use to enumerate all of the products:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;">import</span> random</span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;">def</span> enumerate_all_products(core,<span class="op" style="color: #5E5E5E;">*</span>rgroups,randomOrder<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>):</span>
<span id="cb21-3">    <span class="co" style="color: #5E5E5E;"># preserve the positions of the non-dummy core atoms, </span></span>
<span id="cb21-4">    <span class="co" style="color: #5E5E5E;"># we will use these to make sure the cores are drawn</span></span>
<span id="cb21-5">    <span class="co" style="color: #5E5E5E;"># the same way in each molecule we generate</span></span>
<span id="cb21-6">    corePos <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb21-7">    conf <span class="op" style="color: #5E5E5E;">=</span> core.GetConformer()</span>
<span id="cb21-8">    <span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(conf.GetNumAtoms()):</span>
<span id="cb21-9">        corePos[i] <span class="op" style="color: #5E5E5E;">=</span> Geometry.Point2D(conf.GetAtomPosition(i))</span>
<span id="cb21-10">        </span>
<span id="cb21-11">    <span class="co" style="color: #5E5E5E;"># Python's itertools handles doing the combinatorics of generating</span></span>
<span id="cb21-12">    <span class="co" style="color: #5E5E5E;"># every possible combination of R groups:</span></span>
<span id="cb21-13">    order <span class="op" style="color: #5E5E5E;">=</span> itertools.product(<span class="op" style="color: #5E5E5E;">*</span>rgroups)</span>
<span id="cb21-14">    <span class="cf" style="color: #003B4F;">if</span> randomOrder:</span>
<span id="cb21-15">        order <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(order)</span>
<span id="cb21-16">        random.shuffle(order)</span>
<span id="cb21-17">        </span>
<span id="cb21-18">    <span class="co" style="color: #5E5E5E;"># now we just loop over each combination, copy all the pieces into</span></span>
<span id="cb21-19">    <span class="co" style="color: #5E5E5E;"># one molecule, and zip it. That's our product</span></span>
<span id="cb21-20">    <span class="cf" style="color: #003B4F;">for</span> tpl <span class="kw" style="color: #003B4F;">in</span> order:</span>
<span id="cb21-21">        tm <span class="op" style="color: #5E5E5E;">=</span> Chem.RWMol(core)</span>
<span id="cb21-22">        <span class="cf" style="color: #003B4F;">for</span> r <span class="kw" style="color: #003B4F;">in</span> tpl:</span>
<span id="cb21-23">            tm.InsertMol(r)</span>
<span id="cb21-24">        prod <span class="op" style="color: #5E5E5E;">=</span> Chem.molzip(tm)</span>
<span id="cb21-25">        <span class="cf" style="color: #003B4F;">if</span> prod <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb21-26">            <span class="co" style="color: #5E5E5E;"># generate 2d coordinates with the core fixed in place</span></span>
<span id="cb21-27">            rdDepictor.Compute2DCoords(prod,canonOrient<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,coordMap<span class="op" style="color: #5E5E5E;">=</span>corePos)</span>
<span id="cb21-28">            </span>
<span id="cb21-29">            <span class="co" style="color: #5E5E5E;"># and finally yield the product molecule</span></span>
<span id="cb21-30">            <span class="cf" style="color: #003B4F;">yield</span> prod</span></code></pre></div>
</div>
<p>We’re going to use the core which came from the RGD since it’s labelled in the same way as the sidechains</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">rgd_core <span class="op" style="color: #5E5E5E;">=</span> rgd[<span class="st" style="color: #20794D;">'Core'</span>][<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb22-2">rgd_core</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">

<table><tbody><tr><td colspan="2" style="text-align:center"><img src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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"></td></tr>
<tr><th style="text-align:right">scaffold</th><td style="text-align:left">1</td></tr></tbody></table>
</div>
</div>
<p>Let’s try it out:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;"># this returns a generator which produces products:</span></span>
<span id="cb23-2">prod_gen <span class="op" style="color: #5E5E5E;">=</span> enumerate_all_products(rgd_core,r1s,r2s,r3s)</span>
<span id="cb23-3"></span>
<span id="cb23-4"><span class="co" style="color: #5E5E5E;"># now get the first unique products </span></span>
<span id="cb23-5">prods <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb23-6">seen <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>()</span>
<span id="cb23-7"><span class="cf" style="color: #003B4F;">for</span> prod <span class="kw" style="color: #003B4F;">in</span> prod_gen:</span>
<span id="cb23-8">    <span class="cf" style="color: #003B4F;">if</span> prod <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb23-9">        Chem.SanitizeMol(prod)</span>
<span id="cb23-10">        smi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(prod)</span>
<span id="cb23-11">        <span class="cf" style="color: #003B4F;">if</span> smi <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> seen:</span>
<span id="cb23-12">            prods.append(prod)</span>
<span id="cb23-13">            seen.add(smi)</span>
<span id="cb23-14">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(prods)<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">12</span>:</span>
<span id="cb23-15">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb23-16">Draw.MolsToGridImage(prods,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Those come back ordered by the R groups (i.e.&nbsp;all products created using the first value of R1, then all products created using the second value of R1, etc.). This is fine if we’re planning on enumerating all the molecules, but if we only need a subset we can tell <code>enumerate_all_products()</code> to return the results in a random order:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;"># set a random seed so that we get reproducible results</span></span>
<span id="cb24-2">random.seed(<span class="bn" style="color: #AD0000;">0xbaff7ed</span>)</span>
<span id="cb24-3">prod_gen <span class="op" style="color: #5E5E5E;">=</span> enumerate_all_products(rgd_core,r1s,r2s,r3s,randomOrder<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb24-4">prods <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb24-5">seen <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>()</span>
<span id="cb24-6"><span class="cf" style="color: #003B4F;">for</span> prod <span class="kw" style="color: #003B4F;">in</span> prod_gen:</span>
<span id="cb24-7">    <span class="cf" style="color: #003B4F;">if</span> prod <span class="kw" style="color: #003B4F;">is</span> <span class="kw" style="color: #003B4F;">not</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb24-8">        Chem.SanitizeMol(prod)</span>
<span id="cb24-9">        smi <span class="op" style="color: #5E5E5E;">=</span> Chem.MolToSmiles(prod)</span>
<span id="cb24-10">        <span class="cf" style="color: #003B4F;">if</span> smi <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> seen:</span>
<span id="cb24-11">            prods.append(prod)</span>
<span id="cb24-12">            seen.add(smi)</span>
<span id="cb24-13">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(prods)<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">12</span>:</span>
<span id="cb24-14">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb24-15">Draw.MolsToGridImage(prods,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Hopefully this brief post is useful!</p>


</section>
</section>

 ]]></description>
  <category>tutorial</category>
  <category>rgd</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip.html</guid>
  <pubDate>Sun, 13 Mar 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/rgd-molzip-1.png" medium="image" type="image/png" height="48" width="144"/>
</item>
<item>
  <title>The number of unique fingerprint bits</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2022-01-04-number-of-unique-fp-bits.html</link>
  <description><![CDATA[ 



<section id="how-many-molecules-do-we-need-to-add-before-weve-seen-all-the-bits" class="level1">
<h1>How many molecules do we need to add before we’ve seen all the bits?</h1>
<p>I did an updated post last year looking at <a href="https://greglandrum.github.io/rdkit-blog/fingerprints/reference/2021/07/06/number-of-fp-bits-set.html">the average number of bits set per molecule</a> by the various fingerprinting algorithms in the RDKit.</p>
<p>This one explores a couple of related topics: 1. If we look at a large set of organic molecules, how many different atom environments (as defined by the individual fingerprints) do we observe? 2. How quickly does this number converge with the number of compounds considered?</p>
<p>Obviously the answer to these questions is extremely dependent on the set of molecules you use. For this post I will use a set of around six million random molecules from Zinc20’s <a href="https://zinc20.docking.org/substances/subsets/in-stock/">“in-stock” set</a>. The six million included all have less than 50 heavy atoms after being salt stripped.</p>
<p>The experiment itself could hardly be simpler: read in the molecules, generate fingerprints, and keep track of the unique bits set as a function of number of molecules considered. For this analysis I limit myself to fingerprints which have not been “folded” to fit into a particular bit length (with the exception of the Avalon FP, which currently only supports generating folded forms).</p>
<p>The code and raw data are below, here are the curves showing the saturation behavior for the various fingerprints: <img src="https://greglandrum.github.io/rdkit-blog/images/blog/unique-bits1-1.png" class="img-fluid" alt="unique-bits1-1.png"></p>
<p>Note that the saturation behavior of the avalon fingerprint here is an artifact of the fact that the fingerprint being used was only 9192 bits long (yes, I made a typo when I entered the value in the script to generate the data); 9185 of those bits end up being set.</p>
<p>For a bit more resolution, here’s a table with the number of unique bits set per fingerprint in that set of 6 million, the number of new bits found in the last 100K of the 6 million, as well as how many molecules needed to be considered to reach 90, 95, and 99% of the number of unique bits:</p>
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 20%">
<col style="width: 22%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th># unique bits</th>
<th># in last 100K</th>
<th>0.90</th>
<th>0.95</th>
<th>0.99</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>FeatMorgan0</td>
<td>15</td>
<td>0</td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr class="even">
<td>FeatMorgan1</td>
<td>1621</td>
<td>2</td>
<td>2760000</td>
<td>4080000</td>
<td>5460000</td>
</tr>
<tr class="odd">
<td>FeatMorgan2</td>
<td>116975</td>
<td>464</td>
<td>4000000</td>
<td>4870000</td>
<td>5750000</td>
</tr>
<tr class="even">
<td>FeatMorgan3</td>
<td>1350464</td>
<td>7478</td>
<td>4400000</td>
<td>5130000</td>
<td>5810000</td>
</tr>
<tr class="odd">
<td>Morgan0</td>
<td>143</td>
<td>0</td>
<td>2850000</td>
<td>4080000</td>
<td>5080000</td>
</tr>
<tr class="even">
<td>Morgan1</td>
<td>19428</td>
<td>67</td>
<td>3870000</td>
<td>4750000</td>
<td>5720000</td>
</tr>
<tr class="odd">
<td>Morgan2</td>
<td>575817</td>
<td>2941</td>
<td>4320000</td>
<td>5080000</td>
<td>5790000</td>
</tr>
<tr class="even">
<td>Morgan3</td>
<td>3606676</td>
<td>22970</td>
<td>4580000</td>
<td>5240000</td>
<td>5830000</td>
</tr>
<tr class="odd">
<td>RDKit5</td>
<td>131029</td>
<td>347</td>
<td>3490000</td>
<td>4600000</td>
<td>5690000</td>
</tr>
<tr class="even">
<td>RDKit6</td>
<td>538500</td>
<td>1627</td>
<td>3600000</td>
<td>4680000</td>
<td>5700000</td>
</tr>
<tr class="odd">
<td>RDKit7</td>
<td>1989958</td>
<td>6897</td>
<td>3740000</td>
<td>4760000</td>
<td>5720000</td>
</tr>
<tr class="even">
<td>RDKit-linear5</td>
<td>49852</td>
<td>136</td>
<td>3400000</td>
<td>4520000</td>
<td>5680000</td>
</tr>
<tr class="odd">
<td>RDKit-linear6</td>
<td>133904</td>
<td>402</td>
<td>3480000</td>
<td>4570000</td>
<td>5690000</td>
</tr>
<tr class="even">
<td>RDKit-linear7</td>
<td>315293</td>
<td>1032</td>
<td>3570000</td>
<td>4640000</td>
<td>5700000</td>
</tr>
<tr class="odd">
<td>ap-counts</td>
<td>16585</td>
<td>18</td>
<td>2470000</td>
<td>3840000</td>
<td>5410000</td>
</tr>
<tr class="even">
<td>avalon</td>
<td>9185</td>
<td>0</td>
<td>20000</td>
<td>70000</td>
<td>490000</td>
</tr>
<tr class="odd">
<td>tt-counts</td>
<td>20723</td>
<td>49</td>
<td>3530000</td>
<td>4570000</td>
<td>5640000</td>
</tr>
</tbody>
</table>
<p>To help with the interpretation of this: a total of 131029 unique bits were found for the RDKit5 fingerprint in the set of 6 million molecules and 95% of those bits had been found after looking at 4.6 million molecules. The last 100K molecules added 347 new bits.</p>
<p>The thing that I find most interesting (and somewhat surprising) about these results is how far we are from having encountered “all” of the bits; new bits are being encountered for almost all of the fingerprint types even after 5.9 million molecules have been encountered. I can probably still wave my hands and estimate the order-of-magnitude number of distinct bits for each of the FP types in the full set of ~14 million substances in the ZINC20 “in-stock” set. Here’s a few of those estimates: - FeatMorgan2: 120-150K - FeatMorgan3: 1.4-1.6 million - Morgan1: 20-25K - Morgan2: 600-700K - Morgan3: 3.6-4.0 million</p>
<p>These are also rough lower bounds on the number of atom environments in those compounds (it’s a lower bound due to the possibility of hash collisions causing multiple atom environments to hash to the same fingerprint bit).</p>
<blockquote class="blockquote">
<p><em>Aside:</em> it’s worth mentioning that this, of course, isn’t the first time someone has looked at this topic. I don’t normally include references for blog posts, but this paper from the PubChem team is a nice look at the atom environments in the (huge) PubChem dataset: http://www.jcheminf.com/content/7/1/41</p>
</blockquote>
<p>The rest of the post has the code for generating the data and doing the analysis.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem,DataStructs</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">import</span> time,random,gzip,pickle,copy</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> Counter,defaultdict</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolDescriptors</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.MolStandardize <span class="im" style="color: #00769E;">import</span> rdMolStandardize</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> rdkit.Avalon <span class="im" style="color: #00769E;">import</span> pyAvalonTools</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> DataStructs</span>
<span id="cb1-11"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> rdBase</span>
<span id="cb1-12"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> RDLogger</span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;">%</span>pylab inline</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="bu" style="color: null;">print</span>(rdBase.rdkitVersion)</span>
<span id="cb1-16"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-17"><span class="bu" style="color: null;">print</span>(time.asctime())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Populating the interactive namespace from numpy and matplotlib
2021.09.3
Tue Jan  4 13:17:00 2022</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/glandrum/miniconda3/envs/rdkit_blog/lib/python3.9/site-packages/IPython/core/magics/pylab.py:159: UserWarning: pylab import has clobbered these variables: ['random', 'copy']
`%matplotlib` prevents importing * from pylab and numpy
  warn("pylab import has clobbered these variables: %s"  % clobbered +</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb4-2">    <span class="im" style="color: #00769E;">import</span> ipyparallel <span class="im" style="color: #00769E;">as</span> ipp</span>
<span id="cb4-3">    rc <span class="op" style="color: #5E5E5E;">=</span> ipp.Client()</span>
<span id="cb4-4">    dview <span class="op" style="color: #5E5E5E;">=</span> rc[:]</span>
<span id="cb4-5">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit import Chem'</span>)</span>
<span id="cb4-6">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit import Descriptors'</span>)</span>
<span id="cb4-7">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit.Chem import rdMolDescriptors'</span>)</span>
<span id="cb4-8">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit.Avalon import pyAvalonTools'</span>)</span>
<span id="cb4-9"><span class="cf" style="color: #003B4F;">except</span>:</span>
<span id="cb4-10">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"could not use ipyparallel"</span>)</span>
<span id="cb4-11">    dview <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span></code></pre></div>
</div>
<p>Here’s my local copy of the ~14 million “in stock” compounds I grabbed from ZINC (this file is too big for github):</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">filen<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'/scratch/RDKit_git/LocalData/Zinc20/purchasable/zinc20_instock.pkl.shuffled.gz'</span></span></code></pre></div>
</div>
<p>Loop over the molecules, strip salts, skip anything with more than 50 atoms, and build fingerprints for all the others.</p>
<p>The fingerprints I generate for this analysis are: - Sparse Morgan with radii 1, 2, and 3 - Sparse FeatureMorgan with radii 1, 2, and 3 - Sparse RDKit with maxPath 5, 6, and 7 - Sparse RDKit, no branches, with maxPath 5, 6, and 7 - Avalon BitVect - Sparse Atom Pairs - Sparse Topological Torsions</p>
<p>All of the BitVect fingerprints are 4096 bits long</p>
<div class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;">import</span> copy</span>
<span id="cb6-2"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> defaultdict</span>
<span id="cb6-3">historyf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.history.pkl.gz'</span>,<span class="st" style="color: #20794D;">'wb+'</span>)</span>
<span id="cb6-4">RDLogger.DisableLog(<span class="st" style="color: #20794D;">'rdApp.info'</span>)</span>
<span id="cb6-5">frm <span class="op" style="color: #5E5E5E;">=</span> rdMolStandardize.LargestFragmentChooser()</span>
<span id="cb6-6">counts<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb6-7">accum<span class="op" style="color: #5E5E5E;">=</span>defaultdict(<span class="bu" style="color: null;">set</span>)</span>
<span id="cb6-8">t1 <span class="op" style="color: #5E5E5E;">=</span> time.time()</span>
<span id="cb6-9"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(filen,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb6-10">    i <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb6-11">    ms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;">while</span> <span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb6-13">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb6-14">            m,nm <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb6-15">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb6-16">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb6-17">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m:</span>
<span id="cb6-18">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb6-19">        <span class="co" style="color: #5E5E5E;"># strip salts:</span></span>
<span id="cb6-20">        m <span class="op" style="color: #5E5E5E;">=</span> frm.choose(m)</span>
<span id="cb6-21">        <span class="cf" style="color: #003B4F;">if</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>: </span>
<span id="cb6-22">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb6-23">        ms.append(m)</span>
<span id="cb6-24">        i<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-25">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(ms)<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">10000</span>:</span>
<span id="cb6-26">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>:</span>
<span id="cb6-27">                k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'Morgan'</span>,v)</span>
<span id="cb6-28">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">set</span>(rdMolDescriptors.GetMorganFingerprint(x,v).GetNonzeroElements().keys()),</span>
<span id="cb6-29">                                     ms)</span>
<span id="cb6-30">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-31">                    accum[k].update(obc)</span>
<span id="cb6-32">                counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-33">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>:</span>
<span id="cb6-34">                k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'FeatMorgan'</span>,v)</span>
<span id="cb6-35">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">set</span>(rdMolDescriptors.GetMorganFingerprint(x,v,useFeatures<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>).GetNonzeroElements().keys()),</span>
<span id="cb6-36">                                     ms)</span>
<span id="cb6-37">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-38">                    accum[k].update(obc)</span>
<span id="cb6-39">                counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-40">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">5</span>,<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">7</span>:</span>
<span id="cb6-41">                k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'RDKit'</span>,v)</span>
<span id="cb6-42">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">set</span>(Chem.UnfoldedRDKFingerprintCountBased(x,maxPath<span class="op" style="color: #5E5E5E;">=</span>v).GetNonzeroElements().keys()),</span>
<span id="cb6-43">                                      ms)</span>
<span id="cb6-44">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-45">                    accum[k].update(obc)</span>
<span id="cb6-46">                counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-47">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">5</span>,<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">7</span>:</span>
<span id="cb6-48">                k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'RDKit-linear'</span>,v)</span>
<span id="cb6-49">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">set</span>(Chem.UnfoldedRDKFingerprintCountBased(x,maxPath<span class="op" style="color: #5E5E5E;">=</span>v,branchedPaths<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>).GetNonzeroElements().keys()),</span>
<span id="cb6-50">                                      ms)</span>
<span id="cb6-51">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-52">                    accum[k].update(obc)</span>
<span id="cb6-53">                counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-54"></span>
<span id="cb6-55">            k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'avalon'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-56">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:<span class="bu" style="color: null;">set</span>(pyAvalonTools.GetAvalonFP(x,nBits<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">9192</span>).GetOnBits()),</span>
<span id="cb6-57">                                  ms)</span>
<span id="cb6-58">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-59">                accum[k].update(obc)</span>
<span id="cb6-60">            counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-61">            </span>
<span id="cb6-62">            k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'ap-counts'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-63">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:<span class="bu" style="color: null;">set</span>(rdMolDescriptors.GetAtomPairFingerprint(x).GetNonzeroElements().keys()),</span>
<span id="cb6-64">                                  ms)</span>
<span id="cb6-65">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-66">                accum[k].update(obc)</span>
<span id="cb6-67">            counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-68">            k <span class="op" style="color: #5E5E5E;">=</span> (<span class="st" style="color: #20794D;">'tt-counts'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-69">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:<span class="bu" style="color: null;">set</span>(rdMolDescriptors.GetTopologicalTorsionFingerprint(x).GetNonzeroElements().keys()),</span>
<span id="cb6-70">                                  ms)</span>
<span id="cb6-71">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-72">                accum[k].update(obc)</span>
<span id="cb6-73">            counts[k].append((i,<span class="bu" style="color: null;">len</span>(accum[k])))</span>
<span id="cb6-74">            ms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-75">            </span>
<span id="cb6-76">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> i<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">50000</span>:</span>
<span id="cb6-77">            t2 <span class="op" style="color: #5E5E5E;">=</span> time.time()</span>
<span id="cb6-78">            <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Done </span><span class="sc" style="color: #5E5E5E;">%d</span><span class="st" style="color: #20794D;"> in </span><span class="sc" style="color: #5E5E5E;">%.2f</span><span class="st" style="color: #20794D;"> sec"</span><span class="op" style="color: #5E5E5E;">%</span>(i,t2<span class="op" style="color: #5E5E5E;">-</span>t1))</span>
<span id="cb6-79">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> i<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">500000</span>:</span>
<span id="cb6-80">            pickle.dump(<span class="bu" style="color: null;">dict</span>(counts),historyf)</span>
<span id="cb6-81">            pickle.dump(<span class="bu" style="color: null;">dict</span>(accum),historyf)</span>
<span id="cb6-82">        <span class="cf" style="color: #003B4F;">if</span> i<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">5500000</span>:</span>
<span id="cb6-83">            <span class="cf" style="color: #003B4F;">break</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.history.pkl.gz'</span>,<span class="st" style="color: #20794D;">'wb+'</span>) <span class="im" style="color: #00769E;">as</span> outf:</span>
<span id="cb7-2">    pickle.dump(<span class="bu" style="color: null;">dict</span>(counts),outf)</span>
<span id="cb7-3">    pickle.dump(<span class="bu" style="color: null;">dict</span>(accum),outf)</span>
<span id="cb7-4">        </span></code></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.history.pkl.gz'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb8-2">    counts <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span></code></pre></div>
</div>
<p>Now plot the distributions of the number of bits set</p>
<p>We have a few extra data points, let’s stick to the first 6 million molecules</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="cf" style="color: #003B4F;">for</span> k,v <span class="kw" style="color: #003B4F;">in</span> counts.items():</span>
<span id="cb9-2">    v <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> v <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">6000000</span>]</span>
<span id="cb9-3">    counts[k] <span class="op" style="color: #5E5E5E;">=</span> v</span></code></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">morgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Morgan'</span>]</span>
<span id="cb10-2">featmorgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'FeatMorgan'</span>]</span>
<span id="cb10-3">rdkit_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit'</span>]</span>
<span id="cb10-4">rdkitlin_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit-linear'</span>]</span>
<span id="cb10-5"></span>
<span id="cb10-6">figure(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">15</span>,<span class="dv" style="color: #AD0000;">20</span>))</span>
<span id="cb10-7"></span>
<span id="cb10-8">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb10-9">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb10-10"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkit_ks:</span>
<span id="cb10-11">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb10-12">    </span>
<span id="cb10-13">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb10-14">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-15">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit"</span>)</span>
<span id="cb10-16">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb10-17">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb10-18">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb10-19"></span>
<span id="cb10-20">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb10-21">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb10-22"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkitlin_ks:</span>
<span id="cb10-23">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb10-24">    </span>
<span id="cb10-25">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb10-26">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-27">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit linear"</span>)</span>
<span id="cb10-28">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb10-29">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb10-30">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb10-31"></span>
<span id="cb10-32"></span>
<span id="cb10-33"></span>
<span id="cb10-34">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span></span>
<span id="cb10-35">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb10-36"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> morgan_ks:</span>
<span id="cb10-37">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb10-38">    </span>
<span id="cb10-39">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb10-40">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-41">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"Morgan"</span>)</span>
<span id="cb10-42">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb10-43">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb10-44">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb10-45"></span>
<span id="cb10-46">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb10-47">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb10-48"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> featmorgan_ks:</span>
<span id="cb10-49">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb10-50">    </span>
<span id="cb10-51">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb10-52">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb10-53">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"FeatMorgan"</span>)</span>
<span id="cb10-54">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb10-55">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb10-56">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb10-57"></span>
<span id="cb10-58">pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb10-59">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb10-60"><span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> counts.keys():</span>
<span id="cb10-61">    <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'Morgan'</span>) <span class="kw" style="color: #003B4F;">or</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'FeatMorgan'</span>) <span class="kw" style="color: #003B4F;">or</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'RDKit'</span>):</span>
<span id="cb10-62">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb10-63">    pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb10-64">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[k]</span>
<span id="cb10-65">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span>k[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb10-66">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">'others'</span>)</span>
<span id="cb10-67">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb10-68">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb10-69">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb10-70">   </span>
<span id="cb10-71">tight_layout()<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-01-04-number-of-unique-fp-bits_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Mabye better to plot those on a log scale?</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">morgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Morgan'</span>]</span>
<span id="cb11-2">featmorgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'FeatMorgan'</span>]</span>
<span id="cb11-3">rdkit_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit'</span>]</span>
<span id="cb11-4">rdkitlin_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.keys()) <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit-linear'</span>]</span>
<span id="cb11-5"></span>
<span id="cb11-6">figure(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">15</span>,<span class="dv" style="color: #AD0000;">20</span>))</span>
<span id="cb11-7"></span>
<span id="cb11-8">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb11-9">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb11-10"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkit_ks:</span>
<span id="cb11-11">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb11-12">    </span>
<span id="cb11-13">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb11-14">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb11-15">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit"</span>)</span>
<span id="cb11-16">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb11-17">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb11-18">_<span class="op" style="color: #5E5E5E;">=</span>yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb11-19">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb11-20"></span>
<span id="cb11-21">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb11-22">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb11-23"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkitlin_ks:</span>
<span id="cb11-24">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb11-25">    </span>
<span id="cb11-26">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb11-27">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb11-28">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit linear"</span>)</span>
<span id="cb11-29">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb11-30">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb11-31">_<span class="op" style="color: #5E5E5E;">=</span>yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb11-32">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb11-33"></span>
<span id="cb11-34"></span>
<span id="cb11-35"></span>
<span id="cb11-36">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span></span>
<span id="cb11-37">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb11-38"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> morgan_ks:</span>
<span id="cb11-39">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb11-40">    </span>
<span id="cb11-41">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb11-42">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb11-43">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"Morgan"</span>)</span>
<span id="cb11-44">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb11-45">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb11-46">_<span class="op" style="color: #5E5E5E;">=</span>yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb11-47">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb11-48"></span>
<span id="cb11-49">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb11-50">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb11-51"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> featmorgan_ks:</span>
<span id="cb11-52">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[(n,r)]</span>
<span id="cb11-53">    </span>
<span id="cb11-54">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb11-55">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb11-56">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"FeatMorgan"</span>)</span>
<span id="cb11-57">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb11-58">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb11-59">_<span class="op" style="color: #5E5E5E;">=</span>yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb11-60">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb11-61"></span>
<span id="cb11-62">pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb11-63">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">2</span>,pidx)</span>
<span id="cb11-64"><span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> counts.keys():</span>
<span id="cb11-65">    <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'Morgan'</span>) <span class="kw" style="color: #003B4F;">or</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'FeatMorgan'</span>) <span class="kw" style="color: #003B4F;">or</span> k[<span class="dv" style="color: #AD0000;">0</span>].startswith(<span class="st" style="color: #20794D;">'RDKit'</span>):</span>
<span id="cb11-66">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb11-67">    pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb11-68">    cnts <span class="op" style="color: #5E5E5E;">=</span> counts[k]</span>
<span id="cb11-69">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span>k[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb11-70">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">'others'</span>)</span>
<span id="cb11-71">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"unique bits observed"</span>)</span>
<span id="cb11-72">_<span class="op" style="color: #5E5E5E;">=</span>yscale(<span class="st" style="color: #20794D;">'log'</span>)</span>
<span id="cb11-73">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num molecules"</span>)</span>
<span id="cb11-74">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb11-75"></span>
<span id="cb11-76">tight_layout()<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2022-01-04-number-of-unique-fp-bits_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><em>Notes:</em> - FeatMorgan with r=0 is super boring since there are only 15 types observed and 14 of them appear within the first 10K compounds (the last appears after around 1.2 million compounds). By way of comparison, there are 143 different Morgan0 types observed and the last of those doesn’t show up until after about 5.1 million compounds. - The Avalon fingerprint was 9192 bits long and it ends up setting all essentially of those bits (9185). It probably would have been better to run this with a longer fingerprint.</p>
<p>How many compounds do we need to look at in order to see particular fractions of the total number of bits there?</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">bins <span class="op" style="color: #5E5E5E;">=</span> (<span class="fl" style="color: #AD0000;">0.9</span>,<span class="fl" style="color: #AD0000;">0.95</span>,<span class="fl" style="color: #AD0000;">0.99</span>)</span>
<span id="cb12-2"><span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">' '</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">15</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">'# unique bits'</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">'# in last 100K'</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">' | '</span>.join(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>x<span class="sc" style="color: #5E5E5E;">:7.2f}</span><span class="ss" style="color: #20794D;">'</span> <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> bins),<span class="st" style="color: #20794D;">'|'</span>)</span>
<span id="cb12-3"><span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">'-'</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">15</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">'-'</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">13</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">'-'</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">14</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="st" style="color: #20794D;">' | '</span>.join(<span class="st" style="color: #20794D;">'-'</span><span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">7</span> <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> bins),<span class="st" style="color: #20794D;">'|'</span>)</span>
<span id="cb12-4"><span class="cf" style="color: #003B4F;">for</span> k,cnts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.items()):</span>
<span id="cb12-5">    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span>.join(<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> k <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">!=-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb12-6">    maxv <span class="op" style="color: #5E5E5E;">=</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb12-7">    last100K <span class="op" style="color: #5E5E5E;">=</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">1</span>] <span class="op" style="color: #5E5E5E;">-</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">11</span>][<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb12-8">    <span class="cf" style="color: #003B4F;">if</span> label<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'FeatMorgan0'</span>:</span>
<span id="cb12-9">        accum <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">' | '</span>.join([<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="st" style="color: #20794D;">"N/A"</span><span class="sc" style="color: #5E5E5E;">:7s}</span><span class="ss" style="color: #20794D;">'</span>]<span class="op" style="color: #5E5E5E;">*</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb12-10">    <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb12-11">        accum <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb12-12">        <span class="cf" style="color: #003B4F;">for</span> <span class="bu" style="color: null;">bin</span> <span class="kw" style="color: #003B4F;">in</span> bins:</span>
<span id="cb12-13">            <span class="cf" style="color: #003B4F;">for</span> idx <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(cnts),<span class="dv" style="color: #AD0000;">0</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>):</span>
<span id="cb12-14">                <span class="cf" style="color: #003B4F;">if</span> cnts[idx<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">1</span>]<span class="op" style="color: #5E5E5E;">&lt;</span><span class="bu" style="color: null;">bin</span><span class="op" style="color: #5E5E5E;">*</span>maxv:</span>
<span id="cb12-15">                    accum.append(cnts[idx<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb12-16">                    <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb12-17">        accum <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">' | '</span>.join(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>x<span class="sc" style="color: #5E5E5E;">:7d}</span><span class="ss" style="color: #20794D;">'</span> <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum)</span>
<span id="cb12-18">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'|'</span>,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>label<span class="sc" style="color: #5E5E5E;">:15s}</span><span class="ss" style="color: #20794D;">'</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>maxv<span class="sc" style="color: #5E5E5E;">:13d}</span><span class="ss" style="color: #20794D;">'</span>,<span class="st" style="color: #20794D;">'|'</span>,<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span>last100K<span class="sc" style="color: #5E5E5E;">:14d}</span><span class="ss" style="color: #20794D;">'</span>,<span class="st" style="color: #20794D;">'|'</span>,accum,<span class="st" style="color: #20794D;">'|'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>|                 | # unique bits | # in last 100K |    0.90 |    0.95 |    0.99 |
| --------------- | ------------- | -------------- | ------- | ------- | ------- |
| FeatMorgan0     |            15 |              0 | N/A     | N/A     | N/A     |
| FeatMorgan1     |          1621 |              2 | 2760000 | 4080000 | 5460000 |
| FeatMorgan2     |        116975 |            464 | 4000000 | 4870000 | 5750000 |
| FeatMorgan3     |       1350464 |           7478 | 4400000 | 5130000 | 5810000 |
| Morgan0         |           143 |              0 | 2850000 | 4080000 | 5080000 |
| Morgan1         |         19428 |             67 | 3870000 | 4750000 | 5720000 |
| Morgan2         |        575817 |           2941 | 4320000 | 5080000 | 5790000 |
| Morgan3         |       3606676 |          22970 | 4580000 | 5240000 | 5830000 |
| RDKit5          |        131029 |            347 | 3490000 | 4600000 | 5690000 |
| RDKit6          |        538500 |           1627 | 3600000 | 4680000 | 5700000 |
| RDKit7          |       1989958 |           6897 | 3740000 | 4760000 | 5720000 |
| RDKit-linear5   |         49852 |            136 | 3400000 | 4520000 | 5680000 |
| RDKit-linear6   |        133904 |            402 | 3480000 | 4570000 | 5690000 |
| RDKit-linear7   |        315293 |           1032 | 3570000 | 4640000 | 5700000 |
| ap-counts       |         16585 |             18 | 2470000 | 3840000 | 5410000 |
| avalon          |          9185 |              0 |   20000 |   70000 |  490000 |
| tt-counts       |         20723 |             49 | 3530000 | 4570000 | 5640000 |</code></pre>
</div>
</div>
<p>What fraction of the overall number of bits appear in the last 100K compounds?</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">bins <span class="op" style="color: #5E5E5E;">=</span> (<span class="fl" style="color: #AD0000;">0.9</span>,<span class="fl" style="color: #AD0000;">0.95</span>,<span class="fl" style="color: #AD0000;">0.99</span>)</span>
<span id="cb14-2"><span class="cf" style="color: #003B4F;">for</span> k,cnts <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(counts.items()):</span>
<span id="cb14-3">    label <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span>.join(<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> k <span class="cf" style="color: #003B4F;">if</span> x<span class="op" style="color: #5E5E5E;">!=-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb14-4">    maxv <span class="op" style="color: #5E5E5E;">=</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb14-5">    last100K <span class="op" style="color: #5E5E5E;">=</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>][<span class="dv" style="color: #AD0000;">1</span>] <span class="op" style="color: #5E5E5E;">-</span> cnts[<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">11</span>][<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb14-6">    <span class="bu" style="color: null;">print</span>(label,last100K<span class="op" style="color: #5E5E5E;">/</span>maxv)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>FeatMorgan0 0.0
FeatMorgan1 0.0012338062924120913
FeatMorgan2 0.003966659542637315
FeatMorgan3 0.005537356049476328
Morgan0 0.0
Morgan1 0.0034486308420835906
Morgan2 0.005107525481185863
Morgan3 0.006368745071639371
RDKit5 0.0026482687038747147
RDKit6 0.003021355617455896
RDKit7 0.0034659022954253308
RDKit-linear5 0.0027280751023028163
RDKit-linear6 0.003002150794599116
RDKit-linear7 0.00327314593092774
ap-counts 0.0010853180584865843
avalon 0.0
tt-counts 0.002364522511219418</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>exploratory</category>
  <category>reference</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2022-01-04-number-of-unique-fp-bits.html</guid>
  <pubDate>Mon, 03 Jan 2022 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/unique-bits1-2.png" medium="image" type="image/png" height="130" width="144"/>
</item>
<item>
  <title>A Ternary GHOST</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost.html</link>
  <description><![CDATA[ 



<section id="intro" class="level1">
<h1>Intro</h1>
<p>When we published the <a href="https://doi.org/10.1021/acs.jcim.1c00160">GHOST paper</a> on shifting the decision boundary to improve the predictive performance of classification models built on imbalanced datasets, we only considered binary classifiers (e.g.&nbsp;active/inactive, soluble/insoluble, etc.). I was recently asked if the method could be extended to ternary (three-class) classifiers. This post is about doing that.</p>
<p>The code here isn’t set up for easy re-use at the moment. It will eventually find its way into the <a href="https://github.com/rinikerlab/GHOST">open-source ghostml package</a> once we’ve had a chance to review and test it more thoroughly.</p>
<blockquote class="blockquote">
<p><em>Aside</em>: the ghostml package is now pip installable: <code>python -m pip install ghostml</code> to install it in your environment</p>
</blockquote>
<p>In order for this to make sense, I think I should start with some explanation of the way I’ve approached the problem:</p>
<section id="using-thresholds-in-ternary-problems" class="level2">
<h2 class="anchored" data-anchor-id="using-thresholds-in-ternary-problems">Using thresholds in ternary problems</h2>
<p>Things are a bit more complicated here than with binary classifiers. For the binary case we just have a single threshold which determines whether an instance is predicted to be in class 0 or 1. So, assuming that we optimized based on the probability of class 1, we can formulate the decision as:</p>
<pre><code>if probabilities[1] &gt;= threshold:
   prediction = 1
else:
   prediction = 0</code></pre>
<p>Before doing any optimization <code>threshold</code> is equal to 0.5.</p>
<p>For ternary predictions we have two different decision boundaries and there’s no longer a simple threshold; instead the default decision rule can be expressed as:</p>
<pre><code>prediction = argmax(probabilities)</code></pre>
<p>i.e., the prediction is the class which has the highest predicted probability.</p>
<blockquote class="blockquote">
<p><em>Aside</em>: the same decision rule can be used for a binary classifier with the default threshold. It’s just easier to explain using the threshold of 0.5.</p>
</blockquote>
<p>If we want to introduce two thresholds for the ternary classifier, and assuming that we optimize the thresholds for classes 0 and 2, we have to use a more complex decision rule:</p>
<pre><code>        if probabilities[0]&gt;=thresholds[0]:
            # we might still be in class 2 if the relative probability of that
            # is larger than the probability of class 0
            if (probabilities[2]-thresholds[1])&gt;(probabilities[0]-thresholds[0]):
                prediction = 2
            else:
                prediction = 0
        elif probabilities[2]&gt;=thresholds[1]:
            prediction = 0
        else:
            prediction = 1</code></pre>
</section>
<section id="optimizing-thresholds-for-ternary-problems" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-thresholds-for-ternary-problems">Optimizing thresholds for ternary problems</h2>
<p>For the sake of this post let’s assume that we’re optimizing the thresholds for classes 0 and 2; we could also do 0 and 1, or 1 and 2, the results should still be the same.</p>
<p>In this post I explore two different approaches for optimizing these thresholds.</p>
<section id="greedy-optimization" class="level3">
<h3 class="anchored" data-anchor-id="greedy-optimization">Greedy optimization</h3>
<p>Here I optimize the two thresholds independently of each other by constructing two binary classification problems and optimizing the thresholds for those problems. Here’s the process:</p>
<ol type="1">
<li>Create a binary classification set by setting the training-set <code>y</code> values to 1 if the original value is 0 and to 0 otherwise.</li>
<li>Use the original <code>ghostml</code> approach with that binary classification data and the predicted probabilities of each training point to be 0 in order to set <code>threshold0</code>, the threshold for the predicted probability of being 0.</li>
<li>Create a binary classification set by setting the training-set <code>y</code> values to 1 if the original value is 2 and to 0 otherwise.</li>
<li>Use the original <code>ghostml</code> approach with that binary classification data and the predicted probabilities of each training point to be 2 in order to set <code>threshold2</code>, the threshold for the predicted probability of being 2.</li>
</ol>
<p>Since the current <code>ghostml</code> code doesn’t support using balanced accuracy for optimization, I just use kappa for the greedy optimization.</p>
</section>
<section id="grid-search" class="level3">
<h3 class="anchored" data-anchor-id="grid-search">Grid search</h3>
<p>Explore the full grid of possible <code>(threshold0, threshold2)</code> pairs and pick the one which produces the optimal Cohen’s kappa value. I also try a variant of this which optimizes balanced accuracy instead of Cohen’s kappa.</p>
</section>
</section>
<section id="tldr-results-summary" class="level2">
<h2 class="anchored" data-anchor-id="tldr-results-summary">TL;DR Results summary</h2>
<p>Both approaches work well with both simulated data and a couple of datasets from ChEMBL. There doesn’t seem to be a large or consistent difference in the quality of the results generated with the two different methods. The greedy optimization approach is, however, quite a bit faster.</p>
<p>Here’s the improvement in three scoring metrics (kappa, balanced accuracy, and overall accuracy) when using the greedy optimization procedure on 50 simulated datasets with a 10-80-10 class split; the threshold shift improves both kappa and balanced accuracy on all datasets: <img src="https://greglandrum.github.io/rdkit-blog/images/blog/ternary-ghost1-1.png" class="img-fluid" alt="ternary-ghost1-1.png"></p>
<p>And here’s the same plot for 20 different random stratified train/tests splits with target CHEMBL205 (carbonic anhydrase II) with activity thresholds chosen to give a 19-72-9 class split. Once again, the threshold shift improves predictive performance: <img src="https://greglandrum.github.io/rdkit-blog/images/blog/ternary-ghost1-2.png" class="img-fluid" alt="ternary-ghost1-2.png"></p>
<p>Note: the original version of this <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/ghost_multiclass.ipynb">notebook</a> and the two CHEMBL data files (<a href="https://github.com/greglandrum/rdkit_blog/blob/master/data/target_CHEMBL205.csv.gz">file1</a>, <a href="https://github.com/greglandrum/rdkit_blog/blob/master/data/target_CHEMBL217.csv.gz">file2</a>), are both in github in the <a href="https://github.com/greglandrum/rdkit_blog">older rdkit blog repo</a>.</p>
</section>
<section id="beyond-ternary-problems" class="level2">
<h2 class="anchored" data-anchor-id="beyond-ternary-problems">Beyond ternary problems</h2>
<p>I put some thought into figuring out how to extend this to the general multi-class prediction case, but that turned out to be more difficult than I’d anticipated. If you have suggestions, ideally suggestions accompanied by code, please let me know in the comments!</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>Many thanks to Ryo Kunimoto and Takayuki Serizawa at Daiichi Sankyo for inspiring and funding the initial part of this work.</p>
<p>And now onto the code and more detailed exploration</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb4-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolDescriptors</span>
<span id="cb4-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdFingerprintGenerator</span>
<span id="cb4-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> PandasTools</span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;"># note that you can install ghost using pip: python -m pip install ghostml</span></span>
<span id="cb4-6"><span class="im" style="color: #00769E;">import</span> ghostml</span>
<span id="cb4-7"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb4-8"><span class="im" style="color: #00769E;">from</span> sklearn <span class="im" style="color: #00769E;">import</span> metrics</span>
<span id="cb4-9"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb4-10"></span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="op" style="color: #5E5E5E;">%</span>pylab inline</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
</div>
</section>
</section>
<section id="code-well-use" class="level1">
<h1>Code we’ll use</h1>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;">def</span> ternary_rebin(probs,thresholds):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;">''' returns a list of classifications based on the provided predicted probabilities and thresholds '''</span></span>
<span id="cb6-3">    res <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-4">    <span class="cf" style="color: #003B4F;">for</span> prob <span class="kw" style="color: #003B4F;">in</span> probs:</span>
<span id="cb6-5">        <span class="cf" style="color: #003B4F;">if</span> prob[<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">&gt;=</span>thresholds[<span class="dv" style="color: #AD0000;">0</span>]:</span>
<span id="cb6-6">            <span class="co" style="color: #5E5E5E;"># we might still be in class 2 if the relative probability of that</span></span>
<span id="cb6-7">            <span class="co" style="color: #5E5E5E;"># is larger than the probability of class 0</span></span>
<span id="cb6-8">            <span class="cf" style="color: #003B4F;">if</span> (prob[<span class="dv" style="color: #AD0000;">2</span>]<span class="op" style="color: #5E5E5E;">-</span>thresholds[<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">&gt;</span>(prob[<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">-</span>thresholds[<span class="dv" style="color: #AD0000;">0</span>]):</span>
<span id="cb6-9">                res.append(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb6-10">            <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb6-11">                res.append(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb6-12">        <span class="cf" style="color: #003B4F;">elif</span> prob[<span class="dv" style="color: #AD0000;">2</span>]<span class="op" style="color: #5E5E5E;">&gt;=</span>thresholds[<span class="dv" style="color: #AD0000;">1</span>]:</span>
<span id="cb6-13">            res.append(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb6-14">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb6-15">            res.append(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-16">    <span class="cf" style="color: #003B4F;">return</span> res</span>
<span id="cb6-17"></span>
<span id="cb6-18"><span class="kw" style="color: #003B4F;">def</span> run_ternary_oob_optimization(oob_probs, labels_train, thresholds, ThOpt_metrics <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'Kappa'</span>):</span>
<span id="cb6-19">    <span class="co" style="color: #5E5E5E;">''' does a grid search to optimize the decision thresholds for a ternary problem '''</span></span>
<span id="cb6-20">    res <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-21">    tscores <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-22">    <span class="cf" style="color: #003B4F;">for</span> t1 <span class="kw" style="color: #003B4F;">in</span> thresholds:</span>
<span id="cb6-23">        <span class="cf" style="color: #003B4F;">for</span> t2 <span class="kw" style="color: #003B4F;">in</span> thresholds:</span>
<span id="cb6-24">            preds <span class="op" style="color: #5E5E5E;">=</span> ternary_rebin(oob_probs,(t1,t2))</span>
<span id="cb6-25">            <span class="cf" style="color: #003B4F;">if</span> ThOpt_metrics <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'Kappa'</span>:</span>
<span id="cb6-26">                tgt <span class="op" style="color: #5E5E5E;">=</span> metrics.cohen_kappa_score(labels_train,preds)</span>
<span id="cb6-27">            <span class="cf" style="color: #003B4F;">elif</span> ThOpt_metrics <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'BalancedAccuracy'</span>:</span>
<span id="cb6-28">                tgt <span class="op" style="color: #5E5E5E;">=</span> metrics.balanced_accuracy_score(labels_train,preds)</span>
<span id="cb6-29">            <span class="cf" style="color: #003B4F;">elif</span> ThOpt_metrics <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'F1'</span>:</span>
<span id="cb6-30">                tgt <span class="op" style="color: #5E5E5E;">=</span> metrics.f1_score(labels_train,preds)</span>
<span id="cb6-31">            tscores.append((np.<span class="bu" style="color: null;">round</span>(tgt,<span class="dv" style="color: #AD0000;">3</span>),(t1,t2)))</span>
<span id="cb6-32">    tscores.sort(reverse<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb6-33">    thresh <span class="op" style="color: #5E5E5E;">=</span> tscores[<span class="dv" style="color: #AD0000;">0</span>][<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb6-34">    <span class="cf" style="color: #003B4F;">return</span> thresh</span></code></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;">from</span> sklearn.ensemble <span class="im" style="color: #00769E;">import</span> RandomForestClassifier</span>
<span id="cb7-2"><span class="im" style="color: #00769E;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;">import</span> train_test_split</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;">def</span> run_ternary_experiment(X,y,accum,random_state<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>):</span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;">''' experiment wrapper for the ternary bounds optimization '''</span></span>
<span id="cb7-6">    n_classes <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">max</span>(y)<span class="op" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb7-7">    local <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb7-8">    </span>
<span id="cb7-9">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-10">    <span class="co" style="color: #5E5E5E;"># Train - test split</span></span>
<span id="cb7-11">    X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;">=</span> train_test_split(X, y, test_size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.2</span>, stratify <span class="op" style="color: #5E5E5E;">=</span> y, </span>
<span id="cb7-12">                                                        random_state<span class="op" style="color: #5E5E5E;">=</span>random_state)</span>
<span id="cb7-13"></span>
<span id="cb7-14">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;"># Train a RF classifier</span></span>
<span id="cb7-16">    cls <span class="op" style="color: #5E5E5E;">=</span> RandomForestClassifier(n_estimators<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">500</span>,max_depth<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>,oob_score<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,n_jobs<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">8</span>)</span>
<span id="cb7-17">    cls.fit(X_train, y_train)</span>
<span id="cb7-18"></span>
<span id="cb7-19"></span>
<span id="cb7-20">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-21">    <span class="co" style="color: #5E5E5E;"># Calculate the baseline accuracy values</span></span>
<span id="cb7-22">    test_preds <span class="op" style="color: #5E5E5E;">=</span> cls.predict(X_test)</span>
<span id="cb7-23">    test_probs <span class="op" style="color: #5E5E5E;">=</span> cls.predict_proba(X_test)</span>
<span id="cb7-24">    kappa <span class="op" style="color: #5E5E5E;">=</span> metrics.cohen_kappa_score(y_test,test_preds)</span>
<span id="cb7-25">    balanced <span class="op" style="color: #5E5E5E;">=</span> metrics.balanced_accuracy_score(y_test,test_preds)</span>
<span id="cb7-26">    accuracy <span class="op" style="color: #5E5E5E;">=</span> metrics.accuracy_score(y_test,test_preds)</span>
<span id="cb7-27">    confusion <span class="op" style="color: #5E5E5E;">=</span> metrics.confusion_matrix(y_test,test_preds,labels<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">set</span>(y_test)))</span>
<span id="cb7-28">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'original'</span>)</span>
<span id="cb7-29">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>accuracy<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  balanced accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>balanced<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  kappa: </span><span class="sc" style="color: #5E5E5E;">{</span>kappa<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-30">    <span class="bu" style="color: null;">print</span>(confusion)</span>
<span id="cb7-31">    local[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="op" style="color: #5E5E5E;">=</span> accuracy</span>
<span id="cb7-32">    local[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="op" style="color: #5E5E5E;">=</span> balanced</span>
<span id="cb7-33">    local[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="op" style="color: #5E5E5E;">=</span> kappa</span>
<span id="cb7-34">    local[<span class="st" style="color: #20794D;">'orig-confusion'</span>] <span class="op" style="color: #5E5E5E;">=</span> confusion</span>
<span id="cb7-35">    </span>
<span id="cb7-36">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-37">    <span class="co" style="color: #5E5E5E;"># optimize the two thresholds individually</span></span>
<span id="cb7-38">    thresholds <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">*</span>(n_classes<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb7-39">    <span class="cf" style="color: #003B4F;">for</span> i,clsv <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>((<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">2</span>)):</span>
<span id="cb7-40">        d_tform <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">1</span> <span class="cf" style="color: #003B4F;">if</span> y<span class="op" style="color: #5E5E5E;">==</span>clsv <span class="cf" style="color: #003B4F;">else</span> <span class="dv" style="color: #AD0000;">0</span> <span class="cf" style="color: #003B4F;">for</span> y <span class="kw" style="color: #003B4F;">in</span> y_train]</span>
<span id="cb7-41">        d_probs <span class="op" style="color: #5E5E5E;">=</span> [x[clsv] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> cls.oob_decision_function_]</span>
<span id="cb7-42">        thresholds[i] <span class="op" style="color: #5E5E5E;">=</span> ghostml.optimize_threshold_from_oob_predictions(d_tform,d_probs,thresholds<span class="op" style="color: #5E5E5E;">=</span>np.arange(<span class="fl" style="color: #AD0000;">0.05</span>,<span class="fl" style="color: #AD0000;">1.0</span>,<span class="fl" style="color: #AD0000;">0.05</span>))</span>
<span id="cb7-43">    local[<span class="st" style="color: #20794D;">'thresholds'</span>] <span class="op" style="color: #5E5E5E;">=</span> thresholds</span>
<span id="cb7-44">   </span>
<span id="cb7-45">    <span class="co" style="color: #5E5E5E;"># calculate the accuracy values for those thresholds:</span></span>
<span id="cb7-46">    test_preds <span class="op" style="color: #5E5E5E;">=</span> ternary_rebin(test_probs,thresholds)</span>
<span id="cb7-47">    kappa <span class="op" style="color: #5E5E5E;">=</span> metrics.cohen_kappa_score(y_test,test_preds)</span>
<span id="cb7-48">    balanced <span class="op" style="color: #5E5E5E;">=</span> metrics.balanced_accuracy_score(y_test,test_preds)</span>
<span id="cb7-49">    accuracy <span class="op" style="color: #5E5E5E;">=</span> metrics.accuracy_score(y_test,test_preds)</span>
<span id="cb7-50">    confusion <span class="op" style="color: #5E5E5E;">=</span> metrics.confusion_matrix(y_test,test_preds,labels<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">set</span>(y_test)))</span>
<span id="cb7-51">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'rebalanced'</span>)</span>
<span id="cb7-52">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'thresholds: </span><span class="sc" style="color: #5E5E5E;">{</span>thresholds<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-53">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>accuracy<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  balanced accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>balanced<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  kappa: </span><span class="sc" style="color: #5E5E5E;">{</span>kappa<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-54">    <span class="bu" style="color: null;">print</span>(confusion)</span>
<span id="cb7-55">    local[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="op" style="color: #5E5E5E;">=</span> accuracy</span>
<span id="cb7-56">    local[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="op" style="color: #5E5E5E;">=</span> balanced</span>
<span id="cb7-57">    local[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="op" style="color: #5E5E5E;">=</span> kappa</span>
<span id="cb7-58">    local[<span class="st" style="color: #20794D;">'shift-confusion'</span>] <span class="op" style="color: #5E5E5E;">=</span> confusion</span>
<span id="cb7-59">    </span>
<span id="cb7-60">    </span>
<span id="cb7-61">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-62">    <span class="co" style="color: #5E5E5E;"># grid-search optimization of the threshold values based on kappa</span></span>
<span id="cb7-63">    thresholds <span class="op" style="color: #5E5E5E;">=</span> run_ternary_oob_optimization(cls.oob_decision_function_,y_train,</span>
<span id="cb7-64">                                                   thresholds<span class="op" style="color: #5E5E5E;">=</span>np.arange(<span class="fl" style="color: #AD0000;">0.05</span>,<span class="fl" style="color: #AD0000;">1.00</span>,<span class="fl" style="color: #AD0000;">0.05</span>),</span>
<span id="cb7-65">                                                  ThOpt_metrics <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'Kappa'</span>)</span>
<span id="cb7-66">    test_preds <span class="op" style="color: #5E5E5E;">=</span> ternary_rebin(test_probs,thresholds)</span>
<span id="cb7-67">    kappa <span class="op" style="color: #5E5E5E;">=</span> metrics.cohen_kappa_score(y_test,test_preds)</span>
<span id="cb7-68">    balanced <span class="op" style="color: #5E5E5E;">=</span> metrics.balanced_accuracy_score(y_test,test_preds)</span>
<span id="cb7-69">    accuracy <span class="op" style="color: #5E5E5E;">=</span> metrics.accuracy_score(y_test,test_preds)</span>
<span id="cb7-70">    confusion <span class="op" style="color: #5E5E5E;">=</span> metrics.confusion_matrix(y_test,test_preds,labels<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">set</span>(y_test)))</span>
<span id="cb7-71">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'global kappa rebalanced'</span>)</span>
<span id="cb7-72">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'thresholds: </span><span class="sc" style="color: #5E5E5E;">{</span>thresholds<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-73">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>accuracy<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  balanced accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>balanced<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  kappa: </span><span class="sc" style="color: #5E5E5E;">{</span>kappa<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-74">    <span class="bu" style="color: null;">print</span>(confusion)</span>
<span id="cb7-75">    local[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="op" style="color: #5E5E5E;">=</span> accuracy</span>
<span id="cb7-76">    local[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="op" style="color: #5E5E5E;">=</span> balanced</span>
<span id="cb7-77">    local[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="op" style="color: #5E5E5E;">=</span> kappa</span>
<span id="cb7-78">    local[<span class="st" style="color: #20794D;">'global-k-shift-confusion'</span>] <span class="op" style="color: #5E5E5E;">=</span> confusion</span>
<span id="cb7-79">    </span>
<span id="cb7-80">    <span class="co" style="color: #5E5E5E;"># --------------------</span></span>
<span id="cb7-81">    <span class="co" style="color: #5E5E5E;"># grid-search optimization of the threshold values based on the balanced accuracy</span></span>
<span id="cb7-82">    thresholds <span class="op" style="color: #5E5E5E;">=</span> run_ternary_oob_optimization(cls.oob_decision_function_,y_train,</span>
<span id="cb7-83">                                                   thresholds<span class="op" style="color: #5E5E5E;">=</span>np.arange(<span class="fl" style="color: #AD0000;">0.05</span>,<span class="fl" style="color: #AD0000;">1.00</span>,<span class="fl" style="color: #AD0000;">0.05</span>),</span>
<span id="cb7-84">                                                  ThOpt_metrics <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">'BalancedAccuracy'</span>)</span>
<span id="cb7-85">    test_preds <span class="op" style="color: #5E5E5E;">=</span> ternary_rebin(test_probs,thresholds)</span>
<span id="cb7-86">    kappa <span class="op" style="color: #5E5E5E;">=</span> metrics.cohen_kappa_score(y_test,test_preds)</span>
<span id="cb7-87">    balanced <span class="op" style="color: #5E5E5E;">=</span> metrics.balanced_accuracy_score(y_test,test_preds)</span>
<span id="cb7-88">    accuracy <span class="op" style="color: #5E5E5E;">=</span> metrics.accuracy_score(y_test,test_preds)</span>
<span id="cb7-89">    confusion <span class="op" style="color: #5E5E5E;">=</span> metrics.confusion_matrix(y_test,test_preds,labels<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">set</span>(y_test)))</span>
<span id="cb7-90">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'global balanced_accuracy rebalanced'</span>)</span>
<span id="cb7-91">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'thresholds: </span><span class="sc" style="color: #5E5E5E;">{</span>thresholds<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-92">    <span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>accuracy<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  balanced accuracy: </span><span class="sc" style="color: #5E5E5E;">{</span>balanced<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">  kappa: </span><span class="sc" style="color: #5E5E5E;">{</span>kappa<span class="sc" style="color: #5E5E5E;">:.3f}</span><span class="ss" style="color: #20794D;">'</span>)</span>
<span id="cb7-93">    <span class="bu" style="color: null;">print</span>(confusion)</span>
<span id="cb7-94">    local[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="op" style="color: #5E5E5E;">=</span> accuracy</span>
<span id="cb7-95">    local[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="op" style="color: #5E5E5E;">=</span> balanced</span>
<span id="cb7-96">    local[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="op" style="color: #5E5E5E;">=</span> kappa</span>
<span id="cb7-97">    local[<span class="st" style="color: #20794D;">'global-ba-shift-confusion'</span>] <span class="op" style="color: #5E5E5E;">=</span> confusion</span>
<span id="cb7-98">    </span>
<span id="cb7-99">    accum.append(local)</span></code></pre></div>
</div>
</section>
<section id="synthetic-datasets" class="level1">
<h1>Synthetic datasets</h1>
<p>I will try out a couple of real datasets below, but I want to start by verifying that the process works with some synthetic datasest. Scikit-learn’s <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.make_classification.html">make_classification() function</a> makes this really easy.</p>
<section id="try-a-10-80-10-split" class="level2">
<h2 class="anchored" data-anchor-id="try-a-10-80-10-split">Try a 10-80-10 split</h2>
<p>I will test this with multiple different forms of imbalance, just to be sure that it generalizes. Let’s start with an example where the majority class is in the middle:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;">from</span> sklearn.datasets <span class="im" style="color: #00769E;">import</span> make_classification</span>
<span id="cb8-2"></span>
<span id="cb8-3">accum_10_80_10 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="cf" style="color: #003B4F;">for</span> rep <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">50</span>):</span>
<span id="cb8-6">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'--------------'</span>)</span>
<span id="cb8-7">    <span class="co" style="color: #5E5E5E;"># Generate a ternary imbalanced classification problem</span></span>
<span id="cb8-8">    X, y <span class="op" style="color: #5E5E5E;">=</span> make_classification(n_samples<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">6000</span>, n_features<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>,</span>
<span id="cb8-9">                               n_informative<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>, n_redundant<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, n_classes<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>, </span>
<span id="cb8-10">                               random_state<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span><span class="op" style="color: #5E5E5E;">+</span>rep, shuffle<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>, weights <span class="op" style="color: #5E5E5E;">=</span> [<span class="fl" style="color: #AD0000;">0.1</span>, <span class="fl" style="color: #AD0000;">0.8</span>, <span class="fl" style="color: #AD0000;">0.1</span>])</span>
<span id="cb8-11">    run_ternary_experiment(X,y,accum_10_80_10)</span></code></pre></div>
</div>
<p>Start by comparing the model-performance metrics kappa, balanced accuracy, and accuracy between the model with the greedy threshold shift based on kappa and the model with “default thresholds”.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">accum <span class="op" style="color: #5E5E5E;">=</span> accum_10_80_10</span>
<span id="cb9-2">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb9-3">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-4">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-5">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-6">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-7">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-8">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb9-9">ylabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb9-10">title(<span class="st" style="color: #20794D;">'10-80-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The shift improves all three metrics for every dataset.</p>
<p>Now compare the results for using a grid search based on Cohen’s kappa to the greedy shift results:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb10-7">ylabel(<span class="st" style="color: #20794D;">'grid-kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb10-8">title(<span class="st" style="color: #20794D;">'10-80-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Here the changes are reasonably small, but they do tend to slightly favor the results of the grid search.</p>
<p>Finally, do the equivalent plot comparing the result from using balanced accuracy in the grid search to the results from the greedy shift:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb11-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb11-8">title(<span class="st" style="color: #20794D;">'10-80-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>That plot makes it look like doing the threshold shifts using balanced accuracy doesn’t improve kappa, but it’s important to remember that this comparing the balanced accuracy shift vs the kappa shift.</p>
<p>Using balanced accuracy to do the shift instead of kappa does actually help kappa too, as this plot shows:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-2">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-3">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-6">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb12-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb12-8">title(<span class="st" style="color: #20794D;">'10-80-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Still, with these datasets it looks like optimizing the threshold with kappa instead of balanced accuracy is a better idea.</p>
</section>
<section id="is-the-majority-class" class="level2">
<h2 class="anchored" data-anchor-id="is-the-majority-class">0 is the majority class</h2>
<p>Now let’s make sure that the code doesn’t have some “feature” which causes it to only work with the middle class is the majority:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">accum_80_10_10 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="cf" style="color: #003B4F;">for</span> rep <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">50</span>):</span>
<span id="cb13-4">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'--------------'</span>)</span>
<span id="cb13-5">    <span class="co" style="color: #5E5E5E;"># Generate a ternary imbalanced classification problem</span></span>
<span id="cb13-6">    X, y <span class="op" style="color: #5E5E5E;">=</span> make_classification(n_samples<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">6000</span>, n_features<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>,</span>
<span id="cb13-7">                               n_informative<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>, n_redundant<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, n_classes<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>, </span>
<span id="cb13-8">                               random_state<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span><span class="op" style="color: #5E5E5E;">+</span>rep, shuffle<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>, weights <span class="op" style="color: #5E5E5E;">=</span> [<span class="fl" style="color: #AD0000;">0.8</span>, <span class="fl" style="color: #AD0000;">0.1</span>, <span class="fl" style="color: #AD0000;">0.1</span>])</span>
<span id="cb13-9">    run_ternary_experiment(X,y,accum_80_10_10)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">accum <span class="op" style="color: #5E5E5E;">=</span> accum_80_10_10</span>
<span id="cb14-2">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb14-3">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-4">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-5">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-6">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-7">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-8">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb14-9">ylabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb14-10">title(<span class="st" style="color: #20794D;">'80-10-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb15-7">ylabel(<span class="st" style="color: #20794D;">'grid-kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb15-8">title(<span class="st" style="color: #20794D;">'80-10-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb16-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb16-8">title(<span class="st" style="color: #20794D;">'80-10-10'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Same conclusions as before (good thing!)</p>
</section>
<section id="is-the-majority-class-1" class="level2">
<h2 class="anchored" data-anchor-id="is-the-majority-class-1">2 is the majority class</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">accum_10_10_80 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="cf" style="color: #003B4F;">for</span> rep <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">50</span>):</span>
<span id="cb17-4">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">'--------------'</span>)</span>
<span id="cb17-5">    <span class="co" style="color: #5E5E5E;"># Generate a ternary imbalanced classification problem</span></span>
<span id="cb17-6">    X, y <span class="op" style="color: #5E5E5E;">=</span> make_classification(n_samples<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">6000</span>, n_features<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">20</span>,</span>
<span id="cb17-7">                               n_informative<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">10</span>, n_redundant<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>, n_classes<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>, </span>
<span id="cb17-8">                               random_state<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span><span class="op" style="color: #5E5E5E;">+</span>rep, shuffle<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>, weights <span class="op" style="color: #5E5E5E;">=</span> [<span class="fl" style="color: #AD0000;">0.1</span>, <span class="fl" style="color: #AD0000;">0.1</span>, <span class="fl" style="color: #AD0000;">0.8</span>])</span>
<span id="cb17-9">    run_ternary_experiment(X,y,accum_10_10_80)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">accum <span class="op" style="color: #5E5E5E;">=</span> accum_10_10_80</span>
<span id="cb18-2">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb18-3">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-4">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-5">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-6">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-7">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-8">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb18-9">ylabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb18-10">title(<span class="st" style="color: #20794D;">'10-10-80'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb19-7">ylabel(<span class="st" style="color: #20794D;">'grid-kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb19-8">title(<span class="st" style="color: #20794D;">'10-10-80'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb20-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb20-8">title(<span class="st" style="color: #20794D;">'10-10-80'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Same conclusions as before (good thing!)</p>
</section>
</section>
<section id="some-chembl-datasets" class="level1">
<h1>Some ChEMBL datasets</h1>
<p>Let’s just be sure that this approach works with bioactivity data too. I don’t think it’s necessary do a comprehensive evaluation here, but I want to show a couple of examples. I didn’t cherry pick these.</p>
<section id="chembl205-carbonic-anhydrase-ii" class="level2">
<h2 class="anchored" data-anchor-id="chembl205-carbonic-anhydrase-ii">CHEMBL205: Carbonic Anhydrase II</h2>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">data <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">'../data/target_CHEMBL205.csv.gz'</span>)</span>
<span id="cb21-2">PandasTools.AddMoleculeColumnToFrame(data,smilesCol<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'canonical_smiles'</span>)</span>
<span id="cb21-3">data[<span class="st" style="color: #20794D;">'pKi'</span>] <span class="op" style="color: #5E5E5E;">=</span> [<span class="op" style="color: #5E5E5E;">-</span>math.log10(x<span class="op" style="color: #5E5E5E;">*</span><span class="fl" style="color: #AD0000;">1e-9</span>) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> data[<span class="st" style="color: #20794D;">'standard_value'</span>]]</span>
<span id="cb21-4">data.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>compound_chembl_id</th>
      <th>canonical_smiles</th>
      <th>standard_value</th>
      <th>standard_units</th>
      <th>standard_relation</th>
      <th>standard_type</th>
      <th>year</th>
      <th>ROMol</th>
      <th>pKi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CHEMBL1054</td>
      <td>NS(=O)(=O)c1cc2c(cc1Cl)NC(C(Cl)Cl)NS2(=O)=O</td>
      <td>91.0</td>
      <td>nM</td>
      <td>=</td>
      <td>Ki</td>
      <td>2009</td>
      <td><img data-content="rdkit/molecule" src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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" alt="Mol"></td>
      <td>7.040959</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CHEMBL1055</td>
      <td>NS(=O)(=O)c1cc(C2(O)NC(=O)c3ccccc32)ccc1Cl</td>
      <td>138.0</td>
      <td>nM</td>
      <td>=</td>
      <td>Ki</td>
      <td>2009</td>
      <td><img data-content="rdkit/molecule" src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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XL09MQtW3Ds2NqJAvJyd8eQEIyOxrNnUaFoqqP169cDQEREBLf13759O+lhdXdk5EmLSCRKT0/n1pcBN27cIAEU165dIyXFxcWkpTx8+DBV14/FrIWFiDt3oosLjh2Lp07hypU4fDja2tYpDABtbXHECFy1Co8cUeme+D6UBQsWAMC2bds4rLxcLndycgKAAwcOkBKtVjt48GAaCn4ob7/9NgCMGzdOV7J582YACAgI4GQ+tsWYu7C0WvzPf+qNsdRqTE3F2FgMDcWgIOTxahXWt28xALi7u4eEhERHR589e9bgL/vSSy9xPuh56623AGD06NG6kp07dwKAm5tbaWkph44ehVwud3R01J+AVSqVPXr0AICtW7dy66tUXXq56nKuMhcRy9Rls7NmN3Kx6YV18SJWVNQdnj2LO3fig3t2RMT8fExOfuTbZTI8eBCXL8d58y5YW1vrxzDa2dmNGjVq9erVR44ckcvl5DaKw7C75ORkgUAgEolu3LhBSkpLS40/Cb5hwwYyf6abRvn9999J0I5cLufEhQY187LneaZ4Trw90S/Vb0HOgkJVoctVl0beYnaLKY4ehZdegj59IDm52Sv81Gr11atXExIS/v333wsXLmRlZelO8Xg8Pp+v0WgmTZqkv6gBAIRCoa2trYEpGxsbkUikX8Lj8RwcHHSHiLhr166MjIylS5eSrxYAUlNTp02b5ubmdubMGR6P17zatxSFQhEUFJSZmRkXFzdt2jRSOGbMmJMnT37wwQebNm1qvYtYeewX97442+OsvcBeicrkqmS/Dn690nrJesse9RbzEpZSCcHBcPMmREfDokWttSaTyRITE5OSks6fP3/hwgWVSqXiND8RCY3Kzs4mnRFBqVQWFRWRKX6jcfz48crKSp2qAODy5csDBgywtLR0dXU1kHinTp10/7fvYl+2vkzIE9ryG/y0+DYivggApnea/qP8xwkdJ4Q6herOFqmLGheWeS1Y/fxzuHkTgoLg7bc5sObq6jpx4sSJEycCgEqlcnd3l8vl33zzjX7DQ05VVFQYvLeiosJAhYh4/593aFWq929e3d5efnu3bsX6f0ISCweB7VvDi82SDbRqVMnCwsLkUik32w3xF3jXlBV0LjxvlZ981R5XUVdm1UlMxJWXh6sXw8AsG0bCIUcGxcKhV5eXnK5vH/v04Woz6/PPPT5w4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" alt="Mol"></td>
      <td>6.860121</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CHEMBL1060</td>
      <td>O=P([O-])([O-])O.[Na+].[Na+]</td>
      <td>13200000.0</td>
      <td>nM</td>
      <td>=</td>
      <td>Ki</td>
      <td>2004</td>
      <td><img data-content="rdkit/molecule" src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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" alt="Mol"></td>
      <td>1.879426</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CHEMBL106848</td>
      <td>NS(=O)(=O)c1ccc(SCCO)cc1</td>
      <td>21.0</td>
      <td>nM</td>
      <td>=</td>
      <td>Ki</td>
      <td>2013</td>
      <td><img data-content="rdkit/molecule" src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAIAAAAiOjnJAAAABmJLR0QA/wD/AP+gvaeTAAASpklEQVR4nO3dfVQTd7rA8WcIbwVfQEUvKsUqVo2IumBtjXWtulqVa4svqHuLdLX12NbFurVrre2pWm2r1Uo9p96ru3b1cLe4q+1aOL6wvrZRjgeG96ghCMg7ihCCEELenvvHQBhREcL8EuA+n8MfyRB+M8Gv80smk8AhIhAiNRdnbwDpnSgswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmGCwiJMUFiECQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIkxQWIQJCoswQWERJigswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmGCwiJMUFiECQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIkxQWIQJCoswQWERJigswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmGCwiJMUFiECQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIky4OnsDupH6+vqMjIzU1FSe55csWTJixIjQ0FBnb1RPxSGis7fBaUwmk0ajSUtLS0tLu3btWmZmpsViEb41ZMgQg8GgVConTJjg3I3sof5/hWUymVQqFc/zwm5JpVKZTCbbd93c3EJCQsLCwkJDQ0+fPv3zzz8PHTo0OTk5MDDQidvcQ/XysCwWi1qtTmuRnp7e2Nho+65MJhszZkyoyDPPPCN8y2g0Lly48MKFC3K5/OrVq76+vk66Bz1V7wzrwoULZ86c4Xk+IyOjvr7etpzjuOeffz6sxeTJk729vZ80SF1d3YwZM7KysmbMmJGUlOTp6emQbe8lemFYJ06ciIuLS0xMFK76+/vbdkjTpk0bOHBgx4cqLy9/6aWXiouLIyMj4+PjXVzoSXSHocNYrXj4MEZG4po1+Ouv7NYzZswYAFi9evXZs2erqqrsGCE2NvbDDz8ULqtUKmEefPfddyXdzF7OgWF9+inGxKBWi7dv49SpePUqi5VkZGQAwJAhQ8xms30j5Obmuru7A0BsbKyw5MqVKx4eHgDwzTffSLelvZwDwwoMRIOh+fLZs7hqFYuVfPzxxwDwzjvvdGUQYdbjOC4uLk5Ycvz48TZLSPscFVZjIwYFtV5Vq3HWLBbrGTt2LABcunSpi+N89dVXAODu7n7hwgVhyddff91mCWmHY/dYRmPz5fPnMSpK8jUI86Cfn5/JZELE/fv3v/zyy2fPnrVvtJiYGADo379/VlaWsOT9998HgH79+tmWSMFSWbkvP39ZUdF7JpM9jwi7JweGtWkTfvopmkxYU4MzZ+Lly5Kvoc08OHXqVAA4efKkfaNZLJYlS5YAwLBhw4qLi4Uly5YtEy/puurq/y0sXGU2a+vrUyyWRknG7A4cGJbJhF9+ifPnY0QEJiZiaankbYnnweLiYo7jvLy86uvr7R5Qr9dPnz4dAIKDg7VaLSI2NTXNnj0bAMaPHy8s6aKqqr/m5y+1WPRdH6pbcWBY1dV4+jTyPCKiTocuLujhgU1NUg2fmZkpngf37t0LAMuXL+/isPfv3xd6nTlzpsFgQMTa2tqQkBDxkk4xGstqaxPKyj7LywsvKHjDajWUlGzKyRldUvKB1Wp8+s/3EA4MKzYWAfCtt5qvjhmDAJiWJtXwW7dulXAeFCspKRk+fDgArFixwmKxIGJpaWlAQIB4STvEJWVmDuJ5sH1lZvoJt7FaTfn5y6qre89TTgeGde0aAuDEic1X33gDAfDQIamGl3weFMvOzu7fvz8AbN68WViSk5Pj4+MDALZDqTZarfb8+fOfffZZeHh4YOCw9HRPcUxZWf55eeFlZZ/V1iYYjZVNTYVmsw7RUlDwXzU1/zSZqiXZYKdzYFgNDejqijIZNjQgIu7fjwD49tuSjN1mHty3bx8AREZGSjK44NKlS8KB02+/VZYcvnyZeHA6RdffJGUlLRr167XX39d2LeJ8fw0jebVsrJPtNpTRmNpm2F1uqTbtyM0mjllZZ/q9ZlZWcMqK3vDYVgHhoWIISEIgMnJiIhXryIATpokycDCPLhu3Trh6osvvggAJ06ckGRwm6NHj3IcJ5PJzp8/LyyJi4vjOK5fv37ikvr27atQKGJiYo4dO6ZSqaxWawfHr67+gec5nnepqfmntFvueI4Na80aBMADBxBbdmCurqiX4AmRMA9evHgRGcyDYjt37nzttdcahJ0uIiIOHz7c3d190qRJGzZsiIuLU6vVT33U1Y7Kyj08D2lp7nV1PfswrGPDOngQAVpfzJkwAWUyC3+9i6M6YB4UE3ejUqkAYODAgcKqJVFc/D7PQ0ZGf71ewsOwjubY80CmTAGOs94tFq5V/c/crF887wekdnHUEydOAMCSJUtcXV1tV4UjmSyIT54R1hURESGsWhIBAft8fZdaLLq8vAVGY4lUwzqaIyu2Gg05Sj+edzGb6xDx3r2DPA+FhdFdHNZh8+Cj5HI5ACQlJUk7rNXalJs7i+fhxo3xZrMEh2Edz6F7LM7NQzYwEMCq16cDgJdXGAA0NHRpj5Wdna1WqwcNGjRjxgxoecAeHh7ezqmhUlGr1Tdv3hw4cOArr7wi7cgc5z5y5AlPT3lj442MjD8YjUZpx3cAR58S6e09BQD0+lQA8PKayHEeBoPaYnlg94DCZLR06VLHzINix48fB4CIiAg3NzfJB3d1HTB69BmtdurKlZnR0dFWq1XyVbDl4D1kVdURnoeCghXC1Zs3Q3keHjz4xe4BxfNgeXl5L5gHxdo5DGu3ysrKxkbmr3Y7Oiy9PovnISdnlHC1qGgdz0Nl5V77RsvKygKAQYMG2Z6U5ebmSvIyzlPdunULAHx9fZuke7nzsWyHYW1ntHaWTqdTKpWxsbFRUVFyuZzjuI0bNx4QDvow4+iwrFZzero3z3Mm031ErKr6q3gH1hFGo5HneeHXNGzYMJlMtmDBAmbb+0Tbtm0DgDVr1jhgXfHx8RzHubi4dPCQb11d3ZUrV/bu3btixYqgoKA2c1SfPn06NZp9HB0WIqrV03gedLp/I2JTU9H9+983Nt5q5/bCu0yPHTsWExOjUCiE11VsPD09vby8UlJSHLX5zcaPHw8A586dc8zqvvzyS+HOKpXKR79rNBqFX9HatWvlcrlMJhP/itzc3ORy+dq1a4VXAiwWy549e4Dx2bBOCOvBg6sNDakWi/7u3QMFBW+Ulm4xm3XiG1itZr1edf/+seLiGLVasWPHbPGvydXVVS6XR0VFxcbG/vrrr9HR0cJsmJub67C74LB5UMx2Rmt2dnab/2zCXPnYX5FSqXzsuT0bNmyAh8+PlZYTwhJUVR0pLPyD0VhWV3fRajU0Nt6qro4rLo5Rq6elp3uJTwf4xz8myOXyVatWHThwIDk5Wf/wS0Bms3nRokUAMGrUqMrKSsdsvCPnQRuz2RwRESEE/WhJISEhq1evPnjwYEpKSkdyt1gsS5cuBUnPhhVz2htW792LbWy8+eyz/81xsqamQpVqpPi7bm7+Xl6hXl6h3t6h3t4KV9cB7Qyl1+tnz559/fr1KVOmXL582QFHsIKDg2/cuHHu3Ll58+axXpdYY2NjdHR0U1NTQkKC8Ebc6dOnKxSK9t/S/SQGg2Hu3LlKpTI4OFipVApPPyUjeapP0tRUotX+q6xsq0YzLz8/0myuu3PnrZyc0eXlOxGtN29Oun07oqLiC53u32ZzTWcHv3fv3ujRowFg4cKFEr5s91hqtRocPg+KlZWV6XS6p9+uA6qrq8eNGwcAHy1fLuHZvNj+VJiX13q5oABtr71aLJifj8LJIGYzlpU9/sfv3sXi4vTy8u15ef+ZleUvnt0yMnwRrYhosTRoNL/Tak91/Z7cvn178ODBAPC2ROd4PYlT5kF27ty5s3nmTMuAAfj732OHz/B5qvbCGjmy9XJYGFa3nNtYW4sAKLxzs6oKFYrm5TodKpUYG4tRUSiXI8fhkSN7RDH1U6sVxcUx9+8f0+tVTU0lVqsB0ZKfH1lbmyDJnUlJSRFmhM8/1ySAR/Lwc8HHSE7G318EAClOwxrZ1i/+Q2GhmJNTXNYmzbh6NHIcQjQ+tW3L27fnl5S8kF1dbzBkNdmcK32x7y8+RrNnNLSjxEtZnONJO+qS0xMdHV15Tju+++/7/pohYWFp049tDd1+jzIyqVL6OGBAGjvYdg22gsrIAB3727+Gj78obAUCoyPx7Vrm8NauRIB0M0N5XKMisJDh1ClwvZPdzObdbZXcsrLd/I8lJdvk+QuHTp0CADc3NzseKtqWVlZQkKCcLq6MLECwN27d2032L59OwCsXr1akk3tXn74ATkOXVxQigOn7YUVGIgXLzZ/jRnTNixEnDMHT59GhQKzszEjAzv1oDkzczDPQ1NTESLW1BznecjLC7f3XrS1ZcsWAPDy8rp+/SlnEVZVVZ05c2bHjh2LFi0aOnRom2c2gwcPXrBgQZ7owWZwcDAA2P3u6u5u1y4EQE9PfNxh2E6xcyoUwrp1CydNan2M1SkazTyeB632R0Q0GPJ5HrKyhtgz0ONYrdY333wTAPz8/MRZCHJzc3fv3r106dIRI0a0KcnHx2fOnDkfffTRyZMni4qK2vxgr50Hxf74RwTAAQPw5s2uDNOJ8x6TkyEtDerq4JNPmpeMHQuvvgpKZcfHaOXtPaWuLqmhgffxWezh8Zyr60CT6a7RWOLuHmDPcA/jOO7w4cMVFRVJSUnz58+/du2abV4DgJSUlM2bNwuX+/TpM3HiRNsns40bN+7RT1ezWq0ajYbn+e+++w4AIiIi2rys1Kvs3w9FRXDlClRWwrhx9o/TTnQqVetltRpraxERN23CykpUq5uXNza2Xu4UrfZfPA8aze+EqxrNXJ4HrfYne8Z6grq6usmTJwPACy+8ID6RprCwcP369UePHlWpVE/6GC3xgy3xhwC+9957qampEm5kd9TQ0Pxvn5eHW7bgunV47BhardjQgHv2tN5sW3uPiTt3gPTePVy/3p5NfZTRWCo+oFVWtpXnobT0Y2lGb1FeXi7Md+Hh4e0fOC0tLT116tTWrVvnzZv36MdJBgQERERE7Nq1S23ff6Oe6M4dDA7GX37BwkLcuBE3bsTqagwLa72B+KHSIzoRlkqF69djRQXa+1l5bQlHTYUjES07sLnSDC2Sl5fn5+cHAGvXrhUvr62tFc5SWrZsmb+/f5uSfHx8FArF5s2bExISKioqJN+qHmDrVvzLX5ovm80YGIgVFR0PqxOPse7dgwkTICEBFi+GQYPsmncf5uUVptMlGmoyPPyD+kLYpA0TZSW34A4Cx0kweougoKDExMRZs2YdPnwYAJ577jme53meLyoqEt/M19c3TOTZZ5+VcBt6pKIimDOn+bJMBgEBUFEBGg28+mrzQoOhvR9n2fxTmL7fhz798YMPmq/7+yMA3r7NYl0/viji4vLkCFDbHe8T58+4vcrd+Vdpr3Tn/6E8fGtV4OCsKSEyR5Lcq7/MQ5qdZDa8i6dsDBITASeh1GjJF/X4sWLk5OTr1+/np+fL+yTxo4dSx+v3Z6VK2HDBliwAPr1g/h4CAkBL6+O/7RT/0jTlCkAAOnpYLGATNYcVmoqLF/OYm1Tp04VPtuIdEhYGPz5z7BiBZjNEBQER46AiwsEB7feYNKkdn7a2X9AYMQIKCqCGzdALoczZ2DhQvjtb+HKFWduEpGCs+cCYaclzIbC5bQ0aPkTXKTncnZYYWEAADwPAODnB4GBUF8PubnO3SjSdc7+Q5jisABg2zZwd4dHXgwmPY6zH2M9eAA/QRTpkBaGly8CJ6eEBUFCoUzN4lIwdlhCb76CgoKYOdO0GohOhr27oXp0529TaRLukdYo0ZBTk7zYZILF+Bvf4O/93Z20S6xNkP3gHAYgGLpfXg28iRUNJjP22MtOgGYclkwHFg+wio0lJ68N4LdIOwACAyEnbuBKsV6uth1y54801nbxDpqu7xGMtkgt27ITkZXFwgOhoc8rFphKnuERbpdbrHVEh6HQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIkxQWIQJCoswQWERJigswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmGCwiJMUFiECQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIkxQWIQJCoswQWERJigswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmGCwiJMUFiECQqLMEFhESYoLMIEhUWYoLAIExQWYYLCIkxQWIQJCoswQWERJigswgSFRZigsAgTFBZhgsIiTFBYhAkKizBBYREmKCzCBIVFmKCwCBMUFmHi/wAwW+eHIZ3ONAAAASh6VFh0cmRraXRQS0wgcmRraXQgMjAyMS4wOS4zAAB4nHu/b+09BiDgZUAAPihuYGRnSADSjEwCDApAmo2DQQNIMTPBaDYHMM3C5pABopkZkRgQGYhGJjawOUxwmgNiLiOmRm4GRqB9HEyMzEDMwsDCmsHEypbAxp7BxM7BwMHJwMnFwMXNwM6TwMObwcTLkiDCyMbCy8POxiq+CWQi3Ast7TMPyG2Q2g/iuDOHHogwnb0PxF7ikXFAy2uqPYj9eq/jgWtPHoHV8L9/u9/EinU3iK3isnG/9vOtYDV7TdfaPim8A2Z/tO+yX7lUEszeoa3sIL07DcxmfpTkwM+TBDb/YdkCh4LJS2xBbPagAw43Q1vB5vNoSds/XxsEZn9hid2/9mE/mC0GAO3gRGLNGUJNAAABhnpUWHRNT0wgcmRraXQgMjAyMS4wOS4zAAB4nH2T227DIAyG7/MUfoEgnzhdrmk1TVMTae32Drvf+2s2VUeqogFGCfkC9m8zgbeP4/v3D/w1Pk4TAP4zaq3wJYg4ncEf4HB6fVthub4c7ivL9rleL0DqA70/si/X7XxfIVhh1pBrzpVhxpBQOdovAVvr/zJcYJYgXISjk4JCSgNSYHMycVUxHwKlJJwGoN5A5MyUYaaQMyesAzLC4t9LLDb8cERGkQGZbqQULRYQBWUi2/wZzAbaatGYo3GZrY2cLMaRcYjZPydEKjrgqunDIWqN6n5VJK4jB8kSBGJgRG06MmPWUdBERsaApJG4+YoShyCbkMlA8008elRKhUektKgTJjI/7PDCXNMobCudpQFJJLbkECuaVM/oaT0+1NStyg7beuxV5p17KXmXXi/+qr0qDIXYU69mqedXzXLPopqVniwyqz0n5LbXntpEO42pTbwTU30f2WmmPpHutGl3K+4V2Mfr7/cbac/TL+sHusNMSYvOAAAAz3pUWHRTTUlMRVMgcmRraXQgMjAyMS4wOS4zAAB4nB2POw4CMQwFr0K5SNnIz/9oRUUPBUfINTg8NkUka/w8dl6f4/G+99vYex+f57PKjdv3OHXGiljjpOmkbOM6ZQqnSCMhgeLPnJfKwIR79ZoQB/M4MSPYO4SZluk9SMRUlvWnkloVpjLA46puqoVxoTJw2VCIKEcfQUgdF0/TZVpkEXhVRooYaduZKbTcNglqGG0ksU55oVL0WaTw7HVODvRcMi/3uqnK+oVFx8BKMe7fH2SkO9U2HfHdAAAAAElFTkSuQmCC" alt="Mol"></td>
      <td>7.677781</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CHEMBL107217</td>
      <td>CCN(CC)C(=S)[S-].[Na+]</td>
      <td>3100.0</td>
      <td>nM</td>
      <td>=</td>
      <td>Ki</td>
      <td>2009</td>
      <td><img data-content="rdkit/molecule" src="https://greglandrum.github.io/rdkit-blog/posts/data:image/png;base64,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" alt="Mol"></td>
      <td>5.508638</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Pick two pKi values for binning</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;">def</span> binner(act,bins<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">5</span>,<span class="fl" style="color: #AD0000;">8.5</span>)):</span>
<span id="cb22-2">    <span class="cf" style="color: #003B4F;">for</span> i,<span class="bu" style="color: null;">bin</span> <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(bins):</span>
<span id="cb22-3">        <span class="cf" style="color: #003B4F;">if</span> act<span class="op" style="color: #5E5E5E;">&lt;=</span><span class="bu" style="color: null;">bin</span>:</span>
<span id="cb22-4">            <span class="cf" style="color: #003B4F;">return</span> i</span>
<span id="cb22-5">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">len</span>(bins)</span>
<span id="cb22-6">data[<span class="st" style="color: #20794D;">'activity'</span>] <span class="op" style="color: #5E5E5E;">=</span> [binner(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> data.pKi]</span>
<span id="cb22-7">data.groupby(<span class="st" style="color: #20794D;">'activity'</span>).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">standard_value</th>
      <th colspan="5" halign="left">year</th>
      <th colspan="8" halign="left">pKi</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>...</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>activity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>968.0</td>
      <td>1.242009e+18</td>
      <td>3.864224e+19</td>
      <td>10000.000</td>
      <td>10000.0000</td>
      <td>50000.0</td>
      <td>196700.000</td>
      <td>1.202264e+21</td>
      <td>968.0</td>
      <td>2012.994835</td>
      <td>...</td>
      <td>2016.0</td>
      <td>2020.0</td>
      <td>968.0</td>
      <td>4.069107</td>
      <td>1.200449</td>
      <td>-12.080000</td>
      <td>3.706216</td>
      <td>4.301030</td>
      <td>5.000000</td>
      <td>5.00000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3582.0</td>
      <td>7.292523e+02</td>
      <td>1.778519e+03</td>
      <td>3.200</td>
      <td>13.5000</td>
      <td>73.4</td>
      <td>417.750</td>
      <td>9.900000e+03</td>
      <td>3582.0</td>
      <td>2013.261307</td>
      <td>...</td>
      <td>2017.0</td>
      <td>2020.0</td>
      <td>3582.0</td>
      <td>7.050231</td>
      <td>0.915651</td>
      <td>5.004365</td>
      <td>6.379084</td>
      <td>7.134306</td>
      <td>7.869666</td>
      <td>8.49485</td>
    </tr>
    <tr>
      <th>2</th>
      <td>427.0</td>
      <td>1.309327e+00</td>
      <td>8.709364e-01</td>
      <td>0.008</td>
      <td>0.6355</td>
      <td>1.0</td>
      <td>2.035</td>
      <td>3.100000e+00</td>
      <td>427.0</td>
      <td>2014.962529</td>
      <td>...</td>
      <td>2017.0</td>
      <td>2020.0</td>
      <td>427.0</td>
      <td>9.050659</td>
      <td>0.500779</td>
      <td>8.508638</td>
      <td>8.691437</td>
      <td>9.000000</td>
      <td>9.196895</td>
      <td>11.09691</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 24 columns</p>
</div>
</div>
</div>
<p>Ok, that’s imbalanced :-)</p>
<p>Generate fingerprints:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> SaltRemover</span>
<span id="cb23-2">sr <span class="op" style="color: #5E5E5E;">=</span> SaltRemover.SaltRemover()</span>
<span id="cb23-3">stripped <span class="op" style="color: #5E5E5E;">=</span> [sr.StripMol(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> data.ROMol]</span>
<span id="cb23-4">fpgen <span class="op" style="color: #5E5E5E;">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb23-5">fps <span class="op" style="color: #5E5E5E;">=</span> [fpgen.GetFingerprint(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> stripped]</span></code></pre></div>
</div>
<p>And now run the experiment with 20 random splits:</p>
<div class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">accum_chembl205 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb24-2"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">20</span>):</span>
<span id="cb24-3">    run_ternary_experiment(fps,data.activity,accum_chembl205,random_state<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span><span class="op" style="color: #5E5E5E;">+</span>i)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">accum <span class="op" style="color: #5E5E5E;">=</span> accum_chembl205</span>
<span id="cb25-2">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb25-3">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-4">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-5">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-6">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-7">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-8">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb25-9">ylabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb25-10">title(<span class="st" style="color: #20794D;">'CHEMBL205'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb26-7">ylabel(<span class="st" style="color: #20794D;">'grid-kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb26-8">title(<span class="st" style="color: #20794D;">'CHEMBL205'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb27-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb27-8">title(<span class="st" style="color: #20794D;">'CHEMBL205'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We see the same behavior as before: shifting the descision thresholds using either the greedy approach or grid-based approach improves prediction accuracy over the default decision thresholds.</p>
</section>
<section id="chembl217-dopamine-d2" class="level2">
<h2 class="anchored" data-anchor-id="chembl217-dopamine-d2">CHEMBL217: Dopamine D2</h2>
<div class="cell" data-scrolled="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">data <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">'../data/target_CHEMBL217.csv.gz'</span>)</span>
<span id="cb28-2">PandasTools.AddMoleculeColumnToFrame(data,smilesCol<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'canonical_smiles'</span>)</span>
<span id="cb28-3">data[<span class="st" style="color: #20794D;">'pKi'</span>] <span class="op" style="color: #5E5E5E;">=</span> [<span class="op" style="color: #5E5E5E;">-</span>math.log10(x<span class="op" style="color: #5E5E5E;">*</span><span class="fl" style="color: #AD0000;">1e-9</span>) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> data[<span class="st" style="color: #20794D;">'standard_value'</span>]]</span>
<span id="cb28-4"><span class="kw" style="color: #003B4F;">def</span> binner(act,bins<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">5</span>,<span class="dv" style="color: #AD0000;">8</span>)):</span>
<span id="cb28-5">    <span class="cf" style="color: #003B4F;">for</span> i,<span class="bu" style="color: null;">bin</span> <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(bins):</span>
<span id="cb28-6">        <span class="cf" style="color: #003B4F;">if</span> act<span class="op" style="color: #5E5E5E;">&lt;=</span><span class="bu" style="color: null;">bin</span>:</span>
<span id="cb28-7">            <span class="cf" style="color: #003B4F;">return</span> i</span>
<span id="cb28-8">    <span class="cf" style="color: #003B4F;">return</span> <span class="bu" style="color: null;">len</span>(bins)</span>
<span id="cb28-9">data[<span class="st" style="color: #20794D;">'activity'</span>] <span class="op" style="color: #5E5E5E;">=</span> [binner(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> data.pKi]</span>
<span id="cb28-10">data.groupby(<span class="st" style="color: #20794D;">'activity'</span>).describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">standard_value</th>
      <th colspan="5" halign="left">year</th>
      <th colspan="8" halign="left">pKi</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>...</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>activity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>356.0</td>
      <td>143415.189354</td>
      <td>781194.668326</td>
      <td>10000.000</td>
      <td>10000.0000</td>
      <td>10000.00</td>
      <td>24234.5</td>
      <td>10000000.00</td>
      <td>356.0</td>
      <td>2011.679775</td>
      <td>...</td>
      <td>2017.0</td>
      <td>2019.0</td>
      <td>356.0</td>
      <td>4.672916</td>
      <td>0.581865</td>
      <td>2.000000</td>
      <td>4.615626</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>5.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4014.0</td>
      <td>830.546163</td>
      <td>1471.610125</td>
      <td>10.000</td>
      <td>63.1875</td>
      <td>238.51</td>
      <td>931.0</td>
      <td>9906.00</td>
      <td>4014.0</td>
      <td>2011.100648</td>
      <td>...</td>
      <td>2015.0</td>
      <td>2020.0</td>
      <td>4014.0</td>
      <td>6.620074</td>
      <td>0.724919</td>
      <td>5.004102</td>
      <td>6.031050</td>
      <td>6.622494</td>
      <td>7.199370</td>
      <td>8.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>607.0</td>
      <td>3.715942</td>
      <td>2.786155</td>
      <td>0.027</td>
      <td>1.2150</td>
      <td>3.00</td>
      <td>5.9</td>
      <td>9.86</td>
      <td>607.0</td>
      <td>2011.957166</td>
      <td>...</td>
      <td>2016.0</td>
      <td>2019.0</td>
      <td>607.0</td>
      <td>8.614671</td>
      <td>0.475862</td>
      <td>8.006123</td>
      <td>8.229148</td>
      <td>8.522879</td>
      <td>8.915457</td>
      <td>10.568636</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 24 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> SaltRemover</span>
<span id="cb29-2">sr <span class="op" style="color: #5E5E5E;">=</span> SaltRemover.SaltRemover()</span>
<span id="cb29-3">stripped <span class="op" style="color: #5E5E5E;">=</span> [sr.StripMol(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> data.ROMol]</span>
<span id="cb29-4">fpgen <span class="op" style="color: #5E5E5E;">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb29-5">fps <span class="op" style="color: #5E5E5E;">=</span> [fpgen.GetFingerprint(m) <span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> stripped]</span></code></pre></div>
</div>
<div class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">accum_chembl217 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb30-2"><span class="cf" style="color: #003B4F;">for</span> i <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">20</span>):</span>
<span id="cb30-3">    run_ternary_experiment(fps,data.activity,accum_chembl217,random_state<span class="op" style="color: #5E5E5E;">=</span><span class="bn" style="color: #AD0000;">0xf00d</span><span class="op" style="color: #5E5E5E;">+</span>i)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">accum <span class="op" style="color: #5E5E5E;">=</span> accum_chembl217</span>
<span id="cb31-2">figsize(<span class="dv" style="color: #AD0000;">9</span>,<span class="dv" style="color: #AD0000;">6</span>)</span>
<span id="cb31-3">scatter([x[<span class="st" style="color: #20794D;">'orig-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-4">scatter([x[<span class="st" style="color: #20794D;">'orig-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-5">scatter([x[<span class="st" style="color: #20794D;">'orig-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-6">plot([<span class="fl" style="color: #AD0000;">.2</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.2</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-7">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-8">xlabel(<span class="st" style="color: #20794D;">'orig'</span>)</span>
<span id="cb31-9">ylabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb31-10">title(<span class="st" style="color: #20794D;">'CHEMBL217'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-k-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb32-7">ylabel(<span class="st" style="color: #20794D;">'grid-kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb32-8">title(<span class="st" style="color: #20794D;">'CHEMBL217'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">scatter([x[<span class="st" style="color: #20794D;">'shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-kappa'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'kappa'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-2">scatter([x[<span class="st" style="color: #20794D;">'shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-balanced'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'balanced accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-3">scatter([x[<span class="st" style="color: #20794D;">'shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],[x[<span class="st" style="color: #20794D;">'global-ba-shift-accuracy'</span>] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> accum],label<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'accuracy'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-4">plot([<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>],[<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>])<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-5">legend()<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-6">xlabel(<span class="st" style="color: #20794D;">'greedy shift'</span>)</span>
<span id="cb33-7">ylabel(<span class="st" style="color: #20794D;">'grid-balanced'</span>)<span class="op" style="color: #5E5E5E;">;</span></span>
<span id="cb33-8">title(<span class="st" style="color: #20794D;">'CHEMBL217'</span>)<span class="op" style="color: #5E5E5E;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Again, the same conclusions hold here.</p>


</section>
</section>

 ]]></description>
  <category>exploratory</category>
  <category>machinelearning</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-12-23-ternary-ghost.html</guid>
  <pubDate>Wed, 22 Dec 2021 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/ternary-ghost1-1.png" medium="image" type="image/png" height="101" width="144"/>
</item>
<item>
  <title>Some new features in the SubstructLibrary</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order.html</link>
  <description><![CDATA[ 



<p>Earlier this year I did a <a href="https://greglandrum.github.io/rdkit-blog/tutorial/substructure/2021/08/03/generalized-substructure-search.html">blog post on “Generalized substructure search”</a> with the RDKit. That demonstrated how to use some advanced query features like link nodes, variable attachment points, and tautomer insensitivity to search through the compounds from ChEMBL 29 with the RDKit’s <code>SubstructLibrary</code>.</p>
<p>This post uses the same ChEMBL 29 <code>SubstructLibrary</code> to demonstrate a couple of new features which were added in the 2021.09 release of the RDKit: 1. Changing the search order 2. Specifying which compounds are actually searched 3. Saving a molecule key (or name) together with the molecules in the <code>SubstructLibrary</code></p>
<p>For more about the <code>SubstructLibrary</code>, take a look at this earlier post about <a href="https://greglandrum.github.io/rdkit-blog/tutorial/substructure/2021/08/03/generalized-substructure-search.html">generalized substructure search</a>.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdSubstructLibrary</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> RDLogger</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> rdBase</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">import</span> gzip</span>
<span id="cb1-10"><span class="bu" style="color: null;">print</span>(rdBase.rdkitVersion)</span>
<span id="cb1-11"><span class="bu" style="color: null;">print</span>(time.asctime())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021.09.3
Mon Dec 20 05:14:01 2021</code></pre>
</div>
</div>
<p>Here’s the code to build the <code>SubstructLibrary</code> from the sdf file distributed by the ChEMBL team. This uses a feature added in RDKit v2021.09 to allow a molecule key (or name) to be stored with the molecules in a <code>SubstructLibrary</code>.</p>
<p>Executing this takes about 45 minutes on my machine.</p>
<p>RDLogger.DisableLog(“rdApp.warning”)</p>
<p>molholder = rdSubstructLibrary.CachedTrustedSmilesMolHolder() patts = rdSubstructLibrary.TautomerPatternHolder() # this will automatically grab the “_Name” property for each molecule # in the ChEMBL SD file this contains the ChEMBL ID for the molecules. keys = rdSubstructLibrary.KeyFromPropHolder() slib = rdSubstructLibrary.SubstructLibrary(molholder,patts,keys) t1 = time.time() with gzip.GzipFile(‘/home/glandrum/Downloads/chembl_29.sdf.gz’) as gz, Chem.ForwardSDMolSupplier(gz) as suppl: nDone = 0 for m in suppl: if m is None: continue # skip huge molecules if m.GetNumHeavyAtoms()&gt;75: continue slib.AddMol(m) nDone += 1 if not nDone%50000: print(f’ did {nDone} in {time.time()-t1:.2f}s’) with open(‘./results/chembl29_ssslib.pkl’,‘wb+’) as outf: pickle.dump(slib,outf) print(f’That took {time.time()-t1:.2f}s in total.’) with open(‘./results/chembl29_ssslib.pkl’,‘wb+’) as outf: pickle.dump(slib,outf)</p>
<p>We’re going to use the number of heavy atoms to determine the search order. Since that takes a while, go ahead and pre-calculate those values and store them in the same pickle file as the SubstructLibrary:</p>
<p>holder = slib.GetMolHolder() nats = sorted([(holder.GetMol(x).GetNumHeavyAtoms(),x) for x in range(len(slib))]) order = [y for x,y in nats] # append that to the pickle file with the substruct lib: with open(‘./results/chembl29_ssslib.pkl’,‘ab’) as outf: pickle.dump(order,outf)</p>
<p>Read in the saved data:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/chembl29_ssslib.pkl'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb3-2">    slib <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb3-3">    nat_order <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span></code></pre></div>
</div>
<p>Here’s the query we’ll use for this post:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;">'[O,N]=C-c:1:c:c:n:c:c:1'</span>)</span>
<span id="cb4-2">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s look at doing a search. We also take advantage of the <code>SubstructLibrary</code>’s <code>KeyHolder</code> (a new feature in v2021.09) to include the compound ChEMBL IDs in the results:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">mids <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry)</span>
<span id="cb5-2"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb5-3">ms <span class="op" style="color: #5E5E5E;">=</span> [slib.GetMolHolder().GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb5-4">legends <span class="op" style="color: #5E5E5E;">=</span> [slib.GetKeyHolder().GetKey(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb5-5">Draw.MolsToGridImage(ms,legends<span class="op" style="color: #5E5E5E;">=</span>legends,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">250</span>,<span class="dv" style="color: #AD0000;">200</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>One of the new features is that we can change the search order; this allows us to get the smallest molecules first (always a good idea with a substructure search).</p>
<p>Here we’re using the number of heavy atoms to set the search order:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">slib.SetSearchOrder(nat_order)</span>
<span id="cb7-2">mids <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry)</span>
<span id="cb7-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb7-4">ms <span class="op" style="color: #5E5E5E;">=</span> [slib.GetMolHolder().GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb7-5">legends <span class="op" style="color: #5E5E5E;">=</span> [slib.GetKeyHolder().GetKey(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb7-6">Draw.MolsToGridImage(ms,legends<span class="op" style="color: #5E5E5E;">=</span>legends,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">250</span>,<span class="dv" style="color: #AD0000;">200</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order_files/figure-html/cell-6-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>It’s important to note that we are not just sorting the results from the search here: we’re changing the order in which the search is done. So even though we’re only getting 1000 results (the default max number of results from the SubstructLibrary), we know that they are the 1000 smallest results.</p>
<p>So if we change the maximum number of results to three, we’ll get the same first three results:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">slib.SetSearchOrder(nat_order)</span>
<span id="cb9-2">mids2 <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb9-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids2)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb9-4">ms <span class="op" style="color: #5E5E5E;">=</span> [slib.GetMolHolder().GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids2[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb9-5">legends <span class="op" style="color: #5E5E5E;">=</span> [slib.GetKeyHolder().GetKey(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids2[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb9-6">Draw.MolsToGridImage(ms,legends<span class="op" style="color: #5E5E5E;">=</span>legends,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">250</span>,<span class="dv" style="color: #AD0000;">200</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can also use the search order to limit the compounds we search. In this case I’m going to refine the results of the previous search and identify compounds which also contain Br:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">slib.SetSearchOrder(mids)</span>
<span id="cb11-2">mids_new <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(Chem.MolFromSmarts(<span class="st" style="color: #20794D;">'[Br]'</span>))</span>
<span id="cb11-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids_new)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> sub-results'</span>)</span>
<span id="cb11-4">ms <span class="op" style="color: #5E5E5E;">=</span> [slib.GetMolHolder().GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids_new[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb11-5">legends <span class="op" style="color: #5E5E5E;">=</span> [slib.GetKeyHolder().GetKey(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mids_new[:<span class="dv" style="color: #AD0000;">9</span>]]</span>
<span id="cb11-6">Draw.MolsToGridImage(ms,legends<span class="op" style="color: #5E5E5E;">=</span>legends,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">250</span>,<span class="dv" style="color: #AD0000;">200</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>66 sub-results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Notice that the results are still coming back sorted by the number of heavy atoms. That’s because the IDs of the molecules being used for the search search is sorted.</p>
<p>We almost certainly ran up against the default limit on the number of results (1000 compounds) when doing the first search. Let’s loosen that to 50K. This will take longer since the first query ends up having to run through the entire database.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">slib.SetSearchOrder(nat_order)</span>
<span id="cb13-2">mids <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">50000</span>)</span>
<span id="cb13-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb13-4"></span>
<span id="cb13-5">slib.SetSearchOrder(mids)</span>
<span id="cb13-6">mids_new <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(Chem.MolFromSmarts(<span class="st" style="color: #20794D;">'[Br]'</span>))</span>
<span id="cb13-7"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mids_new)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> sub-results'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>17764 results
919 sub-results</code></pre>
</div>
</div>
<p>It’s never a bad idea to check the performance of these queries.</p>
<p>Here’s the run time for the default value of <code>maxResults</code>:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">slib.SetSearchOrder(nat_order)</span>
<span id="cb15-2"><span class="op" style="color: #5E5E5E;">%</span>timeit mids <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>71.7 ms ± 710 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<p>And here’s the search time for going through the entire database (we only get 17K results here, so maxResults=50K corresponds to searching through the entire database):</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">slib.SetSearchOrder(nat_order)</span>
<span id="cb17-2"><span class="op" style="color: #5E5E5E;">%</span>timeit mids <span class="op" style="color: #5E5E5E;">=</span> slib.GetMatches(qry,maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">50000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5.09 s ± 79.4 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>



 ]]></description>
  <category>tutorial</category>
  <category>substructure</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order.html</guid>
  <pubDate>Sun, 19 Dec 2021 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/substructlib-search-order-1.png" medium="image" type="image/png" height="110" width="144"/>
</item>
<item>
  <title>Using single-molecule reactions</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions.html</link>
  <description><![CDATA[ 



<p>This short post was inspired by a recent question on the RDKit-discuss mailing list: https://www.mail-archive.com/rdkit-discuss@lists.sourceforge.net/msg10905.html</p>
<p>The idea is to provide a quick introduction to a piece of chemical reaction functionality which was added to the 2021.09 RDKit release.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdChemReactions</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-6"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021.09.3</code></pre>
</div>
</div>
<p>This was the molecule that Lewis asked about.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'COC(=O)C1=C(C=CC=C1)C1=CC=C(C[N+]#[N]=[N-])C=C1'</span>,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb3-2">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-3-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The RDKit won’t accept this with default settings because there’s an odd representation of an azide group which includes a five-valent neutral nitrogen.</p>
<p>It’s straight forward to define a reaction which can convert this odd azide form to the more normal variant:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">tf1 <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;">'[#6:1]-[N+:2]#[N:3]=[N-:4]&gt;&gt;[#6:1]-[N+0:2]=[N+1:3]=[N-:4]'</span>)</span>
<span id="cb4-2">tf1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The usual way to use this would be with the <code>RunReactants()</code> method, which returns a list of lists of new molecules. In this case though, we have a reaction which operates on a single reactant and has a single product, so we can take advantage of the new <code>RunReactantInPlace()</code> method.</p>
<p>As the method name implies, this modifies the reactant molecule in place instead of creating new molecules which are returned as products:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">tf1.RunReactantInPlace(m1)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;"># now sanitize the molecule so that we do chemistry perception and can get decent drawings:</span></span>
<span id="cb5-4">Chem.SanitizeMol(m1)</span>
<span id="cb5-5">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It’s important to note that his only modifies one match at a time, so if we have multiple functional groups which need to be modified, we’ll need to call <code>RunReactantInPlace()</code> multiple times.</p>
<p>Here’s a demonstration of that using a molecule which has two of these weird azide constructions</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'c1cc([N+]#[N]=[N-])ccc1[N+]#[N]=[N-]'</span>,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb6-2">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The first application of <code>RunReactantInPlace()</code> changes one of the groups:</p>
<div class="cell" data-scrolled="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">tf1.RunReactantInPlace(m1)</span>
<span id="cb7-2">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>If we call <code>RunReactantInPlace()</code> again, the second occurance is replaced:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">tf1.RunReactantInPlace(m1)</span>
<span id="cb8-2">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>RunReactantInPlace()</code> makes it easy to know when to stop because it returns a boolean letting you know whether or not the molecule was modified. So in this case we’ll get false:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">tf1.RunReactantInPlace(m1)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>False</code></pre>
</div>
</div>
<p>This makes it easy to do all the transformations to a molecule with a while loop:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'c1cc([N+]#[N]=[N-])ccc1[N+]#[N]=[N-]'</span>,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;">while</span> tf1.RunReactantInPlace(m1):</span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;">pass</span></span>
<span id="cb11-4">Chem.SanitizeMol(m1)</span>
<span id="cb11-5">m1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>RunReactantInPlace()</code> is limited, it can only be used with reactions which only have one reactant and product and which do not add atoms in the product.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">tf2 <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;">'[#6:1]-[NH2:2]&gt;&gt;[#6:1]-[NH2:2]C'</span>)</span>
<span id="cb12-2">tmp <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'CCN'</span>)</span>
<span id="cb12-3">tf2.RunReactantInPlace(tmp)</span></code></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: ChemicalParserException: single component reactions which add atoms in the product are not supported</code></pre>
</div>
</div>
<p>Note that it can be used with reactions which remove atoms:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">tf2 <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;">'[#6:1]-[NH2:2]&gt;&gt;[#6:1]'</span>)</span>
<span id="cb14-2">tmp <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'CCN'</span>)</span>
<span id="cb14-3">tf2.RunReactantInPlace(tmp)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">tmp</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Aside from being easier to use when working with this simple transformations, it’s worth pointing out that <code>RunReactantInPlace()</code> is significantly faster than using <code>RunReactants()</code> with the same reaction:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'COC(=O)C1=C(C=CC=C1)C1=CC=C(C[N+]#[N]=[N-])C=C1'</span>,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb17-2"><span class="op" style="color: #5E5E5E;">%</span>timeit tf1.RunReactantInPlace(Chem.Mol(m1))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9.93 µs ± 125 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">m1 <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'COC(=O)C1=C(C=CC=C1)C1=CC=C(C[N+]#[N]=[N-])C=C1'</span>,sanitize<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb19-2"><span class="op" style="color: #5E5E5E;">%</span>timeit tf1.RunReactants((Chem.Mol(m1),))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>22.6 µs ± 81.2 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)</code></pre>
</div>
</div>



 ]]></description>
  <category>tutorial</category>
  <category>reactions</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-12-15-single-molecule-reactions.html</guid>
  <pubDate>Tue, 14 Dec 2021 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/single-molecule-reactions1.png" medium="image" type="image/png" height="48" width="144"/>
</item>
<item>
  <title>Highlighting changing atoms and bonds in reactions</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions.html</link>
  <description><![CDATA[ 



<p>A while ago there was a <a href="https://twitter.com/GeorgeK_86/status/1425807309700276227">question on Twitter</a> about highlighting the bonds which changed in a reaction. I put together a quick bit of example code to answer that question and made a note to do a blog post on the topic. I’m finally getting around to doing that blog post.</p>
<p>Fair warning: This one is heavy on code and light on words. :-)</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdChemReactions</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-6"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021.09.2</code></pre>
</div>
</div>
<p>Here’s something similar to the reaction from the question:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">rxn1 <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromRxnBlock(<span class="st" style="color: #20794D;">'''$RXN</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="st" style="color: #20794D;">      Mrv2102  111820212128</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="st" style="color: #20794D;">  2  1</span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;">$MOL</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="st" style="color: #20794D;">  Mrv2102 11182121282D          </span></span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="st" style="color: #20794D;"> 13 13  0  0  0  0            999 V2000</span></span>
<span id="cb3-11"><span class="st" style="color: #20794D;">   -7.5723    2.6505    0.0000 C   0  0  0  0  0  0  0  0  0  1  0  0</span></span>
<span id="cb3-12"><span class="st" style="color: #20794D;">   -6.8579    2.2380    0.0000 O   0  0  0  0  0  0  0  0  0  2  0  0</span></span>
<span id="cb3-13"><span class="st" style="color: #20794D;">   -6.8580    1.4130    0.0000 C   0  0  0  0  0  0  0  0  0  3  0  0</span></span>
<span id="cb3-14"><span class="st" style="color: #20794D;">   -6.1435    1.0004    0.0000 O   0  0  0  0  0  0  0  0  0  4  0  0</span></span>
<span id="cb3-15"><span class="st" style="color: #20794D;">   -7.5725    1.0005    0.0000 C   0  0  0  0  0  0  0  0  0  5  0  0</span></span>
<span id="cb3-16"><span class="st" style="color: #20794D;">   -7.5725    0.1755    0.0000 N   0  0  0  0  0  0  0  0  0  6  0  0</span></span>
<span id="cb3-17"><span class="st" style="color: #20794D;">   -8.2869   -0.2369    0.0000 C   0  0  0  0  0  0  0  0  0  7  0  0</span></span>
<span id="cb3-18"><span class="st" style="color: #20794D;">   -8.2870   -1.0620    0.0000 C   0  0  0  0  0  0  0  0  0  8  0  0</span></span>
<span id="cb3-19"><span class="st" style="color: #20794D;">   -9.0015   -1.4745    0.0000 C   0  0  0  0  0  0  0  0  0  9  0  0</span></span>
<span id="cb3-20"><span class="st" style="color: #20794D;">   -9.0015   -2.2995    0.0000 C   0  0  0  0  0  0  0  0  0 10  0  0</span></span>
<span id="cb3-21"><span class="st" style="color: #20794D;">   -8.2870   -2.7120    0.0000 C   0  0  0  0  0  0  0  0  0 11  0  0</span></span>
<span id="cb3-22"><span class="st" style="color: #20794D;">   -7.5726   -2.2995    0.0000 C   0  0  0  0  0  0  0  0  0 12  0  0</span></span>
<span id="cb3-23"><span class="st" style="color: #20794D;">   -7.5726   -1.4745    0.0000 C   0  0  0  0  0  0  0  0  0 13  0  0</span></span>
<span id="cb3-24"><span class="st" style="color: #20794D;">  1  2  1  0  0  0  0</span></span>
<span id="cb3-25"><span class="st" style="color: #20794D;">  2  3  1  0  0  0  0</span></span>
<span id="cb3-26"><span class="st" style="color: #20794D;">  3  4  2  0  0  0  0</span></span>
<span id="cb3-27"><span class="st" style="color: #20794D;">  3  5  1  0  0  0  0</span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;">  5  6  1  0  0  0  0</span></span>
<span id="cb3-29"><span class="st" style="color: #20794D;">  6  7  2  0  0  0  0</span></span>
<span id="cb3-30"><span class="st" style="color: #20794D;">  7  8  1  0  0  0  0</span></span>
<span id="cb3-31"><span class="st" style="color: #20794D;">  8  9  1  0  0  0  0</span></span>
<span id="cb3-32"><span class="st" style="color: #20794D;">  8 13  2  0  0  0  0</span></span>
<span id="cb3-33"><span class="st" style="color: #20794D;">  9 10  2  0  0  0  0</span></span>
<span id="cb3-34"><span class="st" style="color: #20794D;"> 10 11  1  0  0  0  0</span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;"> 11 12  2  0  0  0  0</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;"> 12 13  1  0  0  0  0</span></span>
<span id="cb3-37"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb3-38"><span class="st" style="color: #20794D;">$MOL</span></span>
<span id="cb3-39"></span>
<span id="cb3-40"><span class="st" style="color: #20794D;">  Mrv2102 11182121282D          </span></span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="st" style="color: #20794D;"> 12 11  0  0  0  0            999 V2000</span></span>
<span id="cb3-43"><span class="st" style="color: #20794D;">   -3.7934    0.7703    0.0000 C   0  0  0  0  0  0  0  0  0 14  0  0</span></span>
<span id="cb3-44"><span class="st" style="color: #20794D;">   -3.0790    1.1828    0.0000 C   0  0  0  0  0  0  0  0  0 15  0  0</span></span>
<span id="cb3-45"><span class="st" style="color: #20794D;">   -2.3645    0.7703    0.0000 C   0  0  0  0  0  0  0  0  0 16  0  0</span></span>
<span id="cb3-46"><span class="st" style="color: #20794D;">   -3.7934   -0.0547    0.0000 C   0  0  0  0  0  0  0  0  0 17  0  0</span></span>
<span id="cb3-47"><span class="st" style="color: #20794D;">   -4.5078   -0.4672    0.0000 O   0  0  0  0  0  0  0  0  0 18  0  0</span></span>
<span id="cb3-48"><span class="st" style="color: #20794D;">   -3.0789   -0.4671    0.0000 O   0  0  0  0  0  0  0  0  0 19  0  0</span></span>
<span id="cb3-49"><span class="st" style="color: #20794D;">   -1.6500    1.1828    0.0000 O   0  0  0  0  0  0  0  0  0 20  0  0</span></span>
<span id="cb3-50"><span class="st" style="color: #20794D;">   -2.3645   -0.0547    0.0000 O   0  0  0  0  0  0  0  0  0 21  0  0</span></span>
<span id="cb3-51"><span class="st" style="color: #20794D;">   -3.0788   -1.2922    0.0000 C   0  0  0  0  0  0  0  0  0 22  0  0</span></span>
<span id="cb3-52"><span class="st" style="color: #20794D;">   -1.6500   -0.4672    0.0000 C   0  0  0  0  0  0  0  0  0 23  0  0</span></span>
<span id="cb3-53"><span class="st" style="color: #20794D;">   -2.3644   -1.7046    0.0000 C   0  0  0  0  0  0  0  0  0 24  0  0</span></span>
<span id="cb3-54"><span class="st" style="color: #20794D;">   -1.6500   -1.2922    0.0000 C   0  0  0  0  0  0  0  0  0 25  0  0</span></span>
<span id="cb3-55"><span class="st" style="color: #20794D;">  1  2  2  0  0  0  0</span></span>
<span id="cb3-56"><span class="st" style="color: #20794D;">  1  4  1  0  0  0  0</span></span>
<span id="cb3-57"><span class="st" style="color: #20794D;">  2  3  1  0  0  0  0</span></span>
<span id="cb3-58"><span class="st" style="color: #20794D;">  3  7  2  0  0  0  0</span></span>
<span id="cb3-59"><span class="st" style="color: #20794D;">  3  8  1  0  0  0  0</span></span>
<span id="cb3-60"><span class="st" style="color: #20794D;">  4  5  2  0  0  0  0</span></span>
<span id="cb3-61"><span class="st" style="color: #20794D;">  4  6  1  0  0  0  0</span></span>
<span id="cb3-62"><span class="st" style="color: #20794D;">  6  9  1  0  0  0  0</span></span>
<span id="cb3-63"><span class="st" style="color: #20794D;">  8 10  1  0  0  0  0</span></span>
<span id="cb3-64"><span class="st" style="color: #20794D;">  9 11  1  0  0  0  0</span></span>
<span id="cb3-65"><span class="st" style="color: #20794D;"> 10 12  1  0  0  0  0</span></span>
<span id="cb3-66"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb3-67"><span class="st" style="color: #20794D;">$MOL</span></span>
<span id="cb3-68"></span>
<span id="cb3-69"><span class="st" style="color: #20794D;">  Mrv2102 11182121282D          </span></span>
<span id="cb3-70"></span>
<span id="cb3-71"><span class="st" style="color: #20794D;"> 25 26  0  0  0  0            999 V2000</span></span>
<span id="cb3-72"><span class="st" style="color: #20794D;">    5.1328    0.9532    0.0000 C   0  0  0  0  0  0  0  0  0  5  0  0</span></span>
<span id="cb3-73"><span class="st" style="color: #20794D;">    5.8002    0.4683    0.0000 N   0  0  0  0  0  0  0  0  0  6  0  0</span></span>
<span id="cb3-74"><span class="st" style="color: #20794D;">    5.5453   -0.3163    0.0000 C   0  0  0  0  0  0  0  0  0  7  0  0</span></span>
<span id="cb3-75"><span class="st" style="color: #20794D;">    4.7203   -0.3163    0.0000 C   0  0  0  0  0  0  0  0  0 14  0  0</span></span>
<span id="cb3-76"><span class="st" style="color: #20794D;">    4.4654    0.4683    0.0000 C   0  0  0  0  0  0  0  0  0 15  0  0</span></span>
<span id="cb3-77"><span class="st" style="color: #20794D;">    5.1328    1.7782    0.0000 C   0  0  0  0  0  0  0  0  0  3  0  0</span></span>
<span id="cb3-78"><span class="st" style="color: #20794D;">    3.6807    0.7232    0.0000 C   0  0  0  0  0  0  0  0  0 16  0  0</span></span>
<span id="cb3-79"><span class="st" style="color: #20794D;">    4.2354   -0.9838    0.0000 C   0  0  0  0  0  0  0  0  0 17  0  0</span></span>
<span id="cb3-80"><span class="st" style="color: #20794D;">    6.0302   -0.9838    0.0000 C   0  0  0  0  0  0  0  0  0  8  0  0</span></span>
<span id="cb3-81"><span class="st" style="color: #20794D;">    6.8507   -0.8975    0.0000 C   0  0  0  0  0  0  0  0  0  9  0  0</span></span>
<span id="cb3-82"><span class="st" style="color: #20794D;">    7.3356   -1.5650    0.0000 C   0  0  0  0  0  0  0  0  0 10  0  0</span></span>
<span id="cb3-83"><span class="st" style="color: #20794D;">    7.0001   -2.3187    0.0000 C   0  0  0  0  0  0  0  0  0 11  0  0</span></span>
<span id="cb3-84"><span class="st" style="color: #20794D;">    6.1796   -2.4049    0.0000 C   0  0  0  0  0  0  0  0  0 12  0  0</span></span>
<span id="cb3-85"><span class="st" style="color: #20794D;">    5.6947   -1.7375    0.0000 C   0  0  0  0  0  0  0  0  0 13  0  0</span></span>
<span id="cb3-86"><span class="st" style="color: #20794D;">    3.4149   -0.8975    0.0000 O   0  0  0  0  0  0  0  0  0 18  0  0</span></span>
<span id="cb3-87"><span class="st" style="color: #20794D;">    4.5709   -1.7375    0.0000 O   0  0  0  0  0  0  0  0  0 19  0  0</span></span>
<span id="cb3-88"><span class="st" style="color: #20794D;">    4.0860   -2.4049    0.0000 C   0  0  0  0  0  0  0  0  0 22  0  0</span></span>
<span id="cb3-89"><span class="st" style="color: #20794D;">    3.2655   -2.3187    0.0000 C   0  0  0  0  0  0  0  0  0 24  0  0</span></span>
<span id="cb3-90"><span class="st" style="color: #20794D;">    3.5092    1.5302    0.0000 O   0  0  0  0  0  0  0  0  0 20  0  0</span></span>
<span id="cb3-91"><span class="st" style="color: #20794D;">    3.0676    0.1712    0.0000 O   0  0  0  0  0  0  0  0  0 21  0  0</span></span>
<span id="cb3-92"><span class="st" style="color: #20794D;">    2.2830    0.4261    0.0000 C   0  0  0  0  0  0  0  0  0 23  0  0</span></span>
<span id="cb3-93"><span class="st" style="color: #20794D;">    1.6699   -0.1259    0.0000 C   0  0  0  0  0  0  0  0  0 25  0  0</span></span>
<span id="cb3-94"><span class="st" style="color: #20794D;">    5.8473    2.1907    0.0000 O   0  0  0  0  0  0  0  0  0  4  0  0</span></span>
<span id="cb3-95"><span class="st" style="color: #20794D;">    4.4183    2.1907    0.0000 O   0  0  0  0  0  0  0  0  0  2  0  0</span></span>
<span id="cb3-96"><span class="st" style="color: #20794D;">    4.4183    3.0157    0.0000 C   0  0  0  0  0  0  0  0  0  1  0  0</span></span>
<span id="cb3-97"><span class="st" style="color: #20794D;">  1  2  1  0  0  0  0</span></span>
<span id="cb3-98"><span class="st" style="color: #20794D;">  2  3  1  0  0  0  0</span></span>
<span id="cb3-99"><span class="st" style="color: #20794D;">  3  4  1  0  0  0  0</span></span>
<span id="cb3-100"><span class="st" style="color: #20794D;">  4  5  1  0  0  0  0</span></span>
<span id="cb3-101"><span class="st" style="color: #20794D;">  1  5  1  0  0  0  0</span></span>
<span id="cb3-102"><span class="st" style="color: #20794D;">  1  6  1  0  0  0  0</span></span>
<span id="cb3-103"><span class="st" style="color: #20794D;">  5  7  1  0  0  0  0</span></span>
<span id="cb3-104"><span class="st" style="color: #20794D;">  4  8  1  0  0  0  0</span></span>
<span id="cb3-105"><span class="st" style="color: #20794D;">  3  9  1  0  0  0  0</span></span>
<span id="cb3-106"><span class="st" style="color: #20794D;"> 10 11  2  0  0  0  0</span></span>
<span id="cb3-107"><span class="st" style="color: #20794D;"> 11 12  1  0  0  0  0</span></span>
<span id="cb3-108"><span class="st" style="color: #20794D;"> 12 13  2  0  0  0  0</span></span>
<span id="cb3-109"><span class="st" style="color: #20794D;"> 13 14  1  0  0  0  0</span></span>
<span id="cb3-110"><span class="st" style="color: #20794D;">  9 10  1  0  0  0  0</span></span>
<span id="cb3-111"><span class="st" style="color: #20794D;">  9 14  2  0  0  0  0</span></span>
<span id="cb3-112"><span class="st" style="color: #20794D;">  8 15  2  0  0  0  0</span></span>
<span id="cb3-113"><span class="st" style="color: #20794D;">  8 16  1  0  0  0  0</span></span>
<span id="cb3-114"><span class="st" style="color: #20794D;"> 16 17  1  0  0  0  0</span></span>
<span id="cb3-115"><span class="st" style="color: #20794D;"> 17 18  1  0  0  0  0</span></span>
<span id="cb3-116"><span class="st" style="color: #20794D;">  7 19  2  0  0  0  0</span></span>
<span id="cb3-117"><span class="st" style="color: #20794D;">  7 20  1  0  0  0  0</span></span>
<span id="cb3-118"><span class="st" style="color: #20794D;"> 20 21  1  0  0  0  0</span></span>
<span id="cb3-119"><span class="st" style="color: #20794D;"> 21 22  1  0  0  0  0</span></span>
<span id="cb3-120"><span class="st" style="color: #20794D;">  6 23  2  0  0  0  0</span></span>
<span id="cb3-121"><span class="st" style="color: #20794D;">  6 24  1  0  0  0  0</span></span>
<span id="cb3-122"><span class="st" style="color: #20794D;"> 24 25  1  0  0  0  0</span></span>
<span id="cb3-123"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb3-124"><span class="st" style="color: #20794D;">'''</span>)</span></code></pre></div>
</div>
<p>Let’s take a look at the reaction:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;">=</span> (<span class="dv" style="color: #AD0000;">600</span>,<span class="dv" style="color: #AD0000;">250</span>)</span>
<span id="cb4-2">IPythonConsole.highlightByReactant <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb4-3">rxn1</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can ask the reaction to tell us which atoms in the reactants are modified in the reaction:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">rxn1.Initialize()</span>
<span id="cb5-2">rxn1.GetReactingAtoms()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>((4, 5, 6), (0, 1))</code></pre>
</div>
</div>
<p>The information about which atoms react is enough to figure out which bonds change, but we have to do some additional work for this:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> namedtuple</span>
<span id="cb7-2">AtomInfo <span class="op" style="color: #5E5E5E;">=</span> namedtuple(<span class="st" style="color: #20794D;">'AtomInfo'</span>,(<span class="st" style="color: #20794D;">'mapnum'</span>,<span class="st" style="color: #20794D;">'reactant'</span>,<span class="st" style="color: #20794D;">'reactantAtom'</span>,<span class="st" style="color: #20794D;">'product'</span>,<span class="st" style="color: #20794D;">'productAtom'</span>))</span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;">def</span> map_reacting_atoms_to_products(rxn,reactingAtoms):</span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;">''' figures out which atoms in the products each mapped atom in the reactants maps to '''</span></span>
<span id="cb7-5">    res <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;">for</span> ridx,reacting <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(reactingAtoms):</span>
<span id="cb7-7">        reactant <span class="op" style="color: #5E5E5E;">=</span> rxn.GetReactantTemplate(ridx)</span>
<span id="cb7-8">        <span class="cf" style="color: #003B4F;">for</span> raidx <span class="kw" style="color: #003B4F;">in</span> reacting:</span>
<span id="cb7-9">            mapnum <span class="op" style="color: #5E5E5E;">=</span> reactant.GetAtomWithIdx(raidx).GetAtomMapNum()</span>
<span id="cb7-10">            foundit<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span></span>
<span id="cb7-11">            <span class="cf" style="color: #003B4F;">for</span> pidx,product <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(rxn.GetProducts()):</span>
<span id="cb7-12">                <span class="cf" style="color: #003B4F;">for</span> paidx,patom <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(product.GetAtoms()):</span>
<span id="cb7-13">                    <span class="cf" style="color: #003B4F;">if</span> patom.GetAtomMapNum()<span class="op" style="color: #5E5E5E;">==</span>mapnum:</span>
<span id="cb7-14">                        res.append(AtomInfo(mapnum,ridx,raidx,pidx,paidx))</span>
<span id="cb7-15">                        foundit <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb7-16">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb7-17">                    <span class="cf" style="color: #003B4F;">if</span> foundit:</span>
<span id="cb7-18">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb7-19">    <span class="cf" style="color: #003B4F;">return</span> res</span>
<span id="cb7-20"><span class="kw" style="color: #003B4F;">def</span> get_mapped_neighbors(atom):</span>
<span id="cb7-21">    <span class="co" style="color: #5E5E5E;">''' test all mapped neighbors of a mapped atom'''</span></span>
<span id="cb7-22">    res <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb7-23">    amap <span class="op" style="color: #5E5E5E;">=</span> atom.GetAtomMapNum()</span>
<span id="cb7-24">    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> amap:</span>
<span id="cb7-25">        <span class="cf" style="color: #003B4F;">return</span> res</span>
<span id="cb7-26">    <span class="cf" style="color: #003B4F;">for</span> nbr <span class="kw" style="color: #003B4F;">in</span> atom.GetNeighbors():</span>
<span id="cb7-27">        nmap <span class="op" style="color: #5E5E5E;">=</span> nbr.GetAtomMapNum()</span>
<span id="cb7-28">        <span class="cf" style="color: #003B4F;">if</span> nmap:</span>
<span id="cb7-29">            <span class="cf" style="color: #003B4F;">if</span> amap<span class="op" style="color: #5E5E5E;">&gt;</span>nmap:</span>
<span id="cb7-30">                res[(nmap,amap)] <span class="op" style="color: #5E5E5E;">=</span> (atom.GetIdx(),nbr.GetIdx())</span>
<span id="cb7-31">            <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb7-32">                res[(amap,nmap)] <span class="op" style="color: #5E5E5E;">=</span> (nbr.GetIdx(),atom.GetIdx())</span>
<span id="cb7-33">    <span class="cf" style="color: #003B4F;">return</span> res</span>
<span id="cb7-34"></span>
<span id="cb7-35">BondInfo <span class="op" style="color: #5E5E5E;">=</span> namedtuple(<span class="st" style="color: #20794D;">'BondInfo'</span>,(<span class="st" style="color: #20794D;">'product'</span>,<span class="st" style="color: #20794D;">'productAtoms'</span>,<span class="st" style="color: #20794D;">'productBond'</span>,<span class="st" style="color: #20794D;">'status'</span>))</span>
<span id="cb7-36"><span class="kw" style="color: #003B4F;">def</span> find_modifications_in_products(rxn):</span>
<span id="cb7-37">    <span class="co" style="color: #5E5E5E;">''' returns a 2-tuple with the modified atoms and bonds from the reaction '''</span></span>
<span id="cb7-38">    reactingAtoms <span class="op" style="color: #5E5E5E;">=</span> rxn.GetReactingAtoms()</span>
<span id="cb7-39">    amap <span class="op" style="color: #5E5E5E;">=</span> map_reacting_atoms_to_products(rxn,reactingAtoms)</span>
<span id="cb7-40">    res <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb7-41">    seen <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>()</span>
<span id="cb7-42">    <span class="co" style="color: #5E5E5E;"># this is all driven from the list of reacting atoms:</span></span>
<span id="cb7-43">    <span class="cf" style="color: #003B4F;">for</span> _,ridx,raidx,pidx,paidx <span class="kw" style="color: #003B4F;">in</span> amap:</span>
<span id="cb7-44">        reactant <span class="op" style="color: #5E5E5E;">=</span> rxn.GetReactantTemplate(ridx)</span>
<span id="cb7-45">        ratom <span class="op" style="color: #5E5E5E;">=</span> reactant.GetAtomWithIdx(raidx)</span>
<span id="cb7-46">        product <span class="op" style="color: #5E5E5E;">=</span> rxn.GetProductTemplate(pidx)</span>
<span id="cb7-47">        patom <span class="op" style="color: #5E5E5E;">=</span> product.GetAtomWithIdx(paidx)</span>
<span id="cb7-48"></span>
<span id="cb7-49">        rnbrs <span class="op" style="color: #5E5E5E;">=</span> get_mapped_neighbors(ratom)</span>
<span id="cb7-50">        pnbrs <span class="op" style="color: #5E5E5E;">=</span> get_mapped_neighbors(patom)</span>
<span id="cb7-51">        <span class="cf" style="color: #003B4F;">for</span> tpl <span class="kw" style="color: #003B4F;">in</span> pnbrs:</span>
<span id="cb7-52">            pbond <span class="op" style="color: #5E5E5E;">=</span> product.GetBondBetweenAtoms(<span class="op" style="color: #5E5E5E;">*</span>pnbrs[tpl])</span>
<span id="cb7-53">            <span class="cf" style="color: #003B4F;">if</span> (pidx,pbond.GetIdx()) <span class="kw" style="color: #003B4F;">in</span> seen:</span>
<span id="cb7-54">                <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb7-55">            seen.add((pidx,pbond.GetIdx()))</span>
<span id="cb7-56">            <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> tpl <span class="kw" style="color: #003B4F;">in</span> rnbrs:</span>
<span id="cb7-57">                <span class="co" style="color: #5E5E5E;"># new bond in product</span></span>
<span id="cb7-58">                res.append(BondInfo(pidx,pnbrs[tpl],pbond.GetIdx(),<span class="st" style="color: #20794D;">'New'</span>))</span>
<span id="cb7-59">            <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb7-60">                <span class="co" style="color: #5E5E5E;"># present in both reactants and products, check to see if it changed</span></span>
<span id="cb7-61">                rbond <span class="op" style="color: #5E5E5E;">=</span> reactant.GetBondBetweenAtoms(<span class="op" style="color: #5E5E5E;">*</span>rnbrs[tpl])</span>
<span id="cb7-62">                <span class="cf" style="color: #003B4F;">if</span> rbond.GetBondType()<span class="op" style="color: #5E5E5E;">!=</span>pbond.GetBondType():</span>
<span id="cb7-63">                    res.append(BondInfo(pidx,pnbrs[tpl],pbond.GetIdx(),<span class="st" style="color: #20794D;">'Changed'</span>))</span>
<span id="cb7-64">    <span class="cf" style="color: #003B4F;">return</span> amap,res</span></code></pre></div>
</div>
<p>Let’s look at what that function returns for our reaction:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">atms,bnds <span class="op" style="color: #5E5E5E;">=</span> find_modifications_in_products(rxn1)</span>
<span id="cb8-2"><span class="bu" style="color: null;">print</span>(atms)</span>
<span id="cb8-3"><span class="bu" style="color: null;">print</span>(bnds)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[AtomInfo(mapnum=5, reactant=0, reactantAtom=4, product=0, productAtom=0), AtomInfo(mapnum=6, reactant=0, reactantAtom=5, product=0, productAtom=1), AtomInfo(mapnum=7, reactant=0, reactantAtom=6, product=0, productAtom=2), AtomInfo(mapnum=14, reactant=1, reactantAtom=0, product=0, productAtom=3), AtomInfo(mapnum=15, reactant=1, reactantAtom=1, product=0, productAtom=4)]
[BondInfo(product=0, productAtoms=(4, 0), productBond=4, status='New'), BondInfo(product=0, productAtoms=(2, 1), productBond=1, status='Changed'), BondInfo(product=0, productAtoms=(3, 2), productBond=2, status='New'), BondInfo(product=0, productAtoms=(4, 3), productBond=3, status='Changed')]</code></pre>
</div>
</div>
<p>Finally, define the funciton which we’ll use to draw the product molecule with highlights shown for bonds and atoms involved in the reaction:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;">from</span> IPython.display <span class="im" style="color: #00769E;">import</span> Image</span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;">def</span> draw_product_with_modified_bonds(rxn,atms,bnds,productIdx<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>,showAtomMaps<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>):</span>
<span id="cb10-3">    <span class="cf" style="color: #003B4F;">if</span> productIdx <span class="kw" style="color: #003B4F;">is</span> <span class="va" style="color: #111111;">None</span>:</span>
<span id="cb10-4">        pcnts <span class="op" style="color: #5E5E5E;">=</span> [x.GetNumAtoms() <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> rxn.GetProducts()]</span>
<span id="cb10-5">        largestProduct <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(<span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(pcnts,<span class="bu" style="color: null;">range</span>(<span class="bu" style="color: null;">len</span>(pcnts))),reverse<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>))[<span class="dv" style="color: #AD0000;">0</span>][<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb10-6">        productIdx <span class="op" style="color: #5E5E5E;">=</span> largestProduct</span>
<span id="cb10-7">    d2d <span class="op" style="color: #5E5E5E;">=</span> Draw.rdMolDraw2D.MolDraw2DCairo(<span class="dv" style="color: #AD0000;">350</span>,<span class="dv" style="color: #AD0000;">300</span>)</span>
<span id="cb10-8">    pmol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(rxn.GetProductTemplate(productIdx))</span>
<span id="cb10-9">    Chem.SanitizeMol(pmol)</span>
<span id="cb10-10">    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> showAtomMaps:</span>
<span id="cb10-11">        <span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> pmol.GetAtoms():</span>
<span id="cb10-12">            atom.SetAtomMapNum(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb10-13">    bonds_to_highlight<span class="op" style="color: #5E5E5E;">=</span>[]</span>
<span id="cb10-14">    highlight_bond_colors<span class="op" style="color: #5E5E5E;">=</span>{}</span>
<span id="cb10-15">    atoms_seen <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>()</span>
<span id="cb10-16">    <span class="cf" style="color: #003B4F;">for</span> binfo <span class="kw" style="color: #003B4F;">in</span> bnds:</span>
<span id="cb10-17">        <span class="cf" style="color: #003B4F;">if</span> binfo.product<span class="op" style="color: #5E5E5E;">==</span>productIdx <span class="kw" style="color: #003B4F;">and</span> binfo.status<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'New'</span>:</span>
<span id="cb10-18">            bonds_to_highlight.append(binfo.productBond)</span>
<span id="cb10-19">            atoms_seen.update(binfo.productAtoms)</span>
<span id="cb10-20">            highlight_bond_colors[binfo.productBond] <span class="op" style="color: #5E5E5E;">=</span> (<span class="dv" style="color: #AD0000;">1</span>,<span class="fl" style="color: #AD0000;">.4</span>,<span class="fl" style="color: #AD0000;">.4</span>)</span>
<span id="cb10-21">        <span class="cf" style="color: #003B4F;">if</span> binfo.product<span class="op" style="color: #5E5E5E;">==</span>productIdx <span class="kw" style="color: #003B4F;">and</span> binfo.status<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Changed'</span>:</span>
<span id="cb10-22">            bonds_to_highlight.append(binfo.productBond)</span>
<span id="cb10-23">            atoms_seen.update(binfo.productAtoms)</span>
<span id="cb10-24">            highlight_bond_colors[binfo.productBond] <span class="op" style="color: #5E5E5E;">=</span> (<span class="fl" style="color: #AD0000;">.4</span>,<span class="fl" style="color: #AD0000;">.4</span>,<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-25">    atoms_to_highlight<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">set</span>()</span>
<span id="cb10-26">    <span class="cf" style="color: #003B4F;">for</span> ainfo <span class="kw" style="color: #003B4F;">in</span> atms:</span>
<span id="cb10-27">        <span class="cf" style="color: #003B4F;">if</span> ainfo.product <span class="op" style="color: #5E5E5E;">!=</span> productIdx <span class="kw" style="color: #003B4F;">or</span> ainfo.productAtom <span class="kw" style="color: #003B4F;">in</span> atoms_seen:</span>
<span id="cb10-28">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb10-29">        atoms_to_highlight.add(ainfo.productAtom)</span>
<span id="cb10-30"></span>
<span id="cb10-31">    d2d.drawOptions().useBWAtomPalette()</span>
<span id="cb10-32">    d2d.drawOptions().continuousHighlight<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span></span>
<span id="cb10-33">    d2d.drawOptions().highlightBondWidthMultiplier <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">24</span></span>
<span id="cb10-34">    d2d.drawOptions().setHighlightColour((<span class="fl" style="color: #AD0000;">.9</span>,<span class="fl" style="color: #AD0000;">.9</span>,<span class="dv" style="color: #AD0000;">0</span>))</span>
<span id="cb10-35">    d2d.drawOptions().fillHighlights<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span></span>
<span id="cb10-36">    atoms_to_highlight.update(atoms_seen)</span>
<span id="cb10-37">    d2d.DrawMolecule(pmol,highlightAtoms<span class="op" style="color: #5E5E5E;">=</span>atoms_to_highlight,highlightBonds<span class="op" style="color: #5E5E5E;">=</span>bonds_to_highlight,</span>
<span id="cb10-38">                     highlightBondColors<span class="op" style="color: #5E5E5E;">=</span>highlight_bond_colors)</span>
<span id="cb10-39">    d2d.FinishDrawing()</span>
<span id="cb10-40">    <span class="cf" style="color: #003B4F;">return</span> d2d.GetDrawingText()</span></code></pre></div>
</div>
<p>Now we can draw the highlighted product molecule:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">Image(draw_product_with_modified_bonds(rxn1,atms,bnds))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s look at some other reactions. I will use the SI data from</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb12-2">df <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">'../data/reaction_data_ci6b00564/dataSetB.csv'</span>)</span>
<span id="cb12-3">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>rxn_Class</th>
      <th>patentID</th>
      <th>rxnSmiles_Mapping_NameRxn</th>
      <th>reactantSet_NameRxn</th>
      <th>NameRxn_Mapping_Complete</th>
      <th>rxnSmiles_Mapping_IndigoTK</th>
      <th>reactantSet_IndigoTK</th>
      <th>IndigoTK_Mapping_Complete</th>
      <th>rxnSmiles_IndigoAutoMapperKNIME</th>
      <th>reactantSet_IndigoAutoMapperKNIME</th>
      <th>IndigoAutoMapperKNIME_Mapping_Complete</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>US05849732</td>
      <td>C.CCCCCC.CO.O=C(OCc1ccccc1)[NH:1][CH2:2][CH2:3...</td>
      <td>set([3, 4])</td>
      <td>True</td>
      <td>C(OC([NH:11][CH2:12][CH2:13][CH2:14][CH2:15][C...</td>
      <td>set([0, 2])</td>
      <td>True</td>
      <td>C.CCCCCC.CO.[CH3:10][O:11][C:12]([C@@H:14]([NH...</td>
      <td>set([3, 4])</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>US20120114765A1</td>
      <td>O[C:1](=[O:2])[c:3]1[cH:4][c:5]([N+:6](=[O:7])...</td>
      <td>set([0, 1])</td>
      <td>True</td>
      <td>[Cl:1][c:2]1[cH:3][n:4][cH:5][c:6]([Cl:20])[c:...</td>
      <td>set([0, 1])</td>
      <td>True</td>
      <td>[NH2:1][c:2]1[c:11]2[c:6]([cH:7][n:8][cH:9][cH...</td>
      <td>set([0, 1])</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>US08003648B2</td>
      <td>Cl.O=[CH:1][c:2]1[cH:3][cH:4][c:5](-[c:6]2[n:7...</td>
      <td>set([1, 3])</td>
      <td>True</td>
      <td>[CH2:1]([NH:3][CH2:4][CH3:5])[CH3:2].C([BH3-])...</td>
      <td>set([0, 3])</td>
      <td>True</td>
      <td>[CH3:1][CH2:2][NH:3][CH2:4][CH3:5].[CH3:6][c:7...</td>
      <td>set([0, 1])</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>US09045475B2</td>
      <td>CC(=O)O[BH-](OC(C)=O)OC(C)=O.ClCCl.O=[C:1]([CH...</td>
      <td>set([2, 3])</td>
      <td>True</td>
      <td>[nH:1]1[c:5]2[n:6][cH:7][c:8]([O:10][c:11]3[cH...</td>
      <td>set([0, 3])</td>
      <td>True</td>
      <td>CC(O[BH-](OC(=O)C)OC(=O)C)=O.[CH3:14][C:15]1([...</td>
      <td>set([1, 3])</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>US08188098B2</td>
      <td>CCN(C(C)C)C(C)C.ClCCl.Cl[C:1](=[O:2])[O:3][CH:...</td>
      <td>set([2, 5])</td>
      <td>True</td>
      <td>Cl[C:2]([O:4][CH:5]1[CH2:9][CH2:8][CH2:7][CH2:...</td>
      <td>set([0, 2])</td>
      <td>True</td>
      <td>CCN(C(C)C)C(C)C.[CH3:10][CH2:11][O:12][c:13]1[...</td>
      <td>set([1, 4])</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">rxnclass <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb13-2">class_smis <span class="op" style="color: #5E5E5E;">=</span> df[df[<span class="st" style="color: #20794D;">'rxn_Class'</span>]<span class="op" style="color: #5E5E5E;">==</span>rxnclass].rxnSmiles_Mapping_NameRxn.to_list()</span>
<span id="cb13-3">rxn <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(class_smis[<span class="dv" style="color: #AD0000;">3</span>],useSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb13-4">rxn.Initialize()</span>
<span id="cb13-5">atms,bnds <span class="op" style="color: #5E5E5E;">=</span> find_modifications_in_products(rxn)</span>
<span id="cb13-6"><span class="bu" style="color: null;">print</span>(atms)</span>
<span id="cb13-7"><span class="bu" style="color: null;">print</span>(bnds)</span>
<span id="cb13-8">Image(draw_product_with_modified_bonds(rxn,atms,bnds))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[AtomInfo(mapnum=1, reactant=3, reactantAtom=1, product=0, productAtom=0), AtomInfo(mapnum=7, reactant=4, reactantAtom=0, product=0, productAtom=6)]
[BondInfo(product=0, productAtoms=(6, 0), productBond=5, status='New')]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">rxnclass <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb15-2">class_smis <span class="op" style="color: #5E5E5E;">=</span> df[df[<span class="st" style="color: #20794D;">'rxn_Class'</span>]<span class="op" style="color: #5E5E5E;">==</span>rxnclass].rxnSmiles_Mapping_NameRxn.to_list()</span>
<span id="cb15-3">rxn <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(class_smis[<span class="dv" style="color: #AD0000;">1</span>],useSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb15-4">rxn.Initialize()</span>
<span id="cb15-5">atms,bnds <span class="op" style="color: #5E5E5E;">=</span> find_modifications_in_products(rxn)</span>
<span id="cb15-6"><span class="bu" style="color: null;">print</span>(atms)</span>
<span id="cb15-7"><span class="bu" style="color: null;">print</span>(bnds)</span>
<span id="cb15-8">Image(draw_product_with_modified_bonds(rxn,atms,bnds))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[AtomInfo(mapnum=1, reactant=1, reactantAtom=1, product=0, productAtom=0), AtomInfo(mapnum=2, reactant=1, reactantAtom=2, product=0, productAtom=9), AtomInfo(mapnum=16, reactant=2, reactantAtom=0, product=0, productAtom=18), AtomInfo(mapnum=17, reactant=2, reactantAtom=1, product=0, productAtom=16), AtomInfo(mapnum=19, reactant=2, reactantAtom=3, product=0, productAtom=15)]
[BondInfo(product=0, productAtoms=(9, 0), productBond=8, status='Changed'), BondInfo(product=0, productAtoms=(18, 0), productBond=18, status='New'), BondInfo(product=0, productAtoms=(15, 9), productBond=14, status='New'), BondInfo(product=0, productAtoms=(16, 18), productBond=17, status='Changed'), BondInfo(product=0, productAtoms=(15, 16), productBond=15, status='Changed')]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Look at an example where there are no changed bonds in the products but where there is a changed atom:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">rxnclass <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">7</span></span>
<span id="cb17-2">class_smis <span class="op" style="color: #5E5E5E;">=</span> df[df[<span class="st" style="color: #20794D;">'rxn_Class'</span>]<span class="op" style="color: #5E5E5E;">==</span>rxnclass].rxnSmiles_Mapping_NameRxn.to_list()</span>
<span id="cb17-3">rxn <span class="op" style="color: #5E5E5E;">=</span> rdChemReactions.ReactionFromSmarts(class_smis[<span class="dv" style="color: #AD0000;">1</span>],useSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span>
<span id="cb17-4">rxn.Initialize()</span>
<span id="cb17-5">atms,bnds <span class="op" style="color: #5E5E5E;">=</span> find_modifications_in_products(rxn)</span>
<span id="cb17-6"><span class="bu" style="color: null;">print</span>(atms)</span>
<span id="cb17-7"><span class="bu" style="color: null;">print</span>(bnds)</span>
<span id="cb17-8">Image(draw_product_with_modified_bonds(rxn,atms,bnds))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[AtomInfo(mapnum=1, reactant=1, reactantAtom=1, product=0, productAtom=0)]
[]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions_files/figure-html/cell-13-output-2.png" class="img-fluid"></p>
</div>
</div>



 ]]></description>
  <category>tutorial</category>
  <category>reactions</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-11-26-highlighting-changed-bonds-in-reactions.html</guid>
  <pubDate>Thu, 25 Nov 2021 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/highlighting-reactions-1.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>R-Group Decomposition and Highlighting</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting.html</link>
  <description><![CDATA[ 



<p>Note: This is a slightly updated version of a <a href="https://rdkit.blogspot.com/2020/10/molecule-highlighting-and-r-group.html">post from 2020</a></p>
<p>This one was inspired by a conversation that happened at the 2020 RDKit (virtual) UGM.</p>
<p>During Dominique Sydow’s presentation she showed some pictures of molecules with some regions of the molecule highlighted (in her case to indicate which kinase pocket they interact with). Dominique had created the images by hand, but I wanted to explore what’s possible using the 2020.09 RDKit release.</p>
<p>What this post is going to demonstrate is doing R-group decomposition (RGD) on a set of molecules that share a common scaffold, generating coordinates for those molecules that are aligned to the scaffold, and generating images of the molecules where the R groups are colored to make them easy to pick out.</p>
<p>The final images we create will look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/images/blog/rgd-and-highlighting1-1.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">rgd-and-highlighting1-1.png</figcaption><p></p>
</figure>
</div>
<p>The rest of this post will go through the steps to create images like this.</p>
<p>Let’s get started</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.molSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">450</span>,<span class="dv" style="color: #AD0000;">350</span>)</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdRGroupDecomposition</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdqueries</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> rdMolDraw2D</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Geometry</span>
<span id="cb1-10">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-11"><span class="im" style="color: #00769E;">import</span> pandas <span class="im" style="color: #00769E;">as</span> pd</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="im" style="color: #00769E;">from</span> IPython.display <span class="im" style="color: #00769E;">import</span> SVG,Image</span>
<span id="cb1-14"><span class="im" style="color: #00769E;">from</span> ipywidgets <span class="im" style="color: #00769E;">import</span> interact</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-17"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021.03.4</code></pre>
</div>
</div>
<p>Start by reading in the data we will use. This is a collection of ChEMBL compounds with Ki data measured for CDK2. The dataset includes compounds from a number of different documents and, since these are medchem papers, many of the documents contain groups of compounds that share a common scaffold.</p>
<div class="cell" data-scrolled="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">df <span class="op" style="color: #5E5E5E;">=</span> pd.read_csv(<span class="st" style="color: #20794D;">'../data/cdk2_rgd_dataset.csv'</span>)</span>
<span id="cb3-2">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>assay_id</th>
      <th>doc_id</th>
      <th>description</th>
      <th>assay_organism</th>
      <th>assay_chembl_id</th>
      <th>aidx</th>
      <th>pref_name</th>
      <th>activity_id</th>
      <th>molregno</th>
      <th>standard_relation</th>
      <th>...</th>
      <th>src_id (#1)</th>
      <th>type</th>
      <th>relation</th>
      <th>value</th>
      <th>units</th>
      <th>text_value</th>
      <th>standard_text_value</th>
      <th>standard_inchi_key</th>
      <th>canonical_smiles</th>
      <th>compound_chembl_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>265814</td>
      <td>68026</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>20.00</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>RPXWUUDZINQPTJ-UHFFFAOYSA-N</td>
      <td>CNc1nccc(n1)c2sc(C)nc2C</td>
      <td>CHEMBL46474</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>265817</td>
      <td>67880</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.14</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>GDZTURHUKDAJGD-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(Nc3ccc(O)cc3)n2</td>
      <td>CHEMBL442957</td>
    </tr>
    <tr>
      <th>2</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267078</td>
      <td>67751</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>6.50</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CTFDMGIBHFQWKB-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(N)n2</td>
      <td>CHEMBL47302</td>
    </tr>
    <tr>
      <th>3</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267081</td>
      <td>67782</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>1.20</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>HOKDXVAONYXHJK-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(Nc3ccccc3F)n2</td>
      <td>CHEMBL297447</td>
    </tr>
    <tr>
      <th>4</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267084</td>
      <td>67961</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.11</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>XNKSRGHGPSHYIW-UHFFFAOYSA-N</td>
      <td>CNc1nc(C)c(s1)c2ccnc(Nc3cccc(O)c3)n2</td>
      <td>CHEMBL44119</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<p>We pick a group of compounds by selecting all the rows with a given assay ID:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">df_doc1 <span class="op" style="color: #5E5E5E;">=</span> df[df.assay_chembl_id<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'CHEMBL827377'</span>]</span>
<span id="cb4-2"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(df_doc1))</span>
<span id="cb4-3">df_doc1.head()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>91</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>assay_id</th>
      <th>doc_id</th>
      <th>description</th>
      <th>assay_organism</th>
      <th>assay_chembl_id</th>
      <th>aidx</th>
      <th>pref_name</th>
      <th>activity_id</th>
      <th>molregno</th>
      <th>standard_relation</th>
      <th>...</th>
      <th>src_id (#1)</th>
      <th>type</th>
      <th>relation</th>
      <th>value</th>
      <th>units</th>
      <th>text_value</th>
      <th>standard_text_value</th>
      <th>standard_inchi_key</th>
      <th>canonical_smiles</th>
      <th>compound_chembl_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>47</th>
      <td>302524</td>
      <td>21080</td>
      <td>Binding affinity for human cyclin-dependent ki...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL827377</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>1438958</td>
      <td>305637</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>19.95</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>TWQUOUJLNRGSRZ-UHFFFAOYSA-N</td>
      <td>Cc1ccc2c(c3ccnc(Nc4cccc(c4)C(F)(F)F)n3)c(nn2n1...</td>
      <td>CHEMBL182493</td>
    </tr>
    <tr>
      <th>48</th>
      <td>302524</td>
      <td>21080</td>
      <td>Binding affinity for human cyclin-dependent ki...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL827377</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>1438962</td>
      <td>305651</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>19.95</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CYHPFZLFUXOCJJ-UHFFFAOYSA-N</td>
      <td>Cc1ccc2c(c3ccnc(Nc4ccc(F)c(F)c4)n3)c(nn2n1)c5c...</td>
      <td>CHEMBL182326</td>
    </tr>
    <tr>
      <th>49</th>
      <td>302524</td>
      <td>21080</td>
      <td>Binding affinity for human cyclin-dependent ki...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL827377</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>1439061</td>
      <td>305664</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>19.95</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>MYSOMHSTKVRJRA-UHFFFAOYSA-N</td>
      <td>Cc1ccc2c(c3ccnc(Nc4ccc5OCCOc5c4)n3)c(nn2n1)c6c...</td>
      <td>CHEMBL183064</td>
    </tr>
    <tr>
      <th>50</th>
      <td>302524</td>
      <td>21080</td>
      <td>Binding affinity for human cyclin-dependent ki...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL827377</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>1439063</td>
      <td>305674</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>19.95</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>VUGNSTAXWJUVEZ-UHFFFAOYSA-N</td>
      <td>Cc1ccc2c(c3ccnc(Nc4ccc(Cl)c(c4)C(F)(F)F)n3)c(n...</td>
      <td>CHEMBL361038</td>
    </tr>
    <tr>
      <th>51</th>
      <td>302524</td>
      <td>21080</td>
      <td>Binding affinity for human cyclin-dependent ki...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL827377</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>1439065</td>
      <td>305687</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>3.98</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>BWBMBCPGRIOUNV-UHFFFAOYSA-N</td>
      <td>C1CC1c2nn3ncccc3c2c4ccnc(Nc5ccccc5)n4</td>
      <td>CHEMBL362296</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<p>Look at some of the compounds:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb6-2">smis <span class="op" style="color: #5E5E5E;">=</span> df_doc1[<span class="st" style="color: #20794D;">'canonical_smiles'</span>]</span>
<span id="cb6-3">cids <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(df_doc1.compound_chembl_id)</span>
<span id="cb6-4">ms <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> smis]</span>
<span id="cb6-5"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb6-6">    rdDepictor.Compute2DCoords(m)</span>
<span id="cb6-7">Draw.MolsToGridImage(ms[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>cids,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Define a core. I’m doing this manually and am only specifically labeling four of the seven R-groups in this set of molecules. The others will be labelled automatically by the RGD code.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">core <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'c1cc(-c2c([*:1])nn3nc([*:2])ccc23)nc(N(c2ccc([*:4])c([*:3])c2))n1'</span>)</span>
<span id="cb7-2">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb7-3">rdDepictor.Compute2DCoords(core)</span>
<span id="cb7-4">core</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Some pre-processing work we need to do: - convert the dummy atoms in the scaffold into query atoms that match anything - add hydrogens to the molecules - select only the subset of molecules which match the core - set a property on each atom which is used to track its original index (we use this later in the RGD analysis)</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">ps <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryParameters.NoAdjustments()</span>
<span id="cb8-2">ps.makeDummiesQueries<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb8-3">qcore <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(core,ps)</span>
<span id="cb8-4">mhs <span class="op" style="color: #5E5E5E;">=</span> [Chem.AddHs(x,addCoords<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms]</span>
<span id="cb8-5">mms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mhs <span class="cf" style="color: #003B4F;">if</span> x.HasSubstructMatch(qcore)]</span>
<span id="cb8-6"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mms:</span>
<span id="cb8-7">    <span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> m.GetAtoms():</span>
<span id="cb8-8">        atom.SetIntProp(<span class="st" style="color: #20794D;">"SourceAtomIdx"</span>,atom.GetIdx())</span>
<span id="cb8-9"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(mhs),<span class="bu" style="color: null;">len</span>(mms))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>91 91</code></pre>
</div>
</div>
<p>Now do the actual RGD:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">rdkit.RDLogger.DisableLog(<span class="st" style="color: #20794D;">'rdApp.warning'</span>)</span>
<span id="cb10-2">groups,_ <span class="op" style="color: #5E5E5E;">=</span> rdRGroupDecomposition.RGroupDecompose([qcore],mms,asSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,asRows<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
</div>
<p>This is the function that actually does the work of generating aligned coordinates and creating the image with highlighted R groups</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> defaultdict</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;">def</span> highlight_rgroups(mol,row,core,width<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">350</span>,height<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">200</span>,</span>
<span id="cb11-4">                      fillRings<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,legend<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">""</span>,</span>
<span id="cb11-5">                      sourceIdxProperty<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">"SourceAtomIdx"</span>,</span>
<span id="cb11-6">                      lbls<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>,<span class="st" style="color: #20794D;">'R4'</span>)):</span>
<span id="cb11-7">    <span class="co" style="color: #5E5E5E;"># copy the molecule and core</span></span>
<span id="cb11-8">    mol <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(mol)</span>
<span id="cb11-9">    core <span class="op" style="color: #5E5E5E;">=</span> Chem.Mol(core)</span>
<span id="cb11-10"></span>
<span id="cb11-11">    <span class="co" style="color: #5E5E5E;"># -------------------------------------------</span></span>
<span id="cb11-12">    <span class="co" style="color: #5E5E5E;"># include the atom map numbers in the substructure search in order to </span></span>
<span id="cb11-13">    <span class="co" style="color: #5E5E5E;"># try to ensure a good alignment of the molecule to symmetric cores</span></span>
<span id="cb11-14">    <span class="cf" style="color: #003B4F;">for</span> at <span class="kw" style="color: #003B4F;">in</span> core.GetAtoms():</span>
<span id="cb11-15">        <span class="cf" style="color: #003B4F;">if</span> at.GetAtomMapNum():</span>
<span id="cb11-16">            at.ExpandQuery(rdqueries.IsotopeEqualsQueryAtom(<span class="dv" style="color: #AD0000;">200</span><span class="op" style="color: #5E5E5E;">+</span>at.GetAtomMapNum()))</span>
<span id="cb11-17">            </span>
<span id="cb11-18">    <span class="cf" style="color: #003B4F;">for</span> lbl <span class="kw" style="color: #003B4F;">in</span> row:</span>
<span id="cb11-19">        <span class="cf" style="color: #003B4F;">if</span> lbl<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Core'</span>:</span>
<span id="cb11-20">            <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb11-21">        rg <span class="op" style="color: #5E5E5E;">=</span> row[lbl]</span>
<span id="cb11-22">        <span class="cf" style="color: #003B4F;">for</span> at <span class="kw" style="color: #003B4F;">in</span> rg.GetAtoms():</span>
<span id="cb11-23">            <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> at.GetAtomicNum() <span class="kw" style="color: #003B4F;">and</span> at.GetAtomMapNum() <span class="kw" style="color: #003B4F;">and</span> <span class="op" style="color: #5E5E5E;">\</span></span>
<span id="cb11-24">            at.HasProp(<span class="st" style="color: #20794D;">'dummyLabel'</span>) <span class="kw" style="color: #003B4F;">and</span> at.GetProp(<span class="st" style="color: #20794D;">'dummyLabel'</span>)<span class="op" style="color: #5E5E5E;">==</span>lbl:</span>
<span id="cb11-25">                <span class="co" style="color: #5E5E5E;"># attachment point. the atoms connected to this</span></span>
<span id="cb11-26">                <span class="co" style="color: #5E5E5E;"># should be from the molecule</span></span>
<span id="cb11-27">                <span class="cf" style="color: #003B4F;">for</span> nbr <span class="kw" style="color: #003B4F;">in</span> at.GetNeighbors():</span>
<span id="cb11-28">                    <span class="cf" style="color: #003B4F;">if</span> nbr.HasProp(sourceIdxProperty):</span>
<span id="cb11-29">                        mAt <span class="op" style="color: #5E5E5E;">=</span> mol.GetAtomWithIdx(nbr.GetIntProp(sourceIdxProperty))</span>
<span id="cb11-30">                        <span class="cf" style="color: #003B4F;">if</span> mAt.GetIsotope():</span>
<span id="cb11-31">                            mAt.SetIntProp(<span class="st" style="color: #20794D;">'_OrigIsotope'</span>,mAt.GetIsotope())</span>
<span id="cb11-32">                        mAt.SetIsotope(<span class="dv" style="color: #AD0000;">200</span><span class="op" style="color: #5E5E5E;">+</span>at.GetAtomMapNum())</span>
<span id="cb11-33">    <span class="co" style="color: #5E5E5E;"># remove unmapped hs so that they don't mess up the depiction</span></span>
<span id="cb11-34">    rhps <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHsParameters()</span>
<span id="cb11-35">    rhps.removeMapped <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb11-36">    tmol <span class="op" style="color: #5E5E5E;">=</span> Chem.RemoveHs(mol,rhps)</span>
<span id="cb11-37">    rdDepictor.GenerateDepictionMatching2DStructure(tmol,core)</span>
<span id="cb11-38"></span>
<span id="cb11-39">    oldNewAtomMap<span class="op" style="color: #5E5E5E;">=</span>{}</span>
<span id="cb11-40">    <span class="co" style="color: #5E5E5E;"># reset the original isotope values and account for the fact that</span></span>
<span id="cb11-41">    <span class="co" style="color: #5E5E5E;"># removing the Hs changed atom indices</span></span>
<span id="cb11-42">    <span class="cf" style="color: #003B4F;">for</span> i,at <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(tmol.GetAtoms()):</span>
<span id="cb11-43">        <span class="cf" style="color: #003B4F;">if</span> at.HasProp(sourceIdxProperty):</span>
<span id="cb11-44">            oldNewAtomMap[at.GetIntProp(sourceIdxProperty)] <span class="op" style="color: #5E5E5E;">=</span> i</span>
<span id="cb11-45">            <span class="cf" style="color: #003B4F;">if</span> at.HasProp(<span class="st" style="color: #20794D;">"_OrigIsotope"</span>):</span>
<span id="cb11-46">                at.SetIsotope(at.GetIntProp(<span class="st" style="color: #20794D;">"_OrigIsotope"</span>))</span>
<span id="cb11-47">                at.ClearProp(<span class="st" style="color: #20794D;">"_OrigIsotope"</span>)</span>
<span id="cb11-48">            <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb11-49">                at.SetIsotope(<span class="dv" style="color: #AD0000;">0</span>)</span>
<span id="cb11-50">      </span>
<span id="cb11-51">    <span class="co" style="color: #5E5E5E;"># ------------------</span></span>
<span id="cb11-52">    <span class="co" style="color: #5E5E5E;">#  set up our colormap</span></span>
<span id="cb11-53">    <span class="co" style="color: #5E5E5E;">#   the three choices here are all "colorblind" colormaps</span></span>
<span id="cb11-54">    </span>
<span id="cb11-55">    <span class="co" style="color: #5E5E5E;"># "Tol" colormap from https://davidmathlogic.com/colorblind</span></span>
<span id="cb11-56">    colors <span class="op" style="color: #5E5E5E;">=</span> [(<span class="dv" style="color: #AD0000;">51</span>,<span class="dv" style="color: #AD0000;">34</span>,<span class="dv" style="color: #AD0000;">136</span>),(<span class="dv" style="color: #AD0000;">17</span>,<span class="dv" style="color: #AD0000;">119</span>,<span class="dv" style="color: #AD0000;">51</span>),(<span class="dv" style="color: #AD0000;">68</span>,<span class="dv" style="color: #AD0000;">170</span>,<span class="dv" style="color: #AD0000;">153</span>),(<span class="dv" style="color: #AD0000;">136</span>,<span class="dv" style="color: #AD0000;">204</span>,<span class="dv" style="color: #AD0000;">238</span>),(<span class="dv" style="color: #AD0000;">221</span>,<span class="dv" style="color: #AD0000;">204</span>,<span class="dv" style="color: #AD0000;">119</span>),(<span class="dv" style="color: #AD0000;">204</span>,<span class="dv" style="color: #AD0000;">102</span>,<span class="dv" style="color: #AD0000;">119</span>),(<span class="dv" style="color: #AD0000;">170</span>,<span class="dv" style="color: #AD0000;">68</span>,<span class="dv" style="color: #AD0000;">153</span>),(<span class="dv" style="color: #AD0000;">136</span>,<span class="dv" style="color: #AD0000;">34</span>,<span class="dv" style="color: #AD0000;">85</span>)]</span>
<span id="cb11-57">    <span class="co" style="color: #5E5E5E;"># "IBM" colormap from https://davidmathlogic.com/colorblind</span></span>
<span id="cb11-58">    colors <span class="op" style="color: #5E5E5E;">=</span> [(<span class="dv" style="color: #AD0000;">100</span>,<span class="dv" style="color: #AD0000;">143</span>,<span class="dv" style="color: #AD0000;">255</span>),(<span class="dv" style="color: #AD0000;">120</span>,<span class="dv" style="color: #AD0000;">94</span>,<span class="dv" style="color: #AD0000;">240</span>),(<span class="dv" style="color: #AD0000;">220</span>,<span class="dv" style="color: #AD0000;">38</span>,<span class="dv" style="color: #AD0000;">127</span>),(<span class="dv" style="color: #AD0000;">254</span>,<span class="dv" style="color: #AD0000;">97</span>,<span class="dv" style="color: #AD0000;">0</span>),(<span class="dv" style="color: #AD0000;">255</span>,<span class="dv" style="color: #AD0000;">176</span>,<span class="dv" style="color: #AD0000;">0</span>)]</span>
<span id="cb11-59">    <span class="co" style="color: #5E5E5E;"># Okabe_Ito colormap from https://jfly.uni-koeln.de/color/</span></span>
<span id="cb11-60">    colors <span class="op" style="color: #5E5E5E;">=</span> [(<span class="dv" style="color: #AD0000;">230</span>,<span class="dv" style="color: #AD0000;">159</span>,<span class="dv" style="color: #AD0000;">0</span>),(<span class="dv" style="color: #AD0000;">86</span>,<span class="dv" style="color: #AD0000;">180</span>,<span class="dv" style="color: #AD0000;">233</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">158</span>,<span class="dv" style="color: #AD0000;">115</span>),(<span class="dv" style="color: #AD0000;">240</span>,<span class="dv" style="color: #AD0000;">228</span>,<span class="dv" style="color: #AD0000;">66</span>),(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">114</span>,<span class="dv" style="color: #AD0000;">178</span>),(<span class="dv" style="color: #AD0000;">213</span>,<span class="dv" style="color: #AD0000;">94</span>,<span class="dv" style="color: #AD0000;">0</span>),(<span class="dv" style="color: #AD0000;">204</span>,<span class="dv" style="color: #AD0000;">121</span>,<span class="dv" style="color: #AD0000;">167</span>)]</span>
<span id="cb11-61">    <span class="cf" style="color: #003B4F;">for</span> i,x <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(colors):</span>
<span id="cb11-62">        colors[i] <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">tuple</span>(y<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">255</span> <span class="cf" style="color: #003B4F;">for</span> y <span class="kw" style="color: #003B4F;">in</span> x)</span>
<span id="cb11-63">  </span>
<span id="cb11-64">    <span class="co" style="color: #5E5E5E;">#----------------------</span></span>
<span id="cb11-65">    <span class="co" style="color: #5E5E5E;"># Identify and store which atoms, bonds, and rings we'll be highlighting</span></span>
<span id="cb11-66">    highlightatoms <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb11-67">    highlightbonds <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb11-68">    atomrads <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb11-69">    widthmults <span class="op" style="color: #5E5E5E;">=</span> {}</span>
<span id="cb11-70"></span>
<span id="cb11-71">    rings <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-72">    <span class="cf" style="color: #003B4F;">for</span> i,lbl <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(lbls):    </span>
<span id="cb11-73">        color <span class="op" style="color: #5E5E5E;">=</span> colors[i<span class="op" style="color: #5E5E5E;">%</span><span class="bu" style="color: null;">len</span>(colors)]</span>
<span id="cb11-74">        rquery <span class="op" style="color: #5E5E5E;">=</span> row[lbl]</span>
<span id="cb11-75">        Chem.GetSSSR(rquery)</span>
<span id="cb11-76">        rinfo <span class="op" style="color: #5E5E5E;">=</span> rquery.GetRingInfo()</span>
<span id="cb11-77">        <span class="cf" style="color: #003B4F;">for</span> at <span class="kw" style="color: #003B4F;">in</span> rquery.GetAtoms():</span>
<span id="cb11-78">            <span class="cf" style="color: #003B4F;">if</span> at.HasProp(sourceIdxProperty):</span>
<span id="cb11-79">                origIdx <span class="op" style="color: #5E5E5E;">=</span> oldNewAtomMap[at.GetIntProp(sourceIdxProperty)]</span>
<span id="cb11-80">                highlightatoms[origIdx].append(color)</span>
<span id="cb11-81">                atomrads[origIdx] <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.4</span></span>
<span id="cb11-82">        <span class="cf" style="color: #003B4F;">if</span> fillRings:</span>
<span id="cb11-83">            <span class="cf" style="color: #003B4F;">for</span> aring <span class="kw" style="color: #003B4F;">in</span> rinfo.AtomRings():</span>
<span id="cb11-84">                tring <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-85">                allFound <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">True</span></span>
<span id="cb11-86">                <span class="cf" style="color: #003B4F;">for</span> aid <span class="kw" style="color: #003B4F;">in</span> aring:</span>
<span id="cb11-87">                    at <span class="op" style="color: #5E5E5E;">=</span> rquery.GetAtomWithIdx(aid)</span>
<span id="cb11-88">                    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> at.HasProp(sourceIdxProperty):</span>
<span id="cb11-89">                        allFound <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb11-90">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb11-91">                    tring.append(oldNewAtomMap[at.GetIntProp(sourceIdxProperty)])</span>
<span id="cb11-92">                <span class="cf" style="color: #003B4F;">if</span> allFound:</span>
<span id="cb11-93">                    rings.append((tring,color))</span>
<span id="cb11-94">        <span class="cf" style="color: #003B4F;">for</span> qbnd <span class="kw" style="color: #003B4F;">in</span> rquery.GetBonds():</span>
<span id="cb11-95">            batom <span class="op" style="color: #5E5E5E;">=</span> qbnd.GetBeginAtom()</span>
<span id="cb11-96">            eatom <span class="op" style="color: #5E5E5E;">=</span> qbnd.GetEndAtom()</span>
<span id="cb11-97">            <span class="cf" style="color: #003B4F;">if</span> batom.HasProp(sourceIdxProperty) <span class="kw" style="color: #003B4F;">and</span> eatom.HasProp(sourceIdxProperty):</span>
<span id="cb11-98">                origBnd <span class="op" style="color: #5E5E5E;">=</span> tmol.GetBondBetweenAtoms(oldNewAtomMap[batom.GetIntProp(sourceIdxProperty)],</span>
<span id="cb11-99">                                                 oldNewAtomMap[eatom.GetIntProp(sourceIdxProperty)])</span>
<span id="cb11-100">                bndIdx <span class="op" style="color: #5E5E5E;">=</span> origBnd.GetIdx()</span>
<span id="cb11-101">                highlightbonds[bndIdx].append(color)</span>
<span id="cb11-102">                widthmults[bndIdx] <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb11-103"></span>
<span id="cb11-104">    d2d <span class="op" style="color: #5E5E5E;">=</span> rdMolDraw2D.MolDraw2DCairo(width,height)</span>
<span id="cb11-105">    dos <span class="op" style="color: #5E5E5E;">=</span> d2d.drawOptions()</span>
<span id="cb11-106">    dos.useBWAtomPalette()</span>
<span id="cb11-107">                </span>
<span id="cb11-108">    <span class="co" style="color: #5E5E5E;">#----------------------</span></span>
<span id="cb11-109">    <span class="co" style="color: #5E5E5E;"># if we are filling rings, go ahead and do that first so that we draw</span></span>
<span id="cb11-110">    <span class="co" style="color: #5E5E5E;"># the molecule on top of the filled rings</span></span>
<span id="cb11-111">    <span class="cf" style="color: #003B4F;">if</span> fillRings <span class="kw" style="color: #003B4F;">and</span> rings:</span>
<span id="cb11-112">        <span class="co" style="color: #5E5E5E;"># a hack to set the molecule scale</span></span>
<span id="cb11-113">        d2d.DrawMoleculeWithHighlights(tmol,legend,<span class="bu" style="color: null;">dict</span>(highlightatoms),</span>
<span id="cb11-114">                                       <span class="bu" style="color: null;">dict</span>(highlightbonds),</span>
<span id="cb11-115">                                       atomrads,widthmults)</span>
<span id="cb11-116">        d2d.ClearDrawing()</span>
<span id="cb11-117">        conf <span class="op" style="color: #5E5E5E;">=</span> tmol.GetConformer()</span>
<span id="cb11-118">        <span class="cf" style="color: #003B4F;">for</span> (aring,color) <span class="kw" style="color: #003B4F;">in</span> rings:</span>
<span id="cb11-119">            ps <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb11-120">            <span class="cf" style="color: #003B4F;">for</span> aidx <span class="kw" style="color: #003B4F;">in</span> aring:</span>
<span id="cb11-121">                pos <span class="op" style="color: #5E5E5E;">=</span> Geometry.Point2D(conf.GetAtomPosition(aidx))</span>
<span id="cb11-122">                ps.append(pos)</span>
<span id="cb11-123">            d2d.SetFillPolys(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb11-124">            d2d.SetColour(color)</span>
<span id="cb11-125">            d2d.DrawPolygon(ps)</span>
<span id="cb11-126">        dos.clearBackground <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">False</span></span>
<span id="cb11-127"></span>
<span id="cb11-128">    <span class="co" style="color: #5E5E5E;">#----------------------</span></span>
<span id="cb11-129">    <span class="co" style="color: #5E5E5E;"># now draw the molecule, with highlights:</span></span>
<span id="cb11-130">    d2d.DrawMoleculeWithHighlights(tmol,legend,<span class="bu" style="color: null;">dict</span>(highlightatoms),<span class="bu" style="color: null;">dict</span>(highlightbonds),</span>
<span id="cb11-131">                                   atomrads,widthmults)</span>
<span id="cb11-132">    d2d.FinishDrawing()</span>
<span id="cb11-133">    png <span class="op" style="color: #5E5E5E;">=</span> d2d.GetDrawingText()</span>
<span id="cb11-134">    <span class="cf" style="color: #003B4F;">return</span> png</span></code></pre></div>
</div>
<p>Interactively try that out on all the molecules in our set:</p>
<div class="cell" data-scrolled="true" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="at" style="color: #657422;">@interact</span>(idx<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="bu" style="color: null;">len</span>(ms)))</span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;">def</span> draw_it(idx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>):</span>
<span id="cb12-3">    m <span class="op" style="color: #5E5E5E;">=</span> mms[idx]</span>
<span id="cb12-4">    row <span class="op" style="color: #5E5E5E;">=</span> groups[idx]</span>
<span id="cb12-5">    <span class="cf" style="color: #003B4F;">return</span> Image(highlight_rgroups(m,row,qcore,lbls<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>,<span class="st" style="color: #20794D;">'R4'</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"65c52f1d60c84dfc971efdbf5959006d","version_major":2,"version_minor":0}
</script>
</div>
</div>
<p>It would be cool to do see multiple molecules at once. Unforunately <code>DrawMolsToGridImage()</code> doesn’t support the multiple highlighting we’re doing here (we decided that the API for that would just be too complex; this may change in the future if we can figure out a sensible API for it), so we have to manually combine the images. Fortunately the pillow package makes that easy:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;">from</span> PIL <span class="im" style="color: #00769E;">import</span> Image <span class="im" style="color: #00769E;">as</span> pilImage</span>
<span id="cb13-2"><span class="im" style="color: #00769E;">from</span> io <span class="im" style="color: #00769E;">import</span> BytesIO</span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="kw" style="color: #003B4F;">def</span> draw_multiple(ms,groups,qcore,lbls,legends<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>,nPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>,subImageSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">250</span>,<span class="dv" style="color: #AD0000;">200</span>)):</span>
<span id="cb13-5">    nRows <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">len</span>(ms)<span class="op" style="color: #5E5E5E;">//</span>nPerRow</span>
<span id="cb13-6">    <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(ms)<span class="op" style="color: #5E5E5E;">%</span>nPerRow:</span>
<span id="cb13-7">        nRows<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb13-8">    nCols <span class="op" style="color: #5E5E5E;">=</span> nPerRow</span>
<span id="cb13-9">    imgSize <span class="op" style="color: #5E5E5E;">=</span> (subImageSize[<span class="dv" style="color: #AD0000;">0</span>]<span class="op" style="color: #5E5E5E;">*</span>nCols,subImageSize[<span class="dv" style="color: #AD0000;">1</span>]<span class="op" style="color: #5E5E5E;">*</span>nRows)</span>
<span id="cb13-10">    res <span class="op" style="color: #5E5E5E;">=</span> pilImage.new(<span class="st" style="color: #20794D;">'RGB'</span>,imgSize)</span>
<span id="cb13-11">    </span>
<span id="cb13-12">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(ms):</span>
<span id="cb13-13">        col <span class="op" style="color: #5E5E5E;">=</span> i<span class="op" style="color: #5E5E5E;">%</span>nPerRow</span>
<span id="cb13-14">        row <span class="op" style="color: #5E5E5E;">=</span> i<span class="op" style="color: #5E5E5E;">//</span>nPerRow</span>
<span id="cb13-15">        <span class="cf" style="color: #003B4F;">if</span> legends:</span>
<span id="cb13-16">            legend <span class="op" style="color: #5E5E5E;">=</span> legends[i]</span>
<span id="cb13-17">        <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb13-18">            legend <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">''</span></span>
<span id="cb13-19">        png <span class="op" style="color: #5E5E5E;">=</span> highlight_rgroups(m,groups[i],qcore,lbls<span class="op" style="color: #5E5E5E;">=</span>lbls,legend<span class="op" style="color: #5E5E5E;">=</span>legend,</span>
<span id="cb13-20">                               width<span class="op" style="color: #5E5E5E;">=</span>subImageSize[<span class="dv" style="color: #AD0000;">0</span>],height<span class="op" style="color: #5E5E5E;">=</span>subImageSize[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb13-21">        bio <span class="op" style="color: #5E5E5E;">=</span> BytesIO(png)</span>
<span id="cb13-22">        img <span class="op" style="color: #5E5E5E;">=</span> pilImage.<span class="bu" style="color: null;">open</span>(bio)</span>
<span id="cb13-23">        res.paste(img,box<span class="op" style="color: #5E5E5E;">=</span>(col<span class="op" style="color: #5E5E5E;">*</span>subImageSize[<span class="dv" style="color: #AD0000;">0</span>],row<span class="op" style="color: #5E5E5E;">*</span>subImageSize[<span class="dv" style="color: #AD0000;">1</span>]))</span>
<span id="cb13-24">    bio <span class="op" style="color: #5E5E5E;">=</span> BytesIO()</span>
<span id="cb13-25">    res.save(bio,<span class="bu" style="color: null;">format</span><span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'PNG'</span>)</span>
<span id="cb13-26">    <span class="cf" style="color: #003B4F;">return</span> bio.getvalue()</span></code></pre></div>
</div>
<p>Now let’s look at the first 16 molecules in the dataset:</p>
<div class="cell" data-scrolled="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">Image(draw_multiple(mms[:<span class="dv" style="color: #AD0000;">16</span>],groups,qcore,(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>,<span class="st" style="color: #20794D;">'R4'</span>),legends<span class="op" style="color: #5E5E5E;">=</span>cids,subImageSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">300</span>,<span class="dv" style="color: #AD0000;">250</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Repeat that analysis with the compounds from another document just to make sure we did everything sufficiently generally:</p>
<div class="cell" data-scrolled="true" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">df_doc2 <span class="op" style="color: #5E5E5E;">=</span> df[df.assay_chembl_id<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'CHEMBL658107'</span>]</span>
<span id="cb15-2"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(df_doc2))</span>
<span id="cb15-3">df_doc2.head()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>33</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>assay_id</th>
      <th>doc_id</th>
      <th>description</th>
      <th>assay_organism</th>
      <th>assay_chembl_id</th>
      <th>aidx</th>
      <th>pref_name</th>
      <th>activity_id</th>
      <th>molregno</th>
      <th>standard_relation</th>
      <th>...</th>
      <th>src_id (#1)</th>
      <th>type</th>
      <th>relation</th>
      <th>value</th>
      <th>units</th>
      <th>text_value</th>
      <th>standard_text_value</th>
      <th>standard_inchi_key</th>
      <th>canonical_smiles</th>
      <th>compound_chembl_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>265814</td>
      <td>68026</td>
      <td>&gt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&gt;</td>
      <td>20.00</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>RPXWUUDZINQPTJ-UHFFFAOYSA-N</td>
      <td>CNc1nccc(n1)c2sc(C)nc2C</td>
      <td>CHEMBL46474</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>265817</td>
      <td>67880</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.14</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>GDZTURHUKDAJGD-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(Nc3ccc(O)cc3)n2</td>
      <td>CHEMBL442957</td>
    </tr>
    <tr>
      <th>2</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267078</td>
      <td>67751</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>6.50</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CTFDMGIBHFQWKB-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(N)n2</td>
      <td>CHEMBL47302</td>
    </tr>
    <tr>
      <th>3</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267081</td>
      <td>67782</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>1.20</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>HOKDXVAONYXHJK-UHFFFAOYSA-N</td>
      <td>Cc1nc(C)c(s1)c2ccnc(Nc3ccccc3F)n2</td>
      <td>CHEMBL297447</td>
    </tr>
    <tr>
      <th>4</th>
      <td>50641</td>
      <td>17759</td>
      <td>Inhibitory activity against human CDK2 (Cyclin...</td>
      <td>NaN</td>
      <td>CHEMBL658107</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>267084</td>
      <td>67961</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.11</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>XNKSRGHGPSHYIW-UHFFFAOYSA-N</td>
      <td>CNc1nc(C)c(s1)c2ccnc(Nc3cccc(O)c3)n2</td>
      <td>CHEMBL44119</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">smis <span class="op" style="color: #5E5E5E;">=</span> df_doc2[<span class="st" style="color: #20794D;">'canonical_smiles'</span>]</span>
<span id="cb17-2">cids <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(df_doc2.compound_chembl_id)</span>
<span id="cb17-3">ms <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> smis]</span>
<span id="cb17-4"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb17-5">    rdDepictor.Compute2DCoords(m)</span>
<span id="cb17-6">Draw.MolsToGridImage(ms[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>cids,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">core <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'Cc1nc([*:3])sc1-c1ccnc(N([*:1])[*:2])n1'</span>)</span>
<span id="cb18-2">ps <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryParameters.NoAdjustments()</span>
<span id="cb18-3">ps.makeDummiesQueries<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb18-4">qcore <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(core,ps)</span>
<span id="cb18-5">mhs <span class="op" style="color: #5E5E5E;">=</span> [Chem.AddHs(x,addCoords<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms]</span>
<span id="cb18-6">mms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mhs <span class="cf" style="color: #003B4F;">if</span> x.HasSubstructMatch(qcore)]</span>
<span id="cb18-7"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mms:</span>
<span id="cb18-8">    <span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> m.GetAtoms():</span>
<span id="cb18-9">        atom.SetIntProp(<span class="st" style="color: #20794D;">"SourceAtomIdx"</span>,atom.GetIdx())</span>
<span id="cb18-10"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(mhs),<span class="bu" style="color: null;">len</span>(mms))</span>
<span id="cb18-11">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb18-12">rdDepictor.Compute2DCoords(qcore)</span>
<span id="cb18-13">qcore</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>33 33</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">rdkit.RDLogger.DisableLog(<span class="st" style="color: #20794D;">'rdApp.warning'</span>)</span>
<span id="cb20-2">groups,_ <span class="op" style="color: #5E5E5E;">=</span> rdRGroupDecomposition.RGroupDecompose([qcore],mms,asSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,asRows<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="at" style="color: #657422;">@interact</span>(idx<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="bu" style="color: null;">len</span>(mms)))</span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;">def</span> draw_it(idx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>):</span>
<span id="cb21-3">    m <span class="op" style="color: #5E5E5E;">=</span> mms[idx]</span>
<span id="cb21-4">    row <span class="op" style="color: #5E5E5E;">=</span> groups[idx]</span>
<span id="cb21-5">    <span class="cf" style="color: #003B4F;">return</span> Image(highlight_rgroups(m,row,qcore,lbls<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ecbaa6cb1e604eeb857c39cc35749044","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">Image(draw_multiple(mms[:<span class="dv" style="color: #AD0000;">12</span>],groups,qcore,(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>),subImageSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">300</span>,<span class="dv" style="color: #AD0000;">250</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">df_doc3 <span class="op" style="color: #5E5E5E;">=</span> df[df.assay_chembl_id<span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'CHEMBL3101313'</span>]</span>
<span id="cb23-2"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(df_doc3))</span>
<span id="cb23-3">df_doc3.head()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>assay_id</th>
      <th>doc_id</th>
      <th>description</th>
      <th>assay_organism</th>
      <th>assay_chembl_id</th>
      <th>aidx</th>
      <th>pref_name</th>
      <th>activity_id</th>
      <th>molregno</th>
      <th>standard_relation</th>
      <th>...</th>
      <th>src_id (#1)</th>
      <th>type</th>
      <th>relation</th>
      <th>value</th>
      <th>units</th>
      <th>text_value</th>
      <th>standard_text_value</th>
      <th>standard_inchi_key</th>
      <th>canonical_smiles</th>
      <th>compound_chembl_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1129</th>
      <td>1281340</td>
      <td>76402</td>
      <td>Displacement of B-Alexa-Fluor647 from CDK2 (un...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL3101313</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>13859835</td>
      <td>1610535</td>
      <td>&lt;</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>&lt;</td>
      <td>0.10</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>USOUMMYIFYDJEI-ZZTDINLMSA-N</td>
      <td>COC[C@H](Cc1ccc(O)cc1)NC(=O)c2cc(C(=O)O)c3cc(\...</td>
      <td>CHEMBL3099753</td>
    </tr>
    <tr>
      <th>1130</th>
      <td>1281340</td>
      <td>76402</td>
      <td>Displacement of B-Alexa-Fluor647 from CDK2 (un...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL3101313</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>13859836</td>
      <td>1610534</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.10</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>DLJWCYCMLMVSML-FQEVSTJZSA-N</td>
      <td>COC[C@H](Cc1ccc(O)cc1)NC(=O)c2cc(C(=O)O)c3cc(c...</td>
      <td>CHEMBL3099752</td>
    </tr>
    <tr>
      <th>1131</th>
      <td>1281340</td>
      <td>76402</td>
      <td>Displacement of B-Alexa-Fluor647 from CDK2 (un...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL3101313</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>13859837</td>
      <td>1610533</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.16</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>BHBDKGIDYKROMY-BAJJQUEBSA-N</td>
      <td>CN(C)C(=O)[C@H](Cc1ccc(O)cc1)NC(=O)c2cc(C(=O)O...</td>
      <td>CHEMBL3099751</td>
    </tr>
    <tr>
      <th>1132</th>
      <td>1281340</td>
      <td>76402</td>
      <td>Displacement of B-Alexa-Fluor647 from CDK2 (un...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL3101313</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>13859838</td>
      <td>1610532</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.10</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>IYRLCOILNQBJEJ-ZNOKPGKASA-N</td>
      <td>CNC(=O)[C@H](Cc1ccc(O)cc1)NC(=O)c2cc(C(=O)O)c3...</td>
      <td>CHEMBL3099750</td>
    </tr>
    <tr>
      <th>1133</th>
      <td>1281340</td>
      <td>76402</td>
      <td>Displacement of B-Alexa-Fluor647 from CDK2 (un...</td>
      <td>Homo sapiens</td>
      <td>CHEMBL3101313</td>
      <td>CLD0</td>
      <td>Cyclin-dependent kinase 2</td>
      <td>13859839</td>
      <td>1610531</td>
      <td>=</td>
      <td>...</td>
      <td>1</td>
      <td>Ki</td>
      <td>=</td>
      <td>0.30</td>
      <td>uM</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>DDIHZTFUIFPFOO-OAQYLSRUSA-N</td>
      <td>CCC[C@H](Cc1ccc(O)cc1)NC(=O)c2cc(C(=O)O)c3cc(c...</td>
      <td>CHEMBL3099749</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<p>Finally, do another document, just because it’s fun. :-)</p>
<div class="cell" data-scrolled="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">smis <span class="op" style="color: #5E5E5E;">=</span> df_doc3[<span class="st" style="color: #20794D;">'canonical_smiles'</span>]</span>
<span id="cb25-2">cids <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">list</span>(df_doc3.compound_chembl_id)</span>
<span id="cb25-3">ms <span class="op" style="color: #5E5E5E;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> smis]</span>
<span id="cb25-4"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> ms:</span>
<span id="cb25-5">    rdDepictor.Compute2DCoords(m)</span>
<span id="cb25-6">Draw.MolsToGridImage(ms[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>cids,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">core <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;">'OC(=O)c1cc(C(=O)NC(C[*:1])[*:2])nc2ccc([*:3])cc12'</span>)</span>
<span id="cb26-2">ps <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryParameters.NoAdjustments()</span>
<span id="cb26-3">ps.makeDummiesQueries<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span></span>
<span id="cb26-4">qcore <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(core,ps)</span>
<span id="cb26-5">mhs <span class="op" style="color: #5E5E5E;">=</span> [Chem.AddHs(x,addCoords<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ms]</span>
<span id="cb26-6">mms <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> mhs <span class="cf" style="color: #003B4F;">if</span> x.HasSubstructMatch(qcore)]</span>
<span id="cb26-7"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> mms:</span>
<span id="cb26-8">    <span class="cf" style="color: #003B4F;">for</span> atom <span class="kw" style="color: #003B4F;">in</span> m.GetAtoms():</span>
<span id="cb26-9">        atom.SetIntProp(<span class="st" style="color: #20794D;">"SourceAtomIdx"</span>,atom.GetIdx())</span>
<span id="cb26-10"><span class="bu" style="color: null;">print</span>(<span class="bu" style="color: null;">len</span>(mhs),<span class="bu" style="color: null;">len</span>(mms))</span>
<span id="cb26-11">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb26-12">rdDepictor.Compute2DCoords(qcore)</span>
<span id="cb26-13">qcore</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25 22</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-21-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">rdkit.RDLogger.DisableLog(<span class="st" style="color: #20794D;">'rdApp.warning'</span>)</span>
<span id="cb28-2">groups,_ <span class="op" style="color: #5E5E5E;">=</span> rdRGroupDecomposition.RGroupDecompose([qcore],mms,asSmiles<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>,asRows<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="at" style="color: #657422;">@interact</span>(idx<span class="op" style="color: #5E5E5E;">=</span><span class="bu" style="color: null;">range</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="bu" style="color: null;">len</span>(mms)))</span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;">def</span> draw_it(idx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">0</span>):</span>
<span id="cb29-3">    m <span class="op" style="color: #5E5E5E;">=</span> mms[idx]</span>
<span id="cb29-4">    row <span class="op" style="color: #5E5E5E;">=</span> groups[idx]</span>
<span id="cb29-5">    <span class="cf" style="color: #003B4F;">return</span> Image(highlight_rgroups(m,row,qcore,lbls<span class="op" style="color: #5E5E5E;">=</span>(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"60ed706ff14d41e680ee2482d0a80147","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">Image(draw_multiple(mms[:<span class="dv" style="color: #AD0000;">12</span>],groups,qcore,(<span class="st" style="color: #20794D;">'R1'</span>,<span class="st" style="color: #20794D;">'R2'</span>,<span class="st" style="color: #20794D;">'R3'</span>),subImageSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">300</span>,<span class="dv" style="color: #AD0000;">250</span>)))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>



 ]]></description>
  <category>tutorial</category>
  <category>prototypes</category>
  <category>drawing</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-08-07-rgd-and-highlighting.html</guid>
  <pubDate>Fri, 06 Aug 2021 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/rgd-and-highlighting1-1.png" medium="image" type="image/png" height="82" width="144"/>
</item>
<item>
  <title>Generalized substructure search</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search.html</link>
  <description><![CDATA[ 



<p><em>[Updated 19.12.2021 to use new functionality from the 2021.09 RDKit release]</em></p>
<p>Over the last couple of releases we’ve added a number of RDKit features which allow useage of more advanced substructure query features and more control over the results returned by substructure searches. These include</p>
<ul>
<li><code>Chem.AdjustQueryProperties()</code> to tune the results returned by a substructure query</li>
<li><code>rdMolEnumerator.Enumerate()</code> to enumerate some V3000 mol block query features (as of the 2021.03 release the supported features are variable attachment points and link nodes)</li>
<li><code>rdTautomerQuery.TautomerQuery()</code> to allow tautomer-insensitive substructures search</li>
</ul>
<p>In this post I’ll show how to use all of those together to do “generalized substructures searching” with the RDKit. Towards the bottom of the post there are a couple of Python functions which can be used in other scripts to make this process easier. I’ll also try and figure out a good way to get that into a future RDKit release.</p>
<p>AAs an example, here’s a query: <img src="https://greglandrum.github.io/rdkit-blog/images/blog/generalized-substructure-search1-1.png" class="img-fluid" alt="generalized-substructure-search1-1.png"> and here are four ChEMBL molecules returned using that query: <img src="https://greglandrum.github.io/rdkit-blog/images/blog/generalized-substructure-search1-2.png" class="img-fluid" alt="generalized-substructure-search1-2.png"></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolEnumerator</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdTautomerQuery</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-6">IPythonConsole.drawOptions.minFontSize <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb1-7">Draw.SetComicMode(IPythonConsole.drawOptions)</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdDepictor</span>
<span id="cb1-9">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;">True</span>)</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">import</span> rdkit</span>
<span id="cb1-11"><span class="bu" style="color: null;">print</span>(rdkit.__version__)</span>
<span id="cb1-12"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-13"><span class="bu" style="color: null;">print</span>(time.asctime())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021.09.3
Sun Dec 19 06:14:00 2021</code></pre>
</div>
</div>
<p>Load a <code>SubstructLibrary</code> created using ChEMBL_29. The code used to construct this is:</p>
<pre><code>from rdkit import RDLogger
from rdkit import Chem
from rdkit.Chem import rdSubstructLibrary
import pickle, time
import gzip

gz = gzip.GzipFile('/home/glandrum/Downloads/chembl_29.sdf.gz')
suppl = Chem.ForwardSDMolSupplier(gz)
RDLogger.DisableLog("rdApp.warning")
t1=time.time()
data = []
for i,mol in enumerate(suppl):
    if not ((i+1)%50000):
        print(f"Processed {i+1} molecules in {(time.time()-t1):.1f} seconds")
    if mol is None or mol.GetNumAtoms()&gt;50:
        continue
    fp = Chem.PatternFingerprint(mol,fpSize=1024,tautomerFingerprints=True)
    smi = Chem.MolToSmiles(mol)
    data.append((smi,fp))
t2=time.time()
pickle.dump(data,open('../data/chembl29_sssdata.pkl','wb+'))
t1=time.time()
mols = rdSubstructLibrary.CachedTrustedSmilesMolHolder()
fps = rdSubstructLibrary.TautomerPatternHolder(1024)
for smi,fp in data:
    mols.AddSmiles(smi)
    fps.AddFingerprint(fp)
library = rdSubstructLibrary.SubstructLibrary(mols,fps)
t2=time.time()
print(f"That took {t2-t1:.2f} seconds. The library has {len(library)} molecules.")
pickle.dump(library,open('../data/chembl29_ssslib.pkl','wb+'))</code></pre>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;">import</span> pickle</span>
<span id="cb4-2"><span class="cf" style="color: #003B4F;">with</span> <span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'./results/chembl29_ssslib.pkl'</span>,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb4-3">    sslib <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb4-4"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'SubstructLibrary loaded with </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(sslib)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> molecules'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SubstructLibrary loaded with 2049078 molecules</code></pre>
</div>
</div>
<section id="enumeration" class="level1">
<h1>Enumeration</h1>
<p>Start with a query including a variable attachment point:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(<span class="st" style="color: #20794D;">'''</span></span>
<span id="cb6-2"><span class="st" style="color: #20794D;">  Mrv2108 08012107372D          </span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb6-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb6-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 11 11 0 0 0</span></span>
<span id="cb6-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb6-8"><span class="st" style="color: #20794D;">M  V30 1 C -2.4167 7.8734 0 0</span></span>
<span id="cb6-9"><span class="st" style="color: #20794D;">M  V30 2 C -3.7503 7.1034 0 0</span></span>
<span id="cb6-10"><span class="st" style="color: #20794D;">M  V30 3 C -3.7503 5.5633 0 0</span></span>
<span id="cb6-11"><span class="st" style="color: #20794D;">M  V30 4 N -2.4167 4.7933 0 0</span></span>
<span id="cb6-12"><span class="st" style="color: #20794D;">M  V30 5 C -1.083 5.5633 0 0</span></span>
<span id="cb6-13"><span class="st" style="color: #20794D;">M  V30 6 C -1.083 7.1034 0 0</span></span>
<span id="cb6-14"><span class="st" style="color: #20794D;">M  V30 7 N 0.3973 7.5279 0 0</span></span>
<span id="cb6-15"><span class="st" style="color: #20794D;">M  V30 8 N 0.3104 5.0377 0 0</span></span>
<span id="cb6-16"><span class="st" style="color: #20794D;">M  V30 9 C 1.2585 6.2511 0 0</span></span>
<span id="cb6-17"><span class="st" style="color: #20794D;">M  V30 10 * 0.3539 6.2828 0 0</span></span>
<span id="cb6-18"><span class="st" style="color: #20794D;">M  V30 11 C 1.5089 8.2833 0 0</span></span>
<span id="cb6-19"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb6-20"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb6-21"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb6-22"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb6-23"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb6-24"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb6-25"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb6-26"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb6-27"><span class="st" style="color: #20794D;">M  V30 7 1 7 6</span></span>
<span id="cb6-28"><span class="st" style="color: #20794D;">M  V30 8 1 5 8</span></span>
<span id="cb6-29"><span class="st" style="color: #20794D;">M  V30 9 1 8 9</span></span>
<span id="cb6-30"><span class="st" style="color: #20794D;">M  V30 10 2 7 9</span></span>
<span id="cb6-31"><span class="st" style="color: #20794D;">M  V30 11 1 10 11 ENDPTS=(2 8 7) ATTACH=ANY</span></span>
<span id="cb6-32"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb6-33"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb6-34"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb6-35"><span class="st" style="color: #20794D;">'''</span>)</span>
<span id="cb6-36">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb7-2">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(bndl)</span>
<span id="cb7-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb7-4">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;"># sort the molecules by number of atoms and preserve the match ID</span></span>
<span id="cb7-6">sorted_res <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(mols,matches),key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">0</span>].GetNumAtoms())</span>
<span id="cb7-7">sorted_mols,sorted_matches <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>sorted_res)</span>
<span id="cb7-8">Draw.MolsToGridImage(sorted_mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> sorted_matches],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Those include some addditional rings attached to the core in molecules like 1476, 10083, and 10853. We can prevent that by calling <code>AdjustQueryProperties()</code>:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">bndl <span class="op" style="color: #5E5E5E;">=</span> Chem.MolBundle()</span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> rdMolEnumerator.Enumerate(qry):</span>
<span id="cb9-3">    bndl.AddMol(Chem.AdjustQueryProperties(m))</span>
<span id="cb9-4">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(bndl)</span>
<span id="cb9-5"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb9-6">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;"># sort the molecules by number of atoms and preserve the match ID</span></span>
<span id="cb9-8">sorted_res <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(mols,matches),key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">0</span>].GetNumAtoms())</span>
<span id="cb9-9">sorted_mols,sorted_matches <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>sorted_res)</span>
<span id="cb9-10">Draw.MolsToGridImage(sorted_mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> sorted_matches],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>148 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-6-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>An aside: this would be more convenient if <code>AdjustQueryProperties</code> directly supported passing <code>MolBundle</code> objects. That’s something for a future version.</p>
<p>Now let’s make the query more complex by adding a link node in addition to the variable attachment point:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(<span class="st" style="color: #20794D;">'''</span></span>
<span id="cb11-2"><span class="st" style="color: #20794D;">  Mrv2108 08012108062D          </span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb11-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb11-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 13 13 0 0 0</span></span>
<span id="cb11-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb11-8"><span class="st" style="color: #20794D;">M  V30 1 C -2.4167 7.8734 0 0</span></span>
<span id="cb11-9"><span class="st" style="color: #20794D;">M  V30 2 C -3.7503 7.1034 0 0</span></span>
<span id="cb11-10"><span class="st" style="color: #20794D;">M  V30 3 C -3.7503 5.5633 0 0</span></span>
<span id="cb11-11"><span class="st" style="color: #20794D;">M  V30 4 N -2.4167 4.7933 0 0</span></span>
<span id="cb11-12"><span class="st" style="color: #20794D;">M  V30 5 C -1.083 5.5633 0 0</span></span>
<span id="cb11-13"><span class="st" style="color: #20794D;">M  V30 6 C -1.083 7.1034 0 0</span></span>
<span id="cb11-14"><span class="st" style="color: #20794D;">M  V30 7 N 0.3973 7.5279 0 0</span></span>
<span id="cb11-15"><span class="st" style="color: #20794D;">M  V30 8 N 0.3104 5.0377 0 0</span></span>
<span id="cb11-16"><span class="st" style="color: #20794D;">M  V30 9 C 1.2585 6.2511 0 0</span></span>
<span id="cb11-17"><span class="st" style="color: #20794D;">M  V30 10 * 0.3539 6.2828 0 0</span></span>
<span id="cb11-18"><span class="st" style="color: #20794D;">M  V30 11 C 1.5089 8.2833 0 0</span></span>
<span id="cb11-19"><span class="st" style="color: #20794D;">M  V30 12 C 2.7975 6.1974 0 0</span></span>
<span id="cb11-20"><span class="st" style="color: #20794D;">M  V30 13 N 3.6136 7.5033 0 0</span></span>
<span id="cb11-21"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb11-22"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb11-23"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb11-24"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb11-25"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb11-26"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb11-27"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb11-28"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb11-29"><span class="st" style="color: #20794D;">M  V30 7 1 7 6</span></span>
<span id="cb11-30"><span class="st" style="color: #20794D;">M  V30 8 1 5 8</span></span>
<span id="cb11-31"><span class="st" style="color: #20794D;">M  V30 9 1 8 9</span></span>
<span id="cb11-32"><span class="st" style="color: #20794D;">M  V30 10 2 7 9</span></span>
<span id="cb11-33"><span class="st" style="color: #20794D;">M  V30 11 1 10 11 ENDPTS=(2 8 7) ATTACH=ANY</span></span>
<span id="cb11-34"><span class="st" style="color: #20794D;">M  V30 12 1 9 12</span></span>
<span id="cb11-35"><span class="st" style="color: #20794D;">M  V30 13 1 12 13</span></span>
<span id="cb11-36"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb11-37"><span class="st" style="color: #20794D;">M  V30 LINKNODE 1 2 2 12 9 12 13</span></span>
<span id="cb11-38"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb11-39"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb11-40"><span class="st" style="color: #20794D;">'''</span>)</span>
<span id="cb11-41">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb12-2">matches <span class="op" style="color: #5E5E5E;">=</span> sslib.GetMatches(bndl)</span>
<span id="cb12-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb12-4">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;"># sort the molecules by number of atoms and preserve the match ID</span></span>
<span id="cb12-6">sorted_res <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(mols,matches),key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">0</span>].GetNumAtoms())</span>
<span id="cb12-7">sorted_mols,sorted_matches <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>sorted_res)</span>
<span id="cb12-8">Draw.MolsToGridImage(sorted_mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> sorted_matches],molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>193 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="enumeration-tautomer-insensitive-queries" class="level1">
<h1>Enumeration + tautomer-insensitive queries</h1>
<p>Here we will use the RDKit’s <code>TautomerQuery</code> class to do tautomer-insensitive substructure queries. We start by enumerating the molecules, as above, but then convert each of the results into a <code>TautomerQuery</code></p>
<p>To see what’s going on here it helps to have the result molecules all aligned the same way. In order to do that we also need to generate query molecules with aligned coordinates.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdFMCS</span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="kw" style="color: #003B4F;">def</span> getAlignedQueries(qry):</span>
<span id="cb14-4">    <span class="co" style="color: #5E5E5E;"># generate a conformer for the query if we don't have one already</span></span>
<span id="cb14-5">    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> qry.GetNumConformers():</span>
<span id="cb14-6">        rdDepictor.Compute2DCoords(qry)</span>
<span id="cb14-7"></span>
<span id="cb14-8">    bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb14-9">    </span>
<span id="cb14-10">    <span class="co" style="color: #5E5E5E;"># find the MCS of the enumerated molecules:</span></span>
<span id="cb14-11">    mcs <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS(bndl)</span>
<span id="cb14-12">    qmcs <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(mcs.smartsString)</span>
<span id="cb14-13">    </span>
<span id="cb14-14">    <span class="co" style="color: #5E5E5E;"># and now adjust the properties, generate coordinates, and create the TautomerQuery</span></span>
<span id="cb14-15">    queries <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb14-16">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> bndl:</span>
<span id="cb14-17">        q <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(q)</span>
<span id="cb14-18">        rdDepictor.GenerateDepictionMatching2DStructure(q,qry,refPatt<span class="op" style="color: #5E5E5E;">=</span>qmcs)</span>
<span id="cb14-19">        queries.append(rdTautomerQuery.TautomerQuery(q))</span>
<span id="cb14-20">    <span class="cf" style="color: #003B4F;">return</span> queries</span>
<span id="cb14-21"></span>
<span id="cb14-22"><span class="kw" style="color: #003B4F;">def</span> drawAlignedMols(mols,qry,legends<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">None</span>,molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>):</span>
<span id="cb14-23">    queries <span class="op" style="color: #5E5E5E;">=</span> getAlignedQueries(qry)</span>
<span id="cb14-24">    <span class="cf" style="color: #003B4F;">for</span> i,m <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">enumerate</span>(mols):</span>
<span id="cb14-25">        <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> queries:</span>
<span id="cb14-26">            <span class="cf" style="color: #003B4F;">if</span> q.IsSubstructOf(m):</span>
<span id="cb14-27">                rdDepictor.GenerateDepictionMatching2DStructure(m,q.GetTemplateMolecule())</span>
<span id="cb14-28">    <span class="cf" style="color: #003B4F;">return</span> Draw.MolsToGridImage(mols,legends<span class="op" style="color: #5E5E5E;">=</span>legends,molsPerRow<span class="op" style="color: #5E5E5E;">=</span>molsPerRow)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(<span class="st" style="color: #20794D;">'''</span></span>
<span id="cb15-2"><span class="st" style="color: #20794D;">  Mrv2108 08012108222D          </span></span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb15-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb15-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 12 12 0 0 0</span></span>
<span id="cb15-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb15-8"><span class="st" style="color: #20794D;">M  V30 1 C -2.4167 7.8734 0 0</span></span>
<span id="cb15-9"><span class="st" style="color: #20794D;">M  V30 2 C -3.7503 7.1034 0 0</span></span>
<span id="cb15-10"><span class="st" style="color: #20794D;">M  V30 3 C -3.7503 5.5633 0 0</span></span>
<span id="cb15-11"><span class="st" style="color: #20794D;">M  V30 4 N -2.4167 4.7933 0 0</span></span>
<span id="cb15-12"><span class="st" style="color: #20794D;">M  V30 5 C -1.083 5.5633 0 0</span></span>
<span id="cb15-13"><span class="st" style="color: #20794D;">M  V30 6 C -1.083 7.1034 0 0</span></span>
<span id="cb15-14"><span class="st" style="color: #20794D;">M  V30 7 N 0.3973 7.5279 0 0</span></span>
<span id="cb15-15"><span class="st" style="color: #20794D;">M  V30 8 N 0.3104 5.0377 0 0</span></span>
<span id="cb15-16"><span class="st" style="color: #20794D;">M  V30 9 C 1.2585 6.2511 0 0</span></span>
<span id="cb15-17"><span class="st" style="color: #20794D;">M  V30 10 * -3.0835 7.4884 0 0</span></span>
<span id="cb15-18"><span class="st" style="color: #20794D;">M  V30 11 [C,N,O] -3.0835 9.7984 0 0</span></span>
<span id="cb15-19"><span class="st" style="color: #20794D;">M  V30 12 * 2.7975 6.1974 0 0</span></span>
<span id="cb15-20"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb15-21"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb15-22"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb15-23"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb15-24"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb15-25"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb15-26"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb15-27"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb15-28"><span class="st" style="color: #20794D;">M  V30 7 1 7 6</span></span>
<span id="cb15-29"><span class="st" style="color: #20794D;">M  V30 8 1 5 8</span></span>
<span id="cb15-30"><span class="st" style="color: #20794D;">M  V30 9 1 8 9</span></span>
<span id="cb15-31"><span class="st" style="color: #20794D;">M  V30 10 2 7 9</span></span>
<span id="cb15-32"><span class="st" style="color: #20794D;">M  V30 11 1 10 11 ENDPTS=(2 2 1) ATTACH=ANY</span></span>
<span id="cb15-33"><span class="st" style="color: #20794D;">M  V30 12 1 9 12</span></span>
<span id="cb15-34"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb15-35"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb15-36"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb15-37"><span class="st" style="color: #20794D;">'''</span>)</span>
<span id="cb15-38">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Start by doing a tautomer-sensitive query to see how many results we get:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb16-2">matches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb16-3"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> bndl:</span>
<span id="cb16-4">    m <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(m)</span>
<span id="cb16-5">    matches.extend(sslib.GetMatches(m))</span>
<span id="cb16-6"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches'</span>)</span>
<span id="cb16-7">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb16-8"></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;"># sort the molecules by number of atoms and preserve the match ID</span></span>
<span id="cb16-10">sorted_res <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(mols,matches),key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">0</span>].GetNumAtoms())</span>
<span id="cb16-11">sorted_mols,sorted_matches <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>sorted_res)</span>
<span id="cb16-12">drawAlignedMols(sorted_mols[:<span class="dv" style="color: #AD0000;">12</span>],qry,[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> sorted_matches])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>276 matches</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now do the tautomer-insensitive version of that and show just the new molecules</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb18-2">matches2 <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb18-3"><span class="cf" style="color: #003B4F;">for</span> m <span class="kw" style="color: #003B4F;">in</span> bndl:</span>
<span id="cb18-4">    m <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(m)</span>
<span id="cb18-5">    tqry <span class="op" style="color: #5E5E5E;">=</span> rdTautomerQuery.TautomerQuery(m)</span>
<span id="cb18-6">    matches2.extend(sslib.GetMatches(tqry))</span>
<span id="cb18-7">extras <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">set</span>(matches2).difference(matches)</span>
<span id="cb18-8"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(matches2)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> matches, </span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(extras)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> are non-overlapping'</span>)</span>
<span id="cb18-9">mols <span class="op" style="color: #5E5E5E;">=</span> [sslib.GetMol(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> extras]</span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;"># sort the molecules by number of atoms and preserve the match ID</span></span>
<span id="cb18-11">sorted_res <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(<span class="bu" style="color: null;">zip</span>(mols,matches),key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">0</span>].GetNumAtoms())</span>
<span id="cb18-12">sorted_mols,sorted_matches <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>sorted_res)</span>
<span id="cb18-13">drawAlignedMols(sorted_mols[:<span class="dv" style="color: #AD0000;">12</span>],qry,[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> sorted_matches])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>288 matches, 12 are non-overlapping</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="bring-it-all-together" class="level1">
<h1>Bring it all together</h1>
<p>Now let’s put that all together in one function and include the information required to do atom highlighting in the structure drawings</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdFMCS</span>
<span id="cb20-2"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdTautomerQuery</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;"># this function does the enumeration of the queries</span></span>
<span id="cb20-5"><span class="kw" style="color: #003B4F;">def</span> getAlignedQueries(qry,tautomerInsensitive<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>):</span>
<span id="cb20-6">    <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> qry.GetNumConformers():</span>
<span id="cb20-7">        rdDepictor.Compute2DCoords(qry)</span>
<span id="cb20-8">    bndl <span class="op" style="color: #5E5E5E;">=</span> rdMolEnumerator.Enumerate(qry)</span>
<span id="cb20-9">    </span>
<span id="cb20-10">    <span class="co" style="color: #5E5E5E;"># find the MCS of the enumerated molecules:</span></span>
<span id="cb20-11">    mcs <span class="op" style="color: #5E5E5E;">=</span> rdFMCS.FindMCS(bndl)</span>
<span id="cb20-12">    qmcs <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromSmarts(mcs.smartsString)</span>
<span id="cb20-13">    </span>
<span id="cb20-14">    <span class="co" style="color: #5E5E5E;"># and now adjust the properties, generate coordinates, and create the TautomerQuery</span></span>
<span id="cb20-15">    queries <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb20-16">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> bndl:</span>
<span id="cb20-17">        q <span class="op" style="color: #5E5E5E;">=</span> Chem.AdjustQueryProperties(q)</span>
<span id="cb20-18">        rdDepictor.GenerateDepictionMatching2DStructure(q,qry,refPatt<span class="op" style="color: #5E5E5E;">=</span>qmcs)</span>
<span id="cb20-19">        <span class="cf" style="color: #003B4F;">if</span> tautomerInsensitive:</span>
<span id="cb20-20">            q <span class="op" style="color: #5E5E5E;">=</span> rdTautomerQuery.TautomerQuery(q)</span>
<span id="cb20-21">        queries.append(q)</span>
<span id="cb20-22">    <span class="cf" style="color: #003B4F;">return</span> queries</span>
<span id="cb20-23"></span>
<span id="cb20-24"></span>
<span id="cb20-25"><span class="kw" style="color: #003B4F;">def</span> generalizedSubstructureSearch(query,sslib,tautomerInsensitive<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,alignResults<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>,</span>
<span id="cb20-26">                                  maxResults<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1000</span>):</span>
<span id="cb20-27">    queries <span class="op" style="color: #5E5E5E;">=</span> getAlignedQueries(query,tautomerInsensitive<span class="op" style="color: #5E5E5E;">=</span>tautomerInsensitive)</span>
<span id="cb20-28">    matches <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb20-29">    <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> queries:</span>
<span id="cb20-30">        matches.extend(sslib.GetMatches(q,maxResults<span class="op" style="color: #5E5E5E;">=</span>maxResults))</span>
<span id="cb20-31">    tmols <span class="op" style="color: #5E5E5E;">=</span> [(x,sslib.GetMol(x)) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> matches]</span>
<span id="cb20-32">    mols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb20-33">    <span class="cf" style="color: #003B4F;">for</span> idx,mol <span class="kw" style="color: #003B4F;">in</span> <span class="bu" style="color: null;">sorted</span>(tmols,key<span class="op" style="color: #5E5E5E;">=</span><span class="kw" style="color: #003B4F;">lambda</span> x:x[<span class="dv" style="color: #AD0000;">1</span>].GetNumAtoms()):</span>
<span id="cb20-34">        match <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span>
<span id="cb20-35">        <span class="cf" style="color: #003B4F;">if</span>(alignResults):</span>
<span id="cb20-36">            <span class="cf" style="color: #003B4F;">for</span> q <span class="kw" style="color: #003B4F;">in</span> queries:</span>
<span id="cb20-37">                <span class="cf" style="color: #003B4F;">if</span> tautomerInsensitive:</span>
<span id="cb20-38">                    match <span class="op" style="color: #5E5E5E;">=</span> q.GetSubstructMatch(mol)</span>
<span id="cb20-39">                    <span class="cf" style="color: #003B4F;">if</span> match:</span>
<span id="cb20-40">                        rdDepictor.GenerateDepictionMatching2DStructure(mol,q.GetTemplateMolecule())</span>
<span id="cb20-41">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb20-42">                <span class="cf" style="color: #003B4F;">else</span>:</span>
<span id="cb20-43">                    match <span class="op" style="color: #5E5E5E;">=</span> mol.GetSubstructMatch(q)</span>
<span id="cb20-44">                    <span class="cf" style="color: #003B4F;">if</span> match:</span>
<span id="cb20-45">                        rdDepictor.GenerateDepictionMatching2DStructure(mol,q)</span>
<span id="cb20-46">                        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb20-47">                </span>
<span id="cb20-48">        mols.append((idx,mol,match))</span>
<span id="cb20-49">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(mols)<span class="op" style="color: #5E5E5E;">&gt;=</span>maxResults:</span>
<span id="cb20-50">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb20-51">    <span class="cf" style="color: #003B4F;">return</span> mols</span>
<span id="cb20-52">    </span></code></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">res <span class="op" style="color: #5E5E5E;">=</span> generalizedSubstructureSearch(qry,sslib)</span>
<span id="cb21-2">ids,mols,matchAtoms <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>res)</span>
<span id="cb21-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb21-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ids],highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matchAtoms,</span>
<span id="cb21-5">                     molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>288 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">res <span class="op" style="color: #5E5E5E;">=</span> generalizedSubstructureSearch(qry,sslib,tautomerInsensitive<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">False</span>)</span>
<span id="cb23-2">ids,mols,matchAtoms <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>res)</span>
<span id="cb23-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb23-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ids],highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matchAtoms,</span>
<span id="cb23-5">                     molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>276 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Last example, link nodes + variable attachment + tautomer enumeration</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">qry <span class="op" style="color: #5E5E5E;">=</span> Chem.MolFromMolBlock(<span class="st" style="color: #20794D;">'''</span></span>
<span id="cb25-2"><span class="st" style="color: #20794D;">  Mrv2108 08032106392D          </span></span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="st" style="color: #20794D;">  0  0  0     0  0            999 V3000</span></span>
<span id="cb25-5"><span class="st" style="color: #20794D;">M  V30 BEGIN CTAB</span></span>
<span id="cb25-6"><span class="st" style="color: #20794D;">M  V30 COUNTS 13 13 0 0 0</span></span>
<span id="cb25-7"><span class="st" style="color: #20794D;">M  V30 BEGIN ATOM</span></span>
<span id="cb25-8"><span class="st" style="color: #20794D;">M  V30 1 C -2.4167 7.8734 0 0</span></span>
<span id="cb25-9"><span class="st" style="color: #20794D;">M  V30 2 C -3.7503 7.1034 0 0</span></span>
<span id="cb25-10"><span class="st" style="color: #20794D;">M  V30 3 C -3.7503 5.5633 0 0</span></span>
<span id="cb25-11"><span class="st" style="color: #20794D;">M  V30 4 N -2.4167 4.7933 0 0</span></span>
<span id="cb25-12"><span class="st" style="color: #20794D;">M  V30 5 C -1.083 5.5633 0 0</span></span>
<span id="cb25-13"><span class="st" style="color: #20794D;">M  V30 6 C -1.083 7.1034 0 0</span></span>
<span id="cb25-14"><span class="st" style="color: #20794D;">M  V30 7 N 0.3973 7.5279 0 0</span></span>
<span id="cb25-15"><span class="st" style="color: #20794D;">M  V30 8 N 0.3104 5.0377 0 0</span></span>
<span id="cb25-16"><span class="st" style="color: #20794D;">M  V30 9 C 1.2585 6.2511 0 0</span></span>
<span id="cb25-17"><span class="st" style="color: #20794D;">M  V30 10 * -3.0835 7.4884 0 0</span></span>
<span id="cb25-18"><span class="st" style="color: #20794D;">M  V30 11 [C,N,O] -3.0835 9.7984 0 0</span></span>
<span id="cb25-19"><span class="st" style="color: #20794D;">M  V30 12 * 2.7975 6.1974 0 0</span></span>
<span id="cb25-20"><span class="st" style="color: #20794D;">M  V30 13 N 3.6136 7.5033 0 0</span></span>
<span id="cb25-21"><span class="st" style="color: #20794D;">M  V30 END ATOM</span></span>
<span id="cb25-22"><span class="st" style="color: #20794D;">M  V30 BEGIN BOND</span></span>
<span id="cb25-23"><span class="st" style="color: #20794D;">M  V30 1 1 1 2</span></span>
<span id="cb25-24"><span class="st" style="color: #20794D;">M  V30 2 2 2 3</span></span>
<span id="cb25-25"><span class="st" style="color: #20794D;">M  V30 3 1 3 4</span></span>
<span id="cb25-26"><span class="st" style="color: #20794D;">M  V30 4 2 4 5</span></span>
<span id="cb25-27"><span class="st" style="color: #20794D;">M  V30 5 1 5 6</span></span>
<span id="cb25-28"><span class="st" style="color: #20794D;">M  V30 6 2 1 6</span></span>
<span id="cb25-29"><span class="st" style="color: #20794D;">M  V30 7 1 7 6</span></span>
<span id="cb25-30"><span class="st" style="color: #20794D;">M  V30 8 1 5 8</span></span>
<span id="cb25-31"><span class="st" style="color: #20794D;">M  V30 9 1 8 9</span></span>
<span id="cb25-32"><span class="st" style="color: #20794D;">M  V30 10 2 7 9</span></span>
<span id="cb25-33"><span class="st" style="color: #20794D;">M  V30 11 1 10 11 ENDPTS=(3 3 2 1) ATTACH=ANY</span></span>
<span id="cb25-34"><span class="st" style="color: #20794D;">M  V30 12 1 9 12</span></span>
<span id="cb25-35"><span class="st" style="color: #20794D;">M  V30 13 1 12 13</span></span>
<span id="cb25-36"><span class="st" style="color: #20794D;">M  V30 END BOND</span></span>
<span id="cb25-37"><span class="st" style="color: #20794D;">M  V30 LINKNODE 1 3 2 12 9 12 13</span></span>
<span id="cb25-38"><span class="st" style="color: #20794D;">M  V30 END CTAB</span></span>
<span id="cb25-39"><span class="st" style="color: #20794D;">M  END</span></span>
<span id="cb25-40"><span class="st" style="color: #20794D;">'''</span>)</span>
<span id="cb25-41">qry</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">res <span class="op" style="color: #5E5E5E;">=</span> generalizedSubstructureSearch(qry,sslib)</span>
<span id="cb26-2">ids,mols,matchAtoms <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>res)</span>
<span id="cb26-3"><span class="bu" style="color: null;">print</span>(<span class="ss" style="color: #20794D;">f'</span><span class="sc" style="color: #5E5E5E;">{</span><span class="bu" style="color: null;">len</span>(mols)<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;"> results'</span>)</span>
<span id="cb26-4">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ids],highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matchAtoms,</span>
<span id="cb26-5">                     molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>24 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-17-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Image for the blog post summary:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">keep <span class="op" style="color: #5E5E5E;">=</span> [<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">4</span>,<span class="dv" style="color: #AD0000;">6</span>]</span>
<span id="cb28-2">ids,mols,matchAtoms <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">zip</span>(<span class="op" style="color: #5E5E5E;">*</span>[res[x] <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> keep])</span>
<span id="cb28-3">Draw.MolsToGridImage(mols[:<span class="dv" style="color: #AD0000;">12</span>],legends<span class="op" style="color: #5E5E5E;">=</span>[<span class="bu" style="color: null;">str</span>(x) <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> ids],highlightAtomLists<span class="op" style="color: #5E5E5E;">=</span>matchAtoms,</span>
<span id="cb28-4">                    molsPerRow<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span>,subImgSize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">300</span>,<span class="dv" style="color: #AD0000;">250</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>substructure</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-08-03-generalized-substructure-search.html</guid>
  <pubDate>Mon, 02 Aug 2021 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/generalized-substructure-search1-2.png" medium="image" type="image/png" height="120" width="144"/>
</item>
<item>
  <title>Using the RDKit in a C++ program</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-07-24-setting-up-a-cxx-dev-env.html</link>
  <description><![CDATA[ 



<p><em>Note:</em> the instructions in this blog post currently only work on linux systems. There’s a configuration problem with the way we use cmake on the Mac and Windows that needs to be cleared up. I will update the post after that’s done.</p>
<p>Last week I (re)discoverered that it’s pretty easy to use the RDKit in other C++ projects. This is obviously somthing that’s possible, but I thought of it as being something of a pain. It turns out that it’s not, as I hope to show you in this post.</p>
<p>I started by setting up a fresh conda environment and grabbing an RDKit build from conda-forge, this is a bit heavyweight since you end up with a bunch of python packages as well as the RDKit itself (I’m going to look into making this more minimal), but it’s much easier than doing your own build.</p>
<p>The first thing is to set up a conda environment:</p>
<pre><code>conda create -n rdkit_dev
conda activate rdkit_dev
conda install -c conda-forge mamba
mamba install -c conda-forge cmake rdkit eigen</code></pre>
<p>Note: I start by installing <a href="https://github.com/mamba-org/mamba">mamba</a> here because it makes doing conda installs much, much faster.</p>
<p>Here’s a simple demo program which reads in a set of molecules from an input file and generates tautomer hashes for them. It uses the <code>boost::timer</code> library in order to separately time how long it takes to read the molecules and generate the hashes. I called this file <code>tautomer_hash.cpp</code>:</p>
<pre><code>#include &lt;GraphMol/FileParsers/MolSupplier.h&gt;
#include &lt;GraphMol/MolHash/MolHash.h&gt;
#include &lt;GraphMol/RDKitBase.h&gt;
#include &lt;RDGeneral/RDLog.h&gt;
#include &lt;algorithm&gt;
#include &lt;boost/timer/timer.hpp&gt;
#include &lt;iostream&gt;
#include &lt;vector&gt;

using namespace RDKit;

void readmols(std::string pathName, unsigned int maxToDo,
              std::vector&lt;RWMOL_SPTR&gt; &amp;mols) {
  boost::timer::auto_cpu_timer t;
  // using a supplier without sanitizing the molecules...
  RDKit::SmilesMolSupplier suppl(pathName, " \t", 1, 0, true, false);
  unsigned int nDone = 0;
  while (!suppl.atEnd() &amp;&amp; (maxToDo &lt;= 0 || nDone &lt; maxToDo)) {
    RDKit::ROMol *m = suppl.next();
    if (!m) {
      continue;
    }
    m-&gt;updatePropertyCache();
    // the tautomer hash code uses conjugation info
    MolOps::setConjugation(*m);
    nDone += 1;
    mols.push_back(RWMOL_SPTR((RWMol *)m));
  }
  std::cerr &lt;&lt; "read: " &lt;&lt; nDone &lt;&lt; " mols." &lt;&lt; std::endl;
}

void generatehashes(const std::vector&lt;RWMOL_SPTR&gt; &amp;mols) {
  boost::timer::auto_cpu_timer t;
  for (auto &amp;mol : mols) {
    auto hash =
        MolHash::MolHash(mol.get(), MolHash::HashFunction::HetAtomTautomer);
  }
}
int main(int argc, char *argv[]) {
  RDLog::InitLogs();
  std::vector&lt;RWMOL_SPTR&gt; mols;
  BOOST_LOG(rdInfoLog) &lt;&lt; "read mols" &lt;&lt; std::endl;

  readmols(argv[1], 10000, mols);
  BOOST_LOG(rdInfoLog) &lt;&lt; "generate hashes" &lt;&lt; std::endl;
  generatehashes(mols);

  BOOST_LOG(rdInfoLog) &lt;&lt; "done " &lt;&lt; std::endl;
}</code></pre>
<p>This is a pretty crappy program since it doesn’t do much error checking, but the purpose here is to demonstrate how to get the environment setup, not to teach how to write nice C++ programs. :-)</p>
<p>The way to make the build easy is to use cmake to set everything up, so I need a <code>CMakeLists.txt</code> file that defines my executable and its RDKit dependencies:</p>
<pre><code>cmake_minimum_required(VERSION 3.18)

project(simple_cxx_example)
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED True)


find_package(RDKit REQUIRED)
find_package(Boost COMPONENTS timer system REQUIRED)
add_executable(tautomer_hash tautomer_hash.cpp)
target_link_libraries(tautomer_hash RDKit::SmilesParse RDKit::MolHash
   Boost::timer)</code></pre>
<p>This tells cmake to find the RDKit and boost installs (which “just works” since cmake, boost, and the RDKit were all installed from conda), defines the executable I want to create, and then lists the RDKit and boost libraries I use. And that is pretty much that.</p>
<p>Now I create a build dir, run <code>cmake</code> to setup the build, and run <code>make</code> to actually build my program:</p>
<pre><code>(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example$ mkdir build
(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example$ cd build
(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example/build$ cmake ..
-- The C compiler identification is GNU 9.3.0
-- The CXX compiler identification is GNU 9.3.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Looking for pthread.h
-- Looking for pthread.h - found
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD - Failed
-- Looking for pthread_create in pthreads
-- Looking for pthread_create in pthreads - not found
-- Looking for pthread_create in pthread
-- Looking for pthread_create in pthread - found
-- Found Threads: TRUE  
-- Found Boost: /home/glandrum/miniconda3/envs/rdkit_dev/lib/cmake/Boost-1.74.0/BoostConfig.cmake (found suitable version "1.74.0", minimum required is "1.74.0")  
-- Found Boost: /home/glandrum/miniconda3/envs/rdkit_dev/lib/cmake/Boost-1.74.0/BoostConfig.cmake (found version "1.74.0") found components: timer system 
-- Configuring done
-- Generating done
-- Build files have been written to: /home/glandrum/RDKit_blog/src/simple_cxx_example/build
(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example/build$ make tautomer_hash
[ 50%] Building CXX object CMakeFiles/tautomer_hash.dir/tautomer_hash.cpp.o
[100%] Linking CXX executable tautomer_hash
[100%] Built target tautomer_hash</code></pre>
<p>And now I can run the program:</p>
<pre><code>(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example/build$ ./tautomer_hash /scratch/RDKit_git/Code/Profiling/GraphMol/chembl23_very_active.txt
[07:51:33] read mols
read: 10000 mols.
 0.819242s wall, 0.740000s user + 0.070000s system = 0.810000s CPU (98.9%)
[07:51:33] generate hashes
 0.872662s wall, 0.870000s user + 0.010000s system = 0.880000s CPU (100.8%)
[07:51:34] done 
(rdkit_dev) glandrum@Badger:~/RDKit_blog/src/simple_cxx_example/build$ </code></pre>
<p>If you don’t feel like copy/pasting, the source files for this post are <a href="https://github.com/greglandrum/rdkit_blog/tree/master/src/simple_cxx_example">available from github</a>.</p>
<p>This all works so nicely because of the time and effort Riccardo Vianello invested a few years ago to improve the RDKit’s cmake integration.</p>
<p>Next step: add this to the documentation!</p>



 ]]></description>
  <category>tutorial</category>
  <category>technical</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-07-24-setting-up-a-cxx-dev-env.html</guid>
  <pubDate>Fri, 23 Jul 2021 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Looking at the number of bits set by different fingerprints</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2021-07-06-number-of-fp-bits-set.html</link>
  <description><![CDATA[ 



<p>This is an updated version of a post. The original version of the notebook can be <a href="https://github.com/greglandrum/rdkit_blog/blob/eae1643d2ad4788f9f1942ea681e9c001931e418/notebooks/Bits%20Set%20By%20Fingerprint%20Type.ipynb">found in github</a>.</p>
<p>I’ve done a number of posts looking at Morgan fingerprint statistics before, including:</p>
<ul>
<li><a href="https://rdkit.blogspot.ch/2014/02/colliding-bits.html">The number of collisions in Morgan fingerprints</a>.</li>
<li><a href="https://rdkit.blogspot.ch/2016/02/morgan-fingerprint-bit-statistics.html">Morgan fingerprint stats</a></li>
<li><a href="https://rdkit.blogspot.com/2016/02/colliding-bits-iii.html">Collisions in Morgan fingerprints revisited</a></li>
</ul>
<p>I have done similar analysis for other fingerprint types, but it looks like I didn’t post that (at least I can’t find it if I did). It’s useful to do this because, as we’ll see, the different fingerprint types have <em>very</em> different numbers of bits set for typical molecules.</p>
<p>Here’s the summary of the mean and standard deviation of the number of bits set, from an analysis of 5 million molecules with less than 50 heavy atoms extracted from ZINC:</p>
<table class="table">
<thead>
<tr class="header">
<th>Fingerprint</th>
<th>Type</th>
<th>Mean num_bits</th>
<th>SD num_bits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Morgan1</td>
<td>sparse</td>
<td>29.4</td>
<td>5.6</td>
</tr>
<tr class="even">
<td>Morgan2</td>
<td>sparse</td>
<td>48.7</td>
<td>9.6</td>
</tr>
<tr class="odd">
<td>Morgan3</td>
<td>sparse</td>
<td>66.8</td>
<td>13.8</td>
</tr>
<tr class="even">
<td>FeatMorgan1</td>
<td>sparse</td>
<td>20.1</td>
<td>3.9</td>
</tr>
<tr class="odd">
<td>FeatMorgan2</td>
<td>sparse</td>
<td>38.1</td>
<td>7.7</td>
</tr>
<tr class="even">
<td>FeatMorgan3</td>
<td>sparse</td>
<td>56.0</td>
<td>11.8</td>
</tr>
<tr class="odd">
<td>RDKit5</td>
<td>bitvect</td>
<td>363</td>
<td>122</td>
</tr>
<tr class="even">
<td>RDKit6</td>
<td>bitvect</td>
<td>621</td>
<td>233</td>
</tr>
<tr class="odd">
<td>RDKit7</td>
<td>bitvect</td>
<td>993</td>
<td>406</td>
</tr>
<tr class="even">
<td>pattern</td>
<td>bitvect</td>
<td>446</td>
<td>122</td>
</tr>
<tr class="odd">
<td>avalon</td>
<td>bitvect</td>
<td>280</td>
<td>130</td>
</tr>
<tr class="even">
<td>atom pairs</td>
<td>sparse</td>
<td>167</td>
<td>56</td>
</tr>
<tr class="odd">
<td>TT</td>
<td>sparse</td>
<td>33.4</td>
<td>9.8</td>
</tr>
<tr class="even">
<td>atom pairs</td>
<td>bitvect</td>
<td>267</td>
<td>90</td>
</tr>
<tr class="odd">
<td>TT</td>
<td>bitvect</td>
<td>47.2</td>
<td>12.0</td>
</tr>
</tbody>
</table>
<p>The bit vector fingerprints were all 4096 bits long.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> Chem,DataStructs</span>
<span id="cb1-2"><span class="im" style="color: #00769E;">import</span> time,random,gzip,pickle,copy</span>
<span id="cb1-3"><span class="im" style="color: #00769E;">import</span> numpy <span class="im" style="color: #00769E;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;">from</span> collections <span class="im" style="color: #00769E;">import</span> Counter,defaultdict</span>
<span id="cb1-5"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> Draw</span>
<span id="cb1-6"><span class="im" style="color: #00769E;">from</span> rdkit.Chem <span class="im" style="color: #00769E;">import</span> rdMolDescriptors</span>
<span id="cb1-7"><span class="im" style="color: #00769E;">from</span> rdkit.Avalon <span class="im" style="color: #00769E;">import</span> pyAvalonTools</span>
<span id="cb1-8"><span class="im" style="color: #00769E;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;">import</span> IPythonConsole</span>
<span id="cb1-9"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> DataStructs</span>
<span id="cb1-10"><span class="im" style="color: #00769E;">from</span> rdkit <span class="im" style="color: #00769E;">import</span> rdBase</span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;">%</span>pylab inline</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="bu" style="color: null;">print</span>(rdBase.rdkitVersion)</span>
<span id="cb1-14"><span class="im" style="color: #00769E;">import</span> time</span>
<span id="cb1-15"><span class="bu" style="color: null;">print</span>(time.asctime())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Populating the interactive namespace from numpy and matplotlib
2021.09.1pre
Tue Jul  6 04:58:28 2021</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/glandrum/miniconda3/lib/python3.7/site-packages/IPython/core/magics/pylab.py:160: UserWarning: pylab import has clobbered these variables: ['copy', 'random']
`%matplotlib` prevents importing * from pylab and numpy
  "\n`%matplotlib` prevents importing * from pylab and numpy"</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb4-2">    <span class="im" style="color: #00769E;">import</span> ipyparallel <span class="im" style="color: #00769E;">as</span> ipp</span>
<span id="cb4-3">    rc <span class="op" style="color: #5E5E5E;">=</span> ipp.Client()</span>
<span id="cb4-4">    dview <span class="op" style="color: #5E5E5E;">=</span> rc[:]</span>
<span id="cb4-5">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit import Chem'</span>)</span>
<span id="cb4-6">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit import Descriptors'</span>)</span>
<span id="cb4-7">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit.Chem import rdMolDescriptors'</span>)</span>
<span id="cb4-8">    dview.execute(<span class="st" style="color: #20794D;">'from rdkit.Avalon import pyAvalonTools'</span>)</span>
<span id="cb4-9"><span class="cf" style="color: #003B4F;">except</span>:</span>
<span id="cb4-10">    <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"could not use ipyparallel"</span>)</span>
<span id="cb4-11">    dview <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">None</span></span></code></pre></div>
</div>
<p>For test data I’ll use the same 16 million ZINC compounds I used in the <a href="https://rdkit.blogspot.ch/2016/02/morgan-fingerprint-bit-statistics.html">bit statistics post</a>.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">filen<span class="op" style="color: #5E5E5E;">=</span><span class="st" style="color: #20794D;">'/scratch/RDKit_git/LocalData/Zinc/zinc_all_clean.pkl.gz'</span></span></code></pre></div>
</div>
<p>Loop over the molecules, skip anything with more than 50 atoms, and build fingerprints for all the others.</p>
<p>The fingerprints I generate for this analysis are: - Sparse Morgan with radii 1, 2, and 3 - Sparse FeatureMorgan with radii 1, 2, and 3 - RDKit BitVect with maxPath 5, 6, and 7 - Pattern BitVect - Avalon BitVect - Sparse Atom Pairs - Sparse Topological Torsions - Atom Pair BitVect - Topological Torsion BitVect</p>
<p>All of the BitVect fingerprints are 4096 bits long</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;">import</span> copy</span>
<span id="cb6-2"></span>
<span id="cb6-3">historyf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.history.pkl.gz'</span>,<span class="st" style="color: #20794D;">'wb+'</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5">counts<span class="op" style="color: #5E5E5E;">=</span>defaultdict(Counter)</span>
<span id="cb6-6">t1 <span class="op" style="color: #5E5E5E;">=</span> time.time()</span>
<span id="cb6-7"><span class="cf" style="color: #003B4F;">with</span> gzip.<span class="bu" style="color: null;">open</span>(filen,<span class="st" style="color: #20794D;">'rb'</span>) <span class="im" style="color: #00769E;">as</span> inf:</span>
<span id="cb6-8">    i <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb6-9">    ms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-10">    <span class="cf" style="color: #003B4F;">while</span> <span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb6-11">        <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb6-12">            m,nm <span class="op" style="color: #5E5E5E;">=</span> pickle.load(inf)</span>
<span id="cb6-13">        <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb6-14">            <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb6-15">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> m <span class="kw" style="color: #003B4F;">or</span> m.GetNumHeavyAtoms()<span class="op" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">50</span>: <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb6-16">        ms.append(m)</span>
<span id="cb6-17">        i<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-18">        <span class="cf" style="color: #003B4F;">if</span> <span class="bu" style="color: null;">len</span>(ms)<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">10000</span>:</span>
<span id="cb6-19">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>:</span>
<span id="cb6-20">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">len</span>(rdMolDescriptors.GetMorganFingerprint(x,v).GetNonzeroElements()),</span>
<span id="cb6-21">                                     ms)</span>
<span id="cb6-22">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-23">                    counts[(<span class="st" style="color: #20794D;">'Morgan'</span>,v)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-24">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>:</span>
<span id="cb6-25">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:<span class="bu" style="color: null;">len</span>(rdMolDescriptors.GetMorganFingerprint(x,v,useFeatures<span class="op" style="color: #5E5E5E;">=</span><span class="va" style="color: #111111;">True</span>).GetNonzeroElements()),</span>
<span id="cb6-26">                                     ms)</span>
<span id="cb6-27">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-28">                    counts[(<span class="st" style="color: #20794D;">'FeatMorgan'</span>,v)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-29">            <span class="cf" style="color: #003B4F;">for</span> v <span class="kw" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">5</span>,<span class="dv" style="color: #AD0000;">6</span>,<span class="dv" style="color: #AD0000;">7</span>:</span>
<span id="cb6-30">                cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x,v<span class="op" style="color: #5E5E5E;">=</span>v:Chem.RDKFingerprint(x,maxPath<span class="op" style="color: #5E5E5E;">=</span>v,fpSize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4096</span>).GetNumOnBits(),</span>
<span id="cb6-31">                                      ms)</span>
<span id="cb6-32">                <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-33">                    counts[(<span class="st" style="color: #20794D;">'RDKit'</span>,v)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-34">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:Chem.PatternFingerprint(x,fpSize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4096</span>).GetNumOnBits(),</span>
<span id="cb6-35">                                  ms)</span>
<span id="cb6-36">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-37">                counts[(<span class="st" style="color: #20794D;">'pattern'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-38">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:pyAvalonTools.GetAvalonFP(x,nBits<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4096</span>).GetNumOnBits(),</span>
<span id="cb6-39">                                  ms)</span>
<span id="cb6-40">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-41">                counts[(<span class="st" style="color: #20794D;">'avalon'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-42">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:<span class="bu" style="color: null;">len</span>(rdMolDescriptors.GetAtomPairFingerprint(x).GetNonzeroElements()),</span>
<span id="cb6-43">                                  ms)</span>
<span id="cb6-44">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-45">                counts[(<span class="st" style="color: #20794D;">'ap-counts'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-46">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:<span class="bu" style="color: null;">len</span>(rdMolDescriptors.GetTopologicalTorsionFingerprint(x).GetNonzeroElements()),</span>
<span id="cb6-47">                                  ms)</span>
<span id="cb6-48">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-49">                counts[(<span class="st" style="color: #20794D;">'tt-counts'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-50">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:rdMolDescriptors.GetHashedAtomPairFingerprintAsBitVect(x,nBits<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4096</span>).GetNumOnBits(),</span>
<span id="cb6-51">                                  ms)</span>
<span id="cb6-52">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-53">                counts[(<span class="st" style="color: #20794D;">'ap-bv'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-54">            cnts <span class="op" style="color: #5E5E5E;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;">lambda</span> x:rdMolDescriptors.GetHashedTopologicalTorsionFingerprintAsBitVect(x,nBits<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">4096</span>).GetNumOnBits(),</span>
<span id="cb6-55">                                  ms)</span>
<span id="cb6-56">            <span class="cf" style="color: #003B4F;">for</span> obc <span class="kw" style="color: #003B4F;">in</span> cnts:</span>
<span id="cb6-57">                counts[(<span class="st" style="color: #20794D;">'tt-bv'</span>,<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)][obc]<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-58">            ms <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb6-59">            </span>
<span id="cb6-60">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> i<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">50000</span>:</span>
<span id="cb6-61">            t2 <span class="op" style="color: #5E5E5E;">=</span> time.time()</span>
<span id="cb6-62">            <span class="bu" style="color: null;">print</span>(<span class="st" style="color: #20794D;">"Done </span><span class="sc" style="color: #5E5E5E;">%d</span><span class="st" style="color: #20794D;"> in </span><span class="sc" style="color: #5E5E5E;">%.2f</span><span class="st" style="color: #20794D;"> sec"</span><span class="op" style="color: #5E5E5E;">%</span>(i,t2<span class="op" style="color: #5E5E5E;">-</span>t1))</span>
<span id="cb6-63">        <span class="cf" style="color: #003B4F;">if</span> <span class="kw" style="color: #003B4F;">not</span> i<span class="op" style="color: #5E5E5E;">%</span><span class="dv" style="color: #AD0000;">500000</span>:</span>
<span id="cb6-64">            pickle.dump(<span class="bu" style="color: null;">dict</span>(counts),historyf)</span>
<span id="cb6-65">        <span class="cf" style="color: #003B4F;">if</span> i<span class="op" style="color: #5E5E5E;">&gt;=</span><span class="dv" style="color: #AD0000;">5000000</span>:</span>
<span id="cb6-66">            <span class="cf" style="color: #003B4F;">break</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done 50000 in 38.63 sec
Done 100000 in 77.02 sec
Done 150000 in 115.17 sec
Done 200000 in 163.61 sec
Done 250000 in 215.39 sec
Done 300000 in 267.96 sec
Done 350000 in 319.74 sec
Done 400000 in 373.11 sec
Done 450000 in 415.37 sec
Done 500000 in 468.50 sec
Done 550000 in 526.23 sec
Done 600000 in 570.65 sec
Done 650000 in 622.83 sec
Done 700000 in 674.11 sec
Done 750000 in 724.71 sec
Done 800000 in 775.76 sec
Done 850000 in 823.44 sec
Done 900000 in 873.37 sec
Done 950000 in 922.91 sec
Done 1000000 in 971.03 sec
Done 1050000 in 1019.84 sec
Done 1100000 in 1068.24 sec
Done 1150000 in 1116.11 sec
Done 1200000 in 1164.39 sec
Done 1250000 in 1211.31 sec
Done 1300000 in 1255.67 sec
Done 1350000 in 1306.25 sec
Done 1400000 in 1356.04 sec
Done 1450000 in 1402.95 sec
Done 1500000 in 1453.38 sec
Done 1550000 in 1500.31 sec
Done 1600000 in 1546.90 sec
Done 1650000 in 1593.48 sec
Done 1700000 in 1640.38 sec
Done 1750000 in 1696.32 sec
Done 1800000 in 1750.83 sec
Done 1850000 in 1810.42 sec
Done 1900000 in 1868.12 sec
Done 1950000 in 1926.07 sec
Done 2000000 in 1983.37 sec
Done 2050000 in 2043.56 sec
Done 2100000 in 2102.81 sec
Done 2150000 in 2160.67 sec
Done 2200000 in 2218.30 sec
Done 2250000 in 2272.73 sec
Done 2300000 in 2323.77 sec
Done 2350000 in 2375.39 sec
Done 2400000 in 2427.04 sec
Done 2450000 in 2481.36 sec
Done 2500000 in 2536.57 sec
Done 2550000 in 2591.71 sec
Done 2600000 in 2644.06 sec
Done 2650000 in 2698.32 sec
Done 2700000 in 2752.86 sec
Done 2750000 in 2805.41 sec
Done 2800000 in 2856.95 sec
Done 2850000 in 2909.60 sec
Done 2900000 in 2965.05 sec
Done 2950000 in 3021.72 sec
Done 3000000 in 3073.35 sec
Done 3050000 in 3127.90 sec
Done 3100000 in 3177.67 sec
Done 3150000 in 3234.92 sec
Done 3200000 in 3288.20 sec
Done 3250000 in 3341.28 sec
Done 3300000 in 3393.97 sec
Done 3350000 in 3446.92 sec
Done 3400000 in 3499.45 sec
Done 3450000 in 3549.88 sec
Done 3500000 in 3601.67 sec
Done 3550000 in 3653.41 sec
Done 3600000 in 3705.95 sec
Done 3650000 in 3759.37 sec
Done 3700000 in 3810.11 sec
Done 3750000 in 3861.68 sec
Done 3800000 in 3912.28 sec
Done 3850000 in 3965.28 sec
Done 3900000 in 4022.67 sec
Done 3950000 in 4077.32 sec
Done 4000000 in 4129.91 sec
Done 4050000 in 4185.33 sec
Done 4100000 in 4240.67 sec
Done 4150000 in 4287.86 sec
Done 4200000 in 4340.04 sec
Done 4250000 in 4391.57 sec
Done 4300000 in 4443.67 sec
Done 4350000 in 4493.96 sec
Done 4400000 in 4545.53 sec
Done 4450000 in 4592.16 sec
Done 4500000 in 4640.05 sec
Done 4550000 in 4687.30 sec
Done 4600000 in 4733.79 sec
Done 4650000 in 4780.85 sec
Done 4700000 in 4828.29 sec
Done 4750000 in 4878.40 sec
Done 4800000 in 4927.55 sec
Done 4850000 in 4984.36 sec
Done 4900000 in 5042.20 sec
Done 4950000 in 5101.82 sec
Done 5000000 in 5154.32 sec</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">pickle.dump(<span class="bu" style="color: null;">dict</span>(counts),gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.pkl.gz'</span>,<span class="st" style="color: #20794D;">'wb+'</span>))</span></code></pre></div>
</div>
<p>Now plot the distributions of the number of bits set</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">morgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Morgan'</span>]</span>
<span id="cb9-2">featmorgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'FeatMorgan'</span>]</span>
<span id="cb9-3">rdkit_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit'</span>]</span>
<span id="cb9-4"></span>
<span id="cb9-5">figure(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">15</span>,<span class="dv" style="color: #AD0000;">15</span>))</span>
<span id="cb9-6"></span>
<span id="cb9-7">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb9-8">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb9-9"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> morgan_ks:</span>
<span id="cb9-10">    cnts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(counts[(n,r)].items())</span>
<span id="cb9-11">    </span>
<span id="cb9-12">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb9-13">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb9-14">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"Morgan"</span>)</span>
<span id="cb9-15">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num bits set"</span>)</span>
<span id="cb9-16">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb9-17">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb9-18"></span>
<span id="cb9-19">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb9-20">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb9-21"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> featmorgan_ks:</span>
<span id="cb9-22">    cnts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(counts[(n,r)].items())</span>
<span id="cb9-23">    </span>
<span id="cb9-24">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb9-25">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb9-26">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"FeatMorgan"</span>)</span>
<span id="cb9-27">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num bits set"</span>)</span>
<span id="cb9-28">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb9-29">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb9-30"></span>
<span id="cb9-31">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span></span>
<span id="cb9-32">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb9-33"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkit_ks:</span>
<span id="cb9-34">    cnts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(counts[(n,r)].items())</span>
<span id="cb9-35">    </span>
<span id="cb9-36">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],label<span class="op" style="color: #5E5E5E;">=</span></span>
<span id="cb9-37">        <span class="ss" style="color: #20794D;">f"r=</span><span class="sc" style="color: #5E5E5E;">{</span>r<span class="sc" style="color: #5E5E5E;">}</span><span class="ss" style="color: #20794D;">"</span>)</span>
<span id="cb9-38">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit"</span>)</span>
<span id="cb9-39">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num bits set"</span>)</span>
<span id="cb9-40">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb9-41">_<span class="op" style="color: #5E5E5E;">=</span>legend()</span>
<span id="cb9-42"></span>
<span id="cb9-43"><span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> counts.keys():</span>
<span id="cb9-44">    <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">0</span>] <span class="kw" style="color: #003B4F;">in</span> (<span class="st" style="color: #20794D;">'Morgan'</span>,<span class="st" style="color: #20794D;">'FeatMorgan'</span>,<span class="st" style="color: #20794D;">'RDKit'</span>):</span>
<span id="cb9-45">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb9-46">    pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb9-47">    subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb9-48">    cnts <span class="op" style="color: #5E5E5E;">=</span> <span class="bu" style="color: null;">sorted</span>(counts[k].items())</span>
<span id="cb9-49">    plot([x <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts],[y <span class="cf" style="color: #003B4F;">for</span> x,y <span class="kw" style="color: #003B4F;">in</span> cnts])</span>
<span id="cb9-50">    _<span class="op" style="color: #5E5E5E;">=</span>title(k[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb9-51">    _<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num bits set"</span>)</span>
<span id="cb9-52">    _<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb9-53">   </span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-07-06-number-of-fp-bits-set_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The avalon FP curve has an interesting shape</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="cf" style="color: #003B4F;">for</span> k,cnts <span class="kw" style="color: #003B4F;">in</span> counts.items():</span>
<span id="cb10-2">    accum <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb10-3">    denom <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb10-4">    <span class="cf" style="color: #003B4F;">for</span> cnt,num <span class="kw" style="color: #003B4F;">in</span> cnts.items():</span>
<span id="cb10-5">        accum <span class="op" style="color: #5E5E5E;">+=</span> cnt<span class="op" style="color: #5E5E5E;">*</span>num</span>
<span id="cb10-6">        denom <span class="op" style="color: #5E5E5E;">+=</span> num</span>
<span id="cb10-7">    mean <span class="op" style="color: #5E5E5E;">=</span> accum<span class="op" style="color: #5E5E5E;">/</span>denom</span>
<span id="cb10-8">    dev <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb10-9">    <span class="cf" style="color: #003B4F;">for</span> cnt,num <span class="kw" style="color: #003B4F;">in</span> cnts.items():</span>
<span id="cb10-10">        dev <span class="op" style="color: #5E5E5E;">+=</span> num<span class="op" style="color: #5E5E5E;">*</span>(cnt<span class="op" style="color: #5E5E5E;">-</span>mean)<span class="op" style="color: #5E5E5E;">**</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb10-11">    dev <span class="op" style="color: #5E5E5E;">/=</span> (denom<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-12">    dev <span class="op" style="color: #5E5E5E;">=</span> dev<span class="op" style="color: #5E5E5E;">**</span><span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb10-13">    label <span class="op" style="color: #5E5E5E;">=</span> k[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb10-14">    <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">1</span>]<span class="op" style="color: #5E5E5E;">!=-</span><span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb10-15">        label <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">str</span>(k[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb10-16">        </span>
<span id="cb10-17">    <span class="bu" style="color: null;">print</span>(label,<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\t</span><span class="sc" style="color: #5E5E5E;">%.1f</span><span class="st" style="color: #20794D;">'</span><span class="op" style="color: #5E5E5E;">%</span>mean,<span class="st" style="color: #20794D;">'</span><span class="sc" style="color: #5E5E5E;">%.1f</span><span class="st" style="color: #20794D;">'</span><span class="op" style="color: #5E5E5E;">%</span>dev)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Morgan1     29.4 5.6
Morgan2     48.7 9.6
Morgan3     66.8 13.8
FeatMorgan1     20.1 3.9
FeatMorgan2     38.1 7.7
FeatMorgan3     56.0 11.8
RDKit5  363.3 122.5
RDKit6  621.7 233.2
RDKit7  993.6 406.3
pattern     445.5 122.5
avalon  279.8 129.9
ap-counts   166.6 56.3
tt-counts   33.4 9.8
ap-bv   267.3 90.0
tt-bv   47.2 12.0</code></pre>
</div>
</div>
<section id="convergence" class="level1">
<h1>Convergence</h1>
<p>I did 5 million examples, which took a while (about 1.5 hours with 6 worker processes on my PC). Could I have analyzed less and gotten to the same results? Did the means converge? If so, how quickly?</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">historyf <span class="op" style="color: #5E5E5E;">=</span> gzip.<span class="bu" style="color: null;">open</span>(<span class="st" style="color: #20794D;">'../data/fp_bit_counts.history.pkl.gz'</span>,<span class="st" style="color: #20794D;">'rb'</span>)</span>
<span id="cb12-2">means <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb12-3">devs <span class="op" style="color: #5E5E5E;">=</span> defaultdict(<span class="bu" style="color: null;">list</span>)</span>
<span id="cb12-4">nmols <span class="op" style="color: #5E5E5E;">=</span> []</span>
<span id="cb12-5"><span class="cf" style="color: #003B4F;">while</span> <span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb12-6">    <span class="cf" style="color: #003B4F;">try</span>:</span>
<span id="cb12-7">        lcounts <span class="op" style="color: #5E5E5E;">=</span> pickle.load(historyf)</span>
<span id="cb12-8">    <span class="cf" style="color: #003B4F;">except</span> <span class="pp" style="color: #AD0000;">EOFError</span>:</span>
<span id="cb12-9">        <span class="cf" style="color: #003B4F;">break</span></span>
<span id="cb12-10">    <span class="cf" style="color: #003B4F;">for</span> k,cnts <span class="kw" style="color: #003B4F;">in</span> lcounts.items():</span>
<span id="cb12-11">        accum <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-12">        denom <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-13">        <span class="cf" style="color: #003B4F;">for</span> cnt,num <span class="kw" style="color: #003B4F;">in</span> cnts.items():</span>
<span id="cb12-14">            accum <span class="op" style="color: #5E5E5E;">+=</span> cnt<span class="op" style="color: #5E5E5E;">*</span>num</span>
<span id="cb12-15">            denom <span class="op" style="color: #5E5E5E;">+=</span> num</span>
<span id="cb12-16">        mean <span class="op" style="color: #5E5E5E;">=</span> accum<span class="op" style="color: #5E5E5E;">/</span>denom</span>
<span id="cb12-17">        dev <span class="op" style="color: #5E5E5E;">=</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb12-18">        <span class="cf" style="color: #003B4F;">for</span> cnt,num <span class="kw" style="color: #003B4F;">in</span> cnts.items():</span>
<span id="cb12-19">            dev <span class="op" style="color: #5E5E5E;">+=</span> num<span class="op" style="color: #5E5E5E;">*</span>(cnt<span class="op" style="color: #5E5E5E;">-</span>mean)<span class="op" style="color: #5E5E5E;">**</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb12-20">        dev <span class="op" style="color: #5E5E5E;">/=</span> (denom<span class="op" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb12-21">        dev <span class="op" style="color: #5E5E5E;">=</span> dev<span class="op" style="color: #5E5E5E;">**</span><span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb12-22">        </span>
<span id="cb12-23">        <span class="cf" style="color: #003B4F;">if</span> denom <span class="kw" style="color: #003B4F;">not</span> <span class="kw" style="color: #003B4F;">in</span> nmols:</span>
<span id="cb12-24">            nmols.append(denom)</span>
<span id="cb12-25">        means[k].append(mean)</span>
<span id="cb12-26">        devs[k].append(dev)</span>
<span id="cb12-27">        label <span class="op" style="color: #5E5E5E;">=</span> k[<span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb12-28">        <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">1</span>]<span class="op" style="color: #5E5E5E;">!=-</span><span class="dv" style="color: #AD0000;">1</span>:</span>
<span id="cb12-29">            label <span class="op" style="color: #5E5E5E;">+=</span> <span class="bu" style="color: null;">str</span>(k[<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb12-30"></span>
<span id="cb12-31">        <span class="bu" style="color: null;">print</span>(denom,label,<span class="st" style="color: #20794D;">'</span><span class="ch" style="color: #20794D;">\t</span><span class="sc" style="color: #5E5E5E;">%.1f</span><span class="st" style="color: #20794D;">'</span><span class="op" style="color: #5E5E5E;">%</span>mean,<span class="st" style="color: #20794D;">'</span><span class="sc" style="color: #5E5E5E;">%.1f</span><span class="st" style="color: #20794D;">'</span><span class="op" style="color: #5E5E5E;">%</span>dev)    </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>500000 Morgan1  26.0 6.2
500000 Morgan2  42.8 10.7
500000 Morgan3  58.7 15.5
500000 FeatMorgan1  18.2 4.3
500000 FeatMorgan2  33.8 8.5
500000 FeatMorgan3  49.5 13.2
500000 RDKit5   324.6 133.9
500000 RDKit6   560.8 256.2
500000 RDKit7   902.9 445.7
500000 pattern  408.8 133.9
500000 avalon   241.8 133.8
500000 ap-counts    133.3 57.6
500000 tt-counts    28.6 10.2
500000 ap-bv    219.5 93.6
500000 tt-bv    41.9 12.9
1000000 Morgan1     27.1 6.1
1000000 Morgan2     44.6 10.5
1000000 Morgan3     61.2 15.2
1000000 FeatMorgan1     18.9 4.2
1000000 FeatMorgan2     35.2 8.4
1000000 FeatMorgan3     51.6 13.0
1000000 RDKit5  340.7 133.9
1000000 RDKit6  588.9 257.4
1000000 RDKit7  948.5 449.9
1000000 pattern     425.2 136.0
1000000 avalon  257.7 136.7
1000000 ap-counts   143.7 57.7
1000000 tt-counts   30.1 10.1
1000000 ap-bv   234.4 92.8
1000000 tt-bv   43.6 12.9
1500000 Morgan1     27.3 5.8
1500000 Morgan2     45.0 9.9
1500000 Morgan3     61.7 14.3
1500000 FeatMorgan1     19.0 4.1
1500000 FeatMorgan2     35.5 8.0
1500000 FeatMorgan3     52.0 12.3
1500000 RDKit5  340.3 127.8
1500000 RDKit6  587.1 246.2
1500000 RDKit7  944.8 432.0
1500000 pattern     424.0 129.4
1500000 avalon  260.5 133.7
1500000 ap-counts   145.1 54.8
1500000 tt-counts   30.5 9.8
1500000 ap-bv   234.9 87.3
1500000 tt-bv   43.7 12.3
2000000 Morgan1     28.0 5.7
2000000 Morgan2     46.2 9.8
2000000 Morgan3     63.4 14.1
2000000 FeatMorgan1     19.4 4.0
2000000 FeatMorgan2     36.3 7.9
2000000 FeatMorgan3     53.3 12.1
2000000 RDKit5  350.7 126.6
2000000 RDKit6  603.5 243.1
2000000 RDKit7  969.0 425.8
2000000 pattern     433.3 128.0
2000000 avalon  269.5 133.1
2000000 ap-counts   152.4 55.5
2000000 tt-counts   31.5 9.8
2000000 ap-bv   245.8 88.2
2000000 tt-bv   45.0 12.2
2500000 Morgan1     28.7 5.8
2500000 Morgan2     47.5 9.8
2500000 Morgan3     65.3 14.2
2500000 FeatMorgan1     19.7 4.0
2500000 FeatMorgan2     37.2 7.9
2500000 FeatMorgan3     54.7 12.1
2500000 RDKit5  361.5 126.3
2500000 RDKit6  621.2 241.1
2500000 RDKit7  996.0 420.5
2500000 pattern     443.2 126.4
2500000 avalon  278.4 132.6
2500000 ap-counts   160.1 56.9
2500000 tt-counts   32.6 9.9
2500000 ap-bv   257.9 90.2
2500000 tt-bv   46.3 12.2
3000000 Morgan1     29.1 5.7
3000000 Morgan2     48.1 9.8
3000000 Morgan3     66.1 14.1
3000000 FeatMorgan1     19.9 3.9
3000000 FeatMorgan2     37.6 7.8
3000000 FeatMorgan3     55.3 12.0
3000000 RDKit5  364.5 124.5
3000000 RDKit6  625.3 237.2
3000000 RDKit7  1001.4 413.2
3000000 pattern     446.5 124.1
3000000 avalon  280.5 131.5
3000000 ap-counts   163.7 57.0
3000000 tt-counts   33.1 9.8
3000000 ap-bv   263.5 90.5
3000000 tt-bv   46.9 12.1
3500000 Morgan1     29.2 5.7
3500000 Morgan2     48.3 9.7
3500000 Morgan3     66.4 14.0
3500000 FeatMorgan1     19.9 3.9
3500000 FeatMorgan2     37.7 7.8
3500000 FeatMorgan3     55.6 11.9
3500000 RDKit5  365.3 123.8
3500000 RDKit6  626.7 236.0
3500000 RDKit7  1003.7 411.3
3500000 pattern     448.4 123.3
3500000 avalon  280.3 131.1
3500000 ap-counts   165.1 56.7
3500000 tt-counts   33.3 9.8
3500000 ap-bv   265.9 90.1
3500000 tt-bv   47.2 12.1
4000000 Morgan1     29.4 5.7
4000000 Morgan2     48.6 9.8
4000000 Morgan3     66.7 14.1
4000000 FeatMorgan1     20.0 3.9
4000000 FeatMorgan2     38.0 7.8
4000000 FeatMorgan3     55.9 12.0
4000000 RDKit5  365.2 124.1
4000000 RDKit6  627.1 236.6
4000000 RDKit7  1005.0 412.4
4000000 pattern     448.6 124.0
4000000 avalon  281.4 131.3
4000000 ap-counts   165.7 56.9
4000000 tt-counts   33.4 9.9
4000000 ap-bv   266.8 90.6
4000000 tt-bv   47.3 12.2
4500000 Morgan1     29.4 5.6
4500000 Morgan2     48.7 9.6
4500000 Morgan3     66.8 13.9
4500000 FeatMorgan1     20.1 3.9
4500000 FeatMorgan2     38.0 7.7
4500000 FeatMorgan3     55.9 11.8
4500000 RDKit5  364.3 123.1
4500000 RDKit6  624.4 234.6
4500000 RDKit7  999.1 408.8
4500000 pattern     447.0 122.7
4500000 avalon  280.7 130.6
4500000 ap-counts   166.3 56.4
4500000 tt-counts   33.4 9.8
4500000 ap-bv   267.3 89.9
4500000 tt-bv   47.3 12.1
5000000 Morgan1     29.4 5.6
5000000 Morgan2     48.7 9.6
5000000 Morgan3     66.8 13.8
5000000 FeatMorgan1     20.1 3.9
5000000 FeatMorgan2     38.1 7.7
5000000 FeatMorgan3     56.0 11.8
5000000 RDKit5  363.3 122.5
5000000 RDKit6  621.7 233.2
5000000 RDKit7  993.6 406.3
5000000 pattern     445.5 122.5
5000000 avalon  279.8 129.9
5000000 ap-counts   166.6 56.3
5000000 tt-counts   33.4 9.8
5000000 ap-bv   267.3 90.0
5000000 tt-bv   47.2 12.0</code></pre>
</div>
</div>
<p>Let’s look at those graphically:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">morgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'Morgan'</span>]</span>
<span id="cb14-2">featmorgan_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">'FeatMorgan'</span>]</span>
<span id="cb14-3">rdkit_ks <span class="op" style="color: #5E5E5E;">=</span> [x <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> counts.keys() <span class="cf" style="color: #003B4F;">if</span> x[<span class="dv" style="color: #AD0000;">0</span>] <span class="op" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">'RDKit'</span>]</span>
<span id="cb14-4"></span>
<span id="cb14-5">figure(figsize<span class="op" style="color: #5E5E5E;">=</span>(<span class="dv" style="color: #AD0000;">15</span>,<span class="dv" style="color: #AD0000;">15</span>))</span>
<span id="cb14-6"></span>
<span id="cb14-7">nmols2 <span class="op" style="color: #5E5E5E;">=</span> [x<span class="op" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">1000000</span> <span class="cf" style="color: #003B4F;">for</span> x <span class="kw" style="color: #003B4F;">in</span> nmols]</span>
<span id="cb14-8"></span>
<span id="cb14-9">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb14-10">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb14-11"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> morgan_ks:</span>
<span id="cb14-12">    lmeans <span class="op" style="color: #5E5E5E;">=</span> means[(n,r)]</span>
<span id="cb14-13">    ldevs <span class="op" style="color: #5E5E5E;">=</span> devs[(n,r)]</span>
<span id="cb14-14">    errorbar(nmols2,lmeans,yerr<span class="op" style="color: #5E5E5E;">=</span>ldevs,capsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb14-15">    </span>
<span id="cb14-16">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"Morgan"</span>)</span>
<span id="cb14-17">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num mols (millions)"</span>)</span>
<span id="cb14-18">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb14-19"><span class="co" style="color: #5E5E5E;">#_=legend()</span></span>
<span id="cb14-20"></span>
<span id="cb14-21">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb14-22">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb14-23"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> featmorgan_ks:</span>
<span id="cb14-24">    lmeans <span class="op" style="color: #5E5E5E;">=</span> means[(n,r)]</span>
<span id="cb14-25">    ldevs <span class="op" style="color: #5E5E5E;">=</span> devs[(n,r)]</span>
<span id="cb14-26">    errorbar(nmols2,lmeans,yerr<span class="op" style="color: #5E5E5E;">=</span>ldevs,capsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb14-27">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"FeatMorgan"</span>)</span>
<span id="cb14-28">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num mols (millions)"</span>)</span>
<span id="cb14-29">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb14-30"><span class="co" style="color: #5E5E5E;">#_=legend()</span></span>
<span id="cb14-31"></span>
<span id="cb14-32">pidx<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span></span>
<span id="cb14-33">subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb14-34"><span class="cf" style="color: #003B4F;">for</span> n,r <span class="kw" style="color: #003B4F;">in</span> rdkit_ks:</span>
<span id="cb14-35">    lmeans <span class="op" style="color: #5E5E5E;">=</span> means[(n,r)]</span>
<span id="cb14-36">    ldevs <span class="op" style="color: #5E5E5E;">=</span> devs[(n,r)]</span>
<span id="cb14-37">    errorbar(nmols2,lmeans,yerr<span class="op" style="color: #5E5E5E;">=</span>ldevs,capsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb14-38">_<span class="op" style="color: #5E5E5E;">=</span>title(<span class="st" style="color: #20794D;">"RDKit"</span>)</span>
<span id="cb14-39">_<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num mols (millions)"</span>)</span>
<span id="cb14-40">_<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb14-41"><span class="co" style="color: #5E5E5E;">#_=legend()</span></span>
<span id="cb14-42"></span>
<span id="cb14-43"><span class="cf" style="color: #003B4F;">for</span> k <span class="kw" style="color: #003B4F;">in</span> counts.keys():</span>
<span id="cb14-44">    <span class="cf" style="color: #003B4F;">if</span> k[<span class="dv" style="color: #AD0000;">0</span>] <span class="kw" style="color: #003B4F;">in</span> (<span class="st" style="color: #20794D;">'Morgan'</span>,<span class="st" style="color: #20794D;">'FeatMorgan'</span>,<span class="st" style="color: #20794D;">'RDKit'</span>):</span>
<span id="cb14-45">        <span class="cf" style="color: #003B4F;">continue</span></span>
<span id="cb14-46">    pidx<span class="op" style="color: #5E5E5E;">+=</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb14-47">    subplot(<span class="dv" style="color: #AD0000;">3</span>,<span class="dv" style="color: #AD0000;">3</span>,pidx)</span>
<span id="cb14-48">    lmeans <span class="op" style="color: #5E5E5E;">=</span> means[k]</span>
<span id="cb14-49">    ldevs <span class="op" style="color: #5E5E5E;">=</span> devs[k]</span>
<span id="cb14-50">    errorbar(nmols2,lmeans,yerr<span class="op" style="color: #5E5E5E;">=</span>ldevs,capsize<span class="op" style="color: #5E5E5E;">=</span><span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb14-51">    _<span class="op" style="color: #5E5E5E;">=</span>title(k[<span class="dv" style="color: #AD0000;">0</span>])</span>
<span id="cb14-52">    _<span class="op" style="color: #5E5E5E;">=</span>xlabel(<span class="st" style="color: #20794D;">"num mols (millions)"</span>)</span>
<span id="cb14-53">    _<span class="op" style="color: #5E5E5E;">=</span>ylabel(<span class="st" style="color: #20794D;">"count"</span>)</span>
<span id="cb14-54">   </span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2021-07-06-number-of-fp-bits-set_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Looks like we would have been fine with 3 million molecules.</p>


</section>

 ]]></description>
  <category>fingerprints</category>
  <category>reference</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2021-07-06-number-of-fp-bits-set.html</guid>
  <pubDate>Mon, 05 Jul 2021 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/fingerprint-bit-counts-1.png" medium="image" type="image/png" height="46" width="144"/>
</item>
</channel>
</rss>
